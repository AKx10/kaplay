var kaboom=(()=>{var et=Object.defineProperty;var Kt=Object.prototype.hasOwnProperty;var tt=Object.getOwnPropertySymbols,Zt=Object.prototype.propertyIsEnumerable;var nt=(e,t,s)=>t in e?et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,te=(e,t)=>{for(var s in t||(t={}))Kt.call(t,s)&&nt(e,s,t[s]);if(tt)for(var s of tt(t))Zt.call(t,s)&&nt(e,s,t[s]);return e};var o=(e,t)=>et(e,"name",{value:t,configurable:!0});var ne=(e,t)=>()=>(e&&(t=e(e=0)),t),Jt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);function ue(e,t,s){return Math.min(Math.max(e,t),s)}function Ae(e,t,s){return e+(t-e)*s}function De(e,t,s,c,b){return c+(e-t)/(s-t)*(b-c)}function m(e,t){return Ue(e)&&t===void 0?m(e.x,e.y):{x:e!=null?e:0,y:t!=null?t:e!=null?e:0,clone(){return m(this.x,this.y)},add(...s){let c=m(...s);return m(this.x+c.x,this.y+c.y)},sub(...s){let c=m(...s);return m(this.x-c.x,this.y-c.y)},scale(s){return m(this.x*s,this.y*s)},dist(...s){let c=m(...s);return Math.sqrt((this.x-c.x)*(this.x-c.x)+(this.y-c.y)*(this.y-c.y))},len(){return this.dist(m(0,0))},unit(){return this.scale(1/this.len())},normal(){return m(this.y,-this.x)},dot(...s){let c=m(...s);return m(this.x*c.x,this.y*c.y)},angle(...s){let c=m(...s);return Math.atan2(this.y-c.y,this.x-c.x)},lerp(s,c){return m(Ae(this.x,s.x,c),Ae(this.y,s.y,c))},eq(s){return this.x===s.x&&this.y===s.y},str(){return`(${this.x}, ${this.y})`}}}function rt(e){return m(Math.cos(e),Math.sin(e))}function ye(e,t,s){return{x:e,y:t,z:s,xy(){return m(this.x,this.y)}}}function Ue(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}function ot(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}function st(e,t,s){return U(e,t,s,1)}function U(...e){var t;return e=[...e],e.length===0?U(1,1,1,1):{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return U(this.r,this.g,this.b,this.a)},lighten(s){return U(this.r+s,this.g+s,this.b+s,this.a)},darken(s){return this.lighten(-s)},eq(s){return this.r===s.r&&this.g===s.g&&this.b===s.g&&this.a===s.a}}}function re(e,t,s,c){return{x:e,y:t,w:s,h:c,clone(){return re(this.x,this.y,this.w,this.h)},eq(b){return this.x===b.x&&this.y===b.y&&this.w===b.w&&this.h===b.h}}}function W(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return W(this.m)},mult(t){let s=[];for(let c=0;c<4;c++)for(let b=0;b<4;b++)s[c*4+b]=this.m[0*4+b]*t.m[c*4+0]+this.m[1*4+b]*t.m[c*4+1]+this.m[2*4+b]*t.m[c*4+2]+this.m[3*4+b]*t.m[c*4+3];return W(s)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let s=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return ye(s.x,s.y,s.z)},multVec2(t){return m(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(W([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(W([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(W([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(W([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(W([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],s=this.m[10]*this.m[15]-this.m[14]*this.m[11],c=this.m[9]*this.m[15]-this.m[13]*this.m[11],b=this.m[9]*this.m[14]-this.m[13]*this.m[10],C=this.m[8]*this.m[15]-this.m[12]*this.m[11],G=this.m[8]*this.m[14]-this.m[12]*this.m[10],S=this.m[8]*this.m[13]-this.m[12]*this.m[9],O=this.m[6]*this.m[15]-this.m[14]*this.m[7],F=this.m[5]*this.m[15]-this.m[13]*this.m[7],_=this.m[5]*this.m[14]-this.m[13]*this.m[6],T=this.m[4]*this.m[15]-this.m[12]*this.m[7],w=this.m[4]*this.m[14]-this.m[12]*this.m[6],P=this.m[5]*this.m[15]-this.m[13]*this.m[7],k=this.m[4]*this.m[13]-this.m[12]*this.m[5],E=this.m[6]*this.m[11]-this.m[10]*this.m[7],V=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],Y=this.m[4]*this.m[11]-this.m[8]*this.m[7],H=this.m[4]*this.m[10]-this.m[8]*this.m[6],X=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*s-this.m[6]*c+this.m[7]*b,t[4]=-(this.m[4]*s-this.m[6]*C+this.m[7]*G),t[8]=this.m[4]*c-this.m[5]*C+this.m[7]*S,t[12]=-(this.m[4]*b-this.m[5]*G+this.m[6]*S),t[1]=-(this.m[1]*s-this.m[2]*c+this.m[3]*b),t[5]=this.m[0]*s-this.m[2]*C+this.m[3]*G,t[9]=-(this.m[0]*c-this.m[1]*C+this.m[3]*S),t[13]=this.m[0]*b-this.m[1]*G+this.m[2]*S,t[2]=this.m[1]*O-this.m[2]*F+this.m[3]*_,t[6]=-(this.m[0]*O-this.m[2]*T+this.m[3]*w),t[10]=this.m[0]*P-this.m[1]*T+this.m[3]*k,t[14]=-(this.m[0]*_-this.m[1]*w+this.m[2]*k),t[3]=-(this.m[1]*E-this.m[2]*V+this.m[3]*g),t[7]=this.m[0]*E-this.m[2]*Y+this.m[3]*H,t[11]=-(this.m[0]*V-this.m[1]*Y+this.m[3]*X),t[15]=this.m[0]*g-this.m[1]*H+this.m[2]*X;let $=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let v=0;v<4;v++)for(let L=0;L<4;L++)t[v*4+L]*=1/$;return W(t)}}}function it(e,t,s){return e+(Math.sin(s)+1)/2*(t-e)}function Ye(e){return{seed:e,gen(t,s){if(Ue(t)&&Ue(s))return m(this.gen(t.x,s.x),this.gen(t.y,s.y));if(ot(t)&&ot(s))return U(this.gen(t.r,s.r),this.gen(t.g,s.g),this.gen(t.b,s.b),this.gen(t.a,s.a));if(t!==void 0)return s===void 0?this.gen()*t:this.gen()*(s-t)+t;if(t===void 0&&s===void 0)return this.seed=(en*this.seed+tn)%at,this.seed/at;throw new Error("invalid param to rand()")}}}function ct(e){ut.seed=e}function _e(e,t){return ut.gen(e,t)}function dt(e){return _e(0,1)<=e}function mt(e){return e[Math.floor(_e(e.length))]}function He(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function ht(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function ft(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var en,tn,at,ut,le=ne(()=>{o(ue,"clamp");o(Ae,"lerp");o(De,"map");o(m,"vec2");o(rt,"vec2FromAngle");o(ye,"vec3");o(Ue,"isVec2");o(ot,"isColor");o(st,"rgb");o(U,"rgba");o(re,"quad");o(W,"mat4");o(it,"wave");en=1103515245,tn=12345,at=2147483648,ut=Ye(Date.now());o(Ye,"makeRng");o(ct,"randSeed");o(_e,"rand");o(dt,"chance");o(mt,"choose");o(He,"colRectRect");o(ht,"overlapRectRect");o(ft,"colRectPt")});var lt,pt=ne(()=>{lt=`attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_uv;
varying vec4 v_color;

void main() {
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = vec4(a_pos, 1.0);
}
`});var bt,yt=ne(()=>{bt=`precision mediump float;

varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

void main() {
	gl_FragColor = v_color * texture2D(u_tex, v_uv);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`});function ke(e){switch(e){case"topleft":return m(-1,-1);case"top":return m(0,-1);case"topright":return m(1,-1);case"left":return m(-1,0);case"center":return m(0,0);case"right":return m(1,0);case"botleft":return m(-1,1);case"bot":return m(0,1);case"botright":return m(1,1);default:return e}}function gt(e,t){let s=(()=>{var A;let h=E(on,sn),p=g(lt,bt),y=V(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),D=(A=t.clearColor)!=null?A:U(0,0,0,0);return e.clearColor(D.r,D.g,D.b,D.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),{drawCalls:0,mesh:h,defProg:p,defTex:y,curTex:y,transform:W(),transformStack:[]}})();function c(){s.mesh.flush(),!!s.curTex&&(s.mesh.bind(),s.defProg.bind(),s.curTex.bind(),e.vertexAttribPointer(0,3,e.FLOAT,!1,Oe*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,Oe*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,Oe*4,20),e.enableVertexAttribArray(2),e.drawElements(e.TRIANGLES,s.mesh.count(),e.UNSIGNED_SHORT,0),s.drawCalls++,s.defProg.unbind(),s.mesh.unbind(),s.curTex=null)}o(c,"flush");function b(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),s.drawCalls=0,s.transformStack=[],s.transform=W()}o(b,"frameStart");function C(){c()}o(C,"frameEnd");function G(h){return m(h.x/Ve()*2-1,-h.y/xe()*2+1)}o(G,"toNDC");function S(h){s.transform=h.clone()}o(S,"pushMatrix");function O(h){!h||h.x===0&&h.y===0||(s.transform=s.transform.translate(h))}o(O,"pushTranslate");function F(h){!h||h.x===0&&h.y===0||(s.transform=s.transform.scale(h))}o(F,"pushScale");function _(h){!h||(s.transform=s.transform.rotateX(h))}o(_,"pushRotateX");function T(h){!h||(s.transform=s.transform.rotateY(h))}o(T,"pushRotateY");function w(h){!h||(s.transform=s.transform.rotateZ(h))}o(w,"pushRotateZ");function P(){s.transformStack.push(s.transform.clone())}o(P,"pushTransform");function k(){s.transformStack.length>0&&(s.transform=s.transformStack.pop())}o(k,"popTransform");function E(h,p){let y=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,h*32,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let D=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,D),e.bufferData(e.ELEMENT_ARRAY_BUFFER,p*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let A=0;return{vbuf:y,ibuf:D,vqueue:[],iqueue:[],push(I,M){M=M.map(q=>q+this.vqueue.length/Oe),this.vqueue=this.vqueue.concat(I),this.iqueue=this.iqueue.concat(M)},flush(){e.bindBuffer(e.ARRAY_BUFFER,this.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),A=this.iqueue.length,this.iqueue=[],this.vqueue=[]},bind(){e.bindBuffer(e.ARRAY_BUFFER,this.vbuf),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuf)},unbind(){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},count(){return A}}}o(E,"makeBatchedMesh");function V(h){let p=e.createTexture();return e.bindTexture(e.TEXTURE_2D,p),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{id:p,width:h.width,height:h.height,bind(){e.bindTexture(e.TEXTURE_2D,this.id)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}o(V,"makeTex");function g(h,p){let y=e.createShader(e.VERTEX_SHADER);e.shaderSource(y,h),e.compileShader(y);let D;if(D=e.getShaderInfoLog(y))throw new Error(D);let A=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(A,p),e.compileShader(A),D=e.getShaderInfoLog(A))throw new Error(D);let I=e.createProgram();if(e.attachShader(I,y),e.attachShader(I,A),e.bindAttribLocation(I,0,"a_pos"),e.bindAttribLocation(I,1,"a_uv"),e.bindAttribLocation(I,2,"a_color"),e.linkProgram(I),D=e.getProgramInfoLog(I))throw new Error(D);return{id:I,bind(){e.useProgram(this.id)},unbind(){e.useProgram(null)},sendFloat(M,q){let R=e.getUniformLocation(this.id,M);e.uniform1f(R,q)},sendVec2(M,q,R){let z=e.getUniformLocation(this.id,M);e.uniform2f(z,q,R)},sendVec3(M,q,R,z){let N=e.getUniformLocation(this.id,M);e.uniform3f(N,q,R,z)},sendVec4(M,q,R,z,N){let K=e.getUniformLocation(this.id,M);e.uniform4f(K,q,R,z,N)},sendMat4(M,q){let R=e.getUniformLocation(this.id,M);e.uniformMatrix4fv(R,!1,new Float32Array(q))}}}o(g,"makeProgram");function Y(h,p,y,D){let A=h.width/p,I=h.height/y,M=1/A,q=1/I,R={},z=D.split("").entries();for(let[N,K]of z)R[K]=m(N%A*M,Math.floor(N/A)*q);return{tex:h,map:R,qw:M,qh:q}}o(Y,"makeFont");function H(h,p,y=s.defTex){s.curTex!==y&&(c(),s.curTex=y);let D=h.map(A=>{let I=G(s.transform.multVec2(A.pos.xy()));return[I.x,I.y,A.pos.z,A.uv.x,A.uv.y,A.color.r,A.color.g,A.color.b,A.color.a]}).flat();s.mesh.push(D,p)}o(H,"drawRaw");function X(h={}){var K,J;let p=h.width||0,y=h.height||0,D=h.pos||m(0,0),I=ke(h.origin||Xe).dot(m(p,y).scale(-.5)),M=m((K=h.scale)!=null?K:1),q=h.rot||0,R=h.quad||re(0,0,1,1),z=1-((J=h.z)!=null?J:0),N=h.color||U(1,1,1,1);P(),O(D),F(M),w(q),O(I),H([{pos:ye(-p/2,y/2,z),uv:m(R.x,R.y+R.h),color:N},{pos:ye(-p/2,-y/2,z),uv:m(R.x,R.y),color:N},{pos:ye(p/2,-y/2,z),uv:m(R.x+R.w,R.y),color:N},{pos:ye(p/2,y/2,z),uv:m(R.x+R.w,R.y+R.h),color:N}],[0,1,3,1,2,3],h.tex),k()}o(X,"drawQuad");function $(h,p={}){var I;let y=(I=p.quad)!=null?I:re(0,0,1,1),D=h.width*y.w,A=h.height*y.h;X({tex:h,quad:y,width:D,height:A,pos:p.pos,scale:p.scale,rot:p.rot,color:p.color,origin:p.origin,z:p.z})}o($,"drawTexture");function v(h,p,y,D={}){X(te(te({},D),{pos:h,width:p,height:y}))}o(v,"drawRect");function L(h,p,y,D={}){let A=ke(D.origin||Xe).dot(m(p,y)).scale(.5),I=h.add(m(-p/2,-y/2)).sub(A),M=h.add(m(-p/2,y/2)).sub(A),q=h.add(m(p/2,y/2)).sub(A),R=h.add(m(p/2,-y/2)).sub(A);Q(I,M,D),Q(M,q,D),Q(q,R,D),Q(R,I,D)}o(L,"drawRectStroke");function Q(h,p,y={}){let D=y.width||1,A=h.dist(p),I=Math.PI/2-h.angle(p);X(te(te({},y),{pos:h.add(p).scale(.5),width:D,height:A,rot:I,origin:"center"}))}o(Q,"drawLine");function ee(h,p,y={}){let D=(h+"").split(""),A=p.qw*p.tex.width,I=p.qh*p.tex.height,M=y.size||I,q=m(M/I).dot(m(y.scale||1)),R=q.x*A,z=q.y*I,N=0,K=z,J=0,pe=[[]];for(let se of D)(se===`
`||(y.width?N+R>y.width:!1))&&(K+=z,N=0,pe.push([])),se!==`
`&&(pe[pe.length-1].push(se),N+=R),J=Math.max(J,N);y.width&&(J=y.width);let Pe=[],Ge=m(y.pos),ce=ke(y.origin||Xe).scale(.5),de=-ce.x*R-(ce.x+.5)*(J-R),ae=-ce.y*z-(ce.y+.5)*(K-z);return pe.forEach((se,we)=>{let Be=(J-se.length*R)*(ce.x+.5);se.forEach((Re,Le)=>{let Ce=p.map[Re],ze=Le*R,Ie=we*z;Ce&&Pe.push({tex:p.tex,quad:re(Ce.x,Ce.y,p.qw,p.qh),ch:Re,pos:m(Ge.x+ze+de+Be,Ge.y+Ie+ae),color:y.color,origin:y.origin,scale:q,z:y.z})})}),{width:J,height:K,chars:Pe}}o(ee,"fmtText");function oe(h,p,y={}){Z(ee(h,p,y))}o(oe,"drawText");function Z(h){for(let p of h.chars)X({tex:p.tex,width:p.tex.width*p.quad.w,height:p.tex.height*p.quad.h,pos:p.pos,scale:p.scale,color:p.color,quad:p.quad,origin:"center",z:p.z})}o(Z,"drawFmtText");function Ve(){return e.drawingBufferWidth/ve()}o(Ve,"width");function xe(){return e.drawingBufferHeight/ve()}o(xe,"height");function ve(){var h;return(h=t.scale)!=null?h:1}return o(ve,"scale"),{width:Ve,height:xe,scale:ve,makeTex:V,makeFont:Y,drawTexture:$,drawText:oe,drawFmtText:Z,drawRect:v,drawRectStroke:L,drawLine:Q,fmtText:ee,frameStart:b,frameEnd:C,pushTransform:P,popTransform:k,pushMatrix:S}}var Xe,Oe,on,sn,xt=ne(()=>{le();pt();yt();Xe="topleft",Oe=9,on=65536,sn=65536;o(ke,"originPt");o(gt,"gfxInit")});function vt(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}function wt(e={}){var X,$;let t={canvas:(X=e.canvas)!=null?X:(()=>{var L;let v=document.createElement("canvas");return((L=e.root)!=null?L:document.body).appendChild(v),v})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:m(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:($=e.scale)!=null?$:1,isTouch:!1,loopID:null,stopped:!1},s={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},c=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let b=["outline: none"];e.crisp&&(b.push("image-rendering: pixelated"),b.push("image-rendering: crisp-edges")),t.canvas.style=b.join(";"),t.canvas.setAttribute("tabindex","0");let C=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("contextmenu",v=>{v.preventDefault()}),t.canvas.addEventListener("mousemove",v=>{t.mousePos=m(v.offsetX,v.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",v=>{let L=v.touches[0];t.mousePos=m(L.clientX,L.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",v=>{let L=v.touches[0];t.mousePos=m(L.clientX,L.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",v=>{let L=s[v.key]||v.key.toLowerCase();c.includes(L)&&v.preventDefault(),L.length===1&&t.charInputted.push(L),L==="space"&&t.charInputted.push(" "),v.repeat?t.keyStates[L]="rpressed":t.keyStates[L]="pressed"}),t.canvas.addEventListener("keyup",v=>{let L=s[v.key]||v.key.toLowerCase();t.keyStates[L]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function G(){return t.mousePos.clone()}o(G,"mousePos");function S(){return t.mouseState==="pressed"}o(S,"mouseClicked");function O(){return t.mouseState==="pressed"||t.mouseState==="down"}o(O,"mouseDown");function F(){return t.mouseState==="released"}o(F,"mouseReleased");function _(v){return t.keyStates[v]==="pressed"}o(_,"keyPressed");function T(v){return t.keyStates[v]==="pressed"||t.keyStates[v]==="rpressed"}o(T,"keyPressedRep");function w(v){return t.keyStates[v]==="pressed"||t.keyStates[v]==="rpressed"||t.keyStates[v]==="down"}o(w,"keyDown");function P(v){return t.keyStates[v]==="released"}o(P,"keyReleased");function k(){return[...t.charInputted]}o(k,"charInputted");function E(){return t.dt}o(E,"dt");function V(){return t.time}o(V,"time");function g(){return t.canvas.toDataURL()}o(g,"screenshot");function Y(v){let L=o(Q=>{let ee=Q/1e3,oe=ee-t.realTime;t.realTime=ee,t.skipTime||(t.dt=oe,t.time+=t.dt),t.skipTime=!1,v();for(let Z in t.keyStates)t.keyStates[Z]=vt(t.keyStates[Z]);t.mouseState=vt(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(L))},"frame");t.loopID=requestAnimationFrame(L)}o(Y,"run");function H(){cancelAnimationFrame(t.loopID),t.stopped=!0}return o(H,"quit"),{gl:C,mousePos:G,keyDown:w,keyPressed:_,keyPressedRep:T,keyReleased:P,mouseDown:O,mouseClicked:S,mouseReleased:F,charInputted:k,dt:E,time:V,screenshot:g,run:Y,quit:H}}var Rt=ne(()=>{le();o(vt,"processBtnState");o(wt,"appInit")});function Tt(){let e=(()=>{let b=new(window.AudioContext||window.webkitAudioContext),C=b.createGain(),G=C;return G.connect(b.destination),{ctx:b,gainNode:C,masterNode:G}})();function t(b){return b!==void 0&&(e.gainNode.gain.value=ue(b,Ct,St)),e.gainNode.gain.value}o(t,"volume");function s(b,C={loop:!1,volume:1,speed:1,detune:0,seek:0}){var P;let G=!1,S=e.ctx.createBufferSource();S.buffer=b,S.loop=!!C.loop;let O=e.ctx.createGain();S.connect(O),O.connect(e.masterNode);let F=(P=C.seek)!=null?P:0;S.start(0,F);let _=e.ctx.currentTime-F,T=null,w={stop(){S.stop(),G=!0,T=e.ctx.currentTime},play(k){if(!G)return;let E=S;S=e.ctx.createBufferSource(),S.buffer=E.buffer,S.loop=E.loop,S.playbackRate.value=E.playbackRate.value,S.detune&&(S.detune.value=E.detune.value),S.connect(O);let V=k!=null?k:this.time();S.start(0,V),_=e.ctx.currentTime-V,G=!1,T=null},pause(){this.stop()},paused(){return G},stopped(){return G},speed(k){return k!==void 0&&(S.playbackRate.value=ue(k,an,un)),S.playbackRate.value},detune(k){return S.detune?(k!==void 0&&(S.detune.value=ue(k,cn,dn)),S.detune.value):0},volume(k){return k!==void 0&&(O.gain.value=ue(k,Ct,St)),O.gain.value},loop(){S.loop=!0},unloop(){S.loop=!1},duration(){return b.duration},time(){return G&&T?T-_:e.ctx.currentTime-_}};return w.speed(C.speed),w.detune(C.detune),w.volume(C.volume),w}o(s,"play");function c(){return e.ctx}return o(c,"ctx"),{ctx:c,volume:t,play:s}}var Ct,St,an,un,cn,dn,Et=ne(()=>{le();Ct=0,St=3,an=0,un=3,cn=-1200,dn=1200;o(Tt,"audioInit")});var At,Dt=ne(()=>{At="data:image/png;base64,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"});function _t(e){let t=new Image;return t.src=e,new Promise((s,c)=>{t.onload=()=>{s(t)},t.onerror=()=>{c()}})}function kt(e){return e.startsWith("data:")}function Vt(e,t,s={}){let c={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{}};function b(T){var P;let w=c.lastLoaderID;c.loaders[w]=!1,c.lastLoaderID++,T.catch((P=s.errHandler)!=null?P:console.error).finally(()=>{c.loaders[w]=!0})}o(b,"addLoader");function C(){let T=0,w=0;for(let P in c.loaders)T+=1,c.loaders[P]&&(w+=1);return w/T}o(C,"loadProgress");function G(T){return T&&(c.loadRoot=T),c.loadRoot}o(G,"loadRoot");function S(T,w,P,k,E=hn){let V=new Promise((g,Y)=>{let H=kt(w)?w:c.loadRoot+w;_t(H).then(X=>{let $=e.makeFont(e.makeTex(X),P,k,E);c.fonts[T]=$,g($)}).catch(()=>{Y(`failed to load font '${T}' from '${w}'`)})});return b(V),V}o(S,"loadFont");function O(T,w,P={sliceX:1,sliceY:1,anims:{}}){function k(V,g,Y={sliceX:1,sliceY:1,anims:{}}){let H=[],X=e.makeTex(g),$=Y.sliceX||1,v=Y.sliceY||1,L=1/$,Q=1/v;for(let oe=0;oe<v;oe++)for(let Z=0;Z<$;Z++)H.push(re(Z*L,oe*Q,L,Q));let ee={tex:X,frames:H,anims:Y.anims||{}};return c.sprites[V]=ee,ee}o(k,"loadRawSprite");let E=new Promise((V,g)=>{if(typeof w=="string"){let Y=kt(w)?w:c.loadRoot+w;_t(Y).then(H=>{V(k(T,H,P))}).catch(()=>{g(`failed to load sprite '${T}' from '${w}'`)});return}else V(k(T,w,P))});return b(E),E}o(O,"loadSprite");function F(T,w){let P=new Promise((k,E)=>{typeof w=="string"&&fetch(c.loadRoot+w).then(V=>V.arrayBuffer()).then(V=>new Promise((g,Y)=>{t.ctx().decodeAudioData(V,H=>{g(H)},()=>{Y()})})).then(V=>{c.sounds[T]=V,k(V)}).catch(()=>{E(`failed to load sound '${T}' from '${w}'`)})});return b(P),P}o(F,"loadSound");function _(){return c.fonts[ge]}return o(_,"defFont"),S(ge,At,8,8),{loadRoot:G,loadSprite:O,loadSound:F,loadFont:S,loadProgress:C,addLoader:b,defFont:_,sprites:c.sprites,fonts:c.fonts,sounds:c.sounds}}var hn,ge,Pt=ne(()=>{le();Dt();hn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ge="unscii";o(_t,"loadImg");o(kt,"isDataUrl");o(Vt,"assetsInit")});function Gt(e,t,s={max:8}){var F;let c=[],b=(F=s.max)!=null?F:8;function C(){c.length>b&&(c=c.slice(0,b));let _=m(0,e.height());c.forEach((T,w)=>{let P=De(w,0,b,1,.2),k=De(w,0,b,.7,.2),E=(()=>{switch(T.type){case"info":return U(1,1,1,P);case"error":return U(1,0,.5,P)}})(),V=e.fmtText(T.msg,t.defFont(),{pos:_,origin:"botleft",color:E,z:1,size:16/e.scale(),width:e.width()});e.drawRect(_,V.width,V.height,{origin:"botleft",color:U(0,0,0,k),z:1}),e.drawFmtText(V),_.y-=V.height})}o(C,"draw");function G(_){console.error(_),c.unshift({type:"error",msg:_})}o(G,"error");function S(_){console.log(_),c.unshift({type:"info",msg:_})}o(S,"info");function O(){c=[]}return o(O,"clear"),{info:S,error:G,draw:C,clear:O}}var Lt=ne(()=>{le();o(Gt,"loggerInit")});function It(e){let t={},s=[],c=null;function b(){return c!==null&&c.readyState===1}o(b,"connected");function C(){let F=new WebSocket(e);return new Promise((_,T)=>{F.onopen=()=>{_(F),c=F;for(let w of s)F.send(w)},F.onerror=()=>{T(`failed to connect to ${e}`)},F.onmessage=w=>{let P=JSON.parse(w.data);if(t[P.type])for(let k of t[P.type])k(P.data,P.id)}})}o(C,"connect");function G(F,_){t[F]||(t[F]=[]),t[F].push(_)}o(G,"recv");function S(F,_){let T=JSON.stringify({type:F,data:_});c?c.send(T):s.push(T)}o(S,"send");function O(){c&&c.close()}return o(O,"close"),{connect:C,close:O,connected:b,recv:G,send:S}}var Ft=ne(()=>{o(It,"netInit")});var fn=Jt((nr,Mt)=>{le();xt();Rt();Et();Pt();Lt();Ft();Mt.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{var We;let t=wt({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),s=gt(t.gl,{clearColor:(r=>U(r[0],r[1],r[2],r[3]))((We=e.clearColor)!=null?We:[0,0,0,1]),scale:e.scale}),c=Tt(),b=Vt(s,c,{errHandler:r=>{C.error(r)}}),C=Gt(s,b,{max:e.logMax}),G=(()=>e.connect?It(e.connect):null)();function S(r,n){if(!G)throw new Error("not connected to any websockets");G.recv(r,(a,i)=>{try{n(a,i)}catch(u){C.error(u)}})}o(S,"recv");function O(r,n){if(!G)throw new Error("not connected to any websockets");G.send(r,n)}o(O,"send");function F(r,n={}){let a=b.sounds[r];if(!a)throw new Error(`sound not found: "${r}"`);return c.play(a,n)}o(F,"play");function _(r){let n=g();return r?n.cam.ignore.includes(r)?_():n.cam.mpos:t.mousePos()}o(_,"mousePos");function T(r,n={}){var u;let a=(()=>typeof r=="string"?b.sprites[r]:r)();if(!a)throw new Error(`sprite not found: "${r}"`);let i=a.frames[(u=n.frame)!=null?u:0];s.drawTexture(a.tex,te(te({},n),{quad:i}))}o(T,"drawSprite");function w(r,n){var u;let a=(u=n.font)!=null?u:ge,i=b.fonts[a];if(!i)throw new Error(`font not found: ${a}`);s.drawText(r,i,n)}o(w,"drawText");let P=980,k="topleft",E={loaded:!1,scenes:{},curScene:null,nextScene:null};function V(r,n){E.scenes[r]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:m(s.width()/2,s.height()/2),scale:m(1,1),angle:0,shake:0,ignore:[],mpos:m(0)},layers:{},defLayer:null,gravity:P,data:{}}}o(V,"scene");function g(){return E.scenes[E.curScene]}o(g,"curScene");function Y(){return g().data}o(Y,"sceneData");function H(){N("`",()=>{B.showLog=!B.showLog,C.info(`show log: ${B.showLog?"on":"off"}`)}),N("f1",()=>{B.inspect=!B.inspect,C.info(`inspect: ${B.inspect?"on":"off"}`)}),N("f2",()=>{B.clearLog()}),N("f8",()=>{B.paused=!B.paused,C.info(`${B.paused?"paused":"unpaused"}`)}),N("f7",()=>{B.timeScale=ue(B.timeScale-.2,0,2),C.info(`time scale: ${B.timeScale.toFixed(1)}`)}),N("f9",()=>{B.timeScale=ue(B.timeScale+.2,0,2),C.info(`time scale: ${B.timeScale.toFixed(1)}`)}),N("f10",()=>{B.stepFrame(),C.info("stepped frame")})}o(H,"regDebugInputs");function X(r,...n){E.nextScene={name:r,args:[...n]}}o(X,"go");function $(r,...n){v(r),E.curScene=r;let a=E.scenes[r];if(!a)throw new Error(`scene not found: '${r}'`);if(!a.initialized){try{a.init(...n)}catch(i){C.error(i.stack)}e.debug&&H(),a.initialized=!0}}o($,"goSync");function v(r){if(!E.scenes[r])throw new Error(`scene not found: '${r}'`);V(r,E.scenes[r].init)}o(v,"reload");function L(r,n){let a=g();if(!a)return;let i=.5/r.length;r.forEach((u,l)=>{a.layers[u]=.5+i*l}),n&&(a.defLayer=n)}o(L,"layers");function Q(...r){let n=g().cam;return r.length>0&&(n.pos=m(...r)),n.pos.clone()}o(Q,"camPos");function ee(...r){let n=g().cam;return r.length>0&&(n.scale=m(...r)),n.scale.clone()}o(ee,"camScale");function oe(r){let n=g().cam;return r!==void 0&&(n.angle=r),n.angle}o(oe,"camRot");function Z(r){let n=g().cam;n.shake=r}o(Z,"camShake");function Ve(r){let n=g().cam;n.ignore=r}o(Ve,"camIgnore");function xe(r){let n={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(i){if(i===void 0)return;let u=typeof i;if(u==="string"){this._tags.push(i);return}if(u!=="object")throw new Error(`invalid comp type: ${u}`);if(Array.isArray(i)){for(let l of i)this.use(l);return}for(let l in i){if(typeof i[l]=="function"){this._events[l]?this._events[l].push(i[l].bind(this)):this[l]=i[l].bind(this);continue}this[l]=i[l]}},exists(){return this._sceneID!==void 0},is(i){if(i==="*")return!0;if(Array.isArray(i)){for(let u of i)if(!this._tags.includes(u))return!1;return!0}return this._tags.includes(i)},on(i,u){this._events[i]||(this._events[i]=[]),this._events[i].push(u)},action(i){this.on("update",i)},trigger(i,...u){if(this._events[i])for(let f of this._events[i])f.call(this,...u);let d=g().events[i];if(d)for(let f of d)this.is(f.tag)&&f.cb(this,...u)},rmTag(i){let u=this._tags.indexOf(i);u>-1&&this._tags.splice(u,1)}};n.use(r);let a=g();a.objs.set(a.lastID,n),n._sceneID=a.lastID,a.lastID++,n.trigger("add");for(let i of a.events.add)n.is(i.tag)&&i.cb(n);return n}o(xe,"add");function ve(r){if(!r.exists())return;let n=g();return n.objs.delete(r._sceneID),n.objs.set(n.lastID,r),r._sceneID=n.lastID,n.lastID++,r}o(ve,"readd");function h(r,n,a){let i=g();i.events[r]||(i.events[r]=[]),i.events[r].push({tag:n,cb:a})}o(h,"on");function p(r,n){typeof r=="function"&&n===void 0?g().action.push(r):typeof r=="string"&&h("update",r,n)}o(p,"action");function y(r,n){typeof r=="function"&&n===void 0?g().render.push(r):typeof r=="string"&&h("update",r,n)}o(y,"render");function D(r,n,a){p(r,i=>{i._checkCollisions(n,u=>{a(i,u)})})}o(D,"collides");function A(r,n,a){p(r,i=>{i._checkOverlaps(n,u=>{a(i,u)})})}o(A,"overlaps");function I(r,n){p(r,a=>{a.isClicked()&&n(a)})}o(I,"clicks");function M(r,n){return new Promise(a=>{let i=g();i.timers[i.lastTimerID++]={time:r,cb:()=>{n&&n(),a(null)}}})}o(M,"wait");function q(r,n){let a=!1,i=o(()=>{a||(n(),M(r,i))},"newF");return i(),{stop(){a=!0}}}o(q,"loop");function R(r,n,a){if(Array.isArray(n))for(let i of n)R(r,i,a);else g().events[r].push({key:n,cb:a})}o(R,"pushKeyEvent");function z(r,n){R("keyDown",r,n)}o(z,"keyDown");function N(r,n){R("keyPress",r,n)}o(N,"keyPress");function K(r,n){R("keyPressRep",r,n)}o(K,"keyPressRep");function J(r,n){R("keyRelease",r,n)}o(J,"keyRelease");function pe(r){g().events.charInput.push({cb:r})}o(pe,"charInput");function Pe(r){g().events.mouseDown.push({cb:r})}o(Pe,"mouseDown");function Ge(r){g().events.mouseClick.push({cb:r})}o(Ge,"mouseClick");function ce(r){g().events.mouseRelease.push({cb:r})}o(ce,"mouseRelease");function de(r){let a=[...g().objs.values()];return r?a.filter(i=>i.is(r)):a}o(de,"get");function ae(r,n){typeof r=="function"&&n===void 0?de().forEach(r):typeof r=="string"&&de(r).forEach(n)}o(ae,"every");function se(r,n){typeof r=="function"&&n===void 0?de().reverse().forEach(r):typeof r=="string"&&de(r).reverse().forEach(n)}o(se,"revery");function we(r){if(!r.exists())return;let n=g();!n||(r.trigger("destroy"),n.objs.delete(r._sceneID),delete r._sceneID)}o(we,"destroy");function Be(r){ae(r,n=>{we(n)})}o(Be,"destroyAll");function Re(r){let n=g();return r!==void 0&&(n.gravity=r),n.gravity}o(Re,"gravity");function Le(r){let n=g();if(!n)throw new Error(`scene not found: '${E.curScene}'`);let a=r||!B.paused;if(a)for(let f in n.timers){let x=n.timers[f];x.time-=t.dt(),x.time<=0&&(x.cb(),delete n.timers[f])}if(se(f=>{!f.paused&&a&&f.trigger("update")}),a)for(let f of n.action)f();let i=m(s.width(),s.height()),u=n.cam,l=rt(_e(0,Math.PI*2)).scale(u.shake);u.shake=Ae(u.shake,0,5*t.dt());let d=W().translate(i.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(i.scale(-.5)).translate(u.pos.scale(-1).add(i.scale(.5)).add(l));u.mpos=d.invert().multVec2(_()),ae(f=>{f.hidden||(s.pushTransform(),u.ignore.includes(f.layer)||s.pushMatrix(d),f.trigger("draw"),s.popTransform())});for(let f of n.render)f()}o(Le,"gameFrame");function Ce(){let r=g();for(let n of r.events.charInput)t.charInputted().forEach(n.cb);for(let n of r.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of r.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of r.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of r.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of r.events.mouseDown)t.mouseDown()&&n.cb();for(let n of r.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of r.events.mouseRelease)t.mouseReleased()&&n.cb()}o(Ce,"handleEvents");function ze(r,...n){t.run(()=>{if(s.frameStart(),E.loaded){try{if(!g())throw new Error(`scene not found: '${E.curScene}'`);Ce(),Le()}catch(a){C.error(a.stack),t.quit()}E.nextScene&&($.apply(null,[E.nextScene.name,...E.nextScene.args]),E.nextScene=null)}else{let a=b.loadProgress();if(a===1)E.loaded=!0,$(r,...n),G&&G.connect().catch(C.error);else{let i=s.width()/2,u=12,l=m(s.width()/2,s.height()/2).sub(m(i/2,u/2));s.drawRectStroke(l,i,u,{width:2}),s.drawRect(l,i*a,u)}}B.showLog&&C.draw(),s.frameEnd()})}o(ze,"start");function Ie(...r){return{pos:m(...r),move(...n){let a=m(...n),i=a.x*t.dt(),u=a.y*t.dt();this.pos.x+=i,this.pos.y+=u},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}o(Ie,"pos");function qt(...r){return{scale:m(...r),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}o(qt,"scale");function Nt(r){return{angle:r}}o(Nt,"rotate");function Ot(...r){return{color:U(...r)}}o(Ot,"color");function Bt(r){return{origin:r}}o(Bt,"origin");function zt(r){return{layer:r,inspect(){var a;let n=g();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}o(zt,"layer");function je(r,n){var i,u;let a=g();return((i=r.layer)!=null?i:a.defLayer)===((u=n.layer)!=null?u:a.defLayer)}o(je,"isSameLayer");function $e(r,n){let a={},i={};return{area:{p1:r,p2:n},draw(){var Me,qe,Qe,Ke;if(!B.inspect)return;let u=b.defFont(),l=2,d=U(0,1,1,1),f=this.isHovered();f&&(l+=2);let x=this._worldArea(),j=x.p2.x-x.p1.x,ie=x.p2.y-x.p1.y;s.drawRectStroke(x.p1,j,ie,{width:l/((Me=e.scale)!=null?Me:1),color:d,z:.9});let me=_((qe=this.layer)!=null?qe:g().defLayer);if(f){let Ne=m(6,6).scale(1/((Qe=e.scale)!=null?Qe:1)),be=0,Te=0,Ze=[],Je=o(he=>{var Ee;let fe=s.fmtText(he,u,{size:12/((Ee=e.scale)!=null?Ee:1),pos:me.add(m(Ne.x,Ne.y+Te)),z:1});Ze.push(fe),be=fe.width>be?fe.width:be,Te+=fe.height},"addLine");for(let he of this._tags)Je(`"${he}"`);for(let he of this._events.inspect){let fe=he();for(let Ee in fe)Je(`${Ee}: ${fe[Ee]}`)}be+=Ne.x*2,Te+=Ne.y*2,s.drawRect(me,be,Te,{color:U(0,0,0,1),z:1}),s.drawRectStroke(me,be,Te,{width:(l-2)/((Ke=e.scale)!=null?Ke:1),color:U(0,1,1,1),z:1});for(let he of Ze)s.drawFmtText(he)}},areaWidth(){let{p1:u,p2:l}=this._worldArea();return l.x-u.x},areaHeight(){let{p1:u,p2:l}=this._worldArea();return l.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){var u;return this.hasPt(_((u=this.layer)!=null?u:g().defLayer))},isCollided(u){if(!u.area||!je(this,u))return!1;let l=this._worldArea(),d=u._worldArea();return He(l,d)},isOverlapped(u){if(!u.area||!je(this,u))return!1;let l=this._worldArea(),d=u._worldArea();return ht(l,d)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,l){this.action(()=>{this._checkCollisions(u,l)})},overlaps(u,l){this.action(()=>{this._checkOverlaps(u,l)})},hasPt(u){let l=this._worldArea();return ft({p1:l.p1,p2:l.p2},u)},resolve(){let u=[];return ae(l=>{if(l===this||!l.solid||!l.area||!je(this,l))return;let d=this._worldArea(),f=l._worldArea();if(!He(d,f))return;let x=d.p2.x-f.p1.x,j=f.p2.x-d.p1.x,ie=d.p2.y-f.p1.y,me=f.p2.y-d.p1.y,Me=Math.min(x,j,ie,me),qe=(()=>{switch(Me){case x:return this.pos.x-=x,"right";case j:return this.pos.x+=j,"left";case ie:return this.pos.y-=ie,"bottom";case me:return this.pos.y+=me,"top"}})();u.push({obj:l,side:qe})}),u},_checkCollisions(u,l){ae(u,d=>{this!==d&&(a[d._sceneID]||this.isCollided(d)&&(l(d),a[d._sceneID]=d))});for(let d in a){let f=a[d];this.isCollided(f)||delete a[d]}},_checkOverlaps(u,l){ae(u,d=>{this!==d&&(i[d._sceneID]||this.isOverlapped(d)&&(l(d),i[d._sceneID]=d))});for(let d in i){let f=i[d];this.isOverlapped(f)||delete i[d]}},_worldArea(){let u=this.area,l=this.pos||m(0),d=this.scale||m(1),f=l.add(u.p1.dot(d)),x=l.add(u.p2.dot(d));return{p1:m(Math.min(f.x,x.x),Math.min(f.y,x.y)),p2:m(Math.max(f.x,x.x),Math.max(f.y,x.y))}}}}o($e,"area");function Fe(r,n,a){let i=m(r,n),u=ke(a||k).dot(i).scale(-.5);return $e(u.sub(i.scale(.5)),u.add(i.scale(.5)))}o(Fe,"getAreaFromSize");function jt(r,n={}){let a=b.sprites[r];if(!a)throw new Error(`sprite not found: "${r}"`);let i=te({},a.frames[0]);n.quad&&(i.x+=n.quad.x*i.w,i.y+=n.quad.y*i.h,i.w*=n.quad.w,i.h*=n.quad.h);let u=a.tex.width*i.w,l=a.tex.height*i.h,d=null;return{width:u,height:l,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||re(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var j;let f=g(),x=a.frames[this.frame];T(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,z:f.layers[(j=this.layer)!=null?j:f.defLayer]})},update(){if(!d)return;let f=a.anims[d.name];d.timer+=t.dt(),d.timer>=this.animSpeed&&(this.frame++,this.frame>f.to&&(d.loop?this.frame=f.from:(this.frame--,this.stop())),d.timer-=this.animSpeed)},play(f,x=!0){let j=a.anims[f];if(!j)throw new Error(`anim not found: ${f}`);d&&this.stop(),d={name:f,loop:x,timer:0},this.frame=j.from,this.trigger("animPlay",f)},stop(){if(!d)return;let f=d.name;d=null,this.trigger("animEnd",f)},changeSprite(f){if(a=b.sprites[f],!a)throw new Error(`sprite not found: "${f}"`);let x=te({},a.frames[0]);n.quad&&(x.x+=n.quad.x*x.w,x.y+=n.quad.y*x.h,x.w*=n.quad.w,x.h*=n.quad.h),this.width=a.tex.width*x.w,this.height=a.tex.height*x.h,this.area&&!n.noArea&&this.use(Fe(this.width,this.height,this.origin)),d=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return d==null?void 0:d.name},inspect(){let f={};return d&&(f.curAnim=`"${d.name}"`),f}}}o(jt,"sprite");function Ut(r,n,a={}){return{text:r,textSize:n,font:a.font,width:0,height:0,add(){var i,u,l,d;if(!this.area&&!a.noArea){let f=g(),x=b.fonts[(i=this.font)!=null?i:ge],j=s.fmtText(this.text+"",x,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:f.layers[(u=this.layer)!=null?u:f.defLayer]});this.width=j.width/(((l=this.scale)==null?void 0:l.x)||1),this.height=j.height/(((d=this.scale)==null?void 0:d.y)||1),this.use(Fe(this.width,this.height,this.origin))}},draw(){var d,f;let i=g(),u=b.fonts[(d=this.font)!=null?d:ge],l=s.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:i.layers[(f=this.layer)!=null?f:i.defLayer]});this.width=l.width,this.height=l.height,s.drawFmtText(l)}}}o(Ut,"text");function Yt(r,n,a={}){return{width:r,height:n,add(){!this.area&&!a.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var u;let i=g();s.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:i.layers[(u=this.layer)!=null?u:i.defLayer]})}}}o(Yt,"rect");function Ht(){return{solid:!0}}o(Ht,"solid");let Xt=960,$t=480;function Wt(r={}){var u,l;let n=0,a=null,i=(u=r.maxVel)!=null?u:Xt;return{jumpForce:(l=r.jumpForce)!=null?l:$t,update(){this.move(0,n);let d=this.resolve(),f=!1;if(a&&(!a.exists()||!this.isCollided(a))&&(a=null,f=!0),!a){n=Math.min(n+Re()*t.dt(),i);for(let x of d)x.side==="bottom"&&n>0?(a=x.obj,n=0,f||this.trigger("grounded",a)):x.side==="top"&&n<0&&(n=0,this.trigger("headbump",x.obj))}},curPlatform(){return a},grounded(){return a!==null},jump(d){a=null,n=-d||-this.jumpForce}}}o(Wt,"body");let B={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return g().objs.size},stepFrame(){Le(!0)},clearLog:C.clear,log:C.info,error:C.error};function Qt(r,n){let a=[],i=m(n.pos),u=0,l={getPos(...d){let f=m(...d);return m(i.x+f.x*n.width,i.y+f.y*n.height)},spawn(d,f){let x=(()=>{if(Array.isArray(d))return d;if(n[d]){if(typeof n[d]=="function")return n[d]();if(Array.isArray(n[d]))return[...n[d]]}else if(n.any)return n.any(d)})();if(x){x.push(Ie(i.x+f.x*n.width,i.y+f.y*n.height));let j=xe(x);a.push(j),j.use({gridPos:f.clone(),setGridPos(ie){this.gridPos=ie.clone(),this.pos=m(i.x+this.gridPos.x*n.width,i.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(m(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(m(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(m(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(m(0,1)))}})}},width(){return u*n.width},height(){return r.length*n.height},destroy(){for(let d of a)we(d)}};return r.forEach((d,f)=>{let x=d.split("");u=Math.max(x.length,u),x.forEach((j,ie)=>{l.spawn(j,m(ie,f))})}),l}o(Qt,"addLevel");let Se={start:ze,loadRoot:b.loadRoot,loadSprite:b.loadSprite,loadSound:b.loadSound,loadFont:b.loadFont,addLoader:b.addLoader,width:s.width,height:s.height,dt:t.dt,time:t.time,screenshot:t.screenshot,scene:V,go:X,sceneData:Y,layers:L,camPos:Q,camScale:ee,camRot:oe,camShake:Z,camIgnore:Ve,gravity:Re,add:xe,readd:ve,destroy:we,destroyAll:Be,get:de,every:ae,revery:se,send:O,recv:S,pos:Ie,scale:qt,rotate:Nt,color:Ot,origin:Bt,layer:zt,area:$e,sprite:jt,text:Ut,rect:Yt,solid:Ht,body:Wt,on:h,action:p,render:y,collides:D,overlaps:A,clicks:I,keyDown:z,keyPress:N,keyPressRep:K,keyRelease:J,charInput:pe,mouseDown:Pe,mouseClick:Ge,mouseRelease:ce,mousePos:_,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:q,wait:M,play:F,volume:c.volume,makeRng:Ye,rand:_e,randSeed:ct,vec2:m,rgb:st,rgba:U,quad:re,choose:mt,chance:dt,lerp:Ae,map:De,wave:it,drawSprite:T,drawText:w,drawRect:s.drawRect,drawRectStroke:s.drawRectStroke,drawLine:s.drawLine,debug:B,addLevel:Qt};if(e.plugins)for(let r of e.plugins){let n=r(Se);for(let a in n)Se[a]=n[a]}if(e.global)for(let r in Se)window[r]=Se[r];return Se}});return fn();})();
//# sourceMappingURL=kaboom.js.map
