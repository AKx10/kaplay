var it=Object.defineProperty,Ht=Object.defineProperties;var Wt=Object.getOwnPropertyDescriptors;var ot=Object.getOwnPropertySymbols;var Kt=Object.prototype.hasOwnProperty,Zt=Object.prototype.propertyIsEnumerable;var at=(e,t,i)=>t in e?it(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,de=(e,t)=>{for(var i in t||(t={}))Kt.call(t,i)&&at(e,i,t[i]);if(ot)for(var i of ot(t))Zt.call(t,i)&&at(e,i,t[i]);return e},we=(e,t)=>Ht(e,Wt(t));var s=(e,t)=>it(e,"name",{value:t,configurable:!0});function ct(e){return e*Math.PI/180}s(ct,"deg2rad");function ut(e){return e*180/Math.PI}s(ut,"rad2deg");function ae(e,t,i){return Math.min(Math.max(e,t),i)}s(ae,"clamp");function ke(e,t,i){return e+(t-e)*i}s(ke,"lerp");function ge(e,t,i,o,l){return o+(e-t)/(i-t)*(l-o)}s(ge,"map");function ht(e,t,i,o,l){return ae(ge(e,t,i,o,l),o,l)}s(ht,"mapc");function d(...e){if(e.length===0)return d(0,0);if(e.length===1){if(typeof e[0]=="number")return d(e[0],e[0]);if(ve(e[0]))return d(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return d.apply(null,e[0])}return{x:e[0],y:e[1],clone(){return d(this.x,this.y)},add(...t){let i=d(...t);return d(this.x+i.x,this.y+i.y)},sub(...t){let i=d(...t);return d(this.x-i.x,this.y-i.y)},scale(t){return d(this.x*t,this.y*t)},dist(...t){let i=d(...t);return Math.sqrt((this.x-i.x)*(this.x-i.x)+(this.y-i.y)*(this.y-i.y))},len(){return this.dist(d(0,0))},unit(){return this.scale(1/this.len())},normal(){return d(this.y,-this.x)},dot(...t){let i=d(...t);return d(this.x*i.x,this.y*i.y)},angle(...t){let i=d(...t);return Math.atan2(this.y-i.y,this.x-i.x)},lerp(t,i){return d(ke(this.x,t.x,i),ke(this.y,t.y,i))},eq(t){return this.x===t.x&&this.y===t.y},str(){return`(${this.x}, ${this.y})`}}}s(d,"vec2");function dt(e){return d(Math.cos(e),Math.sin(e))}s(dt,"vec2FromAngle");function Re(e,t,i){return{x:e,y:t,z:i,xy(){return d(this.x,this.y)}}}s(Re,"vec3");function ve(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}s(ve,"isVec2");function ft(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0&&e.z!==void 0}s(ft,"isVec3");function pe(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}s(pe,"isColor");function lt(e){if(e!==void 0&&Array.isArray(e.m)&&e.m.length===16)return e}s(lt,"isMat4");function Ne(...e){if(e.length===0)return j();if(e.length===1){if(pe(e[0]))return j(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Ne.apply(null,e[0])}return j(e[0],e[1],e[2],1)}s(Ne,"rgb");function j(...e){var t;if(e.length===0)return j(1,1,1,1);if(e.length===1){if(pe(e[0]))return j(e[0].r,e[0].g,e[0].b,e[0].a);if(Array.isArray(e[0])&&e[0].length===4)return j.apply(null,e[0])}return{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return j(this.r,this.g,this.b,this.a)},lighten(i){return j(this.r+i,this.g+i,this.b+i,this.a)},darken(i){return this.lighten(-i)},invert(){return j(1-this.r,1-this.g,1-this.b,this.a)},isDark(i=.5){return this.r+this.g+this.b<3*i},isLight(i=.5){return this.r+this.g+this.b>3*i},eq(i){return this.r===i.r&&this.g===i.g&&this.b===i.g&&this.a===i.a}}}s(j,"rgba");function te(e,t,i,o){return{x:e,y:t,w:i,h:o,clone(){return te(this.x,this.y,this.w,this.h)},eq(l){return this.x===l.x&&this.y===l.y&&this.w===l.w&&this.h===l.h}}}s(te,"quad");function Z(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return Z(this.m)},mult(t){let i=[];for(let o=0;o<4;o++)for(let l=0;l<4;l++)i[o*4+l]=this.m[0*4+l]*t.m[o*4+0]+this.m[1*4+l]*t.m[o*4+1]+this.m[2*4+l]*t.m[o*4+2]+this.m[3*4+l]*t.m[o*4+3];return Z(i)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let i=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return Re(i.x,i.y,i.z)},multVec2(t){return d(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(Z([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(Z([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(Z([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(Z([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(Z([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],i=this.m[10]*this.m[15]-this.m[14]*this.m[11],o=this.m[9]*this.m[15]-this.m[13]*this.m[11],l=this.m[9]*this.m[14]-this.m[13]*this.m[10],v=this.m[8]*this.m[15]-this.m[12]*this.m[11],k=this.m[8]*this.m[14]-this.m[12]*this.m[10],_=this.m[8]*this.m[13]-this.m[12]*this.m[9],X=this.m[6]*this.m[15]-this.m[14]*this.m[7],P=this.m[5]*this.m[15]-this.m[13]*this.m[7],L=this.m[5]*this.m[14]-this.m[13]*this.m[6],U=this.m[4]*this.m[15]-this.m[12]*this.m[7],A=this.m[4]*this.m[14]-this.m[12]*this.m[6],R=this.m[5]*this.m[15]-this.m[13]*this.m[7],E=this.m[4]*this.m[13]-this.m[12]*this.m[5],q=this.m[6]*this.m[11]-this.m[10]*this.m[7],S=this.m[5]*this.m[11]-this.m[9]*this.m[7],$=this.m[5]*this.m[10]-this.m[9]*this.m[6],b=this.m[4]*this.m[11]-this.m[8]*this.m[7],N=this.m[4]*this.m[10]-this.m[8]*this.m[6],Y=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*i-this.m[6]*o+this.m[7]*l,t[4]=-(this.m[4]*i-this.m[6]*v+this.m[7]*k),t[8]=this.m[4]*o-this.m[5]*v+this.m[7]*_,t[12]=-(this.m[4]*l-this.m[5]*k+this.m[6]*_),t[1]=-(this.m[1]*i-this.m[2]*o+this.m[3]*l),t[5]=this.m[0]*i-this.m[2]*v+this.m[3]*k,t[9]=-(this.m[0]*o-this.m[1]*v+this.m[3]*_),t[13]=this.m[0]*l-this.m[1]*k+this.m[2]*_,t[2]=this.m[1]*X-this.m[2]*P+this.m[3]*L,t[6]=-(this.m[0]*X-this.m[2]*U+this.m[3]*A),t[10]=this.m[0]*R-this.m[1]*U+this.m[3]*E,t[14]=-(this.m[0]*L-this.m[1]*A+this.m[2]*E),t[3]=-(this.m[1]*q-this.m[2]*S+this.m[3]*$),t[7]=this.m[0]*q-this.m[2]*b+this.m[3]*N,t[11]=-(this.m[0]*S-this.m[1]*b+this.m[3]*Y),t[15]=this.m[0]*$-this.m[1]*N+this.m[2]*Y;let z=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let I=0;I<4;I++)for(let w=0;w<4;w++)t[I*4+w]*=1/z;return Z(t)}}}s(Z,"mat4");function mt(e,t,i){return e+(Math.sin(i)+1)/2*(t-e)}s(mt,"wave");var Qt=1103515245,Jt=12345,pt=2147483648,yt=He(Date.now());function He(e){return{seed:e,gen(...t){if(t.length===0)return this.seed=(Qt*this.seed+Jt)%pt,this.seed/pt;if(t.length===1){if(typeof t[0]=="number")return this.gen(0,t[0]);if(ve(t[0]))return this.gen(d(0,0),t[0]);if(pe(t[0]))return this.gen(j(0,0,0,0),t[0])}else if(t.length===2){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.gen()*(t[1]-t[0])+t[0];if(ve(t[0])&&ve(t[1]))return d(this.gen(t[0].x,t[1].x),this.gen(t[0].y,t[1].y));if(pe(t[0])&&pe(t[1]))return j(this.gen(t[0].r,t[1].r),this.gen(t[0].g,t[1].g),this.gen(t[0].b,t[1].b),this.gen(t[0].a,t[1].a))}}}}s(He,"makeRng");function bt(e){yt.seed=e}s(bt,"randSeed");function Pe(...e){return yt.gen(...e)}s(Pe,"rand");function xt(e){return Pe()<=e}s(xt,"chance");function wt(e){return e[Math.floor(Pe(e.length))]}s(wt,"choose");function We(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}s(We,"colRectRect");function gt(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}s(gt,"overlapRectRect");function vt(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}s(vt,"colRectPt");function Ke(e,t){let i=typeof e,o=typeof t;if(i!==o)return!1;if(i==="object"&&o==="object"){let l=Object.keys(e),v=Object.keys(t);if(l.length!==v.length)return!1;for(let k of l){let _=e[k],X=t[k];if(!(typeof _=="function"&&typeof X=="function")&&!Ke(_,X))return!1}return!0}return e===t}s(Ke,"deepEq");var Ze="topleft",De=9,Be=65536,Rt=64,en=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,tn=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Qe=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Je=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;function Fe(e){switch(e){case"topleft":return d(-1,-1);case"top":return d(0,-1);case"topright":return d(1,-1);case"left":return d(-1,0);case"center":return d(0,0);case"right":return d(1,0);case"botleft":return d(-1,1);case"bot":return d(0,1);case"botright":return d(1,1);default:return e}}s(Fe,"originPt");function _t(e,t){let i=(()=>{switch(t.texFilter){case"linear":return e.LINEAR;case"nearest":return e.NEAREST;default:return e.NEAREST}})(),o=(()=>{var B;let f=k(Qe,Je),x=v(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),p=(B=t.clearColor)!=null?B:j(0,0,0,1);e.clearColor(p.r,p.g,p.b,p.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);let D=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,D),e.bufferData(e.ARRAY_BUFFER,Be*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let O=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,O),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Be*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let V=v(new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2));return{drawCalls:0,lastDrawCalls:0,defProg:f,curProg:f,defTex:x,curTex:x,curUniform:{},vbuf:D,ibuf:O,vqueue:[],iqueue:[],transform:Z(),transformStack:[],clearColor:p,bgTex:V}})();function l(f){return Math.log(f)/Math.log(2)%1==0}s(l,"powerOfTwo");function v(f){let x=e.createTexture();e.bindTexture(e.TEXTURE_2D,x),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i);let p=(()=>l(f.width)&&l(f.height)?e.REPEAT:e.CLAMP_TO_EDGE)();return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,p),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,p),e.bindTexture(e.TEXTURE_2D,null),{width:f.width,height:f.height,bind(){e.bindTexture(e.TEXTURE_2D,x)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}s(v,"makeTex");function k(f=Qe,x=Je){let p,D=en.replace("{{user}}",f!=null?f:Qe),O=tn.replace("{{user}}",x!=null?x:Je),V=e.createShader(e.VERTEX_SHADER),B=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(V,D),e.shaderSource(B,O),e.compileShader(V),e.compileShader(B),p=e.getShaderInfoLog(V))throw new Error(p);if(p=e.getShaderInfoLog(B))throw new Error(p);let C=e.createProgram();if(e.attachShader(C,V),e.attachShader(C,B),e.bindAttribLocation(C,0,"a_pos"),e.bindAttribLocation(C,1,"a_uv"),e.bindAttribLocation(C,2,"a_color"),e.linkProgram(C),(p=e.getProgramInfoLog(C))&&p!==`
`)throw new Error(p);return{bind(){e.useProgram(C)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,De*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,De*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,De*4,20),e.enableVertexAttribArray(2)},send(T){this.bind();for(let W in T){let F=T[W],K=e.getUniformLocation(C,W);typeof F=="number"?e.uniform1f(K,F):lt(F)?e.uniformMatrix4fv(K,!1,new Float32Array(F.m)):pe(F)?e.uniform4f(K,F.r,F.g,F.b,F.a):ft(F)?e.uniform3f(K,F.x,F.y,F.z):ve(F)&&e.uniform2f(K,F.x,F.y)}this.unbind()}}}s(k,"makeProgram");function _(f,x,p,D){let O=f.width/x,V=f.height/p,B=1/O,C=1/V,T={},W=D.split("").entries();for(let[F,K]of W)T[K]=d(F%O*B,Math.floor(F/O)*C);return{tex:f,map:T,qw:B,qh:C}}s(_,"makeFont");function X(f,x,p=o.defTex,D=o.defProg,O={}){p=p!=null?p:o.defTex,D=D!=null?D:o.defProg,(p!==o.curTex||D!==o.curProg||!Ke(o.curUniform,O)||o.vqueue.length+f.length*De>Be||o.iqueue.length+x.length>Be)&&P(),o.curTex=p,o.curProg=D,o.curUniform=O;let V=x.map(C=>C+o.vqueue.length/De),B=f.map(C=>{let T=R(o.transform.multVec2(C.pos.xy()));return[T.x,T.y,C.pos.z,C.uv.x,C.uv.y,C.color.r,C.color.g,C.color.b,C.color.a]}).flat();V.forEach(C=>o.iqueue.push(C)),B.forEach(C=>o.vqueue.push(C))}s(X,"drawRaw");function P(){!o.curTex||!o.curProg||o.vqueue.length===0||o.iqueue.length===0||(o.curProg.send(o.curUniform),e.bindBuffer(e.ARRAY_BUFFER,o.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(o.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(o.iqueue)),o.curProg.bind(),o.curProg.bindAttribs(),o.curTex.bind(),e.drawElements(e.TRIANGLES,o.iqueue.length,e.UNSIGNED_SHORT,0),o.curTex.unbind(),o.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),o.iqueue=[],o.vqueue=[],o.drawCalls++)}s(P,"flush");function L(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),t.clearColor||I({width:fe(),height:ye(),quad:te(0,0,fe()*re()/Rt,ye()*re()/Rt),tex:o.bgTex}),o.drawCalls=0,o.transformStack=[],o.transform=Z()}s(L,"frameStart");function U(){P(),o.lastDrawCalls=o.drawCalls}s(U,"frameEnd");function A(){return o.lastDrawCalls}s(A,"drawCalls");function R(f){return d(f.x/fe()*2-1,-f.y/ye()*2+1)}s(R,"toNDC");function E(f){o.transform=f.clone()}s(E,"pushMatrix");function q(f){!f||f.x===0&&f.y===0||(o.transform=o.transform.translate(f))}s(q,"pushTranslate");function S(f){!f||f.x===1&&f.y===1||(o.transform=o.transform.scale(f))}s(S,"pushScale");function $(f){!f||(o.transform=o.transform.rotateX(f))}s($,"pushRotateX");function b(f){!f||(o.transform=o.transform.rotateY(f))}s(b,"pushRotateY");function N(f){!f||(o.transform=o.transform.rotateZ(f))}s(N,"pushRotateZ");function Y(){o.transformStack.push(o.transform.clone())}s(Y,"pushTransform");function z(){o.transformStack.length>0&&(o.transform=o.transformStack.pop())}s(z,"popTransform");function I(f={}){var K,ee;let x=f.width||0,p=f.height||0,D=f.pos||d(0,0),V=Fe(f.origin||Ze).dot(d(x,p).scale(-.5)),B=d((K=f.scale)!=null?K:1),C=f.rot||0,T=f.quad||te(0,0,1,1),W=1-((ee=f.z)!=null?ee:0),F=f.color||j(1,1,1,1);Y(),q(D),S(B),N(C),q(V),X([{pos:Re(-x/2,p/2,W),uv:d(T.x,T.y+T.h),color:F},{pos:Re(-x/2,-p/2,W),uv:d(T.x,T.y),color:F},{pos:Re(x/2,-p/2,W),uv:d(T.x+T.w,T.y),color:F},{pos:Re(x/2,p/2,W),uv:d(T.x+T.w,T.y+T.h),color:F}],[0,1,3,1,2,3],f.tex,f.prog,f.uniform),z()}s(I,"drawQuad");function w(f,x={}){var V;let p=(V=x.quad)!=null?V:te(0,0,1,1),D=f.width*p.w,O=f.height*p.h;I(we(de({},x),{tex:f,quad:p,width:D,height:O}))}s(w,"drawTexture");function G(f,x,p,D={}){I(we(de({},D),{pos:f,width:x,height:p}))}s(G,"drawRect");function ce(f,x,p,D={}){let O=Fe(D.origin||Ze).dot(d(x,p)).scale(.5),V=f.add(d(-x/2,-p/2)).sub(O),B=f.add(d(-x/2,p/2)).sub(O),C=f.add(d(x/2,p/2)).sub(O),T=f.add(d(x/2,-p/2)).sub(O);Q(V,B,D),Q(B,C,D),Q(C,T,D),Q(T,V,D)}s(ce,"drawRectStroke");function Q(f,x,p={}){let D=p.width||1,O=f.dist(x),V=Math.PI/2-f.angle(x);I(we(de({},p),{pos:f.add(x).scale(.5),width:D,height:O,rot:V,origin:"center"}))}s(Q,"drawLine");function ne(f,x,p={}){let D=(f+"").split(""),O=x.qw*x.tex.width,V=x.qh*x.tex.height,B=p.size||V,C=d(B/V).dot(d(p.scale||1)),T=C.x*O,W=C.y*V,F=0,K=W,ee=0,xe=[[]];for(let he of D)(he===`
`||(p.width?F+T>p.width:!1))&&(K+=W,F=0,xe.push([])),he!==`
`&&(xe[xe.length-1].push(he),F+=T),ee=Math.max(ee,F);p.width&&(ee=p.width);let Ie=[],ue=d(p.pos||0),J=Fe(p.origin||Ze).scale(.5),Ee=-J.x*T-(J.x+.5)*(ee-T),Ae=-J.y*W-(J.y+.5)*(K-W);return xe.forEach((he,Me)=>{let Ge=(ee-he.length*T)*(J.x+.5);he.forEach((qe,ze)=>{let Se=x.map[qe],Oe=ze*T,je=Me*W;Se&&Ie.push({tex:x.tex,quad:te(Se.x,Se.y,x.qw,x.qh),ch:qe,pos:d(ue.x+Oe+Ee+Ge,ue.y+je+Ae),color:p.color,origin:p.origin,scale:C,z:p.z})})}),{width:ee,height:K,chars:Ie}}s(ne,"fmtText");function se(f,x,p={}){Le(ne(f,x,p))}s(se,"drawText");function Le(f){for(let x of f.chars)I({tex:x.tex,width:x.tex.width*x.quad.w,height:x.tex.height*x.quad.h,pos:x.pos,scale:x.scale,color:x.color,quad:x.quad,origin:"center",z:x.z})}s(Le,"drawFmtText");function fe(){return e.drawingBufferWidth/re()}s(fe,"width");function ye(){return e.drawingBufferHeight/re()}s(ye,"height");function re(){var f;return(f=t.scale)!=null?f:1}s(re,"scale");function be(){return o.clearColor.clone()}return s(be,"clearColor"),{width:fe,height:ye,scale:re,makeTex:v,makeProgram:k,makeFont:_,drawTexture:w,drawText:se,drawFmtText:Le,drawRect:G,drawRectStroke:ce,drawLine:Q,fmtText:ne,frameStart:L,frameEnd:U,pushTransform:Y,popTransform:z,pushMatrix:E,drawCalls:A,clearColor:be}}s(_t,"gfxInit");function Et(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}s(Et,"processBtnState");function At(e={}){var z,I;let t={canvas:(z=e.canvas)!=null?z:(()=>{var G;let w=document.createElement("canvas");return((G=e.root)!=null?G:document.body).appendChild(w),w})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:d(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(I=e.scale)!=null?I:1,isTouch:!1,loopID:null,stopped:!1},i={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},o=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let l=["outline: none","cursor: default"];e.crisp&&(l.push("image-rendering: pixelated"),l.push("image-rendering: crisp-edges")),t.canvas.style=l.join(";"),t.canvas.setAttribute("tabindex","0");let v=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("mousemove",w=>{t.mousePos=d(w.offsetX,w.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",w=>{let G=i[w.key]||w.key.toLowerCase();o.includes(G)&&w.preventDefault(),G.length===1&&t.charInputted.push(G),G==="space"&&t.charInputted.push(" "),w.repeat?t.keyStates[G]="rpressed":t.keyStates[G]="pressed"}),t.canvas.addEventListener("keyup",w=>{let G=i[w.key]||w.key.toLowerCase();t.keyStates[G]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function k(){return t.mousePos.clone()}s(k,"mousePos");function _(){return t.mouseState==="pressed"}s(_,"mouseClicked");function X(){return t.mouseState==="pressed"||t.mouseState==="down"}s(X,"mouseDown");function P(){return t.mouseState==="released"}s(P,"mouseReleased");function L(w){return t.keyStates[w]==="pressed"}s(L,"keyPressed");function U(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"}s(U,"keyPressedRep");function A(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"||t.keyStates[w]==="down"}s(A,"keyDown");function R(w){return t.keyStates[w]==="released"}s(R,"keyReleased");function E(){return[...t.charInputted]}s(E,"charInputted");function q(){return t.dt}s(q,"dt");function S(){return t.time}s(S,"time");function $(){return t.canvas.toDataURL()}s($,"screenshot");function b(w){return w&&(t.canvas.style.cursor=w!=null?w:"default"),t.canvas.style.cursor}s(b,"cursor");function N(w){let G=s(ce=>{let Q=ce/1e3,ne=Q-t.realTime;t.realTime=Q,t.skipTime||(t.dt=ne,t.time+=t.dt),t.skipTime=!1,w();for(let se in t.keyStates)t.keyStates[se]=Et(t.keyStates[se]);t.mouseState=Et(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(G))},"frame");t.loopID=requestAnimationFrame(G)}s(N,"run");function Y(){cancelAnimationFrame(t.loopID),t.stopped=!0}return s(Y,"quit"),{gl:v,mousePos:k,keyDown:A,keyPressed:L,keyPressedRep:U,keyReleased:R,mouseDown:X,mouseClicked:_,mouseReleased:P,charInputted:E,cursor:b,dt:q,time:S,screenshot:$,run:N,quit:Y}}s(At,"appInit");var St=0,Tt=3,nn=0,sn=3,rn=-1200,on=1200;function Ct(){let e=(()=>{let l=new(window.AudioContext||window.webkitAudioContext),v=l.createGain(),k=v;return k.connect(l.destination),{ctx:l,gainNode:v,masterNode:k}})();function t(l){return l!==void 0&&(e.gainNode.gain.value=ae(l,St,Tt)),e.gainNode.gain.value}s(t,"volume");function i(l,v={loop:!1,volume:1,speed:1,detune:0,seek:0}){var R;let k=!1,_=e.ctx.createBufferSource();_.buffer=l,_.loop=!!v.loop;let X=e.ctx.createGain();_.connect(X),X.connect(e.masterNode);let P=(R=v.seek)!=null?R:0;_.start(0,P);let L=e.ctx.currentTime-P,U=null,A={stop(){this.pause(),L=e.ctx.currentTime},play(E){if(!k)return;let q=_;_=e.ctx.createBufferSource(),_.buffer=q.buffer,_.loop=q.loop,_.playbackRate.value=q.playbackRate.value,_.detune&&(_.detune.value=q.detune.value),_.connect(X);let S=E!=null?E:this.time();_.start(0,S),L=e.ctx.currentTime-S,k=!1,U=null},pause(){_.stop(),k=!0,U=e.ctx.currentTime},paused(){return k},stopped(){return k},speed(E){return E!==void 0&&(_.playbackRate.value=ae(E,nn,sn)),_.playbackRate.value},detune(E){return _.detune?(E!==void 0&&(_.detune.value=ae(E,rn,on)),_.detune.value):0},volume(E){return E!==void 0&&(X.gain.value=ae(E,St,Tt)),X.gain.value},loop(){_.loop=!0},unloop(){_.loop=!1},duration(){return l.duration},time(){return k&&U?U-L:e.ctx.currentTime-L}};return A.speed(v.speed),A.detune(v.detune),A.volume(v.volume),A}s(i,"play");function o(){return e.ctx}return s(o,"ctx"),{ctx:o,volume:t,play:i}}s(Ct,"audioInit");var kt="data:image/png;base64,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";var cn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",_e="unscii";function Pt(e){let t=new Image;return t.src=e,t.crossOrigin="anonymous",new Promise((i,o)=>{t.onload=()=>{i(t)},t.onerror=()=>{o(`failed to load ${e}`)}})}s(Pt,"loadImg");function Dt(e){return e.startsWith("data:")}s(Dt,"isDataUrl");function Ft(e,t,i={}){let o={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function l(A){var E;let R=o.lastLoaderID;o.loaders[R]=!1,o.lastLoaderID++,A.catch((E=i.errHandler)!=null?E:console.error).finally(()=>{o.loaders[R]=!0})}s(l,"addLoader");function v(){let A=0,R=0;for(let E in o.loaders)A+=1,o.loaders[E]&&(R+=1);return R/A}s(v,"loadProgress");function k(A){return A&&(o.loadRoot=A),o.loadRoot}s(k,"loadRoot");function _(A,R,E,q,S=cn){let $=new Promise((b,N)=>{let Y=Dt(R)?R:o.loadRoot+R;Pt(Y).then(z=>{let I=e.makeFont(e.makeTex(z),E,q,S);o.fonts[A]=I,b(I)}).catch(N)});return l($),$}s(_,"loadFont");function X(A,R,E={sliceX:1,sliceY:1,anims:{}}){function q($,b,N={sliceX:1,sliceY:1,anims:{}}){let Y=[],z=e.makeTex(b),I=N.sliceX||1,w=N.sliceY||1,G=1/I,ce=1/w;for(let ne=0;ne<w;ne++)for(let se=0;se<I;se++)Y.push(te(se*G,ne*ce,G,ce));let Q={tex:z,frames:Y,anims:N.anims||{}};return o.sprites[$]=Q,Q}s(q,"loadRawSprite");let S=new Promise(($,b)=>{if(!R)return b(`expected sprite src for "${A}"`);if(typeof R=="string"){let N=Dt(R)?R:o.loadRoot+R;Pt(N).then(Y=>{$(q(A,Y,E))}).catch(b)}else $(q(A,R,E))});return l(S),S}s(X,"loadSprite");function P(A,R,E,q=!1){function S(b,N,Y){let z=e.makeProgram(N,Y);return o.shaders[b]=z,z}s(S,"loadRawShader");let $=new Promise((b,N)=>{if(!R&&!E)return N("no shader");function Y(z){return z?fetch(o.loadRoot+z).then(I=>{if(I.ok)return I.text();throw new Error(`failed to load ${z}`)}).catch(N):new Promise(I=>I(null))}if(s(Y,"resolveUrl"),q)Promise.all([Y(R),Y(E)]).then(([z,I])=>{b(S(A,z,I))}).catch(N);else try{b(S(A,R,E))}catch(z){N(z)}});return l($),$}s(P,"loadShader");function L(A,R){let E=o.loadRoot+R,q=new Promise((S,$)=>{if(!R)return $(`expected sound src for "${A}"`);typeof R=="string"&&fetch(E).then(b=>{if(b.ok)return b.arrayBuffer();throw new Error(`failed to load ${E}`)}).then(b=>new Promise((N,Y)=>{t.ctx().decodeAudioData(b,N,Y)})).then(b=>{o.sounds[A]=b,S(b)}).catch($)});return l(q),q}s(L,"loadSound");function U(){return o.fonts[_e]}return s(U,"defFont"),_(_e,kt,8,8),{loadRoot:k,loadSprite:X,loadSound:L,loadFont:_,loadShader:P,loadProgress:v,addLoader:l,defFont:U,sprites:o.sprites,fonts:o.fonts,sounds:o.sounds,shaders:o.shaders}}s(Ft,"assetsInit");var un=16;function Lt(e,t,i={max:8}){var P;let o=[],l=(P=i.max)!=null?P:8;function v(){o.length>l&&(o=o.slice(0,l));let L=d(0,e.height());o.forEach((U,A)=>{let R=ge(A,0,l,1,.2),E=ge(A,0,l,.8,.2),q=(()=>{switch(U.type){case"info":return j(1,1,1,R);case"error":return j(1,0,.5,R)}})(),S=e.fmtText(U.msg,t.defFont(),{pos:L,origin:"botleft",color:q,z:1,size:un/e.scale(),width:e.width()});e.drawRect(L,S.width,S.height,{origin:"botleft",color:j(0,0,0,E),z:1}),e.drawFmtText(S),L.y-=S.height})}s(v,"draw");function k(L){console.error(L),o.unshift({type:"error",msg:L})}s(k,"error");function _(L){o.unshift({type:"info",msg:L})}s(_,"info");function X(){o=[]}return s(X,"clear"),{info:_,error:k,draw:v,clear:X}}s(Lt,"loggerInit");function It(e){let t={},i=[],o=null;function l(){return o!==null&&o.readyState===1}s(l,"connected");function v(){let P=new WebSocket(e);return new Promise((L,U)=>{P.onopen=()=>{L(P),o=P;for(let A of i)P.send(A)},P.onerror=()=>{U(`failed to connect to ${e}`)},P.onmessage=A=>{let R=JSON.parse(A.data);if(t[R.type])for(let E of t[R.type])E(R.data,R.id)}})}s(v,"connect");function k(P,L){t[P]||(t[P]=[]),t[P].push(L)}s(k,"recv");function _(P,L){let U=JSON.stringify({type:P,data:L});o?o.send(U):i.push(U)}s(_,"send");function X(){o&&o.close()}return s(X,"close"),{connect:v,close:X,connected:l,recv:k,send:_}}s(It,"netInit");module.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{let t=At({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),i=_t(t.gl,{clearColor:e.clearColor?j(e.clearColor):void 0,scale:e.scale,texFilter:e.texFilter}),o=Ct(),l=Ft(i,o,{errHandler:r=>{v.error(r)}}),v=Lt(i,l,{max:e.logMax}),k=(()=>e.connect?It(e.connect):null)();function _(r,n){if(!k)throw new Error("not connected to any websockets");k.recv(r,(a,h)=>{try{n(a,h)}catch(c){v.error(c)}})}s(_,"recv");function X(r,n){if(!k)throw new Error("not connected to any websockets");k.send(r,n)}s(X,"send");function P(){return t.dt()*H.timeScale}s(P,"dt");function L(r,n={}){let a=l.sounds[r];if(!a)throw new Error(`sound not found: "${r}"`);return o.play(a,n)}s(L,"play");function U(r){let n=b();return Object.keys(n.layers).length===0?n.cam.mpos:n.cam.ignore.includes(r!=null?r:n.defLayer)?t.mousePos():n.cam.mpos}s(U,"mousePos");function A(r,n={}){var c;let a=(()=>typeof r=="string"?l.sprites[r]:r)();if(!a)throw new Error(`sprite not found: "${r}"`);let h=a.frames[(c=n.frame)!=null?c:0];i.drawTexture(a.tex,we(de({},n),{quad:h}))}s(A,"drawSprite");function R(r,n={}){var c;let a=(c=n.font)!=null?c:_e,h=l.fonts[a];if(!h)throw new Error(`font not found: ${a}`);i.drawText(r,h,n)}s(R,"drawText");let E=980,q="topleft",S={loaded:!1,scenes:{},curScene:null,nextScene:null};function $(r,n){S.scenes[r]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastObjID:0,timers:{},lastTimerID:0,cam:{pos:d(i.width()/2,i.height()/2),scale:d(1,1),angle:0,shake:0,ignore:[],mpos:d(0),matrix:Z()},layers:{},defLayer:null,gravity:E,data:{}}}s($,"scene");function b(){return S.scenes[S.curScene]}s(b,"curScene");function N(){return b().data}s(N,"sceneData");function Y(){T("`",()=>{H.showLog=!H.showLog,v.info(`show log: ${H.showLog?"on":"off"}`)}),T("f1",()=>{H.inspect=!H.inspect,v.info(`inspect: ${H.inspect?"on":"off"}`)}),T("f2",()=>{H.clearLog()}),T("f8",()=>{H.paused=!H.paused,v.info(`${H.paused?"paused":"unpaused"}`)}),T("f7",()=>{H.timeScale=ae(H.timeScale-.2,0,2),v.info(`time scale: ${H.timeScale.toFixed(1)}`)}),T("f9",()=>{H.timeScale=ae(H.timeScale+.2,0,2),v.info(`time scale: ${H.timeScale.toFixed(1)}`)}),T("f10",()=>{H.stepFrame(),v.info("stepped frame")})}s(Y,"regDebugInputs");function z(r,...n){S.nextScene={name:r,args:[...n]}}s(z,"go");function I(r,...n){w(r),S.curScene=r;let a=S.scenes[r];if(!a)throw new Error(`scene not found: '${r}'`);if(!a.initialized){try{a.init(...n)}catch(h){v.error(h.stack)}e.debug&&Y(),a.initialized=!0}}s(I,"goSync");function w(r){if(!S.scenes[r])throw new Error(`scene not found: '${r}'`);$(r,S.scenes[r].init)}s(w,"reload");function G(r,n){let a=b();if(!a)return;let h=.5/r.length;r.forEach((c,m)=>{a.layers[c]=.5+h*m}),n&&(a.defLayer=n)}s(G,"layers");function ce(...r){let n=b().cam;return r.length>0&&(n.pos=d(...r)),n.pos.clone()}s(ce,"camPos");function Q(...r){let n=b().cam;return r.length>0&&(n.scale=d(...r)),n.scale.clone()}s(Q,"camScale");function ne(r){let n=b().cam;return r!==void 0&&(n.angle=r),n.angle}s(ne,"camRot");function se(r){let n=b().cam;n.shake=r}s(se,"camShake");function Le(r){let n=b().cam;n.ignore=r}s(Le,"camIgnore");function fe(r){let n={hidden:!1,paused:!1,_tags:[],_id:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(c){if(c===void 0)return;let m=typeof c;if(m==="string"){this._tags.push(c);return}if(m!=="object")throw new Error(`invalid comp type: ${m}`);if(Array.isArray(c)){for(let u of c)this.use(u);return}for(let u in c){if(typeof c[u]=="function"){this._events[u]?this._events[u].push(c[u].bind(this)):this[u]=c[u].bind(this);continue}this[u]=c[u]}},exists(){return this._id!==void 0},is(c){if(c==="*")return!0;if(Array.isArray(c)){for(let m of c)if(!this._tags.includes(m))return!1;return!0}return this._tags.includes(c)},on(c,m){this._events[c]||(this._events[c]=[]),this._events[c].push(m)},action(c){this.on("update",c)},trigger(c,...m){if(this._events[c])for(let g of this._events[c])g.call(this,...m);let y=b().events[c];if(y)for(let g of y)this.is(g.tag)&&g.cb(this,...m)},rmTag(c){let m=this._tags.indexOf(c);m>-1&&this._tags.splice(m,1)}};n.use(r);let a=b(),h=a.lastObjID++;a.objs.set(h,n),n._id=h,n.trigger("add");for(let c of a.events.add)n.is(c.tag)&&c.cb(n);return n}s(fe,"add");function ye(r){if(!r.exists())return;let n=b();n.objs.delete(r._id);let a=n.lastObjID++;return n.objs.set(a,r),r._id=a,r}s(ye,"readd");function re(r,n,a){let h=b();h.events[r]||(h.events[r]=[]),h.events[r].push({tag:n,cb:a})}s(re,"on");function be(r,n){typeof r=="function"&&n===void 0?b().action.push(r):typeof r=="string"&&re("update",r,n)}s(be,"action");function f(r,n){typeof r=="function"&&n===void 0?b().render.push(r):typeof r=="string"&&re("update",r,n)}s(f,"render");function x(r,n,a){be(r,h=>{h._checkCollisions(n,c=>{a(h,c)})})}s(x,"collides");function p(r,n,a){be(r,h=>{h._checkOverlaps(n,c=>{a(h,c)})})}s(p,"overlaps");function D(r,n){be(r,a=>{a.isClicked()&&n(a)})}s(D,"clicks");function O(r,n){return new Promise(a=>{let h=b();h.timers[h.lastTimerID++]={time:r,cb:()=>{n&&n(),a()}}})}s(O,"wait");function V(r,n){let a=!1,h=s(()=>{a||(n(),O(r,h))},"newF");return h(),{stop(){a=!0}}}s(V,"loop");function B(r,n,a){if(Array.isArray(n))for(let h of n)B(r,h,a);else b().events[r].push({key:n,cb:a})}s(B,"pushKeyEvent");function C(r,n){B("keyDown",r,n)}s(C,"keyDown");function T(r,n){B("keyPress",r,n)}s(T,"keyPress");function W(r,n){B("keyPressRep",r,n)}s(W,"keyPressRep");function F(r,n){B("keyRelease",r,n)}s(F,"keyRelease");function K(r){b().events.charInput.push({cb:r})}s(K,"charInput");function ee(r){b().events.mouseDown.push({cb:r})}s(ee,"mouseDown");function xe(r){b().events.mouseClick.push({cb:r})}s(xe,"mouseClick");function Ie(r){b().events.mouseRelease.push({cb:r})}s(Ie,"mouseRelease");function ue(r){let a=[...b().objs.values()];return r?a.filter(h=>h.is(r)):a}s(ue,"get");function J(r,n){typeof r=="function"&&n===void 0?ue().forEach(r):typeof r=="string"&&ue(r).forEach(n)}s(J,"every");function Ee(r,n){typeof r=="function"&&n===void 0?ue().reverse().forEach(r):typeof r=="string"&&ue(r).reverse().forEach(n)}s(Ee,"revery");function Ae(r){if(!r.exists())return;let n=b();!n||(r.trigger("destroy"),n.objs.delete(r._id),delete r._id)}s(Ae,"destroy");function he(r){J(r,n=>{Ae(n)})}s(he,"destroyAll");function Me(r){let n=b();return r!==void 0&&(n.gravity=r),n.gravity}s(Me,"gravity");function Ge(r){let n=b();if(!n)throw new Error(`scene not found: '${S.curScene}'`);let a=r||!H.paused;if(a)for(let u in n.timers){let y=n.timers[u];y.time-=P(),y.time<=0&&(y.cb(),delete n.timers[u])}if(Ee(u=>{!u.paused&&a&&u.trigger("update")}),a)for(let u of n.action)u();let h=d(i.width(),i.height()),c=n.cam,m=dt(Pe(0,Math.PI*2)).scale(c.shake);c.shake=ke(c.shake,0,5*P()),c.matrix=Z().translate(h.scale(.5)).scale(c.scale).rotateZ(c.angle).translate(h.scale(-.5)).translate(c.pos.scale(-1).add(h.scale(.5)).add(m)),c.mpos=c.matrix.invert().multVec2(t.mousePos()),J(u=>{u.hidden||(i.pushTransform(),c.ignore.includes(u.layer)||i.pushMatrix(c.matrix),u.trigger("draw"),i.popTransform())});for(let u of n.render)u()}s(Ge,"gameFrame");function qe(){let r=b();for(let n of r.events.charInput)t.charInputted().forEach(n.cb);for(let n of r.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of r.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of r.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of r.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of r.events.mouseDown)t.mouseDown()&&n.cb();for(let n of r.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of r.events.mouseRelease)t.mouseReleased()&&n.cb()}s(qe,"handleEvents");function ze(){var y;let r=b(),n=!1,a=i.scale()*((r.cam.scale.x+r.cam.scale.y)/2),h=l.defFont(),c=j((y=e.inspectColor)!=null?y:[0,1,1,1]),m=d(6,6).scale(1/a),u=12;Ee(g=>{if(!g.area||g.hidden)return;i.pushTransform(),r.cam.ignore.includes(g.layer)||i.pushMatrix(r.cam.matrix);let M=!1;g.isHovered()&&!n&&(M=!0,n=!0);let ie=(M?6:2)/a,oe=g._worldArea(),Ye=oe.p2.x-oe.p1.x,$e=oe.p2.y-oe.p1.y;if(i.drawRectStroke(oe.p1,Ye,$e,{width:ie,color:c,z:.9}),M){let tt=U(g.layer),Ce=0,Ue=0,nt=[],st=s(le=>{let me=i.fmtText(le,h,{size:u/a,pos:tt.add(d(m.x,m.y+Ue)),z:1});nt.push(me),Ce=me.width>Ce?me.width:Ce,Ue+=me.height},"addLine");for(let le of g._tags)st(`"${le}"`);for(let le of g._events.inspect){let me=le();for(let rt in me)st(`${rt}: ${me[rt]}`)}Ce+=m.x*2,Ue+=m.y*2,i.drawRect(tt,Ce,Ue,{color:j(0,0,0,1),z:1});for(let le of nt)i.drawFmtText(le)}i.popTransform()})}s(ze,"drawInspect");function Se(r,...n){t.run(()=>{if(i.frameStart(),S.loaded){try{if(!b())throw new Error(`scene not found: '${S.curScene}'`);qe(),Ge(),H.inspect&&ze()}catch(a){v.error(a.stack),t.quit()}H.showLog&&v.draw(),S.nextScene&&(I.apply(null,[S.nextScene.name,...S.nextScene.args]),S.nextScene=null)}else{let a=l.loadProgress();if(a===1)S.loaded=!0,I(r,...n),k&&k.connect().catch(v.error);else{let h=i.width()/2,c=24/i.scale(),m=d(i.width()/2,i.height()/2).sub(d(h/2,c/2));i.drawRect(d(0),i.width(),i.height(),{color:Ne(0,0,0)}),i.drawRectStroke(m,h,c,{width:4/i.scale()}),i.drawRect(m,h*a,c)}}i.frameEnd()})}s(Se,"start");function Oe(...r){return{pos:d(...r),move(...n){let a=d(...n),h=a.x*P(),c=a.y*P();this.pos.x+=h,this.pos.y+=c},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}s(Oe,"pos");function je(...r){return{scale:d(...r),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}s(je,"scale");function Mt(r){return{angle:r}}s(Mt,"rotate");function Gt(...r){return{color:j(...r)}}s(Gt,"color");function qt(r){return{origin:r}}s(qt,"origin");function Ot(r){return{layer:r,inspect(){var a;let n=b();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}s(Ot,"layer");function Xe(r,n){var h,c;let a=b();return((h=r.layer)!=null?h:a.defLayer)===((c=n.layer)!=null?c:a.defLayer)}s(Xe,"isSameLayer");function et(r,n){let a={},h={};return{area:{p1:r,p2:n},areaWidth(){let{p1:c,p2:m}=this._worldArea();return m.x-c.x},areaHeight(){let{p1:c,p2:m}=this._worldArea();return m.y-c.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){return this.hasPt(U(this.layer))},isCollided(c){if(!c.area||!Xe(this,c))return!1;let m=this._worldArea(),u=c._worldArea();return We(m,u)},isOverlapped(c){if(!c.area||!Xe(this,c))return!1;let m=this._worldArea(),u=c._worldArea();return gt(m,u)},clicks(c){this.action(()=>{this.isClicked()&&c()})},hovers(c){this.action(()=>{this.isHovered()&&c()})},collides(c,m){this.action(()=>{this._checkCollisions(c,m)})},overlaps(c,m){this.action(()=>{this._checkOverlaps(c,m)})},hasPt(c){let m=this._worldArea();return vt({p1:m.p1,p2:m.p2},c)},resolve(){let c=[];return J(m=>{if(m===this||!m.solid||!m.area||!Xe(this,m))return;let u=this._worldArea(),y=m._worldArea();if(!We(u,y))return;let g=u.p2.x-y.p1.x,M=y.p2.x-u.p1.x,ie=u.p2.y-y.p1.y,oe=y.p2.y-u.p1.y,Ye=Math.min(g,M,ie,oe),$e=(()=>{switch(Ye){case g:return this.pos.x-=g,"right";case M:return this.pos.x+=M,"left";case ie:return this.pos.y-=ie,"bottom";case oe:return this.pos.y+=oe,"top"}})();c.push({obj:m,side:$e})}),c},_checkCollisions(c,m){J(c,u=>{this!==u&&(a[u._id]||this.isCollided(u)&&(m(u),a[u._id]=u))});for(let u in a){let y=a[u];this.isCollided(y)||delete a[u]}},_checkOverlaps(c,m){J(c,u=>{this!==u&&(h[u._id]||this.isOverlapped(u)&&(m(u),h[u._id]=u))});for(let u in h){let y=h[u];this.isOverlapped(y)||delete h[u]}},_worldArea(){let c=this.area,m=this.pos||d(0),u=this.scale||d(1),y=m.add(c.p1.dot(u)),g=m.add(c.p2.dot(u));return{p1:d(Math.min(y.x,g.x),Math.min(y.y,g.y)),p2:d(Math.max(y.x,g.x),Math.max(y.y,g.y))}}}}s(et,"area");function Ve(r,n,a){let h=d(r,n),c=Fe(a||q).dot(h).scale(-.5);return et(c.sub(h.scale(.5)),c.add(h.scale(.5)))}s(Ve,"getAreaFromSize");function Vt(r,n={}){let a=l.sprites[r];if(!a)throw new Error(`sprite not found: "${r}"`);let h=de({},a.frames[0]);n.quad&&(h.x+=n.quad.x*h.w,h.y+=n.quad.y*h.h,h.w*=n.quad.w,h.h*=n.quad.h);let c=a.tex.width*h.w,m=a.tex.height*h.h,u=null;return{width:c,height:m,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||te(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Ve(this.width,this.height,this.origin))},draw(){var M;let y=b(),g=a.frames[this.frame];A(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:l.shaders[this.shader],uniform:this.uniform,z:y.layers[(M=this.layer)!=null?M:y.defLayer]})},update(){if(!u)return;let y=a.anims[u.name];u.timer+=P(),u.timer>=this.animSpeed&&(this.frame++,this.frame>y.to&&(u.loop?this.frame=y.from:(this.frame--,this.stop())),u.timer-=this.animSpeed)},play(y,g=!0){let M=a.anims[y];if(!M)throw new Error(`anim not found: ${y}`);u&&this.stop(),u={name:y,loop:g,timer:0},this.frame=M.from,this.trigger("animPlay",y)},stop(){if(!u)return;let y=u.name;u=null,this.trigger("animEnd",y)},changeSprite(y){if(a=l.sprites[y],!a)throw new Error(`sprite not found: "${y}"`);let g=de({},a.frames[0]);n.quad&&(g.x+=n.quad.x*g.w,g.y+=n.quad.y*g.h,g.w*=n.quad.w,g.h*=n.quad.h),this.width=a.tex.width*g.w,this.height=a.tex.height*g.h,this.area&&!n.noArea&&this.use(Ve(this.width,this.height,this.origin)),u=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return u==null?void 0:u.name},inspect(){let y={};return u&&(y.curAnim=`"${u.name}"`),y}}}s(Vt,"sprite");function Ut(r,n,a={}){return{text:r,textSize:n,font:a.font,width:0,height:0,add(){var h,c,m,u;if(!this.area&&!a.noArea){let y=b(),g=l.fonts[(h=this.font)!=null?h:_e],M=i.fmtText(this.text+"",g,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:y.layers[(c=this.layer)!=null?c:y.defLayer]});this.width=M.width/(((m=this.scale)==null?void 0:m.x)||1),this.height=M.height/(((u=this.scale)==null?void 0:u.y)||1),this.use(Ve(this.width,this.height,this.origin))}},draw(){var u,y;let h=b(),c=l.fonts[(u=this.font)!=null?u:_e],m=i.fmtText(this.text+"",c,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:h.layers[(y=this.layer)!=null?y:h.defLayer]});this.width=m.width,this.height=m.height,i.drawFmtText(m)}}}s(Ut,"text");function Nt(r,n,a={}){return{width:r,height:n,add(){!this.area&&!a.noArea&&this.use(Ve(this.width,this.height,this.origin))},draw(){var c;let h=b();i.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:h.layers[(c=this.layer)!=null?c:h.defLayer],prog:l.shaders[this.shader],uniform:this.uniform})}}}s(Nt,"rect");function Bt(){return{solid:!0}}s(Bt,"solid");let zt=960,jt=480;function Xt(r={}){var m,u;let n=0,a=null,h=null,c=(m=r.maxVel)!=null?m:zt;return{jumpForce:(u=r.jumpForce)!=null?u:jt,update(){this.move(0,n);let y=this.resolve(),g=!1;if(a&&(!a.exists()||!this.isCollided(a)?(a=null,h=null,g=!0):h&&(this.pos=this.pos.add(a.pos.sub(h)),h=a.pos.clone())),!a){n=Math.min(n+Me()*P(),c);for(let M of y)M.side==="bottom"&&n>0?(a=M.obj,n=0,h=a.pos.clone(),g||this.trigger("grounded",a)):M.side==="top"&&n<0&&(n=0,this.trigger("headbump",M.obj))}},curPlatform(){return a},grounded(){return a!==null},falling(){return n>0},jump(y){a=null,n=-y||-this.jumpForce}}}s(Xt,"body");function Yt(r,n={}){let a=l.shaders[r];return{shader:r,uniform:n}}s(Yt,"shader");let H={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return b().objs.size},stepFrame(){Ge(!0)},drawCalls:i.drawCalls,clearLog:v.clear,log:v.info,error:v.error};function $t(r,n){let a=[],h=d(n.pos||0),c=0,m={getPos(...u){let y=d(...u);return d(h.x+y.x*n.width,h.y+y.y*n.height)},spawn(u,y){let g=(()=>{if(Array.isArray(u))return u;if(n[u]){if(typeof n[u]=="function")return n[u]();if(Array.isArray(n[u]))return[...n[u]]}else if(n.any)return n.any(u)})();if(!g)return;g.push(Oe(h.x+y.x*n.width,h.y+y.y*n.height));let M=fe(g);return a.push(M),M.use({gridPos:y.clone(),setGridPos(ie){this.gridPos=ie.clone(),this.pos=d(h.x+this.gridPos.x*n.width,h.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(d(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(d(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(d(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(d(0,1)))}}),M},width(){return c*n.width},height(){return r.length*n.height},destroy(){for(let u of a)Ae(u)}};return r.forEach((u,y)=>{let g=u.split("");c=Math.max(g.length,c),g.forEach((M,ie)=>{m.spawn(M,d(ie,y))})}),m}s($t,"addLevel");let Te={start:Se,loadRoot:l.loadRoot,loadSprite:l.loadSprite,loadSound:l.loadSound,loadFont:l.loadFont,loadShader:l.loadShader,addLoader:l.addLoader,width:i.width,height:i.height,dt:P,time:t.time,screenshot:t.screenshot,scene:$,go:z,sceneData:N,layers:G,camPos:ce,camScale:Q,camRot:ne,camShake:se,camIgnore:Le,gravity:Me,add:fe,readd:ye,destroy:Ae,destroyAll:he,get:ue,every:J,revery:Ee,send:X,recv:_,pos:Oe,scale:je,rotate:Mt,color:Gt,origin:qt,layer:Ot,area:et,sprite:Vt,text:Ut,rect:Nt,solid:Bt,body:Xt,shader:Yt,on:re,action:be,render:f,collides:x,overlaps:p,clicks:D,keyDown:C,keyPress:T,keyPressRep:W,keyRelease:F,charInput:K,mouseDown:ee,mouseClick:xe,mouseRelease:Ie,mousePos:U,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:V,wait:O,play:L,volume:o.volume,makeRng:He,rand:Pe,randSeed:bt,vec2:d,rgb:Ne,rgba:j,quad:te,choose:wt,chance:xt,lerp:ke,map:ge,mapc:ht,wave:mt,deg2rad:ct,rad2deg:ut,drawSprite:A,drawText:R,drawRect:i.drawRect,drawRectStroke:i.drawRectStroke,drawLine:i.drawLine,debug:H,addLevel:$t};if(e.plugins)for(let r of e.plugins){let n=r(Te);for(let a in n)Te[a]=n[a]}if(e.global)for(let r in Te)window[r]=Te[r];return Te};
//# sourceMappingURL=kaboom.cjs.map
