var Ke=Object.defineProperty;var Ft=Object.prototype.hasOwnProperty;var Ze=Object.getOwnPropertySymbols,qt=Object.prototype.propertyIsEnumerable;var Je=(e,t,o)=>t in e?Ke(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,ne=(e,t)=>{for(var o in t||(t={}))Ft.call(t,o)&&Je(e,o,t[o]);if(Ze)for(var o of Ze(t))qt.call(t,o)&&Je(e,o,t[o]);return e};var s=(e,t)=>Ke(e,"name",{value:t,configurable:!0});function ce(e,t,o){return Math.min(Math.max(e,t),o)}s(ce,"clamp");function Ee(e,t,o){return e+(t-e)*o}s(Ee,"lerp");function Ae(e,t,o,d,l){return d+(e-t)/(o-t)*(l-d)}s(Ae,"map");function m(e,t){return Ne(e)&&t===void 0?m(e.x,e.y):{x:e!=null?e:0,y:t!=null?t:e!=null?e:0,clone(){return m(this.x,this.y)},add(...o){let d=m(...o);return m(this.x+d.x,this.y+d.y)},sub(...o){let d=m(...o);return m(this.x-d.x,this.y-d.y)},scale(o){return m(this.x*o,this.y*o)},dist(...o){let d=m(...o);return Math.sqrt((this.x-d.x)*(this.x-d.x)+(this.y-d.y)*(this.y-d.y))},len(){return this.dist(m(0,0))},unit(){return this.scale(1/this.len())},normal(){return m(this.y,-this.x)},dot(...o){let d=m(...o);return m(this.x*d.x,this.y*d.y)},angle(...o){let d=m(...o);return Math.atan2(this.y-d.y,this.x-d.x)},lerp(o,d){return m(Ee(this.x,o.x,d),Ee(this.y,o.y,d))},eq(o){return this.x===o.x&&this.y===o.y},str(){return`(${this.x}, ${this.y})`}}}s(m,"vec2");function et(e){return m(Math.cos(e),Math.sin(e))}s(et,"vec2FromAngle");function ge(e,t,o){return{x:e,y:t,z:o,xy(){return m(this.x,this.y)}}}s(ge,"vec3");function Ne(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}s(Ne,"isVec2");function tt(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}s(tt,"isColor");function nt(e,t,o){return W(e,t,o,1)}s(nt,"rgb");function W(...e){var t;return e=[...e],e.length===0?W(1,1,1,1):{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return W(this.r,this.g,this.b,this.a)},lighten(o){return W(this.r+o,this.g+o,this.b+o,this.a)},darken(o){return this.lighten(-o)},eq(o){return this.r===o.r&&this.g===o.g&&this.b===o.g&&this.a===o.a}}}s(W,"rgba");function re(e,t,o,d){return{x:e,y:t,w:o,h:d,clone(){return re(this.x,this.y,this.w,this.h)},eq(l){return this.x===l.x&&this.y===l.y&&this.w===l.w&&this.h===l.h}}}s(re,"quad");function Q(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return Q(this.m)},mult(t){let o=[];for(let d=0;d<4;d++)for(let l=0;l<4;l++)o[d*4+l]=this.m[0*4+l]*t.m[d*4+0]+this.m[1*4+l]*t.m[d*4+1]+this.m[2*4+l]*t.m[d*4+2]+this.m[3*4+l]*t.m[d*4+3];return Q(o)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let o=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return ge(o.x,o.y,o.z)},multVec2(t){return m(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(Q([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(Q([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(Q([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(Q([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(Q([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],d=this.m[9]*this.m[15]-this.m[13]*this.m[11],l=this.m[9]*this.m[14]-this.m[13]*this.m[10],T=this.m[8]*this.m[15]-this.m[12]*this.m[11],P=this.m[8]*this.m[14]-this.m[12]*this.m[10],S=this.m[8]*this.m[13]-this.m[12]*this.m[9],$=this.m[6]*this.m[15]-this.m[14]*this.m[7],M=this.m[5]*this.m[15]-this.m[13]*this.m[7],D=this.m[5]*this.m[14]-this.m[13]*this.m[6],z=this.m[4]*this.m[15]-this.m[12]*this.m[7],w=this.m[4]*this.m[14]-this.m[12]*this.m[6],v=this.m[5]*this.m[15]-this.m[13]*this.m[7],R=this.m[4]*this.m[13]-this.m[12]*this.m[5],E=this.m[6]*this.m[11]-this.m[10]*this.m[7],q=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],j=this.m[4]*this.m[11]-this.m[8]*this.m[7],O=this.m[4]*this.m[10]-this.m[8]*this.m[6],N=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*d+this.m[7]*l,t[4]=-(this.m[4]*o-this.m[6]*T+this.m[7]*P),t[8]=this.m[4]*d-this.m[5]*T+this.m[7]*S,t[12]=-(this.m[4]*l-this.m[5]*P+this.m[6]*S),t[1]=-(this.m[1]*o-this.m[2]*d+this.m[3]*l),t[5]=this.m[0]*o-this.m[2]*T+this.m[3]*P,t[9]=-(this.m[0]*d-this.m[1]*T+this.m[3]*S),t[13]=this.m[0]*l-this.m[1]*P+this.m[2]*S,t[2]=this.m[1]*$-this.m[2]*M+this.m[3]*D,t[6]=-(this.m[0]*$-this.m[2]*z+this.m[3]*w),t[10]=this.m[0]*v-this.m[1]*z+this.m[3]*R,t[14]=-(this.m[0]*D-this.m[1]*w+this.m[2]*R),t[3]=-(this.m[1]*E-this.m[2]*q+this.m[3]*g),t[7]=this.m[0]*E-this.m[2]*j+this.m[3]*O,t[11]=-(this.m[0]*q-this.m[1]*j+this.m[3]*N),t[15]=this.m[0]*g-this.m[1]*O+this.m[2]*N;let B=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let H=0;H<4;H++)for(let x=0;x<4;x++)t[H*4+x]*=1/B;return Q(t)}}}s(Q,"mat4");function rt(e,t,o){return e+(Math.sin(o)+1)/2*(t-e)}s(rt,"wave");var Ot=1103515245,Nt=12345,ot=2147483648,st=ze(Date.now());function ze(e){return{seed:e,gen(t,o){if(Ne(t)&&Ne(o))return m(this.gen(t.x,o.x),this.gen(t.y,o.y));if(tt(t)&&tt(o))return W(this.gen(t.r,o.r),this.gen(t.g,o.g),this.gen(t.b,o.b),this.gen(t.a,o.a));if(t!==void 0)return o===void 0?this.gen()*t:this.gen()*(o-t)+t;if(t===void 0&&o===void 0)return this.seed=(Ot*this.seed+Nt)%ot,this.seed/ot;throw new Error("invalid param to rand()")}}}s(ze,"makeRng");function it(e){st.seed=e}s(it,"randSeed");function De(e,t){return st.gen(e,t)}s(De,"rand");function at(e){return De(0,1)<=e}s(at,"chance");function ut(e){return e[Math.floor(De(e.length))]}s(ut,"choose");function Be(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}s(Be,"colRectRect");function ct(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}s(ct,"overlapRectRect");function dt(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}s(dt,"colRectPt");var Ue="topleft",_e=9,Ie=65536,zt=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,Bt=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,je=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,He=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;function Pe(e){switch(e){case"topleft":return m(-1,-1);case"top":return m(0,-1);case"topright":return m(1,-1);case"left":return m(-1,0);case"center":return m(0,0);case"right":return m(1,0);case"botleft":return m(-1,1);case"bot":return m(0,1);case"botright":return m(1,1);default:return e}}s(Pe,"originPt");function mt(e,t){let o=(()=>{var F;let h=l(je,He),f=d(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),y=(F=t.clearColor)!=null?F:W(0,0,0,0);e.clearColor(y.r,y.g,y.b,y.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);let k=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,k),e.bufferData(e.ARRAY_BUFFER,Ie*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let U=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,U),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Ie*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),{drawCalls:0,defProg:h,curProg:h,defTex:f,curTex:f,vbuf:k,ibuf:U,vqueue:[],iqueue:[],transform:Q(),transformStack:[]}})();function d(h){let f=e.createTexture();return e.bindTexture(e.TEXTURE_2D,f),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{width:h.width,height:h.height,bind(){e.bindTexture(e.TEXTURE_2D,f)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}s(d,"makeTex");function l(h=je,f=He){let y,k=zt.replace("{{user}}",h!=null?h:je),U=Bt.replace("{{user}}",f!=null?f:He),F=e.createShader(e.VERTEX_SHADER),_=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(F,k),e.shaderSource(_,U),e.compileShader(F),e.compileShader(_),y=e.getShaderInfoLog(F))throw new Error(y);if(y=e.getShaderInfoLog(_))throw new Error(y);let L=e.createProgram();if(e.attachShader(L,F),e.attachShader(L,_),e.bindAttribLocation(L,0,"a_pos"),e.bindAttribLocation(L,1,"a_uv"),e.bindAttribLocation(L,2,"a_color"),e.linkProgram(L),y=e.getProgramInfoLog(L))throw new Error(y);return{bind(){e.useProgram(L)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,_e*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,_e*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,_e*4,20),e.enableVertexAttribArray(2)},sendFloat(C,I){let G=e.getUniformLocation(L,C);e.uniform1f(G,I)},sendVec2(C,I){let G=e.getUniformLocation(L,C);e.uniform2f(G,I.x,I.y)},sendVec3(C,I){let G=e.getUniformLocation(L,C);e.uniform3f(G,I.x,I.y,I.z)},sendColor(C,I){let G=e.getUniformLocation(L,C);e.uniform4f(G,I.r,I.g,I.b,I.a)},sendMat4(C,I){let G=e.getUniformLocation(L,C);e.uniformMatrix4fv(G,!1,new Float32Array(I.m))}}}s(l,"makeProgram");function T(h,f,y,k){let U=h.width/f,F=h.height/y,_=1/U,L=1/F,C={},I=k.split("").entries();for(let[G,ee]of I)C[ee]=m(G%U*_,Math.floor(G/U)*L);return{tex:h,map:C,qw:_,qh:L}}s(T,"makeFont");function P(h,f,y=o.defTex,k=o.defProg){y=y!=null?y:o.defTex,k=k!=null?k:o.defProg,(y!==o.curTex||k!==o.curProg||o.vqueue.length+h.length*_e>Ie||o.iqueue.length+f.length>Ie)&&S(),o.curTex=y,o.curProg=k;let U=f.map(_=>_+o.vqueue.length/_e),F=h.map(_=>{let L=z(o.transform.multVec2(_.pos.xy()));return[L.x,L.y,_.pos.z,_.uv.x,_.uv.y,_.color.r,_.color.g,_.color.b,_.color.a]}).flat();U.forEach(_=>o.iqueue.push(_)),F.forEach(_=>o.vqueue.push(_))}s(P,"drawRaw");function S(){!o.curTex||!o.curProg||o.vqueue.length===0||o.iqueue.length===0||(e.bindBuffer(e.ARRAY_BUFFER,o.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(o.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(o.iqueue)),o.curProg.bind(),o.curProg.bindAttribs(),o.curTex.bind(),e.drawElements(e.TRIANGLES,o.iqueue.length,e.UNSIGNED_SHORT,0),o.curTex.unbind(),o.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),o.iqueue=[],o.vqueue=[],o.drawCalls++)}s(S,"flush");function $(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),o.drawCalls=0,o.transformStack=[],o.transform=Q()}s($,"frameStart");function M(){S()}s(M,"frameEnd");function D(){return o.drawCalls}s(D,"drawCalls");function z(h){return m(h.x/K()*2-1,-h.y/xe()*2+1)}s(z,"toNDC");function w(h){o.transform=h.clone()}s(w,"pushMatrix");function v(h){!h||h.x===0&&h.y===0||(o.transform=o.transform.translate(h))}s(v,"pushTranslate");function R(h){!h||h.x===0&&h.y===0||(o.transform=o.transform.scale(h))}s(R,"pushScale");function E(h){!h||(o.transform=o.transform.rotateX(h))}s(E,"pushRotateX");function q(h){!h||(o.transform=o.transform.rotateY(h))}s(q,"pushRotateY");function g(h){!h||(o.transform=o.transform.rotateZ(h))}s(g,"pushRotateZ");function j(){o.transformStack.push(o.transform.clone())}s(j,"pushTransform");function O(){o.transformStack.length>0&&(o.transform=o.transformStack.pop())}s(O,"popTransform");function N(h={}){var ee,Z;let f=h.width||0,y=h.height||0,k=h.pos||m(0,0),F=Pe(h.origin||Ue).dot(m(f,y).scale(-.5)),_=m((ee=h.scale)!=null?ee:1),L=h.rot||0,C=h.quad||re(0,0,1,1),I=1-((Z=h.z)!=null?Z:0),G=h.color||W(1,1,1,1);j(),v(k),R(_),g(L),v(F),P([{pos:ge(-f/2,y/2,I),uv:m(C.x,C.y+C.h),color:G},{pos:ge(-f/2,-y/2,I),uv:m(C.x,C.y),color:G},{pos:ge(f/2,-y/2,I),uv:m(C.x+C.w,C.y),color:G},{pos:ge(f/2,y/2,I),uv:m(C.x+C.w,C.y+C.h),color:G}],[0,1,3,1,2,3],h.tex),O()}s(N,"drawQuad");function B(h,f={}){var F;let y=(F=f.quad)!=null?F:re(0,0,1,1),k=h.width*y.w,U=h.height*y.h;N({tex:h,quad:y,width:k,height:U,pos:f.pos,scale:f.scale,rot:f.rot,color:f.color,origin:f.origin,z:f.z})}s(B,"drawTexture");function H(h,f,y,k={}){N(ne(ne({},k),{pos:h,width:f,height:y}))}s(H,"drawRect");function x(h,f,y,k={}){let U=Pe(k.origin||Ue).dot(m(f,y)).scale(.5),F=h.add(m(-f/2,-y/2)).sub(U),_=h.add(m(-f/2,y/2)).sub(U),L=h.add(m(f/2,y/2)).sub(U),C=h.add(m(f/2,-y/2)).sub(U);V(F,_,k),V(_,L,k),V(L,C,k),V(C,F,k)}s(x,"drawRectStroke");function V(h,f,y={}){let k=y.width||1,U=h.dist(f),F=Math.PI/2-h.angle(f);N(ne(ne({},y),{pos:h.add(f).scale(.5),width:k,height:U,rot:F,origin:"center"}))}s(V,"drawLine");function oe(h,f,y={}){let k=(h+"").split(""),U=f.qw*f.tex.width,F=f.qh*f.tex.height,_=y.size||F,L=m(_/F).dot(m(y.scale||1)),C=L.x*U,I=L.y*F,G=0,ee=I,Z=0,pe=[[]];for(let ae of k)(ae===`
`||(y.width?G+C>y.width:!1))&&(ee+=I,G=0,pe.push([])),ae!==`
`&&(pe[pe.length-1].push(ae),G+=C),Z=Math.max(Z,G);y.width&&(Z=y.width);let Ve=[],ke=m(y.pos),de=Pe(y.origin||Ue).scale(.5),me=-de.x*C-(de.x+.5)*(Z-C),ie=-de.y*I-(de.y+.5)*(ee-I);return pe.forEach((ae,we)=>{let Me=(Z-ae.length*C)*(de.x+.5);ae.forEach((Re,Ge)=>{let Ce=f.map[Re],Fe=Ge*C,qe=we*I;Ce&&Ve.push({tex:f.tex,quad:re(Ce.x,Ce.y,f.qw,f.qh),ch:Re,pos:m(ke.x+Fe+me+Me,ke.y+qe+ie),color:y.color,origin:y.origin,scale:L,z:y.z})})}),{width:Z,height:ee,chars:Ve}}s(oe,"fmtText");function se(h,f,y={}){J(oe(h,f,y))}s(se,"drawText");function J(h){for(let f of h.chars)N({tex:f.tex,width:f.tex.width*f.quad.w,height:f.tex.height*f.quad.h,pos:f.pos,scale:f.scale,color:f.color,quad:f.quad,origin:"center",z:f.z})}s(J,"drawFmtText");function K(){return e.drawingBufferWidth/ve()}s(K,"width");function xe(){return e.drawingBufferHeight/ve()}s(xe,"height");function ve(){var h;return(h=t.scale)!=null?h:1}return s(ve,"scale"),{width:K,height:xe,scale:ve,makeTex:d,makeProgram:l,makeFont:T,drawTexture:B,drawText:se,drawFmtText:J,drawRect:H,drawRectStroke:x,drawLine:V,fmtText:oe,frameStart:$,frameEnd:M,pushTransform:j,popTransform:O,pushMatrix:w,drawCalls:D}}s(mt,"gfxInit");function ht(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}s(ht,"processBtnState");function lt(e={}){var B,H;let t={canvas:(B=e.canvas)!=null?B:(()=>{var V;let x=document.createElement("canvas");return((V=e.root)!=null?V:document.body).appendChild(x),x})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:m(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(H=e.scale)!=null?H:1,isTouch:!1,loopID:null,stopped:!1},o={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},d=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let l=["outline: none","cursor: default"];e.crisp&&(l.push("image-rendering: pixelated"),l.push("image-rendering: crisp-edges")),t.canvas.style=l.join(";"),t.canvas.setAttribute("tabindex","0");let T=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("contextmenu",x=>{x.preventDefault()}),t.canvas.addEventListener("mousemove",x=>{t.mousePos=m(x.offsetX,x.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",x=>{let V=x.touches[0];t.mousePos=m(V.clientX,V.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",x=>{let V=x.touches[0];t.mousePos=m(V.clientX,V.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",x=>{let V=o[x.key]||x.key.toLowerCase();d.includes(V)&&x.preventDefault(),V.length===1&&t.charInputted.push(V),V==="space"&&t.charInputted.push(" "),x.repeat?t.keyStates[V]="rpressed":t.keyStates[V]="pressed"}),t.canvas.addEventListener("keyup",x=>{let V=o[x.key]||x.key.toLowerCase();t.keyStates[V]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function P(){return t.mousePos.clone()}s(P,"mousePos");function S(){return t.mouseState==="pressed"}s(S,"mouseClicked");function $(){return t.mouseState==="pressed"||t.mouseState==="down"}s($,"mouseDown");function M(){return t.mouseState==="released"}s(M,"mouseReleased");function D(x){return t.keyStates[x]==="pressed"}s(D,"keyPressed");function z(x){return t.keyStates[x]==="pressed"||t.keyStates[x]==="rpressed"}s(z,"keyPressedRep");function w(x){return t.keyStates[x]==="pressed"||t.keyStates[x]==="rpressed"||t.keyStates[x]==="down"}s(w,"keyDown");function v(x){return t.keyStates[x]==="released"}s(v,"keyReleased");function R(){return[...t.charInputted]}s(R,"charInputted");function E(){return t.dt}s(E,"dt");function q(){return t.time}s(q,"time");function g(){return t.canvas.toDataURL()}s(g,"screenshot");function j(x){return x&&(t.canvas.style.cursor=x!=null?x:"default"),t.canvas.style.cursor}s(j,"cursor");function O(x){let V=s(oe=>{let se=oe/1e3,J=se-t.realTime;t.realTime=se,t.skipTime||(t.dt=J,t.time+=t.dt),t.skipTime=!1,x();for(let K in t.keyStates)t.keyStates[K]=ht(t.keyStates[K]);t.mouseState=ht(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(V))},"frame");t.loopID=requestAnimationFrame(V)}s(O,"run");function N(){cancelAnimationFrame(t.loopID),t.stopped=!0}return s(N,"quit"),{gl:T,mousePos:P,keyDown:w,keyPressed:D,keyPressedRep:z,keyReleased:v,mouseDown:$,mouseClicked:S,mouseReleased:M,charInputted:R,cursor:j,dt:E,time:q,screenshot:g,run:O,quit:N}}s(lt,"appInit");var ft=0,pt=3,Ut=0,jt=3,Ht=-1200,Xt=1200;function bt(){let e=(()=>{let l=new(window.AudioContext||window.webkitAudioContext),T=l.createGain(),P=T;return P.connect(l.destination),{ctx:l,gainNode:T,masterNode:P}})();function t(l){return l!==void 0&&(e.gainNode.gain.value=ce(l,ft,pt)),e.gainNode.gain.value}s(t,"volume");function o(l,T={loop:!1,volume:1,speed:1,detune:0,seek:0}){var v;let P=!1,S=e.ctx.createBufferSource();S.buffer=l,S.loop=!!T.loop;let $=e.ctx.createGain();S.connect($),$.connect(e.masterNode);let M=(v=T.seek)!=null?v:0;S.start(0,M);let D=e.ctx.currentTime-M,z=null,w={stop(){S.stop(),P=!0,z=e.ctx.currentTime},play(R){if(!P)return;let E=S;S=e.ctx.createBufferSource(),S.buffer=E.buffer,S.loop=E.loop,S.playbackRate.value=E.playbackRate.value,S.detune&&(S.detune.value=E.detune.value),S.connect($);let q=R!=null?R:this.time();S.start(0,q),D=e.ctx.currentTime-q,P=!1,z=null},pause(){this.stop()},paused(){return P},stopped(){return P},speed(R){return R!==void 0&&(S.playbackRate.value=ce(R,Ut,jt)),S.playbackRate.value},detune(R){return S.detune?(R!==void 0&&(S.detune.value=ce(R,Ht,Xt)),S.detune.value):0},volume(R){return R!==void 0&&($.gain.value=ce(R,ft,pt)),$.gain.value},loop(){S.loop=!0},unloop(){S.loop=!1},duration(){return l.duration},time(){return P&&z?z-D:e.ctx.currentTime-D}};return w.speed(T.speed),w.detune(T.detune),w.volume(T.volume),w}s(o,"play");function d(){return e.ctx}return s(d,"ctx"),{ctx:d,volume:t,play:o}}s(bt,"audioInit");var gt="data:image/png;base64,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";var $t=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ye="unscii";function yt(e){let t=new Image;return t.src=e,new Promise((o,d)=>{t.onload=()=>{o(t)},t.onerror=()=>{d()}})}s(yt,"loadImg");function xt(e){return e.startsWith("data:")}s(xt,"isDataUrl");function vt(e,t,o={}){let d={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function l(w){var R;let v=d.lastLoaderID;d.loaders[v]=!1,d.lastLoaderID++,w.catch((R=o.errHandler)!=null?R:console.error).finally(()=>{d.loaders[v]=!0})}s(l,"addLoader");function T(){let w=0,v=0;for(let R in d.loaders)w+=1,d.loaders[R]&&(v+=1);return v/w}s(T,"loadProgress");function P(w){return w&&(d.loadRoot=w),d.loadRoot}s(P,"loadRoot");function S(w,v,R,E,q=$t){let g=new Promise((j,O)=>{let N=xt(v)?v:d.loadRoot+v;yt(N).then(B=>{let H=e.makeFont(e.makeTex(B),R,E,q);d.fonts[w]=H,j(H)}).catch(()=>{O(`failed to load font '${w}' from '${v}'`)})});return l(g),g}s(S,"loadFont");function $(w,v,R={sliceX:1,sliceY:1,anims:{}}){function E(g,j,O={sliceX:1,sliceY:1,anims:{}}){let N=[],B=e.makeTex(j),H=O.sliceX||1,x=O.sliceY||1,V=1/H,oe=1/x;for(let J=0;J<x;J++)for(let K=0;K<H;K++)N.push(re(K*V,J*oe,V,oe));let se={tex:B,frames:N,anims:O.anims||{}};return d.sprites[g]=se,se}s(E,"loadRawSprite");let q=new Promise((g,j)=>{if(v||j(`failed to load sprite '${w}' from '${v}'`),typeof v=="string"){let O=xt(v)?v:d.loadRoot+v;yt(O).then(N=>{g(E(w,N,R))}).catch(()=>{j(`failed to load sprite '${w}' from '${v}'`)});return}else g(E(w,v,R))});return l(q),q}s($,"loadSprite");function M(w,v,R,E=!1){function q(j,O,N){let B=e.makeProgram(O,N);return d.shaders[j]=B,B}s(q,"loadRawShader");let g=new Promise((j,O)=>{if(!v&&!R)return O("no shader");function N(B){return B?fetch(d.loadRoot+B).then(H=>{if(H.ok)return H.text();throw new Error(`failed to fetch ${B}`)}).catch(O):new Promise(H=>H(null))}if(s(N,"resolveUrl"),E)Promise.all([N(v),N(R)]).then(([B,H])=>{j(q(w,B,H))}).catch(O);else try{j(q(w,v,R))}catch(B){O(B)}});return l(g),g}s(M,"loadShader");function D(w,v){let R=new Promise((E,q)=>{typeof v=="string"&&fetch(d.loadRoot+v).then(g=>g.arrayBuffer()).then(g=>new Promise((j,O)=>{t.ctx().decodeAudioData(g,N=>{j(N)},()=>{O()})})).then(g=>{d.sounds[w]=g,E(g)}).catch(()=>{q(`failed to load sound '${w}' from '${v}'`)})});return l(R),R}s(D,"loadSound");function z(){return d.fonts[ye]}return s(z,"defFont"),S(ye,gt,8,8),{loadRoot:P,loadSprite:$,loadSound:D,loadFont:S,loadShader:M,loadProgress:T,addLoader:l,defFont:z,sprites:d.sprites,fonts:d.fonts,sounds:d.sounds,shaders:d.shaders}}s(vt,"assetsInit");var Wt=16;function wt(e,t,o={max:8}){var M;let d=[],l=(M=o.max)!=null?M:8;function T(){d.length>l&&(d=d.slice(0,l));let D=m(0,e.height());d.forEach((z,w)=>{let v=Ae(w,0,l,1,.2),R=Ae(w,0,l,.8,.2),E=(()=>{switch(z.type){case"info":return W(1,1,1,v);case"error":return W(1,0,.5,v)}})(),q=e.fmtText(z.msg,t.defFont(),{pos:D,origin:"botleft",color:E,z:1,size:Wt/e.scale(),width:e.width()});e.drawRect(D,q.width,q.height,{origin:"botleft",color:W(0,0,0,R),z:1}),e.drawFmtText(q),D.y-=q.height})}s(T,"draw");function P(D){console.error(D),d.unshift({type:"error",msg:D})}s(P,"error");function S(D){console.log(D),d.unshift({type:"info",msg:D})}s(S,"info");function $(){d=[]}return s($,"clear"),{info:S,error:P,draw:T,clear:$}}s(wt,"loggerInit");function Rt(e){let t={},o=[],d=null;function l(){return d!==null&&d.readyState===1}s(l,"connected");function T(){let M=new WebSocket(e);return new Promise((D,z)=>{M.onopen=()=>{D(M),d=M;for(let w of o)M.send(w)},M.onerror=()=>{z(`failed to connect to ${e}`)},M.onmessage=w=>{let v=JSON.parse(w.data);if(t[v.type])for(let R of t[v.type])R(v.data,v.id)}})}s(T,"connect");function P(M,D){t[M]||(t[M]=[]),t[M].push(D)}s(P,"recv");function S(M,D){let z=JSON.stringify({type:M,data:D});d?d.send(z):o.push(z)}s(S,"send");function $(){d&&d.close()}return s($,"close"),{connect:T,close:$,connected:l,recv:P,send:S}}s(Rt,"netInit");module.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{var $e;let t=lt({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),o=mt(t.gl,{clearColor:(r=>W(r[0],r[1],r[2],r[3]))(($e=e.clearColor)!=null?$e:[0,0,0,1]),scale:e.scale}),d=bt(),l=vt(o,d,{errHandler:r=>{T.error(r)}}),T=wt(o,l,{max:e.logMax}),P=(()=>e.connect?Rt(e.connect):null)();function S(r,n){if(!P)throw new Error("not connected to any websockets");P.recv(r,(a,i)=>{try{n(a,i)}catch(u){T.error(u)}})}s(S,"recv");function $(r,n){if(!P)throw new Error("not connected to any websockets");P.send(r,n)}s($,"send");function M(r,n={}){let a=l.sounds[r];if(!a)throw new Error(`sound not found: "${r}"`);return d.play(a,n)}s(M,"play");function D(r){let n=g();return r?n.cam.ignore.includes(r)?D():n.cam.mpos:t.mousePos()}s(D,"mousePos");function z(r,n={}){var u;let a=(()=>typeof r=="string"?l.sprites[r]:r)();if(!a)throw new Error(`sprite not found: "${r}"`);let i=a.frames[(u=n.frame)!=null?u:0];o.drawTexture(a.tex,ne(ne({},n),{quad:i}))}s(z,"drawSprite");function w(r,n={}){var u;let a=(u=n.font)!=null?u:ye,i=l.fonts[a];if(!i)throw new Error(`font not found: ${a}`);o.drawText(r,i,n)}s(w,"drawText");let v=980,R="topleft",E={loaded:!1,scenes:{},curScene:null,nextScene:null};function q(r,n){E.scenes[r]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:m(o.width()/2,o.height()/2),scale:m(1,1),angle:0,shake:0,ignore:[],mpos:m(0),matrix:Q()},layers:{},defLayer:null,gravity:v,data:{}}}s(q,"scene");function g(){return E.scenes[E.curScene]}s(g,"curScene");function j(){return g().data}s(j,"sceneData");function O(){G("`",()=>{X.showLog=!X.showLog,T.info(`show log: ${X.showLog?"on":"off"}`)}),G("f1",()=>{X.inspect=!X.inspect,T.info(`inspect: ${X.inspect?"on":"off"}`)}),G("f2",()=>{X.clearLog()}),G("f8",()=>{X.paused=!X.paused,T.info(`${X.paused?"paused":"unpaused"}`)}),G("f7",()=>{X.timeScale=ce(X.timeScale-.2,0,2),T.info(`time scale: ${X.timeScale.toFixed(1)}`)}),G("f9",()=>{X.timeScale=ce(X.timeScale+.2,0,2),T.info(`time scale: ${X.timeScale.toFixed(1)}`)}),G("f10",()=>{X.stepFrame(),T.info("stepped frame")})}s(O,"regDebugInputs");function N(r,...n){E.nextScene={name:r,args:[...n]}}s(N,"go");function B(r,...n){H(r),E.curScene=r;let a=E.scenes[r];if(!a)throw new Error(`scene not found: '${r}'`);if(!a.initialized){try{a.init(...n)}catch(i){T.error(i.stack)}e.debug&&O(),a.initialized=!0}}s(B,"goSync");function H(r){if(!E.scenes[r])throw new Error(`scene not found: '${r}'`);q(r,E.scenes[r].init)}s(H,"reload");function x(r,n){let a=g();if(!a)return;let i=.5/r.length;r.forEach((u,p)=>{a.layers[u]=.5+i*p}),n&&(a.defLayer=n)}s(x,"layers");function V(...r){let n=g().cam;return r.length>0&&(n.pos=m(...r)),n.pos.clone()}s(V,"camPos");function oe(...r){let n=g().cam;return r.length>0&&(n.scale=m(...r)),n.scale.clone()}s(oe,"camScale");function se(r){let n=g().cam;return r!==void 0&&(n.angle=r),n.angle}s(se,"camRot");function J(r){let n=g().cam;n.shake=r}s(J,"camShake");function K(r){let n=g().cam;n.ignore=r}s(K,"camIgnore");function xe(r){let n={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(i){if(i===void 0)return;let u=typeof i;if(u==="string"){this._tags.push(i);return}if(u!=="object")throw new Error(`invalid comp type: ${u}`);if(Array.isArray(i)){for(let p of i)this.use(p);return}for(let p in i){if(typeof i[p]=="function"){this._events[p]?this._events[p].push(i[p].bind(this)):this[p]=i[p].bind(this);continue}this[p]=i[p]}},exists(){return this._sceneID!==void 0},is(i){if(i==="*")return!0;if(Array.isArray(i)){for(let u of i)if(!this._tags.includes(u))return!1;return!0}return this._tags.includes(i)},on(i,u){this._events[i]||(this._events[i]=[]),this._events[i].push(u)},action(i){this.on("update",i)},trigger(i,...u){if(this._events[i])for(let b of this._events[i])b.call(this,...u);let c=g().events[i];if(c)for(let b of c)this.is(b.tag)&&b.cb(this,...u)},rmTag(i){let u=this._tags.indexOf(i);u>-1&&this._tags.splice(u,1)}};n.use(r);let a=g();a.objs.set(a.lastID,n),n._sceneID=a.lastID,a.lastID++,n.trigger("add");for(let i of a.events.add)n.is(i.tag)&&i.cb(n);return n}s(xe,"add");function ve(r){if(!r.exists())return;let n=g();return n.objs.delete(r._sceneID),n.objs.set(n.lastID,r),r._sceneID=n.lastID,n.lastID++,r}s(ve,"readd");function h(r,n,a){let i=g();i.events[r]||(i.events[r]=[]),i.events[r].push({tag:n,cb:a})}s(h,"on");function f(r,n){typeof r=="function"&&n===void 0?g().action.push(r):typeof r=="string"&&h("update",r,n)}s(f,"action");function y(r,n){typeof r=="function"&&n===void 0?g().render.push(r):typeof r=="string"&&h("update",r,n)}s(y,"render");function k(r,n,a){f(r,i=>{i._checkCollisions(n,u=>{a(i,u)})})}s(k,"collides");function U(r,n,a){f(r,i=>{i._checkOverlaps(n,u=>{a(i,u)})})}s(U,"overlaps");function F(r,n){f(r,a=>{a.isClicked()&&n(a)})}s(F,"clicks");function _(r,n){return new Promise(a=>{let i=g();i.timers[i.lastTimerID++]={time:r,cb:()=>{n&&n(),a(null)}}})}s(_,"wait");function L(r,n){let a=!1,i=s(()=>{a||(n(),_(r,i))},"newF");return i(),{stop(){a=!0}}}s(L,"loop");function C(r,n,a){if(Array.isArray(n))for(let i of n)C(r,i,a);else g().events[r].push({key:n,cb:a})}s(C,"pushKeyEvent");function I(r,n){C("keyDown",r,n)}s(I,"keyDown");function G(r,n){C("keyPress",r,n)}s(G,"keyPress");function ee(r,n){C("keyPressRep",r,n)}s(ee,"keyPressRep");function Z(r,n){C("keyRelease",r,n)}s(Z,"keyRelease");function pe(r){g().events.charInput.push({cb:r})}s(pe,"charInput");function Ve(r){g().events.mouseDown.push({cb:r})}s(Ve,"mouseDown");function ke(r){g().events.mouseClick.push({cb:r})}s(ke,"mouseClick");function de(r){g().events.mouseRelease.push({cb:r})}s(de,"mouseRelease");function me(r){let a=[...g().objs.values()];return r?a.filter(i=>i.is(r)):a}s(me,"get");function ie(r,n){typeof r=="function"&&n===void 0?me().forEach(r):typeof r=="string"&&me(r).forEach(n)}s(ie,"every");function ae(r,n){typeof r=="function"&&n===void 0?me().reverse().forEach(r):typeof r=="string"&&me(r).reverse().forEach(n)}s(ae,"revery");function we(r){if(!r.exists())return;let n=g();!n||(r.trigger("destroy"),n.objs.delete(r._sceneID),delete r._sceneID)}s(we,"destroy");function Me(r){ie(r,n=>{we(n)})}s(Me,"destroyAll");function Re(r){let n=g();return r!==void 0&&(n.gravity=r),n.gravity}s(Re,"gravity");function Ge(r){let n=g();if(!n)throw new Error(`scene not found: '${E.curScene}'`);let a=r||!X.paused;if(a)for(let c in n.timers){let b=n.timers[c];b.time-=t.dt(),b.time<=0&&(b.cb(),delete n.timers[c])}if(ae(c=>{!c.paused&&a&&c.trigger("update")}),a)for(let c of n.action)c();let i=m(o.width(),o.height()),u=n.cam,p=et(De(0,Math.PI*2)).scale(u.shake);u.shake=Ee(u.shake,0,5*t.dt()),u.matrix=Q().translate(i.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(i.scale(-.5)).translate(u.pos.scale(-1).add(i.scale(.5)).add(p)),u.mpos=u.matrix.invert().multVec2(D()),ie(c=>{c.hidden||(o.pushTransform(),u.ignore.includes(c.layer)||o.pushMatrix(u.matrix),c.trigger("draw"),o.popTransform())});for(let c of n.render)c()}s(Ge,"gameFrame");function Ce(){let r=g();for(let n of r.events.charInput)t.charInputted().forEach(n.cb);for(let n of r.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of r.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of r.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of r.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of r.events.mouseDown)t.mouseDown()&&n.cb();for(let n of r.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of r.events.mouseRelease)t.mouseReleased()&&n.cb()}s(Ce,"handleEvents");function Fe(){ie(r=>{var Y;if(!r.area||r.hidden)return;o.pushTransform();let n=g();n.cam.ignore.includes(r.layer)||o.pushMatrix(n.cam.matrix);let a=l.defFont(),i=W(0,1,1,1),u=r.isHovered(),p=(u?4:2)/o.scale(),c=r._worldArea(),b=c.p2.x-c.p1.x,A=c.p2.y-c.p1.y;if(o.drawRectStroke(c.p1,b,A,{width:p,color:i,z:.9}),u){let te=D((Y=r.layer)!=null?Y:n.defLayer),ue=m(6,6).scale(1/o.scale()),he=0,be=0,We=[],Qe=s(le=>{var Te;let fe=o.fmtText(le,a,{size:12/((Te=e.scale)!=null?Te:1),pos:te.add(m(ue.x,ue.y+be)),z:1});We.push(fe),he=fe.width>he?fe.width:he,be+=fe.height},"addLine");for(let le of r._tags)Qe(`"${le}"`);for(let le of r._events.inspect){let fe=le();for(let Te in fe)Qe(`${Te}: ${fe[Te]}`)}he+=ue.x*2,be+=ue.y*2,o.drawRect(te,he,be,{color:W(0,0,0,1),z:1});for(let le of We)o.drawFmtText(le)}o.popTransform()})}s(Fe,"drawInspect");function qe(r,...n){t.run(()=>{if(o.frameStart(),E.loaded){try{if(!g())throw new Error(`scene not found: '${E.curScene}'`);Ce(),Ge(),X.inspect&&Fe(),X.showLog&&T.draw()}catch(a){T.error(a.stack),t.quit()}E.nextScene&&(B.apply(null,[E.nextScene.name,...E.nextScene.args]),E.nextScene=null)}else{let a=l.loadProgress();if(a===1)E.loaded=!0,B(r,...n),P&&P.connect().catch(T.error);else{let i=o.width()/2,u=12,p=m(o.width()/2,o.height()/2).sub(m(i/2,u/2));o.drawRectStroke(p,i,u,{width:2}),o.drawRect(p,i*a,u)}}o.frameEnd()})}s(qe,"start");function Xe(...r){return{pos:m(...r),move(...n){let a=m(...n),i=a.x*t.dt(),u=a.y*t.dt();this.pos.x+=i,this.pos.y+=u},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}s(Xe,"pos");function Ct(...r){return{scale:m(...r),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}s(Ct,"scale");function St(r){return{angle:r}}s(St,"rotate");function Tt(...r){return{color:W(...r)}}s(Tt,"color");function Et(r){return{origin:r}}s(Et,"origin");function At(r){return{layer:r,inspect(){var a;let n=g();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}s(At,"layer");function Oe(r,n){var i,u;let a=g();return((i=r.layer)!=null?i:a.defLayer)===((u=n.layer)!=null?u:a.defLayer)}s(Oe,"isSameLayer");function Ye(r,n){let a={},i={};return{area:{p1:r,p2:n},areaWidth(){let{p1:u,p2:p}=this._worldArea();return p.x-u.x},areaHeight(){let{p1:u,p2:p}=this._worldArea();return p.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){var u;return this.hasPt(D((u=this.layer)!=null?u:g().defLayer))},isCollided(u){if(!u.area||!Oe(this,u))return!1;let p=this._worldArea(),c=u._worldArea();return Be(p,c)},isOverlapped(u){if(!u.area||!Oe(this,u))return!1;let p=this._worldArea(),c=u._worldArea();return ct(p,c)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,p){this.action(()=>{this._checkCollisions(u,p)})},overlaps(u,p){this.action(()=>{this._checkOverlaps(u,p)})},hasPt(u){let p=this._worldArea();return dt({p1:p.p1,p2:p.p2},u)},resolve(){let u=[];return ie(p=>{if(p===this||!p.solid||!p.area||!Oe(this,p))return;let c=this._worldArea(),b=p._worldArea();if(!Be(c,b))return;let A=c.p2.x-b.p1.x,Y=b.p2.x-c.p1.x,te=c.p2.y-b.p1.y,ue=b.p2.y-c.p1.y,he=Math.min(A,Y,te,ue),be=(()=>{switch(he){case A:return this.pos.x-=A,"right";case Y:return this.pos.x+=Y,"left";case te:return this.pos.y-=te,"bottom";case ue:return this.pos.y+=ue,"top"}})();u.push({obj:p,side:be})}),u},_checkCollisions(u,p){ie(u,c=>{this!==c&&(a[c._sceneID]||this.isCollided(c)&&(p(c),a[c._sceneID]=c))});for(let c in a){let b=a[c];this.isCollided(b)||delete a[c]}},_checkOverlaps(u,p){ie(u,c=>{this!==c&&(i[c._sceneID]||this.isOverlapped(c)&&(p(c),i[c._sceneID]=c))});for(let c in i){let b=i[c];this.isOverlapped(b)||delete i[c]}},_worldArea(){let u=this.area,p=this.pos||m(0),c=this.scale||m(1),b=p.add(u.p1.dot(c)),A=p.add(u.p2.dot(c));return{p1:m(Math.min(b.x,A.x),Math.min(b.y,A.y)),p2:m(Math.max(b.x,A.x),Math.max(b.y,A.y))}}}}s(Ye,"area");function Le(r,n,a){let i=m(r,n),u=Pe(a||R).dot(i).scale(-.5);return Ye(u.sub(i.scale(.5)),u.add(i.scale(.5)))}s(Le,"getAreaFromSize");function Dt(r,n={}){let a=l.sprites[r];if(!a)throw new Error(`sprite not found: "${r}"`);let i=ne({},a.frames[0]);n.quad&&(i.x+=n.quad.x*i.w,i.y+=n.quad.y*i.h,i.w*=n.quad.w,i.h*=n.quad.h);let u=a.tex.width*i.w,p=a.tex.height*i.h,c=null;return{width:u,height:p,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||re(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Le(this.width,this.height,this.origin))},draw(){var Y;let b=g(),A=a.frames[this.frame];z(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,z:b.layers[(Y=this.layer)!=null?Y:b.defLayer]})},update(){if(!c)return;let b=a.anims[c.name];c.timer+=t.dt(),c.timer>=this.animSpeed&&(this.frame++,this.frame>b.to&&(c.loop?this.frame=b.from:(this.frame--,this.stop())),c.timer-=this.animSpeed)},play(b,A=!0){let Y=a.anims[b];if(!Y)throw new Error(`anim not found: ${b}`);c&&this.stop(),c={name:b,loop:A,timer:0},this.frame=Y.from,this.trigger("animPlay",b)},stop(){if(!c)return;let b=c.name;c=null,this.trigger("animEnd",b)},changeSprite(b){if(a=l.sprites[b],!a)throw new Error(`sprite not found: "${b}"`);let A=ne({},a.frames[0]);n.quad&&(A.x+=n.quad.x*A.w,A.y+=n.quad.y*A.h,A.w*=n.quad.w,A.h*=n.quad.h),this.width=a.tex.width*A.w,this.height=a.tex.height*A.h,this.area&&!n.noArea&&this.use(Le(this.width,this.height,this.origin)),c=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return c==null?void 0:c.name},inspect(){let b={};return c&&(b.curAnim=`"${c.name}"`),b}}}s(Dt,"sprite");function _t(r,n,a={}){return{text:r,textSize:n,font:a.font,width:0,height:0,add(){var i,u,p,c;if(!this.area&&!a.noArea){let b=g(),A=l.fonts[(i=this.font)!=null?i:ye],Y=o.fmtText(this.text+"",A,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:b.layers[(u=this.layer)!=null?u:b.defLayer]});this.width=Y.width/(((p=this.scale)==null?void 0:p.x)||1),this.height=Y.height/(((c=this.scale)==null?void 0:c.y)||1),this.use(Le(this.width,this.height,this.origin))}},draw(){var c,b;let i=g(),u=l.fonts[(c=this.font)!=null?c:ye],p=o.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:i.layers[(b=this.layer)!=null?b:i.defLayer]});this.width=p.width,this.height=p.height,o.drawFmtText(p)}}}s(_t,"text");function Pt(r,n,a={}){return{width:r,height:n,add(){!this.area&&!a.noArea&&this.use(Le(this.width,this.height,this.origin))},draw(){var u;let i=g();o.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:i.layers[(u=this.layer)!=null?u:i.defLayer]})}}}s(Pt,"rect");function Vt(){return{solid:!0}}s(Vt,"solid");let kt=960,Gt=480;function Lt(r={}){var u,p;let n=0,a=null,i=(u=r.maxVel)!=null?u:kt;return{jumpForce:(p=r.jumpForce)!=null?p:Gt,update(){this.move(0,n);let c=this.resolve(),b=!1;if(a&&(!a.exists()||!this.isCollided(a))&&(a=null,b=!0),!a){n=Math.min(n+Re()*t.dt(),i);for(let A of c)A.side==="bottom"&&n>0?(a=A.obj,n=0,b||this.trigger("grounded",a)):A.side==="top"&&n<0&&(n=0,this.trigger("headbump",A.obj))}},curPlatform(){return a},grounded(){return a!==null},jump(c){a=null,n=-c||-this.jumpForce}}}s(Lt,"body");function It(r){let n=l.shaders[r];return{sendVec2(a,i){n.sendVec2(a,i)},sendVec3(a,i){n.sendVec3(a,i)},sendColor(a,i){n.sendColor(a,i)},sendMat4(a,i){n.sendMat4(a,i)}}}s(It,"shader");let X={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return g().objs.size},stepFrame(){Ge(!0)},drawCalls:o.drawCalls,clearLog:T.clear,log:T.info,error:T.error};function Mt(r,n){let a=[],i=m(n.pos),u=0,p={getPos(...c){let b=m(...c);return m(i.x+b.x*n.width,i.y+b.y*n.height)},spawn(c,b){let A=(()=>{if(Array.isArray(c))return c;if(n[c]){if(typeof n[c]=="function")return n[c]();if(Array.isArray(n[c]))return[...n[c]]}else if(n.any)return n.any(c)})();if(A){A.push(Xe(i.x+b.x*n.width,i.y+b.y*n.height));let Y=xe(A);a.push(Y),Y.use({gridPos:b.clone(),setGridPos(te){this.gridPos=te.clone(),this.pos=m(i.x+this.gridPos.x*n.width,i.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(m(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(m(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(m(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(m(0,1)))}})}},width(){return u*n.width},height(){return r.length*n.height},destroy(){for(let c of a)we(c)}};return r.forEach((c,b)=>{let A=c.split("");u=Math.max(A.length,u),A.forEach((Y,te)=>{p.spawn(Y,m(te,b))})}),p}s(Mt,"addLevel");let Se={start:qe,loadRoot:l.loadRoot,loadSprite:l.loadSprite,loadSound:l.loadSound,loadFont:l.loadFont,loadShader:l.loadShader,addLoader:l.addLoader,width:o.width,height:o.height,dt:t.dt,time:t.time,screenshot:t.screenshot,scene:q,go:N,sceneData:j,layers:x,camPos:V,camScale:oe,camRot:se,camShake:J,camIgnore:K,gravity:Re,add:xe,readd:ve,destroy:we,destroyAll:Me,get:me,every:ie,revery:ae,send:$,recv:S,pos:Xe,scale:Ct,rotate:St,color:Tt,origin:Et,layer:At,area:Ye,sprite:Dt,text:_t,rect:Pt,solid:Vt,body:Lt,shader:It,on:h,action:f,render:y,collides:k,overlaps:U,clicks:F,keyDown:I,keyPress:G,keyPressRep:ee,keyRelease:Z,charInput:pe,mouseDown:Ve,mouseClick:ke,mouseRelease:de,mousePos:D,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:L,wait:_,play:M,volume:d.volume,makeRng:ze,rand:De,randSeed:it,vec2:m,rgb:nt,rgba:W,quad:re,choose:ut,chance:at,lerp:Ee,map:Ae,wave:rt,drawSprite:z,drawText:w,drawRect:o.drawRect,drawRectStroke:o.drawRectStroke,drawLine:o.drawLine,debug:X,addLevel:Mt};if(e.plugins)for(let r of e.plugins){let n=r(Se);for(let a in n)Se[a]=n[a]}if(e.global)for(let r in Se)window[r]=Se[r];return Se};
//# sourceMappingURL=kaboom.cjs.map
