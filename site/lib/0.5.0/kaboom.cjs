var Qe=Object.defineProperty;var Vt=Object.prototype.hasOwnProperty;var Ze=Object.getOwnPropertySymbols,qt=Object.prototype.propertyIsEnumerable;var Je=(e,t,r)=>t in e?Qe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ne=(e,t)=>{for(var r in t||(t={}))Vt.call(t,r)&&Je(e,r,t[r]);if(Ze)for(var r of Ze(t))qt.call(t,r)&&Je(e,r,t[r]);return e};var o=(e,t)=>Qe(e,"name",{value:t,configurable:!0});function ue(e,t,r){return Math.min(Math.max(e,t),r)}o(ue,"clamp");function Se(e,t,r){return e+(t-e)*r}o(Se,"lerp");function Ae(e,t,r,h,m){return h+(e-t)/(r-t)*(m-h)}o(Ae,"map");function d(e,t){return Ne(e)&&t===void 0?d(e.x,e.y):{x:e!=null?e:0,y:t!=null?t:e!=null?e:0,clone(){return d(this.x,this.y)},add(...r){let h=d(...r);return d(this.x+h.x,this.y+h.y)},sub(...r){let h=d(...r);return d(this.x-h.x,this.y-h.y)},scale(r){return d(this.x*r,this.y*r)},dist(...r){let h=d(...r);return Math.sqrt((this.x-h.x)*(this.x-h.x)+(this.y-h.y)*(this.y-h.y))},len(){return this.dist(d(0,0))},unit(){return this.scale(1/this.len())},normal(){return d(this.y,-this.x)},dot(...r){let h=d(...r);return d(this.x*h.x,this.y*h.y)},angle(...r){let h=d(...r);return Math.atan2(this.y-h.y,this.x-h.x)},lerp(r,h){return d(Se(this.x,r.x,h),Se(this.y,r.y,h))},eq(r){return this.x===r.x&&this.y===r.y},str(){return`(${this.x}, ${this.y})`}}}o(d,"vec2");function et(e){return d(Math.cos(e),Math.sin(e))}o(et,"vec2FromAngle");function we(e,t,r){return{x:e,y:t,z:r,xy(){return d(this.x,this.y)}}}o(we,"vec3");function Ne(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}o(Ne,"isVec2");function tt(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}o(tt,"isColor");function nt(e,t,r){return W(e,t,r,1)}o(nt,"rgb");function W(...e){var t;return e=[...e],e.length===0?W(1,1,1,1):{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return W(this.r,this.g,this.b,this.a)},lighten(r){return W(this.r+r,this.g+r,this.b+r,this.a)},darken(r){return this.lighten(-r)},eq(r){return this.r===r.r&&this.g===r.g&&this.b===r.g&&this.a===r.a}}}o(W,"rgba");function se(e,t,r,h){return{x:e,y:t,w:r,h,clone(){return se(this.x,this.y,this.w,this.h)},eq(m){return this.x===m.x&&this.y===m.y&&this.w===m.w&&this.h===m.h}}}o(se,"quad");function K(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return K(this.m)},mult(t){let r=[];for(let h=0;h<4;h++)for(let m=0;m<4;m++)r[h*4+m]=this.m[0*4+m]*t.m[h*4+0]+this.m[1*4+m]*t.m[h*4+1]+this.m[2*4+m]*t.m[h*4+2]+this.m[3*4+m]*t.m[h*4+3];return K(r)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let r=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return we(r.x,r.y,r.z)},multVec2(t){return d(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(K([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(K([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(K([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(K([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(K([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],r=this.m[10]*this.m[15]-this.m[14]*this.m[11],h=this.m[9]*this.m[15]-this.m[13]*this.m[11],m=this.m[9]*this.m[14]-this.m[13]*this.m[10],E=this.m[8]*this.m[15]-this.m[12]*this.m[11],P=this.m[8]*this.m[14]-this.m[12]*this.m[10],_=this.m[8]*this.m[13]-this.m[12]*this.m[9],H=this.m[6]*this.m[15]-this.m[14]*this.m[7],G=this.m[5]*this.m[15]-this.m[13]*this.m[7],A=this.m[5]*this.m[14]-this.m[13]*this.m[6],z=this.m[4]*this.m[15]-this.m[12]*this.m[7],S=this.m[4]*this.m[14]-this.m[12]*this.m[6],b=this.m[5]*this.m[15]-this.m[13]*this.m[7],v=this.m[4]*this.m[13]-this.m[12]*this.m[5],T=this.m[6]*this.m[11]-this.m[10]*this.m[7],N=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],V=this.m[4]*this.m[11]-this.m[8]*this.m[7],U=this.m[4]*this.m[10]-this.m[8]*this.m[6],B=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*r-this.m[6]*h+this.m[7]*m,t[4]=-(this.m[4]*r-this.m[6]*E+this.m[7]*P),t[8]=this.m[4]*h-this.m[5]*E+this.m[7]*_,t[12]=-(this.m[4]*m-this.m[5]*P+this.m[6]*_),t[1]=-(this.m[1]*r-this.m[2]*h+this.m[3]*m),t[5]=this.m[0]*r-this.m[2]*E+this.m[3]*P,t[9]=-(this.m[0]*h-this.m[1]*E+this.m[3]*_),t[13]=this.m[0]*m-this.m[1]*P+this.m[2]*_,t[2]=this.m[1]*H-this.m[2]*G+this.m[3]*A,t[6]=-(this.m[0]*H-this.m[2]*z+this.m[3]*S),t[10]=this.m[0]*b-this.m[1]*z+this.m[3]*v,t[14]=-(this.m[0]*A-this.m[1]*S+this.m[2]*v),t[3]=-(this.m[1]*T-this.m[2]*N+this.m[3]*g),t[7]=this.m[0]*T-this.m[2]*V+this.m[3]*U,t[11]=-(this.m[0]*N-this.m[1]*V+this.m[3]*B),t[15]=this.m[0]*g-this.m[1]*U+this.m[2]*B;let j=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let Y=0;Y<4;Y++)for(let x=0;x<4;x++)t[Y*4+x]*=1/j;return K(t)}}}o(K,"mat4");function st(e,t,r){return e+(Math.sin(r)+1)/2*(t-e)}o(st,"wave");var Ot=1103515245,Nt=12345,rt=2147483648,ot=Ue(Date.now());function Ue(e){return{seed:e,gen(t,r){if(Ne(t)&&Ne(r))return d(this.gen(t.x,r.x),this.gen(t.y,r.y));if(tt(t)&&tt(r))return W(this.gen(t.r,r.r),this.gen(t.g,r.g),this.gen(t.b,r.b),this.gen(t.a,r.a));if(t!==void 0)return r===void 0?this.gen()*t:this.gen()*(r-t)+t;if(t===void 0&&r===void 0)return this.seed=(Ot*this.seed+Nt)%rt,this.seed/rt;throw new Error("invalid param to rand()")}}}o(Ue,"makeRng");function it(e){ot.seed=e}o(it,"randSeed");function ke(e,t){return ot.gen(e,t)}o(ke,"rand");function at(e){return ke(0,1)<=e}o(at,"chance");function ct(e){return e[Math.floor(ke(e.length))]}o(ct,"choose");function Be(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}o(Be,"colRectRect");function ut(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}o(ut,"overlapRectRect");function ht(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}o(ht,"colRectPt");var ze="topleft",De=9,Me=65536,Ut=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,Bt=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,je=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,Xe=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;function Pe(e){switch(e){case"topleft":return d(-1,-1);case"top":return d(0,-1);case"topright":return d(1,-1);case"left":return d(-1,0);case"center":return d(0,0);case"right":return d(1,0);case"botleft":return d(-1,1);case"bot":return d(0,1);case"botright":return d(1,1);default:return e}}o(Pe,"originPt");function dt(e,t){let r=(()=>{var q;let f=m(je,Xe),l=h(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),w=(q=t.clearColor)!=null?q:W(0,0,0,0);e.clearColor(w.r,w.g,w.b,w.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA);let I=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,I),e.bufferData(e.ARRAY_BUFFER,Me*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let X=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,X),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Me*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),{drawCalls:0,defProg:f,curProg:f,defTex:l,curTex:l,vbuf:I,ibuf:X,vqueue:[],iqueue:[],transform:K(),transformStack:[]}})();function h(f){let l=e.createTexture();return e.bindTexture(e.TEXTURE_2D,l),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{width:f.width,height:f.height,bind(){e.bindTexture(e.TEXTURE_2D,l)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}o(h,"makeTex");function m(f=je,l=Xe){let w,I=Ut.replace("{{user}}",f!=null?f:je),X=Bt.replace("{{user}}",l!=null?l:Xe),q=e.createShader(e.VERTEX_SHADER),D=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(q,I),e.shaderSource(D,X),e.compileShader(q),e.compileShader(D),w=e.getShaderInfoLog(q))throw new Error(w);if(w=e.getShaderInfoLog(D))throw new Error(w);let F=e.createProgram();if(e.attachShader(F,q),e.attachShader(F,D),e.bindAttribLocation(F,0,"a_pos"),e.bindAttribLocation(F,1,"a_uv"),e.bindAttribLocation(F,2,"a_color"),e.linkProgram(F),w=e.getProgramInfoLog(F))throw new Error(w);return{bind(){e.useProgram(F)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,De*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,De*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,De*4,20),e.enableVertexAttribArray(2)},sendFloat(R,M){let L=e.getUniformLocation(F,R);e.uniform1f(L,M)},sendVec2(R,M){let L=e.getUniformLocation(F,R);e.uniform2f(L,M.x,M.y)},sendVec3(R,M){let L=e.getUniformLocation(F,R);e.uniform3f(L,M.x,M.y,M.z)},sendColor(R,M){let L=e.getUniformLocation(F,R);e.uniform4f(L,M.r,M.g,M.b,M.a)},sendMat4(R,M){let L=e.getUniformLocation(F,R);e.uniformMatrix4fv(L,!1,new Float32Array(M.m))}}}o(m,"makeProgram");function E(f,l,w,I){let X=f.width/l,q=f.height/w,D=1/X,F=1/q,R={},M=I.split("").entries();for(let[L,ee]of M)R[ee]=d(L%X*D,Math.floor(L/X)*F);return{tex:f,map:R,qw:D,qh:F}}o(E,"makeFont");function P(f,l,w=r.defTex,I=r.defProg){w=w!=null?w:r.defTex,I=I!=null?I:r.defProg,(w!==r.curTex||I!==r.curProg||r.vqueue.length+f.length*De>Me||r.iqueue.length+l.length>Me)&&_(),r.curTex=w,r.curProg=I;let X=l.map(D=>D+r.vqueue.length/De),q=f.map(D=>{let F=z(r.transform.multVec2(D.pos.xy()));return[F.x,F.y,D.pos.z,D.uv.x,D.uv.y,D.color.r,D.color.g,D.color.b,D.color.a]}).flat();X.forEach(D=>r.iqueue.push(D)),q.forEach(D=>r.vqueue.push(D))}o(P,"drawRaw");function _(){!r.curTex||!r.curProg||r.vqueue.length===0||r.iqueue.length===0||(e.bindBuffer(e.ARRAY_BUFFER,r.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(r.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(r.iqueue)),r.curProg.bind(),r.curProg.bindAttribs(),r.curTex.bind(),e.drawElements(e.TRIANGLES,r.iqueue.length,e.UNSIGNED_SHORT,0),r.curTex.unbind(),r.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),r.iqueue=[],r.vqueue=[],r.drawCalls++)}o(_,"flush");function H(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),r.drawCalls=0,r.transformStack=[],r.transform=K()}o(H,"frameStart");function G(){_()}o(G,"frameEnd");function A(){return r.drawCalls}o(A,"drawCalls");function z(f){return d(f.x/Q()*2-1,-f.y/xe()*2+1)}o(z,"toNDC");function S(f){r.transform=f.clone()}o(S,"pushMatrix");function b(f){!f||f.x===0&&f.y===0||(r.transform=r.transform.translate(f))}o(b,"pushTranslate");function v(f){!f||f.x===0&&f.y===0||(r.transform=r.transform.scale(f))}o(v,"pushScale");function T(f){!f||(r.transform=r.transform.rotateX(f))}o(T,"pushRotateX");function N(f){!f||(r.transform=r.transform.rotateY(f))}o(N,"pushRotateY");function g(f){!f||(r.transform=r.transform.rotateZ(f))}o(g,"pushRotateZ");function V(){r.transformStack.push(r.transform.clone())}o(V,"pushTransform");function U(){r.transformStack.length>0&&(r.transform=r.transformStack.pop())}o(U,"popTransform");function B(f={}){var ee,Z;let l=f.width||0,w=f.height||0,I=f.pos||d(0,0),q=Pe(f.origin||ze).dot(d(l,w).scale(-.5)),D=d((ee=f.scale)!=null?ee:1),F=f.rot||0,R=f.quad||se(0,0,1,1),M=1-((Z=f.z)!=null?Z:0),L=f.color||W(1,1,1,1);V(),b(I),v(D),g(F),b(q),P([{pos:we(-l/2,w/2,M),uv:d(R.x,R.y+R.h),color:L},{pos:we(-l/2,-w/2,M),uv:d(R.x,R.y),color:L},{pos:we(l/2,-w/2,M),uv:d(R.x+R.w,R.y),color:L},{pos:we(l/2,w/2,M),uv:d(R.x+R.w,R.y+R.h),color:L}],[0,1,3,1,2,3],f.tex),U()}o(B,"drawQuad");function j(f,l={}){var q;let w=(q=l.quad)!=null?q:se(0,0,1,1),I=f.width*w.w,X=f.height*w.h;B({tex:f,quad:w,width:I,height:X,pos:l.pos,scale:l.scale,rot:l.rot,color:l.color,origin:l.origin,z:l.z})}o(j,"drawTexture");function Y(f,l,w,I={}){B(ne(ne({},I),{pos:f,width:l,height:w}))}o(Y,"drawRect");function x(f,l,w,I={}){let X=Pe(I.origin||ze).dot(d(l,w)).scale(.5),q=f.add(d(-l/2,-w/2)).sub(X),D=f.add(d(-l/2,w/2)).sub(X),F=f.add(d(l/2,w/2)).sub(X),R=f.add(d(l/2,-w/2)).sub(X);C(q,D,I),C(D,F,I),C(F,R,I),C(R,q,I)}o(x,"drawRectStroke");function C(f,l,w={}){let I=w.width||1,X=f.dist(l),q=Math.PI/2-f.angle(l);B(ne(ne({},w),{pos:f.add(l).scale(.5),width:I,height:X,rot:q,origin:"center"}))}o(C,"drawLine");function re(f,l,w={}){let I=(f+"").split(""),X=l.qw*l.tex.width,q=l.qh*l.tex.height,D=w.size||q,F=d(D/q).dot(d(w.scale||1)),R=F.x*X,M=F.y*q,L=0,ee=M,Z=0,pe=[[]];for(let ae of I)(ae===`
`||(w.width?L+R>w.width:!1))&&(ee+=M,L=0,pe.push([])),ae!==`
`&&(pe[pe.length-1].push(ae),L+=R),Z=Math.max(Z,L);w.width&&(Z=w.width);let Ce=[],Ie=d(w.pos),he=Pe(w.origin||ze).scale(.5),de=-he.x*R-(he.x+.5)*(Z-R),ie=-he.y*M-(he.y+.5)*(ee-M);return pe.forEach((ae,ve)=>{let Ge=(Z-ae.length*R)*(he.x+.5);ae.forEach((Re,Le)=>{let _e=l.map[Re],Ve=Le*R,qe=ve*M;_e&&Ce.push({tex:l.tex,quad:se(_e.x,_e.y,l.qw,l.qh),ch:Re,pos:d(Ie.x+Ve+de+Ge,Ie.y+qe+ie),color:w.color,origin:w.origin,scale:F,z:w.z})})}),{width:Z,height:ee,chars:Ce}}o(re,"fmtText");function oe(f,l,w={}){J(re(f,l,w))}o(oe,"drawText");function J(f){for(let l of f.chars)B({tex:l.tex,width:l.tex.width*l.quad.w,height:l.tex.height*l.quad.h,pos:l.pos,scale:l.scale,color:l.color,quad:l.quad,origin:"center",z:l.z})}o(J,"drawFmtText");function Q(){return e.drawingBufferWidth/be()}o(Q,"width");function xe(){return e.drawingBufferHeight/be()}o(xe,"height");function be(){var f;return(f=t.scale)!=null?f:1}return o(be,"scale"),{width:Q,height:xe,scale:be,makeTex:h,makeProgram:m,makeFont:E,drawTexture:j,drawText:oe,drawFmtText:J,drawRect:Y,drawRectStroke:x,drawLine:C,fmtText:re,frameStart:H,frameEnd:G,pushTransform:V,popTransform:U,pushMatrix:S,drawCalls:A}}o(dt,"gfxInit");function ft(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}o(ft,"processBtnState");function mt(e={}){var j,Y;let t={canvas:(j=e.canvas)!=null?j:(()=>{var C;let x=document.createElement("canvas");return((C=e.root)!=null?C:document.body).appendChild(x),x})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:d(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(Y=e.scale)!=null?Y:1,isTouch:!1,loopID:null,stopped:!1},r={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},h=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let m=["outline: none","cursor: default"];e.crisp&&(m.push("image-rendering: pixelated"),m.push("image-rendering: crisp-edges")),t.canvas.style=m.join(";"),t.canvas.setAttribute("tabindex","0");let E=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("contextmenu",x=>{x.preventDefault()}),t.canvas.addEventListener("mousemove",x=>{t.mousePos=d(x.offsetX,x.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",x=>{let C=x.touches[0];t.mousePos=d(C.clientX,C.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",x=>{let C=x.touches[0];t.mousePos=d(C.clientX,C.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",x=>{let C=r[x.key]||x.key.toLowerCase();h.includes(C)&&x.preventDefault(),C.length===1&&t.charInputted.push(C),C==="space"&&t.charInputted.push(" "),x.repeat?t.keyStates[C]="rpressed":t.keyStates[C]="pressed"}),t.canvas.addEventListener("keyup",x=>{let C=r[x.key]||x.key.toLowerCase();t.keyStates[C]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function P(){return t.mousePos.clone()}o(P,"mousePos");function _(){return t.mouseState==="pressed"}o(_,"mouseClicked");function H(){return t.mouseState==="pressed"||t.mouseState==="down"}o(H,"mouseDown");function G(){return t.mouseState==="released"}o(G,"mouseReleased");function A(x){return t.keyStates[x]==="pressed"}o(A,"keyPressed");function z(x){return t.keyStates[x]==="pressed"||t.keyStates[x]==="rpressed"}o(z,"keyPressedRep");function S(x){return t.keyStates[x]==="pressed"||t.keyStates[x]==="rpressed"||t.keyStates[x]==="down"}o(S,"keyDown");function b(x){return t.keyStates[x]==="released"}o(b,"keyReleased");function v(){return[...t.charInputted]}o(v,"charInputted");function T(){return t.dt}o(T,"dt");function N(){return t.time}o(N,"time");function g(){return t.canvas.toDataURL()}o(g,"screenshot");function V(x){return x&&(t.canvas.style.cursor=x!=null?x:"default"),t.canvas.style.cursor}o(V,"cursor");function U(x){let C=o(re=>{let oe=re/1e3,J=oe-t.realTime;t.realTime=oe,t.skipTime||(t.dt=J,t.time+=t.dt),t.skipTime=!1,x();for(let Q in t.keyStates)t.keyStates[Q]=ft(t.keyStates[Q]);t.mouseState=ft(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(C))},"frame");t.loopID=requestAnimationFrame(C)}o(U,"run");function B(){cancelAnimationFrame(t.loopID),t.stopped=!0}return o(B,"quit"),{gl:E,mousePos:P,keyDown:S,keyPressed:A,keyPressedRep:z,keyReleased:b,mouseDown:H,mouseClicked:_,mouseReleased:G,charInputted:v,cursor:V,dt:T,time:N,screenshot:g,run:U,quit:B}}o(mt,"appInit");var lt=0,pt=3,zt=0,jt=3,Xt=-1200,Yt=1200;function yt(){let e=(()=>{let m=new(window.AudioContext||window.webkitAudioContext),E=m.createGain(),P=E;return P.connect(m.destination),{ctx:m,gainNode:E,masterNode:P}})();function t(m){return m!==void 0&&(e.gainNode.gain.value=ue(m,lt,pt)),e.gainNode.gain.value}o(t,"volume");function r(m,E={loop:!1,volume:1,speed:1,detune:0,seek:0}){var b;let P=!1,_=e.ctx.createBufferSource();_.buffer=m,_.loop=!!E.loop;let H=e.ctx.createGain();_.connect(H),H.connect(e.masterNode);let G=(b=E.seek)!=null?b:0;_.start(0,G);let A=e.ctx.currentTime-G,z=null,S={stop(){_.stop(),P=!0,z=e.ctx.currentTime},play(v){if(!P)return;let T=_;_=e.ctx.createBufferSource(),_.buffer=T.buffer,_.loop=T.loop,_.playbackRate.value=T.playbackRate.value,_.detune&&(_.detune.value=T.detune.value),_.connect(H);let N=v!=null?v:this.time();_.start(0,N),A=e.ctx.currentTime-N,P=!1,z=null},pause(){this.stop()},paused(){return P},stopped(){return P},speed(v){return v!==void 0&&(_.playbackRate.value=ue(v,zt,jt)),_.playbackRate.value},detune(v){return _.detune?(v!==void 0&&(_.detune.value=ue(v,Xt,Yt)),_.detune.value):0},volume(v){return v!==void 0&&(H.gain.value=ue(v,lt,pt)),H.gain.value},loop(){_.loop=!0},unloop(){_.loop=!1},duration(){return m.duration},time(){return P&&z?z-A:e.ctx.currentTime-A}};return S.speed(E.speed),S.detune(E.detune),S.volume(E.volume),S}o(r,"play");function h(){return e.ctx}return o(h,"ctx"),{ctx:h,volume:t,play:r}}o(yt,"audioInit");var wt="data:image/png;base64,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";var Ht=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ge="unscii";function gt(e){let t=new Image;return t.src=e,new Promise((r,h)=>{t.onload=()=>{r(t)},t.onerror=()=>{h(`failed to load ${e}`)}})}o(gt,"loadImg");function xt(e){return e.startsWith("data:")}o(xt,"isDataUrl");function bt(e,t,r={}){let h={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function m(S){var v;let b=h.lastLoaderID;h.loaders[b]=!1,h.lastLoaderID++,S.catch((v=r.errHandler)!=null?v:console.error).finally(()=>{h.loaders[b]=!0})}o(m,"addLoader");function E(){let S=0,b=0;for(let v in h.loaders)S+=1,h.loaders[v]&&(b+=1);return b/S}o(E,"loadProgress");function P(S){return S&&(h.loadRoot=S),h.loadRoot}o(P,"loadRoot");function _(S,b,v,T,N=Ht){let g=new Promise((V,U)=>{let B=xt(b)?b:h.loadRoot+b;gt(B).then(j=>{let Y=e.makeFont(e.makeTex(j),v,T,N);h.fonts[S]=Y,V(Y)}).catch(U)});return m(g),g}o(_,"loadFont");function H(S,b,v={sliceX:1,sliceY:1,anims:{}}){function T(g,V,U={sliceX:1,sliceY:1,anims:{}}){let B=[],j=e.makeTex(V),Y=U.sliceX||1,x=U.sliceY||1,C=1/Y,re=1/x;for(let J=0;J<x;J++)for(let Q=0;Q<Y;Q++)B.push(se(Q*C,J*re,C,re));let oe={tex:j,frames:B,anims:U.anims||{}};return h.sprites[g]=oe,oe}o(T,"loadRawSprite");let N=new Promise((g,V)=>{if(typeof b=="string"){let U=xt(b)?b:h.loadRoot+b;gt(U).then(B=>{g(T(S,B,v))}).catch(V);return}else g(T(S,b,v))});return m(N),N}o(H,"loadSprite");function G(S,b,v,T=!1){function N(V,U,B){let j=e.makeProgram(U,B);return h.shaders[V]=j,j}o(N,"loadRawShader");let g=new Promise((V,U)=>{if(!b&&!v)return U("no shader");function B(j){return j?fetch(h.loadRoot+j).then(Y=>{if(Y.ok)return Y.text();throw new Error(`failed to load ${j}`)}).catch(U):new Promise(Y=>Y(null))}if(o(B,"resolveUrl"),T)Promise.all([B(b),B(v)]).then(([j,Y])=>{V(N(S,j,Y))}).catch(U);else try{V(N(S,b,v))}catch(j){U(j)}});return m(g),g}o(G,"loadShader");function A(S,b){let v=h.loadRoot+b,T=new Promise((N,g)=>{typeof b=="string"&&fetch(v).then(V=>{if(V.ok)return V.arrayBuffer();throw new Error(`failed to load ${v}`)}).then(V=>new Promise((U,B)=>{t.ctx().decodeAudioData(V,U,B)})).then(V=>{h.sounds[S]=V,N(V)}).catch(g)});return m(T),T}o(A,"loadSound");function z(){return h.fonts[ge]}return o(z,"defFont"),_(ge,wt,8,8),{loadRoot:P,loadSprite:H,loadSound:A,loadFont:_,loadShader:G,loadProgress:E,addLoader:m,defFont:z,sprites:h.sprites,fonts:h.fonts,sounds:h.sounds,shaders:h.shaders}}o(bt,"assetsInit");var Wt=16;function vt(e,t,r={max:8}){var G;let h=[],m=(G=r.max)!=null?G:8;function E(){h.length>m&&(h=h.slice(0,m));let A=d(0,e.height());h.forEach((z,S)=>{let b=Ae(S,0,m,1,.2),v=Ae(S,0,m,.8,.2),T=(()=>{switch(z.type){case"info":return W(1,1,1,b);case"error":return W(1,0,.5,b)}})(),N=e.fmtText(z.msg,t.defFont(),{pos:A,origin:"botleft",color:T,z:1,size:Wt/e.scale(),width:e.width()});e.drawRect(A,N.width,N.height,{origin:"botleft",color:W(0,0,0,v),z:1}),e.drawFmtText(N),A.y-=N.height})}o(E,"draw");function P(A){console.error(A),h.unshift({type:"error",msg:A})}o(P,"error");function _(A){console.log(A),h.unshift({type:"info",msg:A})}o(_,"info");function H(){h=[]}return o(H,"clear"),{info:_,error:P,draw:E,clear:H}}o(vt,"loggerInit");function Rt(e){let t={},r=[],h=null;function m(){return h!==null&&h.readyState===1}o(m,"connected");function E(){let G=new WebSocket(e);return new Promise((A,z)=>{G.onopen=()=>{A(G),h=G;for(let S of r)G.send(S)},G.onerror=()=>{z(`failed to connect to ${e}`)},G.onmessage=S=>{let b=JSON.parse(S.data);if(t[b.type])for(let v of t[b.type])v(b.data,b.id)}})}o(E,"connect");function P(G,A){t[G]||(t[G]=[]),t[G].push(A)}o(P,"recv");function _(G,A){let z=JSON.stringify({type:G,data:A});h?h.send(z):r.push(z)}o(_,"send");function H(){h&&h.close()}return o(H,"close"),{connect:E,close:H,connected:m,recv:P,send:_}}o(Rt,"netInit");module.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{var He;let t=mt({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),r=dt(t.gl,{clearColor:(s=>W(s[0],s[1],s[2],s[3]))((He=e.clearColor)!=null?He:[0,0,0,1]),scale:e.scale}),h=yt(),m=bt(r,h,{errHandler:s=>{E.error(s)}}),E=vt(r,m,{max:e.logMax}),P=(()=>e.connect?Rt(e.connect):null)();function _(s,n){if(!P)throw new Error("not connected to any websockets");P.recv(s,(a,i)=>{try{n(a,i)}catch(c){E.error(c)}})}o(_,"recv");function H(s,n){if(!P)throw new Error("not connected to any websockets");P.send(s,n)}o(H,"send");function G(s,n={}){let a=m.sounds[s];if(!a)throw new Error(`sound not found: "${s}"`);return h.play(a,n)}o(G,"play");function A(s){let n=g();return s?n.cam.ignore.includes(s)?A():n.cam.mpos:t.mousePos()}o(A,"mousePos");function z(s,n={}){var c;let a=(()=>typeof s=="string"?m.sprites[s]:s)();if(!a)throw new Error(`sprite not found: "${s}"`);let i=a.frames[(c=n.frame)!=null?c:0];r.drawTexture(a.tex,ne(ne({},n),{quad:i}))}o(z,"drawSprite");function S(s,n={}){var c;let a=(c=n.font)!=null?c:ge,i=m.fonts[a];if(!i)throw new Error(`font not found: ${a}`);r.drawText(s,i,n)}o(S,"drawText");let b=980,v="topleft",T={loaded:!1,scenes:{},curScene:null,nextScene:null};function N(s,n){T.scenes[s]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:d(r.width()/2,r.height()/2),scale:d(1,1),angle:0,shake:0,ignore:[],mpos:d(0),matrix:K()},layers:{},defLayer:null,gravity:b,data:{}}}o(N,"scene");function g(){return T.scenes[T.curScene]}o(g,"curScene");function V(){return g().data}o(V,"sceneData");function U(){L("`",()=>{$.showLog=!$.showLog,E.info(`show log: ${$.showLog?"on":"off"}`)}),L("f1",()=>{$.inspect=!$.inspect,E.info(`inspect: ${$.inspect?"on":"off"}`)}),L("f2",()=>{$.clearLog()}),L("f8",()=>{$.paused=!$.paused,E.info(`${$.paused?"paused":"unpaused"}`)}),L("f7",()=>{$.timeScale=ue($.timeScale-.2,0,2),E.info(`time scale: ${$.timeScale.toFixed(1)}`)}),L("f9",()=>{$.timeScale=ue($.timeScale+.2,0,2),E.info(`time scale: ${$.timeScale.toFixed(1)}`)}),L("f10",()=>{$.stepFrame(),E.info("stepped frame")})}o(U,"regDebugInputs");function B(s,...n){T.nextScene={name:s,args:[...n]}}o(B,"go");function j(s,...n){Y(s),T.curScene=s;let a=T.scenes[s];if(!a)throw new Error(`scene not found: '${s}'`);if(!a.initialized){try{a.init(...n)}catch(i){E.error(i.stack)}e.debug&&U(),a.initialized=!0}}o(j,"goSync");function Y(s){if(!T.scenes[s])throw new Error(`scene not found: '${s}'`);N(s,T.scenes[s].init)}o(Y,"reload");function x(s,n){let a=g();if(!a)return;let i=.5/s.length;s.forEach((c,p)=>{a.layers[c]=.5+i*p}),n&&(a.defLayer=n)}o(x,"layers");function C(...s){let n=g().cam;return s.length>0&&(n.pos=d(...s)),n.pos.clone()}o(C,"camPos");function re(...s){let n=g().cam;return s.length>0&&(n.scale=d(...s)),n.scale.clone()}o(re,"camScale");function oe(s){let n=g().cam;return s!==void 0&&(n.angle=s),n.angle}o(oe,"camRot");function J(s){let n=g().cam;n.shake=s}o(J,"camShake");function Q(s){let n=g().cam;n.ignore=s}o(Q,"camIgnore");function xe(s){let n={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(i){if(i===void 0)return;let c=typeof i;if(c==="string"){this._tags.push(i);return}if(c!=="object")throw new Error(`invalid comp type: ${c}`);if(Array.isArray(i)){for(let p of i)this.use(p);return}for(let p in i){if(typeof i[p]=="function"){this._events[p]?this._events[p].push(i[p].bind(this)):this[p]=i[p].bind(this);continue}this[p]=i[p]}},exists(){return this._sceneID!==void 0},is(i){if(i==="*")return!0;if(Array.isArray(i)){for(let c of i)if(!this._tags.includes(c))return!1;return!0}return this._tags.includes(i)},on(i,c){this._events[i]||(this._events[i]=[]),this._events[i].push(c)},action(i){this.on("update",i)},trigger(i,...c){if(this._events[i])for(let y of this._events[i])y.call(this,...c);let u=g().events[i];if(u)for(let y of u)this.is(y.tag)&&y.cb(this,...c)},rmTag(i){let c=this._tags.indexOf(i);c>-1&&this._tags.splice(c,1)}};n.use(s);let a=g();a.objs.set(a.lastID,n),n._sceneID=a.lastID,a.lastID++,n.trigger("add");for(let i of a.events.add)n.is(i.tag)&&i.cb(n);return n}o(xe,"add");function be(s){if(!s.exists())return;let n=g();return n.objs.delete(s._sceneID),n.objs.set(n.lastID,s),s._sceneID=n.lastID,n.lastID++,s}o(be,"readd");function f(s,n,a){let i=g();i.events[s]||(i.events[s]=[]),i.events[s].push({tag:n,cb:a})}o(f,"on");function l(s,n){typeof s=="function"&&n===void 0?g().action.push(s):typeof s=="string"&&f("update",s,n)}o(l,"action");function w(s,n){typeof s=="function"&&n===void 0?g().render.push(s):typeof s=="string"&&f("update",s,n)}o(w,"render");function I(s,n,a){l(s,i=>{i._checkCollisions(n,c=>{a(i,c)})})}o(I,"collides");function X(s,n,a){l(s,i=>{i._checkOverlaps(n,c=>{a(i,c)})})}o(X,"overlaps");function q(s,n){l(s,a=>{a.isClicked()&&n(a)})}o(q,"clicks");function D(s,n){return new Promise(a=>{let i=g();i.timers[i.lastTimerID++]={time:s,cb:()=>{n&&n(),a(null)}}})}o(D,"wait");function F(s,n){let a=!1,i=o(()=>{a||(n(),D(s,i))},"newF");return i(),{stop(){a=!0}}}o(F,"loop");function R(s,n,a){if(Array.isArray(n))for(let i of n)R(s,i,a);else g().events[s].push({key:n,cb:a})}o(R,"pushKeyEvent");function M(s,n){R("keyDown",s,n)}o(M,"keyDown");function L(s,n){R("keyPress",s,n)}o(L,"keyPress");function ee(s,n){R("keyPressRep",s,n)}o(ee,"keyPressRep");function Z(s,n){R("keyRelease",s,n)}o(Z,"keyRelease");function pe(s){g().events.charInput.push({cb:s})}o(pe,"charInput");function Ce(s){g().events.mouseDown.push({cb:s})}o(Ce,"mouseDown");function Ie(s){g().events.mouseClick.push({cb:s})}o(Ie,"mouseClick");function he(s){g().events.mouseRelease.push({cb:s})}o(he,"mouseRelease");function de(s){let a=[...g().objs.values()];return s?a.filter(i=>i.is(s)):a}o(de,"get");function ie(s,n){typeof s=="function"&&n===void 0?de().forEach(s):typeof s=="string"&&de(s).forEach(n)}o(ie,"every");function ae(s,n){typeof s=="function"&&n===void 0?de().reverse().forEach(s):typeof s=="string"&&de(s).reverse().forEach(n)}o(ae,"revery");function ve(s){if(!s.exists())return;let n=g();!n||(s.trigger("destroy"),n.objs.delete(s._sceneID),delete s._sceneID)}o(ve,"destroy");function Ge(s){ie(s,n=>{ve(n)})}o(Ge,"destroyAll");function Re(s){let n=g();return s!==void 0&&(n.gravity=s),n.gravity}o(Re,"gravity");function Le(s){let n=g();if(!n)throw new Error(`scene not found: '${T.curScene}'`);let a=s||!$.paused;if(a)for(let u in n.timers){let y=n.timers[u];y.time-=t.dt(),y.time<=0&&(y.cb(),delete n.timers[u])}if(ae(u=>{!u.paused&&a&&u.trigger("update")}),a)for(let u of n.action)u();let i=d(r.width(),r.height()),c=n.cam,p=et(ke(0,Math.PI*2)).scale(c.shake);c.shake=Se(c.shake,0,5*t.dt()),c.matrix=K().translate(i.scale(.5)).scale(c.scale).rotateZ(c.angle).translate(i.scale(-.5)).translate(c.pos.scale(-1).add(i.scale(.5)).add(p)),c.mpos=c.matrix.invert().multVec2(A()),ie(u=>{u.hidden||(r.pushTransform(),c.ignore.includes(u.layer)||r.pushMatrix(c.matrix),u.trigger("draw"),r.popTransform())});for(let u of n.render)u()}o(Le,"gameFrame");function _e(){let s=g();for(let n of s.events.charInput)t.charInputted().forEach(n.cb);for(let n of s.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of s.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of s.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of s.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of s.events.mouseDown)t.mouseDown()&&n.cb();for(let n of s.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of s.events.mouseRelease)t.mouseReleased()&&n.cb()}o(_e,"handleEvents");function Ve(){ie(s=>{var O;if(!s.area||s.hidden)return;r.pushTransform();let n=g();n.cam.ignore.includes(s.layer)||r.pushMatrix(n.cam.matrix);let a=m.defFont(),i=W(0,1,1,1),c=s.isHovered(),p=(c?4:2)/r.scale(),u=s._worldArea(),y=u.p2.x-u.p1.x,k=u.p2.y-u.p1.y;if(r.drawRectStroke(u.p1,y,k,{width:p,color:i,z:.9}),c){let te=A((O=s.layer)!=null?O:n.defLayer),ce=d(6,6).scale(1/r.scale()),fe=0,ye=0,We=[],Ke=o(me=>{var Te;let le=r.fmtText(me,a,{size:12/((Te=e.scale)!=null?Te:1),pos:te.add(d(ce.x,ce.y+ye)),z:1});We.push(le),fe=le.width>fe?le.width:fe,ye+=le.height},"addLine");for(let me of s._tags)Ke(`"${me}"`);for(let me of s._events.inspect){let le=me();for(let Te in le)Ke(`${Te}: ${le[Te]}`)}fe+=ce.x*2,ye+=ce.y*2,r.drawRect(te,fe,ye,{color:W(0,0,0,1),z:1});for(let me of We)r.drawFmtText(me)}r.popTransform()})}o(Ve,"drawInspect");function qe(s,...n){t.run(()=>{if(r.frameStart(),T.loaded){try{if(!g())throw new Error(`scene not found: '${T.curScene}'`);_e(),Le(),$.inspect&&Ve()}catch(a){E.error(a.stack),t.quit()}$.showLog&&E.draw(),T.nextScene&&(j.apply(null,[T.nextScene.name,...T.nextScene.args]),T.nextScene=null)}else{let a=m.loadProgress();if(a===1)T.loaded=!0,j(s,...n),P&&P.connect().catch(E.error);else{let i=r.width()/2,c=12,p=d(r.width()/2,r.height()/2).sub(d(i/2,c/2));r.drawRectStroke(p,i,c,{width:2}),r.drawRect(p,i*a,c)}}r.frameEnd()})}o(qe,"start");function Ye(...s){return{pos:d(...s),move(...n){let a=d(...n),i=a.x*t.dt(),c=a.y*t.dt();this.pos.x+=i,this.pos.y+=c},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}o(Ye,"pos");function _t(...s){return{scale:d(...s),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}o(_t,"scale");function Et(s){return{angle:s}}o(Et,"rotate");function Tt(...s){return{color:W(...s)}}o(Tt,"color");function St(s){return{origin:s}}o(St,"origin");function At(s){return{layer:s,inspect(){var a;let n=g();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}o(At,"layer");function Oe(s,n){var i,c;let a=g();return((i=s.layer)!=null?i:a.defLayer)===((c=n.layer)!=null?c:a.defLayer)}o(Oe,"isSameLayer");function $e(s,n){let a={},i={};return{area:{p1:s,p2:n},areaWidth(){let{p1:c,p2:p}=this._worldArea();return p.x-c.x},areaHeight(){let{p1:c,p2:p}=this._worldArea();return p.y-c.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){var c;return this.hasPt(A((c=this.layer)!=null?c:g().defLayer))},isCollided(c){if(!c.area||!Oe(this,c))return!1;let p=this._worldArea(),u=c._worldArea();return Be(p,u)},isOverlapped(c){if(!c.area||!Oe(this,c))return!1;let p=this._worldArea(),u=c._worldArea();return ut(p,u)},clicks(c){this.action(()=>{this.isClicked()&&c()})},hovers(c){this.action(()=>{this.isHovered()&&c()})},collides(c,p){this.action(()=>{this._checkCollisions(c,p)})},overlaps(c,p){this.action(()=>{this._checkOverlaps(c,p)})},hasPt(c){let p=this._worldArea();return ht({p1:p.p1,p2:p.p2},c)},resolve(){let c=[];return ie(p=>{if(p===this||!p.solid||!p.area||!Oe(this,p))return;let u=this._worldArea(),y=p._worldArea();if(!Be(u,y))return;let k=u.p2.x-y.p1.x,O=y.p2.x-u.p1.x,te=u.p2.y-y.p1.y,ce=y.p2.y-u.p1.y,fe=Math.min(k,O,te,ce),ye=(()=>{switch(fe){case k:return this.pos.x-=k,"right";case O:return this.pos.x+=O,"left";case te:return this.pos.y-=te,"bottom";case ce:return this.pos.y+=ce,"top"}})();c.push({obj:p,side:ye})}),c},_checkCollisions(c,p){ie(c,u=>{this!==u&&(a[u._sceneID]||this.isCollided(u)&&(p(u),a[u._sceneID]=u))});for(let u in a){let y=a[u];this.isCollided(y)||delete a[u]}},_checkOverlaps(c,p){ie(c,u=>{this!==u&&(i[u._sceneID]||this.isOverlapped(u)&&(p(u),i[u._sceneID]=u))});for(let u in i){let y=i[u];this.isOverlapped(y)||delete i[u]}},_worldArea(){let c=this.area,p=this.pos||d(0),u=this.scale||d(1),y=p.add(c.p1.dot(u)),k=p.add(c.p2.dot(u));return{p1:d(Math.min(y.x,k.x),Math.min(y.y,k.y)),p2:d(Math.max(y.x,k.x),Math.max(y.y,k.y))}}}}o($e,"area");function Fe(s,n,a){let i=d(s,n),c=Pe(a||v).dot(i).scale(-.5);return $e(c.sub(i.scale(.5)),c.add(i.scale(.5)))}o(Fe,"getAreaFromSize");function kt(s,n={}){let a=m.sprites[s];if(!a)throw new Error(`sprite not found: "${s}"`);let i=ne({},a.frames[0]);n.quad&&(i.x+=n.quad.x*i.w,i.y+=n.quad.y*i.h,i.w*=n.quad.w,i.h*=n.quad.h);let c=a.tex.width*i.w,p=a.tex.height*i.h,u=null;return{width:c,height:p,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||se(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var O;let y=g(),k=a.frames[this.frame];z(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,z:y.layers[(O=this.layer)!=null?O:y.defLayer]})},update(){if(!u)return;let y=a.anims[u.name];u.timer+=t.dt(),u.timer>=this.animSpeed&&(this.frame++,this.frame>y.to&&(u.loop?this.frame=y.from:(this.frame--,this.stop())),u.timer-=this.animSpeed)},play(y,k=!0){let O=a.anims[y];if(!O)throw new Error(`anim not found: ${y}`);u&&this.stop(),u={name:y,loop:k,timer:0},this.frame=O.from,this.trigger("animPlay",y)},stop(){if(!u)return;let y=u.name;u=null,this.trigger("animEnd",y)},changeSprite(y){if(a=m.sprites[y],!a)throw new Error(`sprite not found: "${y}"`);let k=ne({},a.frames[0]);n.quad&&(k.x+=n.quad.x*k.w,k.y+=n.quad.y*k.h,k.w*=n.quad.w,k.h*=n.quad.h),this.width=a.tex.width*k.w,this.height=a.tex.height*k.h,this.area&&!n.noArea&&this.use(Fe(this.width,this.height,this.origin)),u=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return u==null?void 0:u.name},inspect(){let y={};return u&&(y.curAnim=`"${u.name}"`),y}}}o(kt,"sprite");function Dt(s,n,a={}){return{text:s,textSize:n,font:a.font,width:0,height:0,add(){var i,c,p,u;if(!this.area&&!a.noArea){let y=g(),k=m.fonts[(i=this.font)!=null?i:ge],O=r.fmtText(this.text+"",k,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:y.layers[(c=this.layer)!=null?c:y.defLayer]});this.width=O.width/(((p=this.scale)==null?void 0:p.x)||1),this.height=O.height/(((u=this.scale)==null?void 0:u.y)||1),this.use(Fe(this.width,this.height,this.origin))}},draw(){var u,y;let i=g(),c=m.fonts[(u=this.font)!=null?u:ge],p=r.fmtText(this.text+"",c,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:i.layers[(y=this.layer)!=null?y:i.defLayer]});this.width=p.width,this.height=p.height,r.drawFmtText(p)}}}o(Dt,"text");function Pt(s,n,a={}){return{width:s,height:n,add(){!this.area&&!a.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var c;let i=g();r.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:i.layers[(c=this.layer)!=null?c:i.defLayer]})}}}o(Pt,"rect");function Ct(){return{solid:!0}}o(Ct,"solid");let It=960,Lt=480;function Ft(s={}){var p,u;let n=0,a=null,i=null,c=(p=s.maxVel)!=null?p:It;return{jumpForce:(u=s.jumpForce)!=null?u:Lt,update(){this.move(0,n);let y=this.resolve(),k=!1;if(a&&(!a.exists()||!this.isCollided(a)?(a=null,i=null,k=!0):i&&(this.pos=this.pos.add(a.pos.sub(i)),i=a.pos.clone())),!a){n=Math.min(n+Re()*t.dt(),c);for(let O of y)O.side==="bottom"&&n>0?(a=O.obj,n=0,i=a.pos.clone(),k||this.trigger("grounded",a)):O.side==="top"&&n<0&&(n=0,this.trigger("headbump",O.obj))}},curPlatform(){return a},grounded(){return a!==null},jump(y){a=null,n=-y||-this.jumpForce}}}o(Ft,"body");function Mt(s){let n=m.shaders[s];return{sendVec2(a,i){n.sendVec2(a,i)},sendVec3(a,i){n.sendVec3(a,i)},sendColor(a,i){n.sendColor(a,i)},sendMat4(a,i){n.sendMat4(a,i)}}}o(Mt,"shader");let $={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return g().objs.size},stepFrame(){Le(!0)},drawCalls:r.drawCalls,clearLog:E.clear,log:E.info,error:E.error};function Gt(s,n){let a=[],i=d(n.pos),c=0,p={getPos(...u){let y=d(...u);return d(i.x+y.x*n.width,i.y+y.y*n.height)},spawn(u,y){let k=(()=>{if(Array.isArray(u))return u;if(n[u]){if(typeof n[u]=="function")return n[u]();if(Array.isArray(n[u]))return[...n[u]]}else return n.any?n.any(u):[]})();k.push(Ye(i.x+y.x*n.width,i.y+y.y*n.height));let O=xe(k);return a.push(O),O.use({gridPos:y.clone(),setGridPos(te){this.gridPos=te.clone(),this.pos=d(i.x+this.gridPos.x*n.width,i.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(d(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(d(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(d(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(d(0,1)))}}),O},width(){return c*n.width},height(){return s.length*n.height},destroy(){for(let u of a)ve(u)}};return s.forEach((u,y)=>{let k=u.split("");c=Math.max(k.length,c),k.forEach((O,te)=>{p.spawn(O,d(te,y))})}),p}o(Gt,"addLevel");let Ee={start:qe,loadRoot:m.loadRoot,loadSprite:m.loadSprite,loadSound:m.loadSound,loadFont:m.loadFont,loadShader:m.loadShader,addLoader:m.addLoader,width:r.width,height:r.height,dt:t.dt,time:t.time,screenshot:t.screenshot,scene:N,go:B,sceneData:V,layers:x,camPos:C,camScale:re,camRot:oe,camShake:J,camIgnore:Q,gravity:Re,add:xe,readd:be,destroy:ve,destroyAll:Ge,get:de,every:ie,revery:ae,send:H,recv:_,pos:Ye,scale:_t,rotate:Et,color:Tt,origin:St,layer:At,area:$e,sprite:kt,text:Dt,rect:Pt,solid:Ct,body:Ft,shader:Mt,on:f,action:l,render:w,collides:I,overlaps:X,clicks:q,keyDown:M,keyPress:L,keyPressRep:ee,keyRelease:Z,charInput:pe,mouseDown:Ce,mouseClick:Ie,mouseRelease:he,mousePos:A,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:F,wait:D,play:G,volume:h.volume,makeRng:Ue,rand:ke,randSeed:it,vec2:d,rgb:nt,rgba:W,quad:se,choose:ct,chance:at,lerp:Se,map:Ae,wave:st,drawSprite:z,drawText:S,drawRect:r.drawRect,drawRectStroke:r.drawRectStroke,drawLine:r.drawLine,debug:$,addLevel:Gt};if(e.plugins)for(let s of e.plugins){let n=s(Ee);for(let a in n)Ee[a]=n[a]}if(e.global)for(let s in Ee)window[s]=Ee[s];return Ee};
//# sourceMappingURL=kaboom.cjs.map
