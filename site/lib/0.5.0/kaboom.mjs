var at=Object.defineProperty,un=Object.defineProperties;var cn=Object.getOwnPropertyDescriptors;var ut=Object.getOwnPropertySymbols;var dn=Object.prototype.hasOwnProperty,hn=Object.prototype.propertyIsEnumerable;var ct=(e,t,o)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,de=(e,t)=>{for(var o in t||(t={}))dn.call(t,o)&&ct(e,o,t[o]);if(ut)for(var o of ut(t))hn.call(t,o)&&ct(e,o,t[o]);return e},we=(e,t)=>un(e,cn(t));var r=(e,t)=>at(e,"name",{value:t,configurable:!0});var ae=(e,t)=>()=>(e&&(t=e(e=0)),t),fn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);function dt(e){return e*Math.PI/180}function ht(e){return e*180/Math.PI}function ie(e,t,o){return t>o?ie(e,o,t):Math.min(Math.max(e,t),o)}function Ie(e,t,o){return e+(t-e)*o}function ve(e,t,o,i,l){return i+(e-t)/(o-t)*(l-i)}function ft(e,t,o,i,l){return ie(ve(e,t,o,i,l),i,l)}function f(...e){if(e.length===0)return f(0,0);if(e.length===1){if(typeof e[0]=="number")return f(e[0],e[0]);if(Re(e[0]))return f(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return f.apply(null,e[0])}return{x:e[0],y:e[1],clone(){return f(this.x,this.y)},add(...t){let o=f(...t);return f(this.x+o.x,this.y+o.y)},sub(...t){let o=f(...t);return f(this.x-o.x,this.y-o.y)},scale(t){return f(this.x*t,this.y*t)},dist(...t){let o=f(...t);return Math.sqrt((this.x-o.x)*(this.x-o.x)+(this.y-o.y)*(this.y-o.y))},len(){return this.dist(f(0,0))},unit(){return this.scale(1/this.len())},normal(){return f(this.y,-this.x)},dot(...t){let o=f(...t);return f(this.x*o.x,this.y*o.y)},angle(...t){let o=f(...t);return Math.atan2(this.y-o.y,this.x-o.x)},lerp(t,o){return f(Ie(this.x,t.x,o),Ie(this.y,t.y,o))},eq(t){return this.x===t.x&&this.y===t.y},str(){return`(${this.x}, ${this.y})`}}}function lt(e){return f(Math.cos(e),Math.sin(e))}function Te(e,t,o){return{x:e,y:t,z:o,xy(){return f(this.x,this.y)}}}function Re(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}function mt(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0&&e.z!==void 0}function ye(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}function pt(e){if(e!==void 0&&Array.isArray(e.m)&&e.m.length===16)return e}function je(...e){if(e.length===0)return X();if(e.length===1){if(ye(e[0]))return X(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return je.apply(null,e[0])}return X(e[0],e[1],e[2],1)}function X(...e){var t;if(e.length===0)return X(1,1,1,1);if(e.length===1){if(ye(e[0]))return X(e[0].r,e[0].g,e[0].b,e[0].a);if(Array.isArray(e[0])&&e[0].length===4)return X.apply(null,e[0])}return{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return X(this.r,this.g,this.b,this.a)},lighten(o){return X(this.r+o,this.g+o,this.b+o,this.a)},darken(o){return this.lighten(-o)},invert(){return X(1-this.r,1-this.g,1-this.b,this.a)},isDark(o=.5){return this.r+this.g+this.b<3*o},isLight(o=.5){return this.r+this.g+this.b>3*o},eq(o){return this.r===o.r&&this.g===o.g&&this.b===o.g&&this.a===o.a}}}function ne(e,t,o,i){return{x:e,y:t,w:o,h:i,clone(){return ne(this.x,this.y,this.w,this.h)},eq(l){return this.x===l.x&&this.y===l.y&&this.w===l.w&&this.h===l.h}}}function Z(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return Z(this.m)},mult(t){let o=[];for(let i=0;i<4;i++)for(let l=0;l<4;l++)o[i*4+l]=this.m[0*4+l]*t.m[i*4+0]+this.m[1*4+l]*t.m[i*4+1]+this.m[2*4+l]*t.m[i*4+2]+this.m[3*4+l]*t.m[i*4+3];return Z(o)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let o=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return Te(o.x,o.y,o.z)},multVec2(t){return f(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(Z([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(Z([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(Z([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(Z([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(Z([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],o=this.m[10]*this.m[15]-this.m[14]*this.m[11],i=this.m[9]*this.m[15]-this.m[13]*this.m[11],l=this.m[9]*this.m[14]-this.m[13]*this.m[10],v=this.m[8]*this.m[15]-this.m[12]*this.m[11],_=this.m[8]*this.m[14]-this.m[12]*this.m[10],R=this.m[8]*this.m[13]-this.m[12]*this.m[9],Y=this.m[6]*this.m[15]-this.m[14]*this.m[7],k=this.m[5]*this.m[15]-this.m[13]*this.m[7],P=this.m[5]*this.m[14]-this.m[13]*this.m[6],B=this.m[4]*this.m[15]-this.m[12]*this.m[7],T=this.m[4]*this.m[14]-this.m[12]*this.m[6],w=this.m[5]*this.m[15]-this.m[13]*this.m[7],E=this.m[4]*this.m[13]-this.m[12]*this.m[5],N=this.m[6]*this.m[11]-this.m[10]*this.m[7],U=this.m[5]*this.m[11]-this.m[9]*this.m[7],C=this.m[5]*this.m[10]-this.m[9]*this.m[6],G=this.m[4]*this.m[11]-this.m[8]*this.m[7],b=this.m[4]*this.m[10]-this.m[8]*this.m[6],$=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*o-this.m[6]*i+this.m[7]*l,t[4]=-(this.m[4]*o-this.m[6]*v+this.m[7]*_),t[8]=this.m[4]*i-this.m[5]*v+this.m[7]*R,t[12]=-(this.m[4]*l-this.m[5]*_+this.m[6]*R),t[1]=-(this.m[1]*o-this.m[2]*i+this.m[3]*l),t[5]=this.m[0]*o-this.m[2]*v+this.m[3]*_,t[9]=-(this.m[0]*i-this.m[1]*v+this.m[3]*R),t[13]=this.m[0]*l-this.m[1]*_+this.m[2]*R,t[2]=this.m[1]*Y-this.m[2]*k+this.m[3]*P,t[6]=-(this.m[0]*Y-this.m[2]*B+this.m[3]*T),t[10]=this.m[0]*w-this.m[1]*B+this.m[3]*E,t[14]=-(this.m[0]*P-this.m[1]*T+this.m[2]*E),t[3]=-(this.m[1]*N-this.m[2]*U+this.m[3]*C),t[7]=this.m[0]*N-this.m[2]*G+this.m[3]*b,t[11]=-(this.m[0]*U-this.m[1]*G+this.m[3]*$),t[15]=this.m[0]*C-this.m[1]*b+this.m[2]*$;let M=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let q=0;q<4;q++)for(let g=0;g<4;g++)t[q*4+g]*=1/M;return Z(t)}}}function yt(e,t,o){return e+(Math.sin(o)+1)/2*(t-e)}function Ke(e){return{seed:e,gen(...t){if(t.length===0)return this.seed=(ln*this.seed+mn)%bt,this.seed/bt;if(t.length===1){if(typeof t[0]=="number")return this.gen(0,t[0]);if(Re(t[0]))return this.gen(f(0,0),t[0]);if(ye(t[0]))return this.gen(X(0,0,0,0),t[0])}else if(t.length===2){if(typeof t[0]=="number"&&typeof t[1]=="number")return this.gen()*(t[1]-t[0])+t[0];if(Re(t[0])&&Re(t[1]))return f(this.gen(t[0].x,t[1].x),this.gen(t[0].y,t[1].y));if(ye(t[0])&&ye(t[1]))return X(this.gen(t[0].r,t[1].r),this.gen(t[0].g,t[1].g),this.gen(t[0].b,t[1].b),this.gen(t[0].a,t[1].a))}}}}function gt(e){xt.seed=e}function Le(...e){return xt.gen(...e)}function wt(e){return Le()<=e}function vt(e){return e[Math.floor(Le(e.length))]}function Ze(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function Rt(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function Tt(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var ln,mn,bt,xt,be=ae(()=>{r(dt,"deg2rad");r(ht,"rad2deg");r(ie,"clamp");r(Ie,"lerp");r(ve,"map");r(ft,"mapc");r(f,"vec2");r(lt,"vec2FromAngle");r(Te,"vec3");r(Re,"isVec2");r(mt,"isVec3");r(ye,"isColor");r(pt,"isMat4");r(je,"rgb");r(X,"rgba");r(ne,"quad");r(Z,"mat4");r(yt,"wave");ln=1103515245,mn=12345,bt=2147483648,xt=Ke(Date.now());r(Ke,"makeRng");r(gt,"randSeed");r(Le,"rand");r(wt,"chance");r(vt,"choose");r(Ze,"colRectRect");r(Rt,"overlapRectRect");r(Tt,"colRectPt")});function Qe(e,t){let o=typeof e,i=typeof t;if(o!==i)return!1;if(o==="object"&&i==="object"){let l=Object.keys(e),v=Object.keys(t);if(l.length!==v.length)return!1;for(let _ of l){let R=e[_],Y=t[_];if(!(typeof R=="function"&&typeof Y=="function")&&!Qe(R,Y))return!1}return!0}return e===t}var Et=ae(()=>{r(Qe,"deepEq")});function Ge(e){switch(e){case"topleft":return f(-1,-1);case"top":return f(0,-1);case"topright":return f(1,-1);case"left":return f(-1,0);case"center":return f(0,0);case"right":return f(1,0);case"botleft":return f(-1,1);case"bot":return f(0,1);case"botright":return f(1,1);default:return e}}function At(e,t){let o=(()=>{switch(t.texFilter){case"linear":return e.LINEAR;case"nearest":return e.NEAREST;default:return e.NEAREST}})(),i=(()=>{var W;let h=_(et,tt),x=v(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),p=(W=t.clearColor)!=null?W:X(0,0,0,1);e.clearColor(p.r,p.g,p.b,p.a),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);let I=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,I),e.bufferData(e.ARRAY_BUFFER,ze*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let j=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,j),e.bufferData(e.ELEMENT_ARRAY_BUFFER,ze*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let V=v(new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2));return{drawCalls:0,lastDrawCalls:0,defProg:h,curProg:h,defTex:x,curTex:x,curUniform:{},vbuf:I,ibuf:j,vqueue:[],iqueue:[],transform:Z(),transformStack:[],clearColor:p,bgTex:V}})();P(),B();function l(h){return Math.log(h)/Math.log(2)%1==0}r(l,"powerOfTwo");function v(h){let x=e.createTexture();e.bindTexture(e.TEXTURE_2D,x),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,o);let p=(()=>l(h.width)&&l(h.height)?e.REPEAT:e.CLAMP_TO_EDGE)();return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,p),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,p),e.bindTexture(e.TEXTURE_2D,null),{width:h.width,height:h.height,bind(){e.bindTexture(e.TEXTURE_2D,x)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}r(v,"makeTex");function _(h=et,x=tt){let p,I=pn.replace("{{user}}",h!=null?h:et),j=yn.replace("{{user}}",x!=null?x:tt),V=e.createShader(e.VERTEX_SHADER),W=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(V,I),e.shaderSource(W,j),e.compileShader(V),e.compileShader(W),p=e.getShaderInfoLog(V))throw new Error(p);if(p=e.getShaderInfoLog(W))throw new Error(p);let S=e.createProgram();if(e.attachShader(S,V),e.attachShader(S,W),e.bindAttribLocation(S,0,"a_pos"),e.bindAttribLocation(S,1,"a_uv"),e.bindAttribLocation(S,2,"a_color"),e.linkProgram(S),(p=e.getProgramInfoLog(S))&&p!==`
`)throw new Error(p);return{bind(){e.useProgram(S)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,Fe*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,Fe*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,Fe*4,20),e.enableVertexAttribArray(2)},send(D){this.bind();for(let z in D){let L=D[z],K=e.getUniformLocation(S,z);typeof L=="number"?e.uniform1f(K,L):pt(L)?e.uniformMatrix4fv(K,!1,new Float32Array(L.m)):ye(L)?e.uniform4f(K,L.r,L.g,L.b,L.a):mt(L)?e.uniform3f(K,L.x,L.y,L.z):Re(L)&&e.uniform2f(K,L.x,L.y)}this.unbind()}}}r(_,"makeProgram");function R(h,x,p,I){let j=h.width/x,V=h.height/p,W=1/j,S=1/V,D={},z=I.split("").entries();for(let[L,K]of z)D[K]=f(L%j*W,Math.floor(L/j)*S);return{tex:h,map:D,qw:W,qh:S}}r(R,"makeFont");function Y(h,x,p=i.defTex,I=i.defProg,j={}){p=p!=null?p:i.defTex,I=I!=null?I:i.defProg,(p!==i.curTex||I!==i.curProg||!Qe(i.curUniform,j)||i.vqueue.length+h.length*Fe>ze||i.iqueue.length+x.length>ze)&&k(),i.curTex=p,i.curProg=I,i.curUniform=j;let V=x.map(S=>S+i.vqueue.length/Fe),W=h.map(S=>{let D=w(i.transform.multVec2(S.pos.xy()));return[D.x,D.y,S.pos.z,S.uv.x,S.uv.y,S.color.r,S.color.g,S.color.b,S.color.a]}).flat();V.forEach(S=>i.iqueue.push(S)),W.forEach(S=>i.vqueue.push(S))}r(Y,"drawRaw");function k(){!i.curTex||!i.curProg||i.vqueue.length===0||i.iqueue.length===0||(i.curProg.send(i.curUniform),e.bindBuffer(e.ARRAY_BUFFER,i.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(i.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(i.iqueue)),i.curProg.bind(),i.curProg.bindAttribs(),i.curTex.bind(),e.drawElements(e.TRIANGLES,i.iqueue.length,e.UNSIGNED_SHORT,0),i.curTex.unbind(),i.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),i.iqueue=[],i.vqueue=[],i.drawCalls++)}r(k,"flush");function P(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),t.clearColor||q({width:xe(),height:he(),quad:ne(0,0,xe()*fe()/St,he()*fe()/St),tex:i.bgTex}),i.drawCalls=0,i.transformStack=[],i.transform=Z()}r(P,"frameStart");function B(){k(),i.lastDrawCalls=i.drawCalls}r(B,"frameEnd");function T(){return i.lastDrawCalls}r(T,"drawCalls");function w(h){return f(h.x/xe()*2-1,-h.y/he()*2+1)}r(w,"toNDC");function E(h){i.transform=h.clone()}r(E,"pushMatrix");function N(h){!h||h.x===0&&h.y===0||(i.transform=i.transform.translate(h))}r(N,"pushTranslate");function U(h){!h||h.x===1&&h.y===1||(i.transform=i.transform.scale(h))}r(U,"pushScale");function C(h){!h||(i.transform=i.transform.rotateX(h))}r(C,"pushRotateX");function G(h){!h||(i.transform=i.transform.rotateY(h))}r(G,"pushRotateY");function b(h){!h||(i.transform=i.transform.rotateZ(h))}r(b,"pushRotateZ");function $(){i.transformStack.push(i.transform.clone())}r($,"pushTransform");function M(){i.transformStack.length>0&&(i.transform=i.transformStack.pop())}r(M,"popTransform");function q(h={}){var K,J;let x=h.width||0,p=h.height||0,I=h.pos||f(0,0),V=Ge(h.origin||Je).dot(f(x,p).scale(-.5)),W=f((K=h.scale)!=null?K:1),S=h.rot||0,D=h.quad||ne(0,0,1,1),z=1-((J=h.z)!=null?J:0),L=h.color||X(1,1,1,1);$(),N(I),U(W),b(S),N(V),Y([{pos:Te(-x/2,p/2,z),uv:f(D.x,D.y+D.h),color:L},{pos:Te(-x/2,-p/2,z),uv:f(D.x,D.y),color:L},{pos:Te(x/2,-p/2,z),uv:f(D.x+D.w,D.y),color:L},{pos:Te(x/2,p/2,z),uv:f(D.x+D.w,D.y+D.h),color:L}],[0,1,3,1,2,3],h.tex,h.prog,h.uniform),M()}r(q,"drawQuad");function g(h,x={}){var V;let p=(V=x.quad)!=null?V:ne(0,0,1,1),I=h.width*p.w,j=h.height*p.h;q(we(de({},x),{tex:h,quad:p,width:I,height:j}))}r(g,"drawTexture");function O(h,x,p,I={}){q(we(de({},I),{pos:h,width:x,height:p}))}r(O,"drawRect");function ue(h,x,p,I={}){let j=Ge(I.origin||Je).dot(f(x,p)).scale(.5),V=h.add(f(-x/2,-p/2)).sub(j),W=h.add(f(-x/2,p/2)).sub(j),S=h.add(f(x/2,p/2)).sub(j),D=h.add(f(x/2,-p/2)).sub(j);Q(V,W,I),Q(W,S,I),Q(S,D,I),Q(D,V,I)}r(ue,"drawRectStroke");function Q(h,x,p={}){let I=p.width||1,j=h.dist(x),V=Math.PI/2-h.angle(x);q(we(de({},p),{pos:h.add(x).scale(.5),width:I,height:j,rot:V,origin:"center"}))}r(Q,"drawLine");function re(h,x,p={}){let I=(h+"").split(""),j=x.qw*x.tex.width,V=x.qh*x.tex.height,W=p.size||V,S=f(W/V).dot(f(p.scale||1)),D=S.x*j,z=S.y*V,L=0,K=z,J=0,ge=[[]];for(let oe of I)(oe===`
`||(p.width?L+D>p.width:!1))&&(K+=z,L=0,ge.push([])),oe!==`
`&&(ge[ge.length-1].push(oe),L+=D),J=Math.max(J,L);p.width&&(J=p.width);let qe=[],Oe=f(p.pos||0),ee=Ge(p.origin||Je).scale(.5),ce=-ee.x*D-(ee.x+.5)*(J-D),Ae=-ee.y*z-(ee.y+.5)*(K-z);return ge.forEach((oe,Xe)=>{let Ve=(J-oe.length*D)*(ee.x+.5);oe.forEach((Ce,Ye)=>{let _e=x.map[Ce],$e=Ye*D,Ne=Xe*z;_e&&qe.push({tex:x.tex,quad:ne(_e.x,_e.y,x.qw,x.qh),ch:Ce,pos:f(Oe.x+$e+ce+Ve,Oe.y+Ne+Ae),color:p.color,origin:p.origin,scale:S,z:p.z})})}),{width:J,height:K,chars:qe}}r(re,"fmtText");function se(h,x,p={}){Me(re(h,x,p))}r(se,"drawText");function Me(h){for(let x of h.chars)q({tex:x.tex,width:x.tex.width*x.quad.w,height:x.tex.height*x.quad.h,pos:x.pos,scale:x.scale,color:x.color,quad:x.quad,origin:"center",z:x.z})}r(Me,"drawFmtText");function xe(){return e.drawingBufferWidth/fe()}r(xe,"width");function he(){return e.drawingBufferHeight/fe()}r(he,"height");function fe(){var h;return(h=t.scale)!=null?h:1}r(fe,"scale");function Se(){return i.clearColor.clone()}return r(Se,"clearColor"),{width:xe,height:he,scale:fe,makeTex:v,makeProgram:_,makeFont:R,drawTexture:g,drawText:se,drawFmtText:Me,drawRect:O,drawRectStroke:ue,drawLine:Q,fmtText:re,frameStart:P,frameEnd:B,pushTransform:$,popTransform:M,pushMatrix:E,drawCalls:T,clearColor:Se}}var Je,Fe,ze,St,pn,yn,et,tt,Ct=ae(()=>{be();Et();Je="topleft",Fe=9,ze=65536,St=64,pn=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,yn=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,et=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,tt=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;r(Ge,"originPt");r(At,"gfxInit")});function _t(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}function kt(e={}){var M,q;let t={canvas:(M=e.canvas)!=null?M:(()=>{var O;let g=document.createElement("canvas");return((O=e.root)!=null?O:document.body).appendChild(g),g})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:f(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(q=e.scale)!=null?q:1,isTouch:!1,loopID:null,stopped:!1},o={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},i=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let l=["outline: none","cursor: default"];e.crisp&&(l.push("image-rendering: pixelated"),l.push("image-rendering: crisp-edges")),t.canvas.style=l.join(";"),t.canvas.setAttribute("tabindex","0");let v=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("mousemove",g=>{t.mousePos=f(g.offsetX,g.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",g=>{let O=g.touches[0];t.mousePos=f(O.clientX,O.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",g=>{let O=g.touches[0];t.mousePos=f(O.clientX,O.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",g=>{let O=o[g.key]||g.key.toLowerCase();i.includes(O)&&g.preventDefault(),O.length===1&&t.charInputted.push(O),O==="space"&&t.charInputted.push(" "),g.repeat?t.keyStates[O]="rpressed":t.keyStates[O]="pressed"}),t.canvas.addEventListener("keyup",g=>{let O=o[g.key]||g.key.toLowerCase();t.keyStates[O]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function _(){return t.mousePos.clone()}r(_,"mousePos");function R(){return t.mouseState==="pressed"}r(R,"mouseClicked");function Y(){return t.mouseState==="pressed"||t.mouseState==="down"}r(Y,"mouseDown");function k(){return t.mouseState==="released"}r(k,"mouseReleased");function P(g){return t.keyStates[g]==="pressed"}r(P,"keyPressed");function B(g){return t.keyStates[g]==="pressed"||t.keyStates[g]==="rpressed"}r(B,"keyPressedRep");function T(g){return t.keyStates[g]==="pressed"||t.keyStates[g]==="rpressed"||t.keyStates[g]==="down"}r(T,"keyDown");function w(g){return t.keyStates[g]==="released"}r(w,"keyReleased");function E(){return[...t.charInputted]}r(E,"charInputted");function N(){return t.dt}r(N,"dt");function U(){return t.time}r(U,"time");function C(){return t.canvas.toDataURL()}r(C,"screenshot");function G(g){return g&&(t.canvas.style.cursor=g!=null?g:"default"),t.canvas.style.cursor}r(G,"cursor");function b(g){let O=r(ue=>{let Q=ue/1e3,re=Q-t.realTime;t.realTime=Q,t.skipTime||(t.dt=re,t.time+=t.dt),t.skipTime=!1,g();for(let se in t.keyStates)t.keyStates[se]=_t(t.keyStates[se]);t.mouseState=_t(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(O))},"frame");t.loopID=requestAnimationFrame(O)}r(b,"run");function $(){cancelAnimationFrame(t.loopID),t.stopped=!0}return r($,"quit"),{gl:v,mousePos:_,keyDown:T,keyPressed:P,keyPressedRep:B,keyReleased:w,mouseDown:Y,mouseClicked:R,mouseReleased:k,charInputted:E,cursor:G,dt:N,time:U,screenshot:C,run:b,quit:$}}var Dt=ae(()=>{be();r(_t,"processBtnState");r(kt,"appInit")});function Lt(){let e=(()=>{let l=new(window.AudioContext||window.webkitAudioContext),v=l.createGain(),_=v;return _.connect(l.destination),{ctx:l,gainNode:v,masterNode:_}})();function t(l){return l!==void 0&&(e.gainNode.gain.value=ie(l,Pt,It)),e.gainNode.gain.value}r(t,"volume");function o(l,v={loop:!1,volume:1,speed:1,detune:0,seek:0}){var w;let _=!1,R=e.ctx.createBufferSource();R.buffer=l,R.loop=!!v.loop;let Y=e.ctx.createGain();R.connect(Y),Y.connect(e.masterNode);let k=(w=v.seek)!=null?w:0;R.start(0,k);let P=e.ctx.currentTime-k,B=null,T={stop(){this.pause(),P=e.ctx.currentTime},play(E){if(!_)return;let N=R;R=e.ctx.createBufferSource(),R.buffer=N.buffer,R.loop=N.loop,R.playbackRate.value=N.playbackRate.value,R.detune&&(R.detune.value=N.detune.value),R.connect(Y);let U=E!=null?E:this.time();R.start(0,U),P=e.ctx.currentTime-U,_=!1,B=null},pause(){R.stop(),_=!0,B=e.ctx.currentTime},paused(){return _},stopped(){return _},speed(E){return E!==void 0&&(R.playbackRate.value=ie(E,bn,xn)),R.playbackRate.value},detune(E){return R.detune?(E!==void 0&&(R.detune.value=ie(E,gn,wn)),R.detune.value):0},volume(E){return E!==void 0&&(Y.gain.value=ie(E,Pt,It)),Y.gain.value},loop(){R.loop=!0},unloop(){R.loop=!1},duration(){return l.duration},time(){return _?B-P:e.ctx.currentTime-P}};return T.speed(v.speed),T.detune(v.detune),T.volume(v.volume),T}r(o,"play");function i(){return e.ctx}return r(i,"ctx"),{ctx:i,volume:t,play:o}}var Pt,It,bn,xn,gn,wn,Ft=ae(()=>{be();Pt=0,It=3,bn=0,xn=3,gn=-1200,wn=1200;r(Lt,"audioInit")});var Gt,Mt=ae(()=>{Gt="data:image/png;base64,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"});function qt(e){let t=new Image;return t.src=e,t.crossOrigin="anonymous",new Promise((o,i)=>{t.onload=()=>{o(t)},t.onerror=()=>{i(`failed to load ${e}`)}})}function Ot(e){return e.startsWith("data:")}function Vt(e,t,o={}){let i={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function l(T){var E;let w=i.lastLoaderID;i.loaders[w]=!1,i.lastLoaderID++,T.catch((E=o.errHandler)!=null?E:console.error).finally(()=>{i.loaders[w]=!0})}r(l,"addLoader");function v(){let T=0,w=0;for(let E in i.loaders)T+=1,i.loaders[E]&&(w+=1);return w/T}r(v,"loadProgress");function _(T){return T&&(i.loadRoot=T),i.loadRoot}r(_,"loadRoot");function R(T,w,E,N,U=Rn){let C=new Promise((G,b)=>{let $=Ot(w)?w:i.loadRoot+w;qt($).then(M=>{let q=e.makeFont(e.makeTex(M),E,N,U);i.fonts[T]=q,G(q)}).catch(b)});return l(C),C}r(R,"loadFont");function Y(T,w,E={sliceX:1,sliceY:1,anims:{}}){function N(C,G,b={sliceX:1,sliceY:1,gridWidth:0,gridHeight:0,anims:{}}){let $=[],M=e.makeTex(G),q=b.sliceX||M.width/(b.gridWidth||M.width),g=b.sliceY||M.height/(b.gridHeight||M.height),O=1/q,ue=1/g;for(let re=0;re<g;re++)for(let se=0;se<q;se++)$.push(ne(se*O,re*ue,O,ue));let Q={tex:M,frames:$,anims:b.anims||{}};return i.sprites[C]=Q,Q}r(N,"loadRawSprite");let U=new Promise((C,G)=>{if(!w)return G(`expected sprite src for "${T}"`);if(typeof w=="string"){let b=Ot(w)?w:i.loadRoot+w;qt(b).then($=>{C(N(T,$,E))}).catch(G)}else C(N(T,w,E))});return l(U),U}r(Y,"loadSprite");function k(T,w,E,N=!1){function U(G,b,$){let M=e.makeProgram(b,$);return i.shaders[G]=M,M}r(U,"loadRawShader");let C=new Promise((G,b)=>{if(!w&&!E)return b("no shader");function $(M){return M?fetch(i.loadRoot+M).then(q=>{if(q.ok)return q.text();throw new Error(`failed to load ${M}`)}).catch(b):new Promise(q=>q(null))}if(r($,"resolveUrl"),N)Promise.all([$(w),$(E)]).then(([M,q])=>{G(U(T,M,q))}).catch(b);else try{G(U(T,w,E))}catch(M){b(M)}});return l(C),C}r(k,"loadShader");function P(T,w){let E=i.loadRoot+w,N=new Promise((U,C)=>{if(!w)return C(`expected sound src for "${T}"`);typeof w=="string"&&fetch(E).then(G=>{if(G.ok)return G.arrayBuffer();throw new Error(`failed to load ${E}`)}).then(G=>new Promise((b,$)=>{t.ctx().decodeAudioData(G,b,$)})).then(G=>{i.sounds[T]=G,U(G)}).catch(C)});return l(N),N}r(P,"loadSound");function B(){return i.fonts[Ee]}return r(B,"defFont"),R(Ee,Gt,8,8),{loadRoot:_,loadSprite:Y,loadSound:P,loadFont:R,loadShader:k,loadProgress:v,addLoader:l,defFont:B,sprites:i.sprites,fonts:i.fonts,sounds:i.sounds,shaders:i.shaders}}var Rn,Ee,Nt=ae(()=>{be();Mt();Rn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Ee="unscii";r(qt,"loadImg");r(Ot,"isDataUrl");r(Vt,"assetsInit")});function Ut(e,t,o={max:8}){var k;let i=[],l=(k=o.max)!=null?k:8;function v(){i.length>l&&(i=i.slice(0,l));let P=f(0,e.height());i.forEach((B,T)=>{let w=ve(T,0,l,1,.2),E=ve(T,0,l,.8,.2),N=(()=>{switch(B.type){case"info":return X(1,1,1,w);case"error":return X(1,0,.5,w)}})(),U=e.fmtText(B.msg,t.defFont(),{pos:P,origin:"botleft",color:N,z:1,size:Tn/e.scale(),width:e.width()});e.drawRect(P,U.width,U.height,{origin:"botleft",color:X(0,0,0,E),z:1}),e.drawFmtText(U),P.y-=U.height})}r(v,"draw");function _(P){console.error(P),i.unshift({type:"error",msg:P})}r(_,"error");function R(P){i.unshift({type:"info",msg:P})}r(R,"info");function Y(){i=[]}return r(Y,"clear"),{info:R,error:_,draw:v,clear:Y}}var Tn,Bt=ae(()=>{be();Tn=16;r(Ut,"loggerInit")});function jt(e){let t={},o=[],i=null;function l(){return i!==null&&i.readyState===1}r(l,"connected");function v(){let k=new WebSocket(e);return new Promise((P,B)=>{k.onopen=()=>{P(k),i=k;for(let T of o)k.send(T)},k.onerror=()=>{B(`failed to connect to ${e}`)},k.onmessage=T=>{let w=JSON.parse(T.data);if(t[w.type])for(let E of t[w.type])E(w.data,w.id)}})}r(v,"connect");function _(k,P){t[k]||(t[k]=[]),t[k].push(P)}r(_,"recv");function R(k,P){let B=JSON.stringify({type:k,data:P});i?i.send(B):o.push(B)}r(R,"send");function Y(){i&&i.close()}return r(Y,"close"),{connect:v,close:Y,connected:l,recv:_,send:R}}var zt=ae(()=>{r(jt,"netInit")});var En=fn((Kn,Xt)=>{be();Ct();Dt();Ft();Nt();Bt();zt();Xt.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{let t=kt({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),o=At(t.gl,{clearColor:e.clearColor?X(e.clearColor):void 0,scale:e.scale,texFilter:e.texFilter}),i=Lt(),l=Vt(o,i,{errHandler:s=>{v.error(s)}}),v=Ut(o,l,{max:e.logMax}),_=(()=>e.connect?jt(e.connect):null)();function R(s,n){if(!_)throw new Error("not connected to any websockets");_.recv(s,(a,d)=>{try{n(a,d)}catch(u){v.error(u)}})}r(R,"recv");function Y(s,n){if(!_)throw new Error("not connected to any websockets");_.send(s,n)}r(Y,"send");function k(){return t.dt()*H.timeScale}r(k,"dt");function P(s,n={}){let a=l.sounds[s];if(!a)throw new Error(`sound not found: "${s}"`);return i.play(a,n)}r(P,"play");function B(s){let n=b();return!n.cam.ignore.includes(s!=null?s:n.defLayer)}r(B,"isCamLayer");function T(s){return B(s)?b().cam.mpos:t.mousePos()}r(T,"mousePos");function w(s,n={}){var u;let a=(()=>typeof s=="string"?l.sprites[s]:s)();if(!a)throw new Error(`sprite not found: "${s}"`);let d=a.frames[(u=n.frame)!=null?u:0];o.drawTexture(a.tex,we(de({},n),{quad:d}))}r(w,"drawSprite");function E(s,n={}){var u;let a=(u=n.font)!=null?u:Ee,d=l.fonts[a];if(!d)throw new Error(`font not found: ${a}`);o.drawText(s,d,n)}r(E,"drawText");let N=980,U="topleft",C={loaded:!1,scenes:{},curScene:null,nextScene:null};function G(s,n){C.scenes[s]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastObjID:0,timers:{},lastTimerID:0,cam:{pos:f(o.width()/2,o.height()/2),scale:f(1,1),angle:0,shake:0,ignore:[],mpos:f(0),matrix:Z()},layers:{},defLayer:null,gravity:N,data:{}}}r(G,"scene");function b(){return C.scenes[C.curScene]}r(b,"curScene");function $(){return b().data}r($,"sceneData");function M(){z("`",()=>{H.showLog=!H.showLog,v.info(`show log: ${H.showLog?"on":"off"}`)}),z("f1",()=>{H.inspect=!H.inspect,v.info(`inspect: ${H.inspect?"on":"off"}`)}),z("f2",()=>{H.clearLog()}),z("f8",()=>{H.paused=!H.paused,v.info(`${H.paused?"paused":"unpaused"}`)}),z("f7",()=>{H.timeScale=ie(H.timeScale-.2,0,2),v.info(`time scale: ${H.timeScale.toFixed(1)}`)}),z("f9",()=>{H.timeScale=ie(H.timeScale+.2,0,2),v.info(`time scale: ${H.timeScale.toFixed(1)}`)}),z("f10",()=>{H.stepFrame(),v.info("stepped frame")})}r(M,"regDebugInputs");function q(s,...n){C.nextScene={name:s,args:[...n]}}r(q,"go");function g(s,...n){O(s),C.curScene=s;let a=C.scenes[s];if(!a)throw new Error(`scene not found: '${s}'`);if(!a.initialized){try{a.init(...n)}catch(d){v.error(d.stack)}e.debug&&M(),a.initialized=!0}}r(g,"goSync");function O(s){if(!C.scenes[s])throw new Error(`scene not found: '${s}'`);G(s,C.scenes[s].init)}r(O,"reload");function ue(s,n){let a=b();if(!a)return;let d=.5/s.length;s.forEach((u,m)=>{a.layers[u]=.5+d*m}),n&&(a.defLayer=n)}r(ue,"layers");function Q(...s){let n=b().cam;return s.length>0&&(n.pos=f(...s)),n.pos.clone()}r(Q,"camPos");function re(...s){let n=b().cam;return s.length>0&&(n.scale=f(...s)),n.scale.clone()}r(re,"camScale");function se(s){let n=b().cam;return s!==void 0&&(n.angle=s),n.angle}r(se,"camRot");function Me(s){let n=b().cam;n.shake=s}r(Me,"camShake");function xe(s){let n=b().cam;n.ignore=s}r(xe,"camIgnore");function he(s){let n={hidden:!1,paused:!1,_tags:[],_id:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(u){if(u===void 0)return;let m=typeof u;if(m==="string"){this._tags.push(u);return}if(m!=="object")throw new Error(`invalid comp type: ${m}`);if(Array.isArray(u)){for(let c of u)this.use(c);return}for(let c in u){if(typeof u[c]=="function"){this._events[c]?this._events[c].push(u[c].bind(this)):this[c]=u[c].bind(this);continue}this[c]=u[c]}},exists(){return this._id!==void 0},is(u){if(u==="*")return!0;if(Array.isArray(u)){for(let m of u)if(!this._tags.includes(m))return!1;return!0}return this._tags.includes(u)},on(u,m){this._events[u]||(this._events[u]=[]),this._events[u].push(m)},action(u){this.on("update",u)},trigger(u,...m){if(this._events[u])for(let A of this._events[u])A.call(this,...m);let y=b().events[u];if(y)for(let A of y)this.is(A.tag)&&A.cb(this,...m)},rmTag(u){let m=this._tags.indexOf(u);m>-1&&this._tags.splice(m,1)}};n.use(s);let a=b(),d=a.lastObjID++;a.objs.set(d,n),n._id=d,n.trigger("add");for(let u of a.events.add)n.is(u.tag)&&u.cb(n);return n}r(he,"add");function fe(s){if(!s.exists())return;let n=b();n.objs.delete(s._id);let a=n.lastObjID++;return n.objs.set(a,s),s._id=a,s}r(fe,"readd");function Se(s,n,a){let d=b();d.events[s]||(d.events[s]=[]),d.events[s].push({tag:n,cb:a})}r(Se,"on");function h(s,n){typeof s=="function"&&n===void 0?b().action.push(s):typeof s=="string"&&Se("update",s,n)}r(h,"action");function x(s,n){typeof s=="function"&&n===void 0?b().render.push(s):typeof s=="string"&&Se("update",s,n)}r(x,"render");function p(s,n,a){h(s,d=>{d._checkCollisions(n,u=>{a(d,u)})})}r(p,"collides");function I(s,n,a){h(s,d=>{d._checkOverlaps(n,u=>{a(d,u)})})}r(I,"overlaps");function j(s,n){h(s,a=>{a.isClicked()&&n(a)})}r(j,"clicks");function V(s,n){return new Promise(a=>{let d=b();d.timers[d.lastTimerID++]={time:s,cb:()=>{n&&n(),a()}}})}r(V,"wait");function W(s,n){let a=!1,d=r(()=>{a||(n(),V(s,d))},"newF");return d(),{stop(){a=!0}}}r(W,"loop");function S(s,n,a){if(Array.isArray(n))for(let d of n)S(s,d,a);else b().events[s].push({key:n,cb:a})}r(S,"pushKeyEvent");function D(s,n){S("keyDown",s,n)}r(D,"keyDown");function z(s,n){S("keyPress",s,n)}r(z,"keyPress");function L(s,n){S("keyPressRep",s,n)}r(L,"keyPressRep");function K(s,n){S("keyRelease",s,n)}r(K,"keyRelease");function J(s){b().events.charInput.push({cb:s})}r(J,"charInput");function ge(s){b().events.mouseDown.push({cb:s})}r(ge,"mouseDown");function qe(s){b().events.mouseClick.push({cb:s})}r(qe,"mouseClick");function Oe(s){b().events.mouseRelease.push({cb:s})}r(Oe,"mouseRelease");function ee(s){let a=[...b().objs.values()];return s?a.filter(d=>d.is(s)):a}r(ee,"get");function ce(s,n){typeof s=="function"&&n===void 0?ee().forEach(s):typeof s=="string"&&ee(s).forEach(n)}r(ce,"every");function Ae(s,n){typeof s=="function"&&n===void 0?ee().reverse().forEach(s):typeof s=="string"&&ee(s).reverse().forEach(n)}r(Ae,"revery");function oe(s){if(!s.exists())return;let n=b();!n||(s.trigger("destroy"),n.objs.delete(s._id),delete s._id)}r(oe,"destroy");function Xe(s){ce(s,n=>{oe(n)})}r(Xe,"destroyAll");function Ve(s){let n=b();return s!==void 0&&(n.gravity=s),n.gravity}r(Ve,"gravity");function Ce(s){let n=b();if(!n)throw new Error(`scene not found: '${C.curScene}'`);let a=s||!H.paused;if(a)for(let c in n.timers){let y=n.timers[c];y.time-=k(),y.time<=0&&(y.cb(),delete n.timers[c])}if(Ae(c=>{!c.paused&&a&&c.trigger("update")}),a)for(let c of n.action)c();let d=f(o.width(),o.height()),u=n.cam,m=lt(Le(0,Math.PI*2)).scale(u.shake);u.shake=Ie(u.shake,0,5*k()),u.matrix=Z().translate(d.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(d.scale(-.5)).translate(u.pos.scale(-1).add(d.scale(.5)).add(m)),u.mpos=u.matrix.invert().multVec2(t.mousePos()),ce(c=>{c.hidden||(o.pushTransform(),B(c.layer)&&o.pushMatrix(u.matrix),c.trigger("draw"),o.popTransform())});for(let c of n.render)c()}r(Ce,"gameFrame");function Ye(){let s=b();for(let n of s.events.charInput)t.charInputted().forEach(n.cb);for(let n of s.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of s.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of s.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of s.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of s.events.mouseDown)t.mouseDown()&&n.cb();for(let n of s.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of s.events.mouseRelease)t.mouseReleased()&&n.cb()}r(Ye,"handleEvents");function _e(){var m;let s=b(),n=!1,a=l.defFont(),d=X((m=e.inspectColor)!=null?m:[0,1,1,1]),u=12;Ae(c=>{let y=B(c.layer),A=o.scale()*(y?(s.cam.scale.x+s.cam.scale.y)/2:1),F=f(4).scale(1/A);if(!c.area||c.hidden)return;o.pushTransform(),y&&o.pushMatrix(s.cam.matrix);let te=!1;c.isHovered()&&!n&&(te=!0,n=!0);let De=(te?6:2)/A,le=c._worldArea(),We=le.p2.x-le.p1.x,an=le.p2.y-le.p1.y;if(o.drawRectStroke(le.p1,We,an,{width:De,color:d,z:.9}),te){let rt=T(c.layer),Pe=0,Be=0,st=[],ot=r(me=>{let pe=o.fmtText(me,a,{size:u/A,pos:rt.add(f(F.x,F.y+Be)),z:1});st.push(pe),Pe=pe.width>Pe?pe.width:Pe,Be+=pe.height},"addLine");for(let me of c._tags)ot(`"${me}"`);for(let me of c._events.inspect){let pe=me();for(let it in pe)ot(`${it}: ${pe[it]}`)}Pe+=F.x*2,Be+=F.y*2,o.drawRect(rt,Pe,Be,{color:X(0,0,0,1),z:1});for(let me of st)o.drawFmtText(me)}o.popTransform()})}r(_e,"drawInspect");function $e(s,...n){t.run(()=>{if(o.frameStart(),C.loaded){try{if(!b())throw new Error(`scene not found: '${C.curScene}'`);Ye(),Ce(),H.inspect&&_e()}catch(a){v.error(a.stack),t.quit()}H.showLog&&v.draw(),C.nextScene&&(g.apply(null,[C.nextScene.name,...C.nextScene.args]),C.nextScene=null)}else{let a=l.loadProgress();if(a===1)C.loaded=!0,g(s,...n),_&&_.connect().catch(v.error);else{let d=o.width()/2,u=24/o.scale(),m=f(o.width()/2,o.height()/2).sub(f(d/2,u/2));o.drawRect(f(0),o.width(),o.height(),{color:je(0,0,0)}),o.drawRectStroke(m,d,u,{width:4/o.scale()}),o.drawRect(m,d*a,u)}}o.frameEnd()})}r($e,"start");function Ne(...s){return{pos:f(...s),move(...n){let a=f(...n),d=a.x*k(),u=a.y*k();this.pos.x+=d,this.pos.y+=u},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}r(Ne,"pos");function Yt(...s){return{scale:f(...s),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}r(Yt,"scale");function $t(s){return{angle:s}}r($t,"rotate");function Ht(...s){return{color:X(...s)}}r(Ht,"color");function Wt(s){return{origin:s}}r(Wt,"origin");function Kt(s){return{layer:s,inspect(){var a;let n=b();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}r(Kt,"layer");function He(s,n){var d,u;let a=b();return((d=s.layer)!=null?d:a.defLayer)===((u=n.layer)!=null?u:a.defLayer)}r(He,"isSameLayer");function nt(s,n){let a={},d={};return{area:{p1:s,p2:n},areaWidth(){let{p1:u,p2:m}=this._worldArea();return m.x-u.x},areaHeight(){let{p1:u,p2:m}=this._worldArea();return m.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){return this.hasPt(T(this.layer))},isCollided(u){if(!u.area||!He(this,u))return!1;let m=this._worldArea(),c=u._worldArea();return Ze(m,c)},isOverlapped(u){if(!u.area||!He(this,u))return!1;let m=this._worldArea(),c=u._worldArea();return Rt(m,c)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,m){this.action(()=>{this._checkCollisions(u,m)})},overlaps(u,m){this.action(()=>{this._checkOverlaps(u,m)})},hasPt(u){let m=this._worldArea();return Tt({p1:m.p1,p2:m.p2},u)},resolve(){let u=[];return ce(m=>{if(m===this||!m.solid||!m.area||!He(this,m))return;let c=this._worldArea(),y=m._worldArea();if(!Ze(c,y))return;let A=c.p2.x-y.p1.x,F=y.p2.x-c.p1.x,te=c.p2.y-y.p1.y,De=y.p2.y-c.p1.y,le=Math.min(A,F,te,De),We=(()=>{switch(le){case A:return this.pos.x-=A,"right";case F:return this.pos.x+=F,"left";case te:return this.pos.y-=te,"bottom";case De:return this.pos.y+=De,"top"}})();u.push({obj:m,side:We})}),u},_checkCollisions(u,m){ce(u,c=>{this!==c&&(a[c._id]||this.isCollided(c)&&(m(c),a[c._id]=c))});for(let c in a){let y=a[c];this.isCollided(y)||delete a[c]}},_checkOverlaps(u,m){ce(u,c=>{this!==c&&(d[c._id]||this.isOverlapped(c)&&(m(c),d[c._id]=c))});for(let c in d){let y=d[c];this.isOverlapped(y)||delete d[c]}},_worldArea(){let u=this.area,m=this.pos||f(0),c=this.scale||f(1),y=m.add(u.p1.dot(c)),A=m.add(u.p2.dot(c));return{p1:f(Math.min(y.x,A.x),Math.min(y.y,A.y)),p2:f(Math.max(y.x,A.x),Math.max(y.y,A.y))}}}}r(nt,"area");function Ue(s,n,a){let d=f(s,n),u=Ge(a||U).dot(d).scale(-.5);return nt(u.sub(d.scale(.5)),u.add(d.scale(.5)))}r(Ue,"getAreaFromSize");function Zt(s,n={}){let a=l.sprites[s];if(!a)throw new Error(`sprite not found: "${s}"`);let d=de({},a.frames[0]);n.quad&&(d.x+=n.quad.x*d.w,d.y+=n.quad.y*d.h,d.w*=n.quad.w,d.h*=n.quad.h);let u=a.tex.width*d.w,m=a.tex.height*d.h,c=null;return{width:u,height:m,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||ne(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Ue(this.width,this.height,this.origin))},draw(){var F;let y=b(),A=a.frames[this.frame];w(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:l.shaders[this.shader],uniform:this.uniform,z:y.layers[(F=this.layer)!=null?F:y.defLayer]})},update(){if(!c)return;let y=a.anims[c.name];c.timer+=k(),c.timer>=this.animSpeed&&(this.frame++,this.frame>y.to&&(c.loop?this.frame=y.from:(this.frame--,this.stop())),c&&(c.timer-=this.animSpeed))},play(y,A=!0){let F=a.anims[y];if(!F)throw new Error(`anim not found: ${y}`);c&&this.stop(),c={name:y,loop:A,timer:0},this.frame=F.from,this.trigger("animPlay",y)},stop(){if(!c)return;let y=c.name;c=null,this.trigger("animEnd",y)},changeSprite(y){if(a=l.sprites[y],!a)throw new Error(`sprite not found: "${y}"`);let A=de({},a.frames[0]);n.quad&&(A.x+=n.quad.x*A.w,A.y+=n.quad.y*A.h,A.w*=n.quad.w,A.h*=n.quad.h),this.width=a.tex.width*A.w,this.height=a.tex.height*A.h,this.area&&!n.noArea&&this.use(Ue(this.width,this.height,this.origin)),c=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return c==null?void 0:c.name},inspect(){let y={};return c&&(y.curAnim=`"${c.name}"`),y}}}r(Zt,"sprite");function Qt(s,n,a={}){return{text:s,textSize:n,font:a.font,width:0,height:0,add(){var d,u,m,c;if(!this.area&&!a.noArea){let y=b(),A=l.fonts[(d=this.font)!=null?d:Ee],F=o.fmtText(this.text+"",A,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:y.layers[(u=this.layer)!=null?u:y.defLayer]});this.width=F.width/(((m=this.scale)==null?void 0:m.x)||1),this.height=F.height/(((c=this.scale)==null?void 0:c.y)||1),this.use(Ue(this.width,this.height,this.origin))}},draw(){var c,y;let d=b(),u=l.fonts[(c=this.font)!=null?c:Ee],m=o.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:d.layers[(y=this.layer)!=null?y:d.defLayer]});this.width=m.width,this.height=m.height,o.drawFmtText(m)}}}r(Qt,"text");function Jt(s,n,a={}){return{width:s,height:n,add(){!this.area&&!a.noArea&&this.use(Ue(this.width,this.height,this.origin))},draw(){var u;let d=b();o.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:d.layers[(u=this.layer)!=null?u:d.defLayer],prog:l.shaders[this.shader],uniform:this.uniform})}}}r(Jt,"rect");function en(){return{solid:!0}}r(en,"solid");let tn=960,nn=480;function rn(s={}){var m,c;let n=0,a=null,d=null,u=(m=s.maxVel)!=null?m:tn;return{jumpForce:(c=s.jumpForce)!=null?c:nn,update(){this.move(0,n);let y=this.resolve(),A=!1;if(a&&(!a.exists()||!this.isCollided(a)?(a=null,d=null,A=!0):d&&(this.pos=this.pos.add(a.pos.sub(d)),d=a.pos.clone())),!a){n=Math.min(n+Ve()*k(),u);for(let F of y)F.side==="bottom"&&n>0?(a=F.obj,n=0,d=a.pos.clone(),A||this.trigger("grounded",a)):F.side==="top"&&n<0&&(n=0,this.trigger("headbump",F.obj))}},curPlatform(){return a},grounded(){return a!==null},falling(){return n>0},jump(y){a=null,n=-y||-this.jumpForce}}}r(rn,"body");function sn(s,n={}){let a=l.shaders[s];return{shader:s,uniform:n}}r(sn,"shader");let H={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return b().objs.size},stepFrame(){Ce(!0)},drawCalls:o.drawCalls,clearLog:v.clear,log:v.info,error:v.error};function on(s,n){let a=[],d=f(n.pos||0),u=0,m={getPos(...c){let y=f(...c);return f(d.x+y.x*n.width,d.y+y.y*n.height)},spawn(c,y){let A=(()=>{if(Array.isArray(c))return c;if(n[c]){if(typeof n[c]=="function")return n[c]();if(Array.isArray(n[c]))return[...n[c]]}else if(n.any)return n.any(c)})();if(!A)return;A.push(Ne(d.x+y.x*n.width,d.y+y.y*n.height));let F=he(A);return a.push(F),F.use({gridPos:y.clone(),setGridPos(te){this.gridPos=te.clone(),this.pos=f(d.x+this.gridPos.x*n.width,d.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(f(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(f(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(f(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(f(0,1)))}}),F},width(){return u*n.width},height(){return s.length*n.height},destroy(){for(let c of a)oe(c)}};return s.forEach((c,y)=>{let A=c.split("");u=Math.max(A.length,u),A.forEach((F,te)=>{m.spawn(F,f(te,y))})}),m}r(on,"addLevel");let ke={start:$e,loadRoot:l.loadRoot,loadSprite:l.loadSprite,loadSound:l.loadSound,loadFont:l.loadFont,loadShader:l.loadShader,addLoader:l.addLoader,width:o.width,height:o.height,dt:k,time:t.time,screenshot:t.screenshot,scene:G,go:q,sceneData:$,layers:ue,camPos:Q,camScale:re,camRot:se,camShake:Me,camIgnore:xe,gravity:Ve,add:he,readd:fe,destroy:oe,destroyAll:Xe,get:ee,every:ce,revery:Ae,send:Y,recv:R,pos:Ne,scale:Yt,rotate:$t,color:Ht,origin:Wt,layer:Kt,area:nt,sprite:Zt,text:Qt,rect:Jt,solid:en,body:rn,shader:sn,on:Se,action:h,render:x,collides:p,overlaps:I,clicks:j,keyDown:D,keyPress:z,keyPressRep:L,keyRelease:K,charInput:J,mouseDown:ge,mouseClick:qe,mouseRelease:Oe,mousePos:T,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:W,wait:V,play:P,volume:i.volume,makeRng:Ke,rand:Le,randSeed:gt,vec2:f,rgb:je,rgba:X,quad:ne,choose:vt,chance:wt,lerp:Ie,map:ve,mapc:ft,wave:yt,deg2rad:dt,rad2deg:ht,drawSprite:w,drawText:E,drawRect:o.drawRect,drawRectStroke:o.drawRectStroke,drawLine:o.drawLine,debug:H,addLevel:on};if(e.plugins)for(let s of e.plugins){let n=s(ke);for(let a in n)ke[a]=n[a]}if(e.global)for(let s in ke)window[s]=ke[s];return ke}});export default En();
//# sourceMappingURL=kaboom.mjs.map
