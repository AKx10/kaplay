var at=Object.defineProperty,rn=Object.defineProperties;var on=Object.getOwnPropertyDescriptors;var ct=Object.getOwnPropertySymbols;var an=Object.prototype.hasOwnProperty,cn=Object.prototype.propertyIsEnumerable;var ut=(e,t,i)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,de=(e,t)=>{for(var i in t||(t={}))an.call(t,i)&&ut(e,i,t[i]);if(ct)for(var i of ct(t))cn.call(t,i)&&ut(e,i,t[i]);return e},xe=(e,t)=>rn(e,on(t));var s=(e,t)=>at(e,"name",{value:t,configurable:!0});var oe=(e,t)=>()=>(e&&(t=e(e=0)),t),un=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);function ht(e){return e*Math.PI/180}function dt(e){return e*180/Math.PI}function ae(e,t,i){return Math.min(Math.max(e,t),i)}function ke(e,t,i){return e+(t-e)*i}function we(e,t,i,o,l){return o+(e-t)/(i-t)*(l-o)}function ft(e,t,i,o,l){return ae(we(e,t,i,o,l),o,l)}function d(...e){if(e.length===0)return d(0,0);if(e.length===1){if(typeof e[0]=="number")return d(e[0],e[0]);if(De(e[0]))return d(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return d.apply(null,e[0])}return{x:e[0],y:e[1],clone(){return d(this.x,this.y)},add(...t){let i=d(...t);return d(this.x+i.x,this.y+i.y)},sub(...t){let i=d(...t);return d(this.x-i.x,this.y-i.y)},scale(t){return d(this.x*t,this.y*t)},dist(...t){let i=d(...t);return Math.sqrt((this.x-i.x)*(this.x-i.x)+(this.y-i.y)*(this.y-i.y))},len(){return this.dist(d(0,0))},unit(){return this.scale(1/this.len())},normal(){return d(this.y,-this.x)},dot(...t){let i=d(...t);return d(this.x*i.x,this.y*i.y)},angle(...t){let i=d(...t);return Math.atan2(this.y-i.y,this.x-i.x)},lerp(t,i){return d(ke(this.x,t.x,i),ke(this.y,t.y,i))},eq(t){return this.x===t.x&&this.y===t.y},str(){return`(${this.x}, ${this.y})`}}}function lt(e){return d(Math.cos(e),Math.sin(e))}function ge(e,t,i){return{x:e,y:t,z:i,xy(){return d(this.x,this.y)}}}function De(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}function mt(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0&&e.z!==void 0}function ve(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}function pt(e){if(e!==void 0&&Array.isArray(e.m)&&e.m.length===16)return e}function Pe(...e){if(e.length===0)return Y();if(e.length===1){if(ve(e[0]))return Y(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Pe.apply(null,e[0])}return Y(e[0],e[1],e[2],1)}function Y(...e){var t;if(e.length===0)return Y(1,1,1,1);if(e.length===1){if(ve(e[0]))return Y(e[0].r,e[0].g,e[0].b,e[0].a);if(Array.isArray(e[0])&&e[0].length===4)return Y.apply(null,e[0])}return{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return Y(this.r,this.g,this.b,this.a)},lighten(i){return Y(this.r+i,this.g+i,this.b+i,this.a)},darken(i){return this.lighten(-i)},invert(){return Y(1-this.r,1-this.g,1-this.b,this.a)},isDark(i=.5){return this.r+this.g+this.b<3*i},isLight(i=.5){return this.r+this.g+this.b>3*i},eq(i){return this.r===i.r&&this.g===i.g&&this.b===i.g&&this.a===i.a}}}function se(e,t,i,o){return{x:e,y:t,w:i,h:o,clone(){return se(this.x,this.y,this.w,this.h)},eq(l){return this.x===l.x&&this.y===l.y&&this.w===l.w&&this.h===l.h}}}function Z(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return Z(this.m)},mult(t){let i=[];for(let o=0;o<4;o++)for(let l=0;l<4;l++)i[o*4+l]=this.m[0*4+l]*t.m[o*4+0]+this.m[1*4+l]*t.m[o*4+1]+this.m[2*4+l]*t.m[o*4+2]+this.m[3*4+l]*t.m[o*4+3];return Z(i)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let i=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return ge(i.x,i.y,i.z)},multVec2(t){return d(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(Z([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(Z([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(Z([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(Z([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(Z([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],i=this.m[10]*this.m[15]-this.m[14]*this.m[11],o=this.m[9]*this.m[15]-this.m[13]*this.m[11],l=this.m[9]*this.m[14]-this.m[13]*this.m[10],g=this.m[8]*this.m[15]-this.m[12]*this.m[11],k=this.m[8]*this.m[14]-this.m[12]*this.m[10],R=this.m[8]*this.m[13]-this.m[12]*this.m[9],j=this.m[6]*this.m[15]-this.m[14]*this.m[7],D=this.m[5]*this.m[15]-this.m[13]*this.m[7],F=this.m[5]*this.m[14]-this.m[13]*this.m[6],N=this.m[4]*this.m[15]-this.m[12]*this.m[7],E=this.m[4]*this.m[14]-this.m[12]*this.m[6],v=this.m[5]*this.m[15]-this.m[13]*this.m[7],_=this.m[4]*this.m[13]-this.m[12]*this.m[5],q=this.m[6]*this.m[11]-this.m[10]*this.m[7],A=this.m[5]*this.m[11]-this.m[9]*this.m[7],$=this.m[5]*this.m[10]-this.m[9]*this.m[6],b=this.m[4]*this.m[11]-this.m[8]*this.m[7],U=this.m[4]*this.m[10]-this.m[8]*this.m[6],X=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*i-this.m[6]*o+this.m[7]*l,t[4]=-(this.m[4]*i-this.m[6]*g+this.m[7]*k),t[8]=this.m[4]*o-this.m[5]*g+this.m[7]*R,t[12]=-(this.m[4]*l-this.m[5]*k+this.m[6]*R),t[1]=-(this.m[1]*i-this.m[2]*o+this.m[3]*l),t[5]=this.m[0]*i-this.m[2]*g+this.m[3]*k,t[9]=-(this.m[0]*o-this.m[1]*g+this.m[3]*R),t[13]=this.m[0]*l-this.m[1]*k+this.m[2]*R,t[2]=this.m[1]*j-this.m[2]*D+this.m[3]*F,t[6]=-(this.m[0]*j-this.m[2]*N+this.m[3]*E),t[10]=this.m[0]*v-this.m[1]*N+this.m[3]*_,t[14]=-(this.m[0]*F-this.m[1]*E+this.m[2]*_),t[3]=-(this.m[1]*q-this.m[2]*A+this.m[3]*$),t[7]=this.m[0]*q-this.m[2]*b+this.m[3]*U,t[11]=-(this.m[0]*A-this.m[1]*b+this.m[3]*X),t[15]=this.m[0]*$-this.m[1]*U+this.m[2]*X;let z=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let M=0;M<4;M++)for(let w=0;w<4;w++)t[M*4+w]*=1/z;return Z(t)}}}function yt(e,t,i){return e+(Math.sin(i)+1)/2*(t-e)}function Ke(e){return{seed:e,gen(t,i){if(De(t)&&De(i))return d(this.gen(t.x,i.x),this.gen(t.y,i.y));if(ve(t)&&ve(i))return Y(this.gen(t.r,i.r),this.gen(t.g,i.g),this.gen(t.b,i.b),this.gen(t.a,i.a));if(t!==void 0)return i===void 0?this.gen()*t:this.gen()*(i-t)+t;if(t===void 0&&i===void 0)return this.seed=(hn*this.seed+dn)%bt,this.seed/bt;throw new Error("invalid param to rand()")}}}function wt(e){xt.seed=e}function Ie(e,t){return xt.gen(e,t)}function gt(e){return Ie(0,1)<=e}function vt(e){return e[Math.floor(Ie(e.length))]}function Ze(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function Rt(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function _t(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var hn,dn,bt,xt,pe=oe(()=>{s(ht,"deg2rad");s(dt,"rad2deg");s(ae,"clamp");s(ke,"lerp");s(we,"map");s(ft,"mapc");s(d,"vec2");s(lt,"vec2FromAngle");s(ge,"vec3");s(De,"isVec2");s(mt,"isVec3");s(ve,"isColor");s(pt,"isMat4");s(Pe,"rgb");s(Y,"rgba");s(se,"quad");s(Z,"mat4");s(yt,"wave");hn=1103515245,dn=12345,bt=2147483648,xt=Ke(Date.now());s(Ke,"makeRng");s(wt,"randSeed");s(Ie,"rand");s(gt,"chance");s(vt,"choose");s(Ze,"colRectRect");s(Rt,"overlapRectRect");s(_t,"colRectPt")});function Qe(e,t){let i=typeof e,o=typeof t;if(i!==o)return!1;if(i==="object"&&o==="object"){let l=Object.keys(e),g=Object.keys(t);if(l.length!==g.length)return!1;for(let k of l){let R=e[k],j=t[k];if(!(typeof R=="function"&&typeof j=="function")&&!Qe(R,j))return!1}return!0}return e===t}var Et=oe(()=>{s(Qe,"deepEq")});function Le(e){switch(e){case"topleft":return d(-1,-1);case"top":return d(0,-1);case"topright":return d(1,-1);case"left":return d(-1,0);case"center":return d(0,0);case"right":return d(1,0);case"botleft":return d(-1,1);case"bot":return d(0,1);case"botright":return d(1,1);default:return e}}function At(e,t){let i=(()=>{switch(t.texFilter){case"linear":return e.LINEAR;case"nearest":return e.NEAREST;default:return e.NEAREST}})(),o=(()=>{var B;let f=k(et,tt),x=g(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),y=(B=t.clearColor)!=null?B:Y(0,0,0,1);e.clearColor(y.r,y.g,y.b,y.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);let P=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,P),e.bufferData(e.ARRAY_BUFFER,je*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let O=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,O),e.bufferData(e.ELEMENT_ARRAY_BUFFER,je*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let V=g(new ImageData(new Uint8ClampedArray([128,128,128,255,190,190,190,255,190,190,190,255,128,128,128,255]),2,2));return{drawCalls:0,lastDrawCalls:0,defProg:f,curProg:f,defTex:x,curTex:x,curUniform:{},vbuf:P,ibuf:O,vqueue:[],iqueue:[],transform:Z(),transformStack:[],clearColor:y,bgTex:V}})();function l(f){return Math.log(f)/Math.log(2)%1==0}s(l,"powerOfTwo");function g(f){let x=e.createTexture();e.bindTexture(e.TEXTURE_2D,x),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i);let y=(()=>l(f.width)&&l(f.height)?e.REPEAT:e.CLAMP_TO_EDGE)();return e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,y),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,y),e.bindTexture(e.TEXTURE_2D,null),{width:f.width,height:f.height,bind(){e.bindTexture(e.TEXTURE_2D,x)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}s(g,"makeTex");function k(f=et,x=tt){let y,P=fn.replace("{{user}}",f!=null?f:et),O=ln.replace("{{user}}",x!=null?x:tt),V=e.createShader(e.VERTEX_SHADER),B=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(V,P),e.shaderSource(B,O),e.compileShader(V),e.compileShader(B),y=e.getShaderInfoLog(V))throw new Error(y);if(y=e.getShaderInfoLog(B))throw new Error(y);let C=e.createProgram();if(e.attachShader(C,V),e.attachShader(C,B),e.bindAttribLocation(C,0,"a_pos"),e.bindAttribLocation(C,1,"a_uv"),e.bindAttribLocation(C,2,"a_color"),e.linkProgram(C),(y=e.getProgramInfoLog(C))&&y!==`
`)throw new Error(y);return{bind(){e.useProgram(C)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,Fe*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,Fe*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,Fe*4,20),e.enableVertexAttribArray(2)},send(T){this.bind();for(let W in T){let I=T[W],K=e.getUniformLocation(C,W);typeof I=="number"?e.uniform1f(K,I):pt(I)?e.uniformMatrix4fv(K,!1,new Float32Array(I.m)):ve(I)?e.uniform4f(K,I.r,I.g,I.b,I.a):mt(I)?e.uniform3f(K,I.x,I.y,I.z):De(I)&&e.uniform2f(K,I.x,I.y)}this.unbind()}}}s(k,"makeProgram");function R(f,x,y,P){let O=f.width/x,V=f.height/y,B=1/O,C=1/V,T={},W=P.split("").entries();for(let[I,K]of W)T[K]=d(I%O*B,Math.floor(I/O)*C);return{tex:f,map:T,qw:B,qh:C}}s(R,"makeFont");function j(f,x,y=o.defTex,P=o.defProg,O={}){y=y!=null?y:o.defTex,P=P!=null?P:o.defProg,(y!==o.curTex||P!==o.curProg||!Qe(o.curUniform,O)||o.vqueue.length+f.length*Fe>je||o.iqueue.length+x.length>je)&&D(),o.curTex=y,o.curProg=P,o.curUniform=O;let V=x.map(C=>C+o.vqueue.length/Fe),B=f.map(C=>{let T=v(o.transform.multVec2(C.pos.xy()));return[T.x,T.y,C.pos.z,C.uv.x,C.uv.y,C.color.r,C.color.g,C.color.b,C.color.a]}).flat();V.forEach(C=>o.iqueue.push(C)),B.forEach(C=>o.vqueue.push(C))}s(j,"drawRaw");function D(){!o.curTex||!o.curProg||o.vqueue.length===0||o.iqueue.length===0||(o.curProg.send(o.curUniform),e.bindBuffer(e.ARRAY_BUFFER,o.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(o.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(o.iqueue)),o.curProg.bind(),o.curProg.bindAttribs(),o.curTex.bind(),e.drawElements(e.TRIANGLES,o.iqueue.length,e.UNSIGNED_SHORT,0),o.curTex.unbind(),o.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),o.iqueue=[],o.vqueue=[],o.drawCalls++)}s(D,"flush");function F(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),o.drawCalls=0,o.transformStack=[],o.transform=Z()}s(F,"frameStart");function N(){D(),o.lastDrawCalls=o.drawCalls}s(N,"frameEnd");function E(){return o.lastDrawCalls}s(E,"drawCalls");function v(f){return d(f.x/_e()*2-1,-f.y/Ge()*2+1)}s(v,"toNDC");function _(f){o.transform=f.clone()}s(_,"pushMatrix");function q(f){!f||f.x===0&&f.y===0||(o.transform=o.transform.translate(f))}s(q,"pushTranslate");function A(f){!f||f.x===1&&f.y===1||(o.transform=o.transform.scale(f))}s(A,"pushScale");function $(f){!f||(o.transform=o.transform.rotateX(f))}s($,"pushRotateX");function b(f){!f||(o.transform=o.transform.rotateY(f))}s(b,"pushRotateY");function U(f){!f||(o.transform=o.transform.rotateZ(f))}s(U,"pushRotateZ");function X(){o.transformStack.push(o.transform.clone())}s(X,"pushTransform");function z(){o.transformStack.length>0&&(o.transform=o.transformStack.pop())}s(z,"popTransform");function M(f={}){var K,ee;let x=f.width||0,y=f.height||0,P=f.pos||d(0,0),V=Le(f.origin||Je).dot(d(x,y).scale(-.5)),B=d((K=f.scale)!=null?K:1),C=f.rot||0,T=f.quad||se(0,0,1,1),W=1-((ee=f.z)!=null?ee:0),I=f.color||Y(1,1,1,1);X(),q(P),A(B),U(C),q(V),j([{pos:ge(-x/2,y/2,W),uv:d(T.x,T.y+T.h),color:I},{pos:ge(-x/2,-y/2,W),uv:d(T.x,T.y),color:I},{pos:ge(x/2,-y/2,W),uv:d(T.x+T.w,T.y),color:I},{pos:ge(x/2,y/2,W),uv:d(T.x+T.w,T.y+T.h),color:I}],[0,1,3,1,2,3],f.tex,f.prog,f.uniform),z()}s(M,"drawQuad");function w(f,x={}){var V;let y=(V=x.quad)!=null?V:se(0,0,1,1),P=f.width*y.w,O=f.height*y.h;M(xe(de({},x),{tex:f,quad:y,width:P,height:O}))}s(w,"drawTexture");function G(f,x,y,P={}){M(xe(de({},P),{pos:f,width:x,height:y}))}s(G,"drawRect");function ce(f,x,y,P={}){let O=Le(P.origin||Je).dot(d(x,y)).scale(.5),V=f.add(d(-x/2,-y/2)).sub(O),B=f.add(d(-x/2,y/2)).sub(O),C=f.add(d(x/2,y/2)).sub(O),T=f.add(d(x/2,-y/2)).sub(O);Q(V,B,P),Q(B,C,P),Q(C,T,P),Q(T,V,P)}s(ce,"drawRectStroke");function Q(f,x,y={}){let P=y.width||1,O=f.dist(x),V=Math.PI/2-f.angle(x);M(xe(de({},y),{pos:f.add(x).scale(.5),width:P,height:O,rot:V,origin:"center"}))}s(Q,"drawLine");function te(f,x,y={}){let P=(f+"").split(""),O=x.qw*x.tex.width,V=x.qh*x.tex.height,B=y.size||V,C=d(B/V).dot(d(y.scale||1)),T=C.x*O,W=C.y*V,I=0,K=W,ee=0,be=[[]];for(let he of P)(he===`
`||(y.width?I+T>y.width:!1))&&(K+=W,I=0,be.push([])),he!==`
`&&(be[be.length-1].push(he),I+=T),ee=Math.max(ee,I);y.width&&(ee=y.width);let qe=[],ue=d(y.pos||0),J=Le(y.origin||Je).scale(.5),Ee=-J.x*T-(J.x+.5)*(ee-T),Ae=-J.y*W-(J.y+.5)*(K-W);return be.forEach((he,Oe)=>{let Ve=(ee-he.length*T)*(J.x+.5);he.forEach((Ne,Xe)=>{let Se=x.map[Ne],Ue=Xe*T,Ye=Oe*W;Se&&qe.push({tex:x.tex,quad:se(Se.x,Se.y,x.qw,x.qh),ch:Ne,pos:d(ue.x+Ue+Ee+Ve,ue.y+Ye+Ae),color:y.color,origin:y.origin,scale:C,z:y.z})})}),{width:ee,height:K,chars:qe}}s(te,"fmtText");function ne(f,x,y={}){Me(te(f,x,y))}s(ne,"drawText");function Me(f){for(let x of f.chars)M({tex:x.tex,width:x.tex.width*x.quad.w,height:x.tex.height*x.quad.h,pos:x.pos,scale:x.scale,color:x.color,quad:x.quad,origin:"center",z:x.z})}s(Me,"drawFmtText");function _e(){return e.drawingBufferWidth/fe()}s(_e,"width");function Ge(){return e.drawingBufferHeight/fe()}s(Ge,"height");function fe(){var f;return(f=t.scale)!=null?f:1}s(fe,"scale");function ye(){return o.clearColor.clone()}return s(ye,"clearColor"),{width:_e,height:Ge,scale:fe,makeTex:g,makeProgram:k,makeFont:R,drawTexture:w,drawText:ne,drawFmtText:Me,drawRect:G,drawRectStroke:ce,drawLine:Q,fmtText:te,frameStart:F,frameEnd:N,pushTransform:X,popTransform:z,pushMatrix:_,drawCalls:E,clearColor:ye}}var Je,Fe,je,fn,ln,et,tt,St=oe(()=>{pe();Et();Je="topleft",Fe=9,je=65536,fn=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,ln=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,et=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,tt=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;s(Le,"originPt");s(At,"gfxInit")});function Tt(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}function Ct(e={}){var z,M;let t={canvas:(z=e.canvas)!=null?z:(()=>{var G;let w=document.createElement("canvas");return((G=e.root)!=null?G:document.body).appendChild(w),w})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:d(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(M=e.scale)!=null?M:1,isTouch:!1,loopID:null,stopped:!1},i={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},o=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let l=["outline: none","cursor: default"];e.crisp&&(l.push("image-rendering: pixelated"),l.push("image-rendering: crisp-edges")),t.canvas.style=l.join(";"),t.canvas.setAttribute("tabindex","0");let g=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("mousemove",w=>{t.mousePos=d(w.offsetX,w.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",w=>{let G=i[w.key]||w.key.toLowerCase();o.includes(G)&&w.preventDefault(),G.length===1&&t.charInputted.push(G),G==="space"&&t.charInputted.push(" "),w.repeat?t.keyStates[G]="rpressed":t.keyStates[G]="pressed"}),t.canvas.addEventListener("keyup",w=>{let G=i[w.key]||w.key.toLowerCase();t.keyStates[G]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function k(){return t.mousePos.clone()}s(k,"mousePos");function R(){return t.mouseState==="pressed"}s(R,"mouseClicked");function j(){return t.mouseState==="pressed"||t.mouseState==="down"}s(j,"mouseDown");function D(){return t.mouseState==="released"}s(D,"mouseReleased");function F(w){return t.keyStates[w]==="pressed"}s(F,"keyPressed");function N(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"}s(N,"keyPressedRep");function E(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"||t.keyStates[w]==="down"}s(E,"keyDown");function v(w){return t.keyStates[w]==="released"}s(v,"keyReleased");function _(){return[...t.charInputted]}s(_,"charInputted");function q(){return t.dt}s(q,"dt");function A(){return t.time}s(A,"time");function $(){return t.canvas.toDataURL()}s($,"screenshot");function b(w){return w&&(t.canvas.style.cursor=w!=null?w:"default"),t.canvas.style.cursor}s(b,"cursor");function U(w){let G=s(ce=>{let Q=ce/1e3,te=Q-t.realTime;t.realTime=Q,t.skipTime||(t.dt=te,t.time+=t.dt),t.skipTime=!1,w();for(let ne in t.keyStates)t.keyStates[ne]=Tt(t.keyStates[ne]);t.mouseState=Tt(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(G))},"frame");t.loopID=requestAnimationFrame(G)}s(U,"run");function X(){cancelAnimationFrame(t.loopID),t.stopped=!0}return s(X,"quit"),{gl:g,mousePos:k,keyDown:E,keyPressed:F,keyPressedRep:N,keyReleased:v,mouseDown:j,mouseClicked:R,mouseReleased:D,charInputted:_,cursor:b,dt:q,time:A,screenshot:$,run:U,quit:X}}var kt=oe(()=>{pe();s(Tt,"processBtnState");s(Ct,"appInit")});function It(){let e=(()=>{let l=new(window.AudioContext||window.webkitAudioContext),g=l.createGain(),k=g;return k.connect(l.destination),{ctx:l,gainNode:g,masterNode:k}})();function t(l){return l!==void 0&&(e.gainNode.gain.value=ae(l,Dt,Pt)),e.gainNode.gain.value}s(t,"volume");function i(l,g={loop:!1,volume:1,speed:1,detune:0,seek:0}){var v;let k=!1,R=e.ctx.createBufferSource();R.buffer=l,R.loop=!!g.loop;let j=e.ctx.createGain();R.connect(j),j.connect(e.masterNode);let D=(v=g.seek)!=null?v:0;R.start(0,D);let F=e.ctx.currentTime-D,N=null,E={stop(){this.pause(),F=e.ctx.currentTime},play(_){if(!k)return;let q=R;R=e.ctx.createBufferSource(),R.buffer=q.buffer,R.loop=q.loop,R.playbackRate.value=q.playbackRate.value,R.detune&&(R.detune.value=q.detune.value),R.connect(j);let A=_!=null?_:this.time();R.start(0,A),F=e.ctx.currentTime-A,k=!1,N=null},pause(){R.stop(),k=!0,N=e.ctx.currentTime},paused(){return k},stopped(){return k},speed(_){return _!==void 0&&(R.playbackRate.value=ae(_,mn,pn)),R.playbackRate.value},detune(_){return R.detune?(_!==void 0&&(R.detune.value=ae(_,yn,bn)),R.detune.value):0},volume(_){return _!==void 0&&(j.gain.value=ae(_,Dt,Pt)),j.gain.value},loop(){R.loop=!0},unloop(){R.loop=!1},duration(){return l.duration},time(){return k&&N?N-F:e.ctx.currentTime-F}};return E.speed(g.speed),E.detune(g.detune),E.volume(g.volume),E}s(i,"play");function o(){return e.ctx}return s(o,"ctx"),{ctx:o,volume:t,play:i}}var Dt,Pt,mn,pn,yn,bn,Ft=oe(()=>{pe();Dt=0,Pt=3,mn=0,pn=3,yn=-1200,bn=1200;s(It,"audioInit")});var Lt,Mt=oe(()=>{Lt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAvgAAAAICAYAAACML4vTAAAAAXNSR0IArs4c6QAABo1JREFUeJzdW9uO5SgMJKv9/1/OPnQnDabKVQb6zGgtjeYkvmJsYwh9tQLc931//7yu63retdba+/4hTZ6ZDMQ3wHVdPe1kXk/60He2D/J7HLMhGyOwHQKji/o/BYmv40DecRq+cfgr8l8dhBfRLPF3v6F9Cu/ObwFPYxRBFptE7mA/wQ2yWMwI/1r+y3Bq/h4H3TwJ3fl16xcz4UfQPB+oplF9QJ7id+SjMVjz/wf5e5rK+hKfB9+a86PsZTIm+7P6942jufsqSvg7/END5WSg6ojLt7uurcjL6v8pfQ4doinIL9v+f4HTMfQ3gopR5gOQ+6jviPj7EfLvqQGsQFiXb/B7KMBGc/rQ3x1ONuHmBmOQfd93XwDVguPI/3Uw/fc8Dz5s4/xMogU/xScNKILJb4W5Q/YyXtt+IWcyF+GzMajY7ehZbCK5vf2sGczmJ+J6O6J8pT8dB5HPwPU706/knsjfVRlxvhje0Zn5H+F/m/+kf6uA1oxqPVD1Jeqj+kHuRr5x0ZzzU8nJANrCalDS5A54xV9Ynyd+p/6bNXSiBfY5Dk1pkPyObzI0s10ceFr+3+FXsMq/qk+BM97TusU6bIvp+Flf1ufuy/OJBh817s/vlcKOaOHgRBOeyu0nppt4uIEA+gcboLLv96oIu18IFLhfSRooMh19hsvkKyNjkCo6R+fXC3ya/ddAdjrekxH2i8VmiH23oGTNYy+n2iBHyPhYjtWV8IJtyz38BW6a42JMKuJtn30IfgJT+PdkziayaP1W+OpX6J6HyJ+ac8MXaJEvNfnGGheVow34neAn/tag30aByRfI5PDBlZ9tzNghHuJDMnZpGO37rMam/L/Jj2w6wY/8TH1gPCNfQ3zxAJTZ3wPKkS9EIS9bm3OfbDonof9YWgw7gCJ0uqF+390/JIs1QZE+yhjkKOcifMKDdMX3kYbxKB3xn8fsNZEPPm2SBQ7KD/OkkgXZfYV/PV/U/+rok0IswDH+HDyCmAcuXs1LHP8gBzTyd487dIrgAPPfC489wK6K/GwjouYoo6nmZQXUHCtA9RThd+yX87fIn9X3T8Kkl2yC3zlS+NZK9XUClruFjU3093IcBFui8U79Zfg74Flj7dRHJJ/1Hq58xAs3JAdgNb9QDxHB9f8JfgSV+c96QaVnCcRhzx3+r+hXY9qtq1HmKy+up3Ft3T7BN06gWVDGZhI5JL4b6Mh9yolu5T6iukMN7M4KQqWZ/SKYP9+lYJyAOYtPveMy5IPdZja//XPVnkw+tBHdPe35w8kWs3UX+tjNrtggvpWvM3H8Lihi5f/dE1kVD068PL7O+Fc2z65eNseuDEfHKoxFpx4fjm9bS+LjFyEu4F8P4gras1geqq8QzK9wlJ3IWYJk3TtS8zbvV8MN2qGvaxQOXt3YafKe2NjN8U8A2hzGDQpdg37xqzurObB3dOY9uyYG8nG37pXjp9rg7wQm+v0A201GvGqUd4KfFlejgUobxCDjixAXod3NiWVfRaa6YsT0hitIWWAqXyr+JdhYBDJbSg32Y8fOFZvVDdziBq/cABPY8WEKpxf31fgnMM2xq681u9HYagAM/6mxDmM0eXaBNhCELgKt36Z+Vf9GYoDLrsg496TZ8yFg629dEL+D7sDq4FB8bIF7xTaxI2X8Q9dJWf7Y/ks2iPYGf2HsWf5HnOovUH2m4896Q9JDDs+rV7TduKs2+EcLNdnhvM/f+MqCEp8tO437h9C2YEP2nL7/5WR2G79sgYwGqo1ElJHu4F9msAkC84Lscxd4Bg5/ansGhVOAKf7MAuBu4NC8seJ1mQ0lku/okM090M/iS8HuAq/ivxJ/To1RMrDg/G8OTuVHub4e1j/wg9xBuF5fbPJVTlTsdOaPrmdiHVqK3UN/w+Xmz2r+K/mQf6G5RnauwDuHm80oGwCLkZMbHLYB/nkYm9Md/yF6NDa3SR9sNPM/0rD+cpgf8ws+qifOGN35XK2bHznBj3xWEKHTy+QT5HYiGJ83kW3lP5ZI4MTmKU1a9rcFbNyFT76OzVC+olP2tQYLEJNfGmO2iVs4AU/nd/PzejrHiM58z/BWvjnzs+J7QEvxzlcQgFupJxXfVuSjuFP11NFp4bI76IVnpZ/a7cxfRkNiIxtL9n41f1yayhrngmrG5LwYdWkp/x35h9Yg1WC6vlYNuStvKeZW+h9zfR/eIboHxD12Bml87PYgiCZZP5Z81fI5lrm5k0fxfWVj+x9lSgjp7YOOoAAAAABJRU5ErkJggg=="});function Gt(e){let t=new Image;return t.src=e,t.crossOrigin="anonymous",new Promise((i,o)=>{t.onload=()=>{i(t)},t.onerror=()=>{o(`failed to load ${e}`)}})}function qt(e){return e.startsWith("data:")}function Ot(e,t,i={}){let o={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function l(E){var _;let v=o.lastLoaderID;o.loaders[v]=!1,o.lastLoaderID++,E.catch((_=i.errHandler)!=null?_:console.error).finally(()=>{o.loaders[v]=!0})}s(l,"addLoader");function g(){let E=0,v=0;for(let _ in o.loaders)E+=1,o.loaders[_]&&(v+=1);return v/E}s(g,"loadProgress");function k(E){return E&&(o.loadRoot=E),o.loadRoot}s(k,"loadRoot");function R(E,v,_,q,A=wn){let $=new Promise((b,U)=>{let X=qt(v)?v:o.loadRoot+v;Gt(X).then(z=>{let M=e.makeFont(e.makeTex(z),_,q,A);o.fonts[E]=M,b(M)}).catch(U)});return l($),$}s(R,"loadFont");function j(E,v,_={sliceX:1,sliceY:1,anims:{}}){function q($,b,U={sliceX:1,sliceY:1,anims:{}}){let X=[],z=e.makeTex(b),M=U.sliceX||1,w=U.sliceY||1,G=1/M,ce=1/w;for(let te=0;te<w;te++)for(let ne=0;ne<M;ne++)X.push(se(ne*G,te*ce,G,ce));let Q={tex:z,frames:X,anims:U.anims||{}};return o.sprites[$]=Q,Q}s(q,"loadRawSprite");let A=new Promise(($,b)=>{if(!v)return b(`expected sprite src for "${E}"`);if(typeof v=="string"){let U=qt(v)?v:o.loadRoot+v;Gt(U).then(X=>{$(q(E,X,_))}).catch(b)}else $(q(E,v,_))});return l(A),A}s(j,"loadSprite");function D(E,v,_,q=!1){function A(b,U,X){let z=e.makeProgram(U,X);return o.shaders[b]=z,z}s(A,"loadRawShader");let $=new Promise((b,U)=>{if(!v&&!_)return U("no shader");function X(z){return z?fetch(o.loadRoot+z).then(M=>{if(M.ok)return M.text();throw new Error(`failed to load ${z}`)}).catch(U):new Promise(M=>M(null))}if(s(X,"resolveUrl"),q)Promise.all([X(v),X(_)]).then(([z,M])=>{b(A(E,z,M))}).catch(U);else try{b(A(E,v,_))}catch(z){U(z)}});return l($),$}s(D,"loadShader");function F(E,v){let _=o.loadRoot+v,q=new Promise((A,$)=>{if(!v)return $(`expected sound src for "${E}"`);typeof v=="string"&&fetch(_).then(b=>{if(b.ok)return b.arrayBuffer();throw new Error(`failed to load ${_}`)}).then(b=>new Promise((U,X)=>{t.ctx().decodeAudioData(b,U,X)})).then(b=>{o.sounds[E]=b,A(b)}).catch($)});return l(q),q}s(F,"loadSound");function N(){return o.fonts[Re]}return s(N,"defFont"),R(Re,Lt,8,8),{loadRoot:k,loadSprite:j,loadSound:F,loadFont:R,loadShader:D,loadProgress:g,addLoader:l,defFont:N,sprites:o.sprites,fonts:o.fonts,sounds:o.sounds,shaders:o.shaders}}var wn,Re,Vt=oe(()=>{pe();Mt();wn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",Re="unscii";s(Gt,"loadImg");s(qt,"isDataUrl");s(Ot,"assetsInit")});function Nt(e,t,i={max:8}){var D;let o=[],l=(D=i.max)!=null?D:8;function g(){o.length>l&&(o=o.slice(0,l));let F=d(0,e.height());o.forEach((N,E)=>{let v=we(E,0,l,1,.2),_=we(E,0,l,.8,.2),q=(()=>{switch(N.type){case"info":return Y(1,1,1,v);case"error":return Y(1,0,.5,v)}})(),A=e.fmtText(N.msg,t.defFont(),{pos:F,origin:"botleft",color:q,z:1,size:gn/e.scale(),width:e.width()});e.drawRect(F,A.width,A.height,{origin:"botleft",color:Y(0,0,0,_),z:1}),e.drawFmtText(A),F.y-=A.height})}s(g,"draw");function k(F){console.error(F),o.unshift({type:"error",msg:F})}s(k,"error");function R(F){o.unshift({type:"info",msg:F})}s(R,"info");function j(){o=[]}return s(j,"clear"),{info:R,error:k,draw:g,clear:j}}var gn,Ut=oe(()=>{pe();gn=16;s(Nt,"loggerInit")});function Bt(e){let t={},i=[],o=null;function l(){return o!==null&&o.readyState===1}s(l,"connected");function g(){let D=new WebSocket(e);return new Promise((F,N)=>{D.onopen=()=>{F(D),o=D;for(let E of i)D.send(E)},D.onerror=()=>{N(`failed to connect to ${e}`)},D.onmessage=E=>{let v=JSON.parse(E.data);if(t[v.type])for(let _ of t[v.type])_(v.data,v.id)}})}s(g,"connect");function k(D,F){t[D]||(t[D]=[]),t[D].push(F)}s(k,"recv");function R(D,F){let N=JSON.stringify({type:D,data:F});o?o.send(N):i.push(N)}s(R,"send");function j(){o&&o.close()}return s(j,"close"),{connect:g,close:j,connected:l,recv:k,send:R}}var zt=oe(()=>{s(Bt,"netInit")});var vn=un((Yn,jt)=>{pe();St();kt();Ft();Vt();Ut();zt();jt.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{let t=Ct({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),i=At(t.gl,{clearColor:e.clearColor?Y(e.clearColor):void 0,scale:e.scale,texFilter:e.texFilter}),o=It(),l=Ot(i,o,{errHandler:r=>{g.error(r)}}),g=Nt(i,l,{max:e.logMax}),k=(()=>e.connect?Bt(e.connect):null)();function R(r,n){if(!k)throw new Error("not connected to any websockets");k.recv(r,(a,c)=>{try{n(a,c)}catch(u){g.error(u)}})}s(R,"recv");function j(r,n){if(!k)throw new Error("not connected to any websockets");k.send(r,n)}s(j,"send");function D(){return t.dt()*H.timeScale}s(D,"dt");function F(r,n={}){let a=l.sounds[r];if(!a)throw new Error(`sound not found: "${r}"`);return o.play(a,n)}s(F,"play");function N(r){let n=b();return Object.keys(n.layers).length===0?n.cam.mpos:n.cam.ignore.includes(r!=null?r:n.defLayer)?t.mousePos():n.cam.mpos}s(N,"mousePos");function E(r,n={}){var u;let a=(()=>typeof r=="string"?l.sprites[r]:r)();if(!a)throw new Error(`sprite not found: "${r}"`);let c=a.frames[(u=n.frame)!=null?u:0];i.drawTexture(a.tex,xe(de({},n),{quad:c}))}s(E,"drawSprite");function v(r,n={}){var u;let a=(u=n.font)!=null?u:Re,c=l.fonts[a];if(!c)throw new Error(`font not found: ${a}`);i.drawText(r,c,n)}s(v,"drawText");let _=980,q="topleft",A={loaded:!1,scenes:{},curScene:null,nextScene:null};function $(r,n){A.scenes[r]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:d(i.width()/2,i.height()/2),scale:d(1,1),angle:0,shake:0,ignore:[],mpos:d(0),matrix:Z()},layers:{},defLayer:null,gravity:_,data:{}}}s($,"scene");function b(){return A.scenes[A.curScene]}s(b,"curScene");function U(){return b().data}s(U,"sceneData");function X(){T("`",()=>{H.showLog=!H.showLog,g.info(`show log: ${H.showLog?"on":"off"}`)}),T("f1",()=>{H.inspect=!H.inspect,g.info(`inspect: ${H.inspect?"on":"off"}`)}),T("f2",()=>{H.clearLog()}),T("f8",()=>{H.paused=!H.paused,g.info(`${H.paused?"paused":"unpaused"}`)}),T("f7",()=>{H.timeScale=ae(H.timeScale-.2,0,2),g.info(`time scale: ${H.timeScale.toFixed(1)}`)}),T("f9",()=>{H.timeScale=ae(H.timeScale+.2,0,2),g.info(`time scale: ${H.timeScale.toFixed(1)}`)}),T("f10",()=>{H.stepFrame(),g.info("stepped frame")})}s(X,"regDebugInputs");function z(r,...n){A.nextScene={name:r,args:[...n]}}s(z,"go");function M(r,...n){w(r),A.curScene=r;let a=A.scenes[r];if(!a)throw new Error(`scene not found: '${r}'`);if(!a.initialized){try{a.init(...n)}catch(c){g.error(c.stack)}e.debug&&X(),a.initialized=!0}}s(M,"goSync");function w(r){if(!A.scenes[r])throw new Error(`scene not found: '${r}'`);$(r,A.scenes[r].init)}s(w,"reload");function G(r,n){let a=b();if(!a)return;let c=.5/r.length;r.forEach((u,m)=>{a.layers[u]=.5+c*m}),n&&(a.defLayer=n)}s(G,"layers");function ce(...r){let n=b().cam;return r.length>0&&(n.pos=d(...r)),n.pos.clone()}s(ce,"camPos");function Q(...r){let n=b().cam;return r.length>0&&(n.scale=d(...r)),n.scale.clone()}s(Q,"camScale");function te(r){let n=b().cam;return r!==void 0&&(n.angle=r),n.angle}s(te,"camRot");function ne(r){let n=b().cam;n.shake=r}s(ne,"camShake");function Me(r){let n=b().cam;n.ignore=r}s(Me,"camIgnore");function _e(r){let n={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(c){if(c===void 0)return;let u=typeof c;if(u==="string"){this._tags.push(c);return}if(u!=="object")throw new Error(`invalid comp type: ${u}`);if(Array.isArray(c)){for(let m of c)this.use(m);return}for(let m in c){if(typeof c[m]=="function"){this._events[m]?this._events[m].push(c[m].bind(this)):this[m]=c[m].bind(this);continue}this[m]=c[m]}},exists(){return this._sceneID!==void 0},is(c){if(c==="*")return!0;if(Array.isArray(c)){for(let u of c)if(!this._tags.includes(u))return!1;return!0}return this._tags.includes(c)},on(c,u){this._events[c]||(this._events[c]=[]),this._events[c].push(u)},action(c){this.on("update",c)},trigger(c,...u){if(this._events[c])for(let p of this._events[c])p.call(this,...u);let h=b().events[c];if(h)for(let p of h)this.is(p.tag)&&p.cb(this,...u)},rmTag(c){let u=this._tags.indexOf(c);u>-1&&this._tags.splice(u,1)}};n.use(r);let a=b();a.objs.set(a.lastID,n),n._sceneID=a.lastID,a.lastID++,n.trigger("add");for(let c of a.events.add)n.is(c.tag)&&c.cb(n);return n}s(_e,"add");function Ge(r){if(!r.exists())return;let n=b();return n.objs.delete(r._sceneID),n.objs.set(n.lastID,r),r._sceneID=n.lastID,n.lastID++,r}s(Ge,"readd");function fe(r,n,a){let c=b();c.events[r]||(c.events[r]=[]),c.events[r].push({tag:n,cb:a})}s(fe,"on");function ye(r,n){typeof r=="function"&&n===void 0?b().action.push(r):typeof r=="string"&&fe("update",r,n)}s(ye,"action");function f(r,n){typeof r=="function"&&n===void 0?b().render.push(r):typeof r=="string"&&fe("update",r,n)}s(f,"render");function x(r,n,a){ye(r,c=>{c._checkCollisions(n,u=>{a(c,u)})})}s(x,"collides");function y(r,n,a){ye(r,c=>{c._checkOverlaps(n,u=>{a(c,u)})})}s(y,"overlaps");function P(r,n){ye(r,a=>{a.isClicked()&&n(a)})}s(P,"clicks");function O(r,n){return new Promise(a=>{let c=b();c.timers[c.lastTimerID++]={time:r,cb:()=>{n&&n(),a()}}})}s(O,"wait");function V(r,n){let a=!1,c=s(()=>{a||(n(),O(r,c))},"newF");return c(),{stop(){a=!0}}}s(V,"loop");function B(r,n,a){if(Array.isArray(n))for(let c of n)B(r,c,a);else b().events[r].push({key:n,cb:a})}s(B,"pushKeyEvent");function C(r,n){B("keyDown",r,n)}s(C,"keyDown");function T(r,n){B("keyPress",r,n)}s(T,"keyPress");function W(r,n){B("keyPressRep",r,n)}s(W,"keyPressRep");function I(r,n){B("keyRelease",r,n)}s(I,"keyRelease");function K(r){b().events.charInput.push({cb:r})}s(K,"charInput");function ee(r){b().events.mouseDown.push({cb:r})}s(ee,"mouseDown");function be(r){b().events.mouseClick.push({cb:r})}s(be,"mouseClick");function qe(r){b().events.mouseRelease.push({cb:r})}s(qe,"mouseRelease");function ue(r){let a=[...b().objs.values()];return r?a.filter(c=>c.is(r)):a}s(ue,"get");function J(r,n){typeof r=="function"&&n===void 0?ue().forEach(r):typeof r=="string"&&ue(r).forEach(n)}s(J,"every");function Ee(r,n){typeof r=="function"&&n===void 0?ue().reverse().forEach(r):typeof r=="string"&&ue(r).reverse().forEach(n)}s(Ee,"revery");function Ae(r){if(!r.exists())return;let n=b();!n||(r.trigger("destroy"),n.objs.delete(r._sceneID),delete r._sceneID)}s(Ae,"destroy");function he(r){J(r,n=>{Ae(n)})}s(he,"destroyAll");function Oe(r){let n=b();return r!==void 0&&(n.gravity=r),n.gravity}s(Oe,"gravity");function Ve(r){let n=b();if(!n)throw new Error(`scene not found: '${A.curScene}'`);let a=r||!H.paused;if(a)for(let h in n.timers){let p=n.timers[h];p.time-=D(),p.time<=0&&(p.cb(),delete n.timers[h])}if(Ee(h=>{!h.paused&&a&&h.trigger("update")}),a)for(let h of n.action)h();let c=d(i.width(),i.height()),u=n.cam,m=lt(Ie(0,Math.PI*2)).scale(u.shake);u.shake=ke(u.shake,0,5*D()),u.matrix=Z().translate(c.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(c.scale(-.5)).translate(u.pos.scale(-1).add(c.scale(.5)).add(m)),u.mpos=u.matrix.invert().multVec2(t.mousePos()),J(h=>{h.hidden||(i.pushTransform(),u.ignore.includes(h.layer)||i.pushMatrix(u.matrix),h.trigger("draw"),i.popTransform())});for(let h of n.render)h()}s(Ve,"gameFrame");function Ne(){let r=b();for(let n of r.events.charInput)t.charInputted().forEach(n.cb);for(let n of r.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of r.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of r.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of r.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of r.events.mouseDown)t.mouseDown()&&n.cb();for(let n of r.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of r.events.mouseRelease)t.mouseReleased()&&n.cb()}s(Ne,"handleEvents");function Xe(){var p;let r=b(),n=!1,a=i.scale()*((r.cam.scale.x+r.cam.scale.y)/2),c=l.defFont(),u=Y((p=e.inspectColor)!=null?p:[0,1,1,1]),m=d(6,6).scale(1/a),h=12;Ee(S=>{if(!S.area||S.hidden)return;i.pushTransform(),r.cam.ignore.includes(S.layer)||i.pushMatrix(r.cam.matrix);let L=!1;S.isHovered()&&!n&&(L=!0,n=!0);let re=(L?6:2)/a,ie=S._worldArea(),He=ie.p2.x-ie.p1.x,We=ie.p2.y-ie.p1.y;if(i.drawRectStroke(ie.p1,He,We,{width:re,color:u,z:.9}),L){let st=N(S.layer),Ce=0,ze=0,rt=[],it=s(le=>{let me=i.fmtText(le,c,{size:h/a,pos:st.add(d(m.x,m.y+ze)),z:1});rt.push(me),Ce=me.width>Ce?me.width:Ce,ze+=me.height},"addLine");for(let le of S._tags)it(`"${le}"`);for(let le of S._events.inspect){let me=le();for(let ot in me)it(`${ot}: ${me[ot]}`)}Ce+=m.x*2,ze+=m.y*2,i.drawRect(st,Ce,ze,{color:Y(0,0,0,1),z:1});for(let le of rt)i.drawFmtText(le)}i.popTransform()})}s(Xe,"drawInspect");function Se(r,...n){t.run(()=>{if(i.frameStart(),A.loaded){try{if(!b())throw new Error(`scene not found: '${A.curScene}'`);Ne(),Ve(),H.inspect&&Xe()}catch(a){g.error(a.stack),t.quit()}H.showLog&&g.draw(),A.nextScene&&(M.apply(null,[A.nextScene.name,...A.nextScene.args]),A.nextScene=null)}else{let a=l.loadProgress();if(a===1)A.loaded=!0,M(r,...n),k&&k.connect().catch(g.error);else{let c=i.width()/2,u=12,m=d(i.width()/2,i.height()/2).sub(d(c/2,u/2)),h=i.clearColor().isDark(.7)?Pe(1,1,1):Pe(0,0,0);i.drawRectStroke(m,c,u,{width:2,color:h}),i.drawRect(m,c*a,u,{color:h})}}i.frameEnd()})}s(Se,"start");function Ue(...r){return{pos:d(...r),move(...n){let a=d(...n),c=a.x*D(),u=a.y*D();this.pos.x+=c,this.pos.y+=u},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}s(Ue,"pos");function Ye(...r){return{scale:d(...r),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}s(Ye,"scale");function Xt(r){return{angle:r}}s(Xt,"rotate");function Yt(...r){return{color:Y(...r)}}s(Yt,"color");function $t(r){return{origin:r}}s($t,"origin");function Ht(r){return{layer:r,inspect(){var a;let n=b();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}s(Ht,"layer");function $e(r,n){var c,u;let a=b();return((c=r.layer)!=null?c:a.defLayer)===((u=n.layer)!=null?u:a.defLayer)}s($e,"isSameLayer");function nt(r,n){let a={},c={};return{area:{p1:r,p2:n},areaWidth(){let{p1:u,p2:m}=this._worldArea();return m.x-u.x},areaHeight(){let{p1:u,p2:m}=this._worldArea();return m.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){return this.hasPt(N(this.layer))},isCollided(u){if(!u.area||!$e(this,u))return!1;let m=this._worldArea(),h=u._worldArea();return Ze(m,h)},isOverlapped(u){if(!u.area||!$e(this,u))return!1;let m=this._worldArea(),h=u._worldArea();return Rt(m,h)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,m){this.action(()=>{this._checkCollisions(u,m)})},overlaps(u,m){this.action(()=>{this._checkOverlaps(u,m)})},hasPt(u){let m=this._worldArea();return _t({p1:m.p1,p2:m.p2},u)},resolve(){let u=[];return J(m=>{if(m===this||!m.solid||!m.area||!$e(this,m))return;let h=this._worldArea(),p=m._worldArea();if(!Ze(h,p))return;let S=h.p2.x-p.p1.x,L=p.p2.x-h.p1.x,re=h.p2.y-p.p1.y,ie=p.p2.y-h.p1.y,He=Math.min(S,L,re,ie),We=(()=>{switch(He){case S:return this.pos.x-=S,"right";case L:return this.pos.x+=L,"left";case re:return this.pos.y-=re,"bottom";case ie:return this.pos.y+=ie,"top"}})();u.push({obj:m,side:We})}),u},_checkCollisions(u,m){J(u,h=>{this!==h&&(a[h._sceneID]||this.isCollided(h)&&(m(h),a[h._sceneID]=h))});for(let h in a){let p=a[h];this.isCollided(p)||delete a[h]}},_checkOverlaps(u,m){J(u,h=>{this!==h&&(c[h._sceneID]||this.isOverlapped(h)&&(m(h),c[h._sceneID]=h))});for(let h in c){let p=c[h];this.isOverlapped(p)||delete c[h]}},_worldArea(){let u=this.area,m=this.pos||d(0),h=this.scale||d(1),p=m.add(u.p1.dot(h)),S=m.add(u.p2.dot(h));return{p1:d(Math.min(p.x,S.x),Math.min(p.y,S.y)),p2:d(Math.max(p.x,S.x),Math.max(p.y,S.y))}}}}s(nt,"area");function Be(r,n,a){let c=d(r,n),u=Le(a||q).dot(c).scale(-.5);return nt(u.sub(c.scale(.5)),u.add(c.scale(.5)))}s(Be,"getAreaFromSize");function Wt(r,n={}){let a=l.sprites[r];if(!a)throw new Error(`sprite not found: "${r}"`);let c=de({},a.frames[0]);n.quad&&(c.x+=n.quad.x*c.w,c.y+=n.quad.y*c.h,c.w*=n.quad.w,c.h*=n.quad.h);let u=a.tex.width*c.w,m=a.tex.height*c.h,h=null;return{width:u,height:m,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||se(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Be(this.width,this.height,this.origin))},draw(){var L;let p=b(),S=a.frames[this.frame];E(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:l.shaders[this.shader],uniform:this.uniform,z:p.layers[(L=this.layer)!=null?L:p.defLayer]})},update(){if(!h)return;let p=a.anims[h.name];h.timer+=D(),h.timer>=this.animSpeed&&(this.frame++,this.frame>p.to&&(h.loop?this.frame=p.from:(this.frame--,this.stop())),h.timer-=this.animSpeed)},play(p,S=!0){let L=a.anims[p];if(!L)throw new Error(`anim not found: ${p}`);h&&this.stop(),h={name:p,loop:S,timer:0},this.frame=L.from,this.trigger("animPlay",p)},stop(){if(!h)return;let p=h.name;h=null,this.trigger("animEnd",p)},changeSprite(p){if(a=l.sprites[p],!a)throw new Error(`sprite not found: "${p}"`);let S=de({},a.frames[0]);n.quad&&(S.x+=n.quad.x*S.w,S.y+=n.quad.y*S.h,S.w*=n.quad.w,S.h*=n.quad.h),this.width=a.tex.width*S.w,this.height=a.tex.height*S.h,this.area&&!n.noArea&&this.use(Be(this.width,this.height,this.origin)),h=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return h==null?void 0:h.name},inspect(){let p={};return h&&(p.curAnim=`"${h.name}"`),p}}}s(Wt,"sprite");function Kt(r,n,a={}){return{text:r,textSize:n,font:a.font,width:0,height:0,add(){var c,u,m,h;if(!this.area&&!a.noArea){let p=b(),S=l.fonts[(c=this.font)!=null?c:Re],L=i.fmtText(this.text+"",S,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:p.layers[(u=this.layer)!=null?u:p.defLayer]});this.width=L.width/(((m=this.scale)==null?void 0:m.x)||1),this.height=L.height/(((h=this.scale)==null?void 0:h.y)||1),this.use(Be(this.width,this.height,this.origin))}},draw(){var h,p;let c=b(),u=l.fonts[(h=this.font)!=null?h:Re],m=i.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:c.layers[(p=this.layer)!=null?p:c.defLayer]});this.width=m.width,this.height=m.height,i.drawFmtText(m)}}}s(Kt,"text");function Zt(r,n,a={}){return{width:r,height:n,add(){!this.area&&!a.noArea&&this.use(Be(this.width,this.height,this.origin))},draw(){var u;let c=b();i.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:c.layers[(u=this.layer)!=null?u:c.defLayer],prog:l.shaders[this.shader],uniform:this.uniform})}}}s(Zt,"rect");function Qt(){return{solid:!0}}s(Qt,"solid");let Jt=960,en=480;function tn(r={}){var m,h;let n=0,a=null,c=null,u=(m=r.maxVel)!=null?m:Jt;return{jumpForce:(h=r.jumpForce)!=null?h:en,update(){this.move(0,n);let p=this.resolve(),S=!1;if(a&&(!a.exists()||!this.isCollided(a)?(a=null,c=null,S=!0):c&&(this.pos=this.pos.add(a.pos.sub(c)),c=a.pos.clone())),!a){n=Math.min(n+Oe()*D(),u);for(let L of p)L.side==="bottom"&&n>0?(a=L.obj,n=0,c=a.pos.clone(),S||this.trigger("grounded",a)):L.side==="top"&&n<0&&(n=0,this.trigger("headbump",L.obj))}},curPlatform(){return a},grounded(){return a!==null},falling(){return n>0},jump(p){a=null,n=-p||-this.jumpForce}}}s(tn,"body");function nn(r,n={}){let a=l.shaders[r];return{shader:r,uniform:n}}s(nn,"shader");let H={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return b().objs.size},stepFrame(){Ve(!0)},drawCalls:i.drawCalls,clearLog:g.clear,log:g.info,error:g.error};function sn(r,n){let a=[],c=d(n.pos||0),u=0,m={getPos(...h){let p=d(...h);return d(c.x+p.x*n.width,c.y+p.y*n.height)},spawn(h,p){let S=(()=>{if(Array.isArray(h))return h;if(n[h]){if(typeof n[h]=="function")return n[h]();if(Array.isArray(n[h]))return[...n[h]]}else if(n.any)return n.any(h)})();if(!S)return;S.push(Ue(c.x+p.x*n.width,c.y+p.y*n.height));let L=_e(S);return a.push(L),L.use({gridPos:p.clone(),setGridPos(re){this.gridPos=re.clone(),this.pos=d(c.x+this.gridPos.x*n.width,c.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(d(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(d(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(d(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(d(0,1)))}}),L},width(){return u*n.width},height(){return r.length*n.height},destroy(){for(let h of a)Ae(h)}};return r.forEach((h,p)=>{let S=h.split("");u=Math.max(S.length,u),S.forEach((L,re)=>{m.spawn(L,d(re,p))})}),m}s(sn,"addLevel");let Te={start:Se,loadRoot:l.loadRoot,loadSprite:l.loadSprite,loadSound:l.loadSound,loadFont:l.loadFont,loadShader:l.loadShader,addLoader:l.addLoader,width:i.width,height:i.height,dt:D,time:t.time,screenshot:t.screenshot,scene:$,go:z,sceneData:U,layers:G,camPos:ce,camScale:Q,camRot:te,camShake:ne,camIgnore:Me,gravity:Oe,add:_e,readd:Ge,destroy:Ae,destroyAll:he,get:ue,every:J,revery:Ee,send:j,recv:R,pos:Ue,scale:Ye,rotate:Xt,color:Yt,origin:$t,layer:Ht,area:nt,sprite:Wt,text:Kt,rect:Zt,solid:Qt,body:tn,shader:nn,on:fe,action:ye,render:f,collides:x,overlaps:y,clicks:P,keyDown:C,keyPress:T,keyPressRep:W,keyRelease:I,charInput:K,mouseDown:ee,mouseClick:be,mouseRelease:qe,mousePos:N,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:V,wait:O,play:F,volume:o.volume,makeRng:Ke,rand:Ie,randSeed:wt,vec2:d,rgb:Pe,rgba:Y,quad:se,choose:vt,chance:gt,lerp:ke,map:we,mapc:ft,wave:yt,deg2rad:ht,rad2deg:dt,drawSprite:E,drawText:v,drawRect:i.drawRect,drawRectStroke:i.drawRectStroke,drawLine:i.drawLine,debug:H,addLevel:sn};if(e.plugins)for(let r of e.plugins){let n=r(Te);for(let a in n)Te[a]=n[a]}if(e.global)for(let r in Te)window[r]=Te[r];return Te}});export default vn();
//# sourceMappingURL=kaboom.mjs.map
