var tt=Object.defineProperty;var tn=Object.prototype.hasOwnProperty;var nt=Object.getOwnPropertySymbols,nn=Object.prototype.propertyIsEnumerable;var rt=(e,t,s)=>t in e?tt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,ee=(e,t)=>{for(var s in t||(t={}))tn.call(t,s)&&rt(e,s,t[s]);if(nt)for(var s of nt(t))nn.call(t,s)&&rt(e,s,t[s]);return e};var o=(e,t)=>tt(e,"name",{value:t,configurable:!0});var te=(e,t)=>()=>(e&&(t=e(e=0)),t),rn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);function ae(e,t,s){return Math.min(Math.max(e,t),s)}function Ae(e,t,s){return e+(t-e)*s}function De(e,t,s,c,b){return c+(e-t)/(s-t)*(b-c)}function m(e,t){return Ue(e)&&t===void 0?m(e.x,e.y):{x:e!=null?e:0,y:t!=null?t:e!=null?e:0,clone(){return m(this.x,this.y)},add(...s){let c=m(...s);return m(this.x+c.x,this.y+c.y)},sub(...s){let c=m(...s);return m(this.x-c.x,this.y-c.y)},scale(s){return m(this.x*s,this.y*s)},dist(...s){let c=m(...s);return Math.sqrt((this.x-c.x)*(this.x-c.x)+(this.y-c.y)*(this.y-c.y))},len(){return this.dist(m(0,0))},unit(){return this.scale(1/this.len())},normal(){return m(this.y,-this.x)},dot(...s){let c=m(...s);return m(this.x*c.x,this.y*c.y)},angle(...s){let c=m(...s);return Math.atan2(this.y-c.y,this.x-c.x)},lerp(s,c){return m(Ae(this.x,s.x,c),Ae(this.y,s.y,c))},eq(s){return this.x===s.x&&this.y===s.y},str(){return`(${this.x}, ${this.y})`}}}function ot(e){return m(Math.cos(e),Math.sin(e))}function be(e,t,s){return{x:e,y:t,z:s,xy(){return m(this.x,this.y)}}}function Ue(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}function st(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}function it(e,t,s){return j(e,t,s,1)}function j(...e){var t;return e=[...e],e.length===0?j(1,1,1,1):{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return j(this.r,this.g,this.b,this.a)},lighten(s){return j(this.r+s,this.g+s,this.b+s,this.a)},darken(s){return this.lighten(-s)},eq(s){return this.r===s.r&&this.g===s.g&&this.b===s.g&&this.a===s.a}}}function ne(e,t,s,c){return{x:e,y:t,w:s,h:c,clone(){return ne(this.x,this.y,this.w,this.h)},eq(b){return this.x===b.x&&this.y===b.y&&this.w===b.w&&this.h===b.h}}}function $(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return $(this.m)},mult(t){let s=[];for(let c=0;c<4;c++)for(let b=0;b<4;b++)s[c*4+b]=this.m[0*4+b]*t.m[c*4+0]+this.m[1*4+b]*t.m[c*4+1]+this.m[2*4+b]*t.m[c*4+2]+this.m[3*4+b]*t.m[c*4+3];return $(s)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let s=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return be(s.x,s.y,s.z)},multVec2(t){return m(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult($([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult($([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult($([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult($([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult($([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],s=this.m[10]*this.m[15]-this.m[14]*this.m[11],c=this.m[9]*this.m[15]-this.m[13]*this.m[11],b=this.m[9]*this.m[14]-this.m[13]*this.m[10],S=this.m[8]*this.m[15]-this.m[12]*this.m[11],I=this.m[8]*this.m[14]-this.m[12]*this.m[10],C=this.m[8]*this.m[13]-this.m[12]*this.m[9],O=this.m[6]*this.m[15]-this.m[14]*this.m[7],F=this.m[5]*this.m[15]-this.m[13]*this.m[7],_=this.m[5]*this.m[14]-this.m[13]*this.m[6],T=this.m[4]*this.m[15]-this.m[12]*this.m[7],w=this.m[4]*this.m[14]-this.m[12]*this.m[6],P=this.m[5]*this.m[15]-this.m[13]*this.m[7],k=this.m[4]*this.m[13]-this.m[12]*this.m[5],E=this.m[6]*this.m[11]-this.m[10]*this.m[7],V=this.m[5]*this.m[11]-this.m[9]*this.m[7],g=this.m[5]*this.m[10]-this.m[9]*this.m[6],U=this.m[4]*this.m[11]-this.m[8]*this.m[7],Y=this.m[4]*this.m[10]-this.m[8]*this.m[6],H=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*s-this.m[6]*c+this.m[7]*b,t[4]=-(this.m[4]*s-this.m[6]*S+this.m[7]*I),t[8]=this.m[4]*c-this.m[5]*S+this.m[7]*C,t[12]=-(this.m[4]*b-this.m[5]*I+this.m[6]*C),t[1]=-(this.m[1]*s-this.m[2]*c+this.m[3]*b),t[5]=this.m[0]*s-this.m[2]*S+this.m[3]*I,t[9]=-(this.m[0]*c-this.m[1]*S+this.m[3]*C),t[13]=this.m[0]*b-this.m[1]*I+this.m[2]*C,t[2]=this.m[1]*O-this.m[2]*F+this.m[3]*_,t[6]=-(this.m[0]*O-this.m[2]*T+this.m[3]*w),t[10]=this.m[0]*P-this.m[1]*T+this.m[3]*k,t[14]=-(this.m[0]*_-this.m[1]*w+this.m[2]*k),t[3]=-(this.m[1]*E-this.m[2]*V+this.m[3]*g),t[7]=this.m[0]*E-this.m[2]*U+this.m[3]*Y,t[11]=-(this.m[0]*V-this.m[1]*U+this.m[3]*H),t[15]=this.m[0]*g-this.m[1]*Y+this.m[2]*H;let X=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let v=0;v<4;v++)for(let G=0;G<4;G++)t[v*4+G]*=1/X;return $(t)}}}function at(e,t,s){return e+(Math.sin(s)+1)/2*(t-e)}function Ye(e){return{seed:e,gen(t,s){if(Ue(t)&&Ue(s))return m(this.gen(t.x,s.x),this.gen(t.y,s.y));if(st(t)&&st(s))return j(this.gen(t.r,s.r),this.gen(t.g,s.g),this.gen(t.b,s.b),this.gen(t.a,s.a));if(t!==void 0)return s===void 0?this.gen()*t:this.gen()*(s-t)+t;if(t===void 0&&s===void 0)return this.seed=(on*this.seed+sn)%ut,this.seed/ut;throw new Error("invalid param to rand()")}}}function dt(e){ct.seed=e}function _e(e,t){return ct.gen(e,t)}function mt(e){return _e(0,1)<=e}function ht(e){return e[Math.floor(_e(e.length))]}function He(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function ft(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function lt(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var on,sn,ut,ct,fe=te(()=>{o(ae,"clamp");o(Ae,"lerp");o(De,"map");o(m,"vec2");o(ot,"vec2FromAngle");o(be,"vec3");o(Ue,"isVec2");o(st,"isColor");o(it,"rgb");o(j,"rgba");o(ne,"quad");o($,"mat4");o(at,"wave");on=1103515245,sn=12345,ut=2147483648,ct=Ye(Date.now());o(Ye,"makeRng");o(dt,"randSeed");o(_e,"rand");o(mt,"chance");o(ht,"choose");o(He,"colRectRect");o(ft,"overlapRectRect");o(lt,"colRectPt")});var pt,bt=te(()=>{pt=`attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec2 v_uv;
varying vec4 v_color;

void main() {
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = vec4(a_pos, 1.0);
}
`});var yt,gt=te(()=>{yt=`precision mediump float;

varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

void main() {
	gl_FragColor = v_color * texture2D(u_tex, v_uv);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`});function ke(e){switch(e){case"topleft":return m(-1,-1);case"top":return m(0,-1);case"topright":return m(1,-1);case"left":return m(-1,0);case"center":return m(0,0);case"right":return m(1,0);case"botleft":return m(-1,1);case"bot":return m(0,1);case"botright":return m(1,1);default:return e}}function xt(e,t){let s=(()=>{var A;let h=E(cn,dn),p=g(pt,yt),y=V(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),D=(A=t.clearColor)!=null?A:j(0,0,0,0);return e.clearColor(D.r,D.g,D.b,D.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),{drawCalls:0,mesh:h,defProg:p,defTex:y,curTex:y,transform:$(),transformStack:[]}})();function c(){s.mesh.flush(),!!s.curTex&&(s.mesh.bind(),s.defProg.bind(),s.curTex.bind(),e.vertexAttribPointer(0,3,e.FLOAT,!1,Oe*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,Oe*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,Oe*4,20),e.enableVertexAttribArray(2),e.drawElements(e.TRIANGLES,s.mesh.count(),e.UNSIGNED_SHORT,0),s.drawCalls++,s.defProg.unbind(),s.mesh.unbind(),s.curTex=null)}o(c,"flush");function b(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),s.drawCalls=0,s.transformStack=[],s.transform=$()}o(b,"frameStart");function S(){c()}o(S,"frameEnd");function I(h){return m(h.x/Ve()*2-1,-h.y/ge()*2+1)}o(I,"toNDC");function C(h){s.transform=h.clone()}o(C,"pushMatrix");function O(h){!h||h.x===0&&h.y===0||(s.transform=s.transform.translate(h))}o(O,"pushTranslate");function F(h){!h||h.x===0&&h.y===0||(s.transform=s.transform.scale(h))}o(F,"pushScale");function _(h){!h||(s.transform=s.transform.rotateX(h))}o(_,"pushRotateX");function T(h){!h||(s.transform=s.transform.rotateY(h))}o(T,"pushRotateY");function w(h){!h||(s.transform=s.transform.rotateZ(h))}o(w,"pushRotateZ");function P(){s.transformStack.push(s.transform.clone())}o(P,"pushTransform");function k(){s.transformStack.length>0&&(s.transform=s.transformStack.pop())}o(k,"popTransform");function E(h,p){let y=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,y),e.bufferData(e.ARRAY_BUFFER,h*32,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let D=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,D),e.bufferData(e.ELEMENT_ARRAY_BUFFER,p*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);let A=0;return{vbuf:y,ibuf:D,vqueue:[],iqueue:[],push(L,M){M=M.map(q=>q+this.vqueue.length/Oe),this.vqueue=this.vqueue.concat(L),this.iqueue=this.iqueue.concat(M)},flush(){e.bindBuffer(e.ARRAY_BUFFER,this.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(this.vqueue)),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(this.iqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),A=this.iqueue.length,this.iqueue=[],this.vqueue=[]},bind(){e.bindBuffer(e.ARRAY_BUFFER,this.vbuf),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this.ibuf)},unbind(){e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null)},count(){return A}}}o(E,"makeBatchedMesh");function V(h){let p=e.createTexture();return e.bindTexture(e.TEXTURE_2D,p),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{id:p,width:h.width,height:h.height,bind(){e.bindTexture(e.TEXTURE_2D,this.id)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}o(V,"makeTex");function g(h,p){let y=e.createShader(e.VERTEX_SHADER);e.shaderSource(y,h),e.compileShader(y);let D;if(D=e.getShaderInfoLog(y))throw new Error(D);let A=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(A,p),e.compileShader(A),D=e.getShaderInfoLog(A))throw new Error(D);let L=e.createProgram();if(e.attachShader(L,y),e.attachShader(L,A),e.bindAttribLocation(L,0,"a_pos"),e.bindAttribLocation(L,1,"a_uv"),e.bindAttribLocation(L,2,"a_color"),e.linkProgram(L),D=e.getProgramInfoLog(L))throw new Error(D);return{id:L,bind(){e.useProgram(this.id)},unbind(){e.useProgram(null)},sendFloat(M,q){let R=e.getUniformLocation(this.id,M);e.uniform1f(R,q)},sendVec2(M,q,R){let B=e.getUniformLocation(this.id,M);e.uniform2f(B,q,R)},sendVec3(M,q,R,B){let N=e.getUniformLocation(this.id,M);e.uniform3f(N,q,R,B)},sendVec4(M,q,R,B,N){let Q=e.getUniformLocation(this.id,M);e.uniform4f(Q,q,R,B,N)},sendMat4(M,q){let R=e.getUniformLocation(this.id,M);e.uniformMatrix4fv(R,!1,new Float32Array(q))}}}o(g,"makeProgram");function U(h,p,y,D){let A=h.width/p,L=h.height/y,M=1/A,q=1/L,R={},B=D.split("").entries();for(let[N,Q]of B)R[Q]=m(N%A*M,Math.floor(N/A)*q);return{tex:h,map:R,qw:M,qh:q}}o(U,"makeFont");function Y(h,p,y=s.defTex){s.curTex!==y&&(c(),s.curTex=y);let D=h.map(A=>{let L=I(s.transform.multVec2(A.pos.xy()));return[L.x,L.y,A.pos.z,A.uv.x,A.uv.y,A.color.r,A.color.g,A.color.b,A.color.a]}).flat();s.mesh.push(D,p)}o(Y,"drawRaw");function H(h={}){var Q,Z;let p=h.width||0,y=h.height||0,D=h.pos||m(0,0),L=ke(h.origin||Xe).dot(m(p,y).scale(-.5)),M=m((Q=h.scale)!=null?Q:1),q=h.rot||0,R=h.quad||ne(0,0,1,1),B=1-((Z=h.z)!=null?Z:0),N=h.color||j(1,1,1,1);P(),O(D),F(M),w(q),O(L),Y([{pos:be(-p/2,y/2,B),uv:m(R.x,R.y+R.h),color:N},{pos:be(-p/2,-y/2,B),uv:m(R.x,R.y),color:N},{pos:be(p/2,-y/2,B),uv:m(R.x+R.w,R.y),color:N},{pos:be(p/2,y/2,B),uv:m(R.x+R.w,R.y+R.h),color:N}],[0,1,3,1,2,3],h.tex),k()}o(H,"drawQuad");function X(h,p={}){var L;let y=(L=p.quad)!=null?L:ne(0,0,1,1),D=h.width*y.w,A=h.height*y.h;H({tex:h,quad:y,width:D,height:A,pos:p.pos,scale:p.scale,rot:p.rot,color:p.color,origin:p.origin,z:p.z})}o(X,"drawTexture");function v(h,p,y,D={}){H(ee(ee({},D),{pos:h,width:p,height:y}))}o(v,"drawRect");function G(h,p,y,D={}){let A=ke(D.origin||Xe).dot(m(p,y)).scale(.5),L=h.add(m(-p/2,-y/2)).sub(A),M=h.add(m(-p/2,y/2)).sub(A),q=h.add(m(p/2,y/2)).sub(A),R=h.add(m(p/2,-y/2)).sub(A);W(L,M,D),W(M,q,D),W(q,R,D),W(R,L,D)}o(G,"drawRectStroke");function W(h,p,y={}){let D=y.width||1,A=h.dist(p),L=Math.PI/2-h.angle(p);H(ee(ee({},y),{pos:h.add(p).scale(.5),width:D,height:A,rot:L,origin:"center"}))}o(W,"drawLine");function J(h,p,y={}){let D=(h+"").split(""),A=p.qw*p.tex.width,L=p.qh*p.tex.height,M=y.size||L,q=m(M/L).dot(m(y.scale||1)),R=q.x*A,B=q.y*L,N=0,Q=B,Z=0,le=[[]];for(let oe of D)(oe===`
`||(y.width?N+R>y.width:!1))&&(Q+=B,N=0,le.push([])),oe!==`
`&&(le[le.length-1].push(oe),N+=R),Z=Math.max(Z,N);y.width&&(Z=y.width);let Pe=[],Ie=m(y.pos),ue=ke(y.origin||Xe).scale(.5),ce=-ue.x*R-(ue.x+.5)*(Z-R),ie=-ue.y*B-(ue.y+.5)*(Q-B);return le.forEach((oe,ve)=>{let Be=(Z-oe.length*R)*(ue.x+.5);oe.forEach((we,Ge)=>{let Re=p.map[we],ze=Ge*R,Le=ve*B;Re&&Pe.push({tex:p.tex,quad:ne(Re.x,Re.y,p.qw,p.qh),ch:we,pos:m(Ie.x+ze+ce+Be,Ie.y+Le+ie),color:y.color,origin:y.origin,scale:q,z:y.z})})}),{width:Z,height:Q,chars:Pe}}o(J,"fmtText");function re(h,p,y={}){K(J(h,p,y))}o(re,"drawText");function K(h){for(let p of h.chars)H({tex:p.tex,width:p.tex.width*p.quad.w,height:p.tex.height*p.quad.h,pos:p.pos,scale:p.scale,color:p.color,quad:p.quad,origin:"center",z:p.z})}o(K,"drawFmtText");function Ve(){return e.drawingBufferWidth/xe()}o(Ve,"width");function ge(){return e.drawingBufferHeight/xe()}o(ge,"height");function xe(){var h;return(h=t.scale)!=null?h:1}return o(xe,"scale"),{width:Ve,height:ge,scale:xe,makeTex:V,makeFont:U,drawTexture:X,drawText:re,drawFmtText:K,drawRect:v,drawRectStroke:G,drawLine:W,fmtText:J,frameStart:b,frameEnd:S,pushTransform:P,popTransform:k,pushMatrix:C}}var Xe,Oe,cn,dn,vt=te(()=>{fe();bt();gt();Xe="topleft",Oe=9,cn=65536,dn=65536;o(ke,"originPt");o(xt,"gfxInit")});function wt(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}function Rt(e={}){var H,X;let t={canvas:(H=e.canvas)!=null?H:(()=>{var G;let v=document.createElement("canvas");return((G=e.root)!=null?G:document.body).appendChild(v),v})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:m(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(X=e.scale)!=null?X:1,isTouch:!1,loopID:null,stopped:!1},s={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},c=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let b=["outline: none"];e.crisp&&(b.push("image-rendering: pixelated"),b.push("image-rendering: crisp-edges")),t.canvas.style=b.join(";"),t.canvas.setAttribute("tabindex","0");let S=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("contextmenu",v=>{v.preventDefault()}),t.canvas.addEventListener("mousemove",v=>{t.mousePos=m(v.offsetX,v.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",v=>{let G=v.touches[0];t.mousePos=m(G.clientX,G.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",v=>{let G=v.touches[0];t.mousePos=m(G.clientX,G.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",v=>{let G=s[v.key]||v.key.toLowerCase();c.includes(G)&&v.preventDefault(),G.length===1&&t.charInputted.push(G),G==="space"&&t.charInputted.push(" "),v.repeat?t.keyStates[G]="rpressed":t.keyStates[G]="pressed"}),t.canvas.addEventListener("keyup",v=>{let G=s[v.key]||v.key.toLowerCase();t.keyStates[G]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function I(){return t.mousePos.clone()}o(I,"mousePos");function C(){return t.mouseState==="pressed"}o(C,"mouseClicked");function O(){return t.mouseState==="pressed"||t.mouseState==="down"}o(O,"mouseDown");function F(){return t.mouseState==="released"}o(F,"mouseReleased");function _(v){return t.keyStates[v]==="pressed"}o(_,"keyPressed");function T(v){return t.keyStates[v]==="pressed"||t.keyStates[v]==="rpressed"}o(T,"keyPressedRep");function w(v){return t.keyStates[v]==="pressed"||t.keyStates[v]==="rpressed"||t.keyStates[v]==="down"}o(w,"keyDown");function P(v){return t.keyStates[v]==="released"}o(P,"keyReleased");function k(){return[...t.charInputted]}o(k,"charInputted");function E(){return t.dt}o(E,"dt");function V(){return t.time}o(V,"time");function g(){return t.canvas.toDataURL()}o(g,"screenshot");function U(v){let G=o(W=>{let J=W/1e3,re=J-t.realTime;t.realTime=J,t.skipTime||(t.dt=re,t.time+=t.dt),t.skipTime=!1,v();for(let K in t.keyStates)t.keyStates[K]=wt(t.keyStates[K]);t.mouseState=wt(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(G))},"frame");t.loopID=requestAnimationFrame(G)}o(U,"run");function Y(){cancelAnimationFrame(t.loopID),t.stopped=!0}return o(Y,"quit"),{gl:S,mousePos:I,keyDown:w,keyPressed:_,keyPressedRep:T,keyReleased:P,mouseDown:O,mouseClicked:C,mouseReleased:F,charInputted:k,dt:E,time:V,screenshot:g,run:U,quit:Y}}var St=te(()=>{fe();o(wt,"processBtnState");o(Rt,"appInit")});function Et(){let e=(()=>{let b=new(window.AudioContext||window.webkitAudioContext),S=b.createGain(),I=S;return I.connect(b.destination),{ctx:b,gainNode:S,masterNode:I}})();function t(b){return b!==void 0&&(e.gainNode.gain.value=ae(b,Ct,Tt)),e.gainNode.gain.value}o(t,"volume");function s(b,S={loop:!1,volume:1,speed:1,detune:0,seek:0}){var P;let I=!1,C=e.ctx.createBufferSource();C.buffer=b,C.loop=!!S.loop;let O=e.ctx.createGain();C.connect(O),O.connect(e.masterNode);let F=(P=S.seek)!=null?P:0;C.start(0,F);let _=e.ctx.currentTime-F,T=null,w={stop(){C.stop(),I=!0,T=e.ctx.currentTime},play(k){if(!I)return;let E=C;C=e.ctx.createBufferSource(),C.buffer=E.buffer,C.loop=E.loop,C.playbackRate.value=E.playbackRate.value,C.detune&&(C.detune.value=E.detune.value),C.connect(O);let V=k!=null?k:this.time();C.start(0,V),_=e.ctx.currentTime-V,I=!1,T=null},pause(){this.stop()},paused(){return I},stopped(){return I},speed(k){return k!==void 0&&(C.playbackRate.value=ae(k,mn,hn)),C.playbackRate.value},detune(k){return C.detune?(k!==void 0&&(C.detune.value=ae(k,fn,ln)),C.detune.value):0},volume(k){return k!==void 0&&(O.gain.value=ae(k,Ct,Tt)),O.gain.value},loop(){C.loop=!0},unloop(){C.loop=!1},duration(){return b.duration},time(){return I&&T?T-_:e.ctx.currentTime-_}};return w.speed(S.speed),w.detune(S.detune),w.volume(S.volume),w}o(s,"play");function c(){return e.ctx}return o(c,"ctx"),{ctx:c,volume:t,play:s}}var Ct,Tt,mn,hn,fn,ln,At=te(()=>{fe();Ct=0,Tt=3,mn=0,hn=3,fn=-1200,ln=1200;o(Et,"audioInit")});var Dt,_t=te(()=>{Dt="data:image/png;base64,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"});function kt(e){let t=new Image;return t.src=e,new Promise((s,c)=>{t.onload=()=>{s(t)},t.onerror=()=>{c()}})}function Vt(e){return e.startsWith("data:")}function Pt(e,t,s={}){let c={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{}};function b(T){var P;let w=c.lastLoaderID;c.loaders[w]=!1,c.lastLoaderID++,T.catch((P=s.errHandler)!=null?P:console.error).finally(()=>{c.loaders[w]=!0})}o(b,"addLoader");function S(){let T=0,w=0;for(let P in c.loaders)T+=1,c.loaders[P]&&(w+=1);return w/T}o(S,"loadProgress");function I(T){return T&&(c.loadRoot=T),c.loadRoot}o(I,"loadRoot");function C(T,w,P,k,E=bn){let V=new Promise((g,U)=>{let Y=Vt(w)?w:c.loadRoot+w;kt(Y).then(H=>{let X=e.makeFont(e.makeTex(H),P,k,E);c.fonts[T]=X,g(X)}).catch(()=>{U(`failed to load font '${T}' from '${w}'`)})});return b(V),V}o(C,"loadFont");function O(T,w,P={sliceX:1,sliceY:1,anims:{}}){function k(V,g,U={sliceX:1,sliceY:1,anims:{}}){let Y=[],H=e.makeTex(g),X=U.sliceX||1,v=U.sliceY||1,G=1/X,W=1/v;for(let re=0;re<v;re++)for(let K=0;K<X;K++)Y.push(ne(K*G,re*W,G,W));let J={tex:H,frames:Y,anims:U.anims||{}};return c.sprites[V]=J,J}o(k,"loadRawSprite");let E=new Promise((V,g)=>{if(typeof w=="string"){let U=Vt(w)?w:c.loadRoot+w;kt(U).then(Y=>{V(k(T,Y,P))}).catch(()=>{g(`failed to load sprite '${T}' from '${w}'`)});return}else V(k(T,w,P))});return b(E),E}o(O,"loadSprite");function F(T,w){let P=new Promise((k,E)=>{typeof w=="string"&&fetch(c.loadRoot+w).then(V=>V.arrayBuffer()).then(V=>new Promise((g,U)=>{t.ctx().decodeAudioData(V,Y=>{g(Y)},()=>{U()})})).then(V=>{c.sounds[T]=V,k(V)}).catch(()=>{E(`failed to load sound '${T}' from '${w}'`)})});return b(P),P}o(F,"loadSound");function _(){return c.fonts[ye]}return o(_,"defFont"),C(ye,Dt,8,8),{loadRoot:I,loadSprite:O,loadSound:F,loadFont:C,loadProgress:S,addLoader:b,defFont:_,sprites:c.sprites,fonts:c.fonts,sounds:c.sounds}}var bn,ye,It=te(()=>{fe();_t();bn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ye="unscii";o(kt,"loadImg");o(Vt,"isDataUrl");o(Pt,"assetsInit")});function Gt(e,t,s={max:8}){var F;let c=[],b=(F=s.max)!=null?F:8;function S(){c.length>b&&(c=c.slice(0,b));let _=m(0,e.height());c.forEach((T,w)=>{let P=De(w,0,b,1,.2),k=De(w,0,b,.7,.2),E=(()=>{switch(T.type){case"info":return j(1,1,1,P);case"error":return j(1,0,.5,P)}})(),V=e.fmtText(T.msg,t.defFont(),{pos:_,origin:"botleft",color:E,z:1,size:16/e.scale(),width:e.width()});e.drawRect(_,V.width,V.height,{origin:"botleft",color:j(0,0,0,k),z:1}),e.drawFmtText(V),_.y-=V.height})}o(S,"draw");function I(_){console.error(_),c.unshift({type:"error",msg:_})}o(I,"error");function C(_){console.log(_),c.unshift({type:"info",msg:_})}o(C,"info");function O(){c=[]}return o(O,"clear"),{info:C,error:I,draw:S,clear:O}}var Lt=te(()=>{fe();o(Gt,"loggerInit")});function Ft(e){let t={},s=[],c=null;function b(){return c!==null&&c.readyState===1}o(b,"connected");function S(){let F=new WebSocket(e);return new Promise((_,T)=>{F.onopen=()=>{_(F),c=F;for(let w of s)F.send(w)},F.onerror=()=>{T(`failed to connect to ${e}`)},F.onmessage=w=>{let P=JSON.parse(w.data);if(t[P.type])for(let k of t[P.type])k(P.data,P.id)}})}o(S,"connect");function I(F,_){t[F]||(t[F]=[]),t[F].push(_)}o(I,"recv");function C(F,_){let T=JSON.stringify({type:F,data:_});c?c.send(T):s.push(T)}o(C,"send");function O(){c&&c.close()}return o(O,"close"),{connect:S,close:O,connected:b,recv:I,send:C}}var Mt=te(()=>{o(Ft,"netInit")});var yn=rn((ir,qt)=>{fe();vt();St();At();It();Lt();Mt();qt.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{var Qe;let t=Rt({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),s=xt(t.gl,{clearColor:(n=>j(n[0],n[1],n[2],n[3]))((Qe=e.clearColor)!=null?Qe:[0,0,0,1]),scale:e.scale}),c=Et(),b=Pt(s,c,{errHandler:n=>{S.error(n)}}),S=Gt(s,b,{max:e.logMax}),I=(()=>e.connect?Ft(e.connect):null)();function C(n,r){if(!I)throw new Error("not connected to any websockets");I.recv(n,(a,i)=>{try{r(a,i)}catch(u){S.error(u)}})}o(C,"recv");function O(n,r){if(!I)throw new Error("not connected to any websockets");I.send(n,r)}o(O,"send");function F(n,r={}){let a=b.sounds[n];if(!a)throw new Error(`sound not found: "${n}"`);return c.play(a,r)}o(F,"play");function _(n){let r=g();return n?r.cam.ignore.includes(n)?_():r.cam.mpos:t.mousePos()}o(_,"mousePos");function T(n,r={}){var u;let a=(()=>typeof n=="string"?b.sprites[n]:n)();if(!a)throw new Error(`sprite not found: "${n}"`);let i=a.frames[(u=r.frame)!=null?u:0];s.drawTexture(a.tex,ee(ee({},r),{quad:i}))}o(T,"drawSprite");function w(n,r){var u;let a=(u=r.font)!=null?u:ye,i=b.fonts[a];if(!i)throw new Error(`font not found: ${a}`);s.drawText(n,i,r)}o(w,"drawText");let P=980,k="topleft",E={loaded:!1,scenes:{},curScene:null,nextScene:null};function V(n,r){E.scenes[n]={init:r,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:m(s.width()/2,s.height()/2),scale:m(1,1),angle:0,shake:0,ignore:[],mpos:m(0)},layers:{},defLayer:null,gravity:P,data:{}}}o(V,"scene");function g(){return E.scenes[E.curScene]}o(g,"curScene");function U(){return g().data}o(U,"sceneData");function Y(){let n=Se;N("`",()=>{n.showLog=!n.showLog,S.info(`show log: ${n.showLog?"on":"off"}`)}),N("f1",()=>{n.inspect=!n.inspect,S.info(`inspect: ${n.inspect?"on":"off"}`)}),N("f2",()=>{S.clear()}),N("f8",()=>{n.paused=!n.paused,S.info(`${n.paused?"paused":"unpaused"}`)}),N("f7",()=>{n.timeScale=ae(n.timeScale-.2,0,2),S.info(`time scale: ${n.timeScale.toFixed(1)}`)}),N("f9",()=>{n.timeScale=ae(n.timeScale+.2,0,2),S.info(`time scale: ${n.timeScale.toFixed(1)}`)}),N("f10",()=>{We(),S.info("stepped frame")})}o(Y,"regDebugInputs");function H(n,...r){E.nextScene={name:n,args:[...r]}}o(H,"go");function X(n,...r){v(n),E.curScene=n;let a=E.scenes[n];if(!a)throw new Error(`scene not found: '${n}'`);if(!a.initialized){try{a.init(...r)}catch(i){S.error(i.stack)}e.debug&&Y(),a.initialized=!0}}o(X,"goSync");function v(n){if(!E.scenes[n])throw new Error(`scene not found: '${n}'`);V(n,E.scenes[n].init)}o(v,"reload");function G(n,r){let a=g();if(!a)return;let i=.5/n.length;n.forEach((u,l)=>{a.layers[u]=.5+i*l}),r&&(a.defLayer=r)}o(G,"layers");function W(...n){let r=g().cam;return n.length>0&&(r.pos=m(...n)),r.pos.clone()}o(W,"camPos");function J(...n){let r=g().cam;return n.length>0&&(r.scale=m(...n)),r.scale.clone()}o(J,"camScale");function re(n){let r=g().cam;return n!==void 0&&(r.angle=n),r.angle}o(re,"camRot");function K(n){let r=g().cam;r.shake=n}o(K,"camShake");function Ve(n){let r=g().cam;r.ignore=n}o(Ve,"camIgnore");function ge(n){let r={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],debugInfo:[]},use(i){if(i===void 0)return;let u=typeof i;if(u==="string"){this._tags.push(i);return}if(u!=="object")throw new Error(`invalid comp type: ${u}`);if(Array.isArray(i)){for(let l of i)this.use(l);return}for(let l in i){if(typeof i[l]=="function"){this._events[l]?this._events[l].push(i[l].bind(this)):this[l]=i[l].bind(this);continue}this[l]=i[l]}},exists(){return this._sceneID!==void 0},is(i){if(i==="*")return!0;if(Array.isArray(i)){for(let u of i)if(!this._tags.includes(u))return!1;return!0}return this._tags.includes(i)},on(i,u){this._events[i]||(this._events[i]=[]),this._events[i].push(u)},action(i){this.on("update",i)},trigger(i,...u){if(this._events[i])for(let f of this._events[i])f.call(this,...u);let d=g().events[i];if(d)for(let f of d)this.is(f.tag)&&f.cb(this,...u)},rmTag(i){let u=this._tags.indexOf(i);u>-1&&this._tags.splice(u,1)}};r.use(n);let a=g();a.objs.set(a.lastID,r),r._sceneID=a.lastID,a.lastID++,r.trigger("add");for(let i of a.events.add)r.is(i.tag)&&i.cb(r);return r}o(ge,"add");function xe(n){if(!n.exists())return;let r=g();return r.objs.delete(n._sceneID),r.objs.set(r.lastID,n),n._sceneID=r.lastID,r.lastID++,n}o(xe,"readd");function h(n,r,a){let i=g();i.events[n]||(i.events[n]=[]),i.events[n].push({tag:r,cb:a})}o(h,"on");function p(n,r){typeof n=="function"&&r===void 0?g().action.push(n):typeof n=="string"&&h("update",n,r)}o(p,"action");function y(n,r){typeof n=="function"&&r===void 0?g().render.push(n):typeof n=="string"&&h("update",n,r)}o(y,"render");function D(n,r,a){p(n,i=>{i._checkCollisions(r,u=>{a(i,u)})})}o(D,"collides");function A(n,r,a){p(n,i=>{i._checkOverlaps(r,u=>{a(i,u)})})}o(A,"overlaps");function L(n,r){p(n,a=>{a.isClicked()&&r(a)})}o(L,"clicks");function M(n,r){return new Promise(a=>{let i=g();i.timers[i.lastTimerID++]={time:n,cb:()=>{r&&r(),a(null)}}})}o(M,"wait");function q(n,r){let a=!1,i=o(()=>{a||(r(),M(n,i))},"newF");return i(),{stop(){a=!0}}}o(q,"loop");function R(n,r,a){if(Array.isArray(r))for(let i of r)R(n,i,a);else g().events[n].push({key:r,cb:a})}o(R,"pushKeyEvent");function B(n,r){R("keyDown",n,r)}o(B,"keyDown");function N(n,r){R("keyPress",n,r)}o(N,"keyPress");function Q(n,r){R("keyPressRep",n,r)}o(Q,"keyPressRep");function Z(n,r){R("keyRelease",n,r)}o(Z,"keyRelease");function le(n){g().events.charInput.push({cb:n})}o(le,"charInput");function Pe(n){g().events.mouseDown.push({cb:n})}o(Pe,"mouseDown");function Ie(n){g().events.mouseClick.push({cb:n})}o(Ie,"mouseClick");function ue(n){g().events.mouseRelease.push({cb:n})}o(ue,"mouseRelease");function ce(n){let a=[...g().objs.values()];return n?a.filter(i=>i.is(n)):a}o(ce,"get");function ie(n,r){typeof n=="function"&&r===void 0?ce().forEach(n):typeof n=="string"&&ce(n).forEach(r)}o(ie,"every");function oe(n,r){typeof n=="function"&&r===void 0?ce().reverse().forEach(n):typeof n=="string"&&ce(n).reverse().forEach(r)}o(oe,"revery");function ve(n){if(!n.exists())return;let r=g();!r||(n.trigger("destroy"),r.objs.delete(n._sceneID),delete n._sceneID)}o(ve,"destroy");function Be(n){ie(n,r=>{ve(r)})}o(Be,"destroyAll");function we(n){let r=g();return n!==void 0&&(r.gravity=n),r.gravity}o(we,"gravity");function Ge(n){let r=g();if(!r)throw new Error(`scene not found: '${E.curScene}'`);let a=n||!Se.paused;if(a)for(let f in r.timers){let x=r.timers[f];x.time-=t.dt(),x.time<=0&&(x.cb(),delete r.timers[f])}if(oe(f=>{!f.paused&&a&&f.trigger("update")}),a)for(let f of r.action)f();let i=m(s.width(),s.height()),u=r.cam,l=ot(_e(0,Math.PI*2)).scale(u.shake);u.shake=Ae(u.shake,0,5*t.dt());let d=$().translate(i.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(i.scale(-.5)).translate(u.pos.scale(-1).add(i.scale(.5)).add(l));u.mpos=d.invert().multVec2(_()),ie(f=>{f.hidden||(s.pushTransform(),u.ignore.includes(f.layer)||s.pushMatrix(d),f.trigger("draw"),s.popTransform())});for(let f of r.render)f()}o(Ge,"gameFrame");function Re(){let n=g();for(let r of n.events.charInput)t.charInputted().forEach(r.cb);for(let r of n.events.keyDown)t.keyDown(r.key)&&r.cb();for(let r of n.events.keyPress)t.keyPressed(r.key)&&r.cb();for(let r of n.events.keyPressRep)t.keyPressedRep(r.key)&&r.cb();for(let r of n.events.keyRelease)t.keyReleased(r.key)&&r.cb();for(let r of n.events.mouseDown)t.mouseDown()&&r.cb();for(let r of n.events.mouseClick)t.mouseClicked()&&r.cb();for(let r of n.events.mouseRelease)t.mouseReleased()&&r.cb()}o(Re,"handleEvents");function ze(n,...r){t.run(()=>{if(s.frameStart(),E.loaded){try{if(!g())throw new Error(`scene not found: '${E.curScene}'`);Re(),Ge()}catch(a){S.error(a.stack),t.quit()}E.nextScene&&(X.apply(null,[E.nextScene.name,...E.nextScene.args]),E.nextScene=null)}else{let a=b.loadProgress();if(a===1)E.loaded=!0,X(n,...r),I&&I.connect().catch(S.error);else{let i=s.width()/2,u=12,l=m(s.width()/2,s.height()/2).sub(m(i/2,u/2));s.drawRectStroke(l,i,u,{width:2}),s.drawRect(l,i*a,u)}}Se.showLog&&S.draw(),s.frameEnd()})}o(ze,"start");function Le(...n){return{pos:m(...n),move(...r){let a=m(...r),i=a.x*t.dt(),u=a.y*t.dt();this.pos.x+=i,this.pos.y+=u},debugInfo(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}o(Le,"pos");function Nt(...n){return{scale:m(...n),flipX(r){this.scale.x=Math.sign(r)*Math.abs(this.scale.x)},flipY(r){this.scale.y=Math.sign(r)*Math.abs(this.scale.y)}}}o(Nt,"scale");function Ot(n){return{angle:n}}o(Ot,"rotate");function Bt(...n){return{color:j(...n)}}o(Bt,"color");function zt(n){return{origin:n}}o(zt,"origin");function jt(n){return{layer:n,debugInfo(){var a;let r=g();return{layer:(a=this.layer)!=null?a:r.defLayer}}}}o(jt,"layer");function je(n,r){var i,u;let a=g();return((i=n.layer)!=null?i:a.defLayer)===((u=r.layer)!=null?u:a.defLayer)}o(je,"isSameLayer");function $e(n,r){let a={},i={};return{area:{p1:n,p2:r},draw(){var Me,qe,Ke,Ze;if(!Se.inspect)return;let u=b.defFont(),l=2,d=j(0,1,1,1),f=this.isHovered();f&&(l+=2);let x=this._worldArea(),z=x.p2.x-x.p1.x,se=x.p2.y-x.p1.y;s.drawRectStroke(x.p1,z,se,{width:l/((Me=e.scale)!=null?Me:1),color:d,z:.9});let de=_((qe=this.layer)!=null?qe:g().defLayer);if(f){let Ne=m(6,6).scale(1/((Ke=e.scale)!=null?Ke:1)),pe=0,Te=0,Je=[],et=o(me=>{var Ee;let he=s.fmtText(me,u,{size:12/((Ee=e.scale)!=null?Ee:1),pos:de.add(m(Ne.x,Ne.y+Te)),z:1});Je.push(he),pe=he.width>pe?he.width:pe,Te+=he.height},"addLine");for(let me of this._tags)et(`"${me}"`);for(let me of this._events.debugInfo){let he=me();for(let Ee in he)et(`${Ee}: ${he[Ee]}`)}pe+=Ne.x*2,Te+=Ne.y*2,s.drawRect(de,pe,Te,{color:j(0,0,0,1),z:1}),s.drawRectStroke(de,pe,Te,{width:(l-2)/((Ze=e.scale)!=null?Ze:1),color:j(0,1,1,1),z:1});for(let me of Je)s.drawFmtText(me)}},areaWidth(){let{p1:u,p2:l}=this._worldArea();return l.x-u.x},areaHeight(){let{p1:u,p2:l}=this._worldArea();return l.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){var u;return this.hasPt(_((u=this.layer)!=null?u:g().defLayer))},isCollided(u){if(!u.area||!je(this,u))return!1;let l=this._worldArea(),d=u._worldArea();return He(l,d)},isOverlapped(u){if(!u.area||!je(this,u))return!1;let l=this._worldArea(),d=u._worldArea();return ft(l,d)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,l){this.action(()=>{this._checkCollisions(u,l)})},overlaps(u,l){this.action(()=>{this._checkOverlaps(u,l)})},hasPt(u){let l=this._worldArea();return lt({p1:l.p1,p2:l.p2},u)},resolve(){let u=[];return ie(l=>{if(l===this||!l.solid||!l.area||!je(this,l))return;let d=this._worldArea(),f=l._worldArea();if(!He(d,f))return;let x=d.p2.x-f.p1.x,z=f.p2.x-d.p1.x,se=d.p2.y-f.p1.y,de=f.p2.y-d.p1.y,Me=Math.min(x,z,se,de),qe=(()=>{switch(Me){case x:return this.pos.x-=x,"right";case z:return this.pos.x+=z,"left";case se:return this.pos.y-=se,"bottom";case de:return this.pos.y+=de,"top"}})();u.push({obj:l,side:qe})}),u},_checkCollisions(u,l){ie(u,d=>{this!==d&&(a[d._sceneID]||this.isCollided(d)&&(l(d),a[d._sceneID]=d))});for(let d in a){let f=a[d];this.isCollided(f)||delete a[d]}},_checkOverlaps(u,l){ie(u,d=>{this!==d&&(i[d._sceneID]||this.isOverlapped(d)&&(l(d),i[d._sceneID]=d))});for(let d in i){let f=i[d];this.isOverlapped(f)||delete i[d]}},_worldArea(){let u=this.area,l=this.pos||m(0),d=this.scale||m(1),f=l.add(u.p1.dot(d)),x=l.add(u.p2.dot(d));return{p1:m(Math.min(f.x,x.x),Math.min(f.y,x.y)),p2:m(Math.max(f.x,x.x),Math.max(f.y,x.y))}}}}o($e,"area");function Fe(n,r,a){let i=m(n,r),u=ke(a||k).dot(i).scale(-.5);return $e(u.sub(i.scale(.5)),u.add(i.scale(.5)))}o(Fe,"getAreaFromSize");function Ut(n,r={}){let a=b.sprites[n];if(!a)throw new Error(`sprite not found: "${n}"`);let i=ee({},a.frames[0]);r.quad&&(i.x+=r.quad.x*i.w,i.y+=r.quad.y*i.h,i.w*=r.quad.w,i.h*=r.quad.h);let u=a.tex.width*i.w,l=a.tex.height*i.h,d=null;return{width:u,height:l,animSpeed:r.animSpeed||.1,frame:r.frame||0,quad:r.quad||ne(0,0,1,1),add(){!this.area&&!r.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var z;let f=g(),x=a.frames[this.frame];T(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,z:f.layers[(z=this.layer)!=null?z:f.defLayer]})},update(){if(!d)return;let f=a.anims[d.name];d.timer+=t.dt(),d.timer>=this.animSpeed&&(this.frame++,this.frame>f.to&&(d.loop?this.frame=f.from:(this.frame--,this.stop())),d.timer-=this.animSpeed)},play(f,x=!0){let z=a.anims[f];if(!z)throw new Error(`anim not found: ${f}`);d&&this.stop(),d={name:f,loop:x,timer:0},this.frame=z.from,this.trigger("animPlay",f)},stop(){if(!d)return;let f=d.name;d=null,this.trigger("animEnd",f)},changeSprite(f){if(a=b.sprites[f],!a)throw new Error(`sprite not found: "${f}"`);let x=ee({},a.frames[0]);r.quad&&(x.x+=r.quad.x*x.w,x.y+=r.quad.y*x.h,x.w*=r.quad.w,x.h*=r.quad.h),this.width=a.tex.width*x.w,this.height=a.tex.height*x.h,this.area&&!r.noArea&&this.use(Fe(this.width,this.height,this.origin)),d=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return d==null?void 0:d.name},debugInfo(){let f={};return d&&(f.curAnim=`"${d.name}"`),f}}}o(Ut,"sprite");function Yt(n,r,a={}){return{text:n,textSize:r,font:a.font,width:0,height:0,add(){var i,u,l,d;if(!this.area&&!a.noArea){let f=g(),x=b.fonts[(i=this.font)!=null?i:ye],z=s.fmtText(this.text+"",x,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:f.layers[(u=this.layer)!=null?u:f.defLayer]});this.width=z.width/(((l=this.scale)==null?void 0:l.x)||1),this.height=z.height/(((d=this.scale)==null?void 0:d.y)||1),this.use(Fe(this.width,this.height,this.origin))}},draw(){var d,f;let i=g(),u=b.fonts[(d=this.font)!=null?d:ye],l=s.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:i.layers[(f=this.layer)!=null?f:i.defLayer]});this.width=l.width,this.height=l.height,s.drawFmtText(l)}}}o(Yt,"text");function Ht(n,r,a={}){return{width:n,height:r,add(){!this.area&&!a.noArea&&this.use(Fe(this.width,this.height,this.origin))},draw(){var u;let i=g();s.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:i.layers[(u=this.layer)!=null?u:i.defLayer]})}}}o(Ht,"rect");function Xt(){return{solid:!0}}o(Xt,"solid");let $t=960,Wt=480;function Qt(n={}){var u,l;let r=0,a=null,i=(u=n.maxVel)!=null?u:$t;return{jumpForce:(l=n.jumpForce)!=null?l:Wt,update(){this.move(0,r);let d=this.resolve(),f=!1;if(a&&(!a.exists()||!this.isCollided(a))&&(a=null,f=!0),!a){r=Math.min(r+we()*t.dt(),i);for(let x of d)x.side==="bottom"&&r>0?(a=x.obj,r=0,f||this.trigger("grounded",a)):x.side==="top"&&r<0&&(r=0,this.trigger("headbump",x.obj))}},curPlatform(){return a},grounded(){return a!==null},jump(d){a=null,r=-d||-this.jumpForce}}}o(Qt,"body");let Se={paused:!1,inspect:!1,timeScale:1,showLog:!0};function Kt(){return Se}o(Kt,"dbg");function Zt(){return 1/t.dt()}o(Zt,"fps");function Jt(){return g().objs.size}o(Jt,"objCount");function We(){Ge(!0)}o(We,"stepFrame");function en(n,r){let a=[],i=m(r.pos),u=0,l={getPos(...d){let f=m(...d);return m(i.x+f.x*r.width,i.y+f.y*r.height)},spawn(d,f){let x=(()=>{if(Array.isArray(d))return d;if(r[d]){if(typeof r[d]=="function")return r[d]();if(Array.isArray(r[d]))return[...r[d]]}else if(r.any)return r.any(d)})();if(x){x.push(Le(i.x+f.x*r.width,i.y+f.y*r.height));let z=ge(x);a.push(z),z.use({gridPos:f.clone(),setGridPos(se){this.gridPos=se.clone(),this.pos=m(i.x+this.gridPos.x*r.width,i.y+this.gridPos.y*r.height)},moveLeft(){this.setGridPos(this.gridPos.add(m(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(m(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(m(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(m(0,1)))}})}},width(){return u*r.width},height(){return n.length*r.height},destroy(){for(let d of a)ve(d)}};return n.forEach((d,f)=>{let x=d.split("");u=Math.max(x.length,u),x.forEach((z,se)=>{l.spawn(z,m(se,f))})}),l}o(en,"addLevel");let Ce={start:ze,loadRoot:b.loadRoot,loadSprite:b.loadSprite,loadSound:b.loadSound,loadFont:b.loadFont,addLoader:b.addLoader,width:s.width,height:s.height,dt:t.dt,time:t.time,screenshot:t.screenshot,scene:V,go:H,sceneData:U,layers:G,camPos:W,camScale:J,camRot:re,camShake:K,camIgnore:Ve,gravity:we,add:ge,readd:xe,destroy:ve,destroyAll:Be,get:ce,every:ie,revery:oe,send:O,recv:C,pos:Le,scale:Nt,rotate:Ot,color:Bt,origin:zt,layer:jt,area:$e,sprite:Ut,text:Yt,rect:Ht,solid:Xt,body:Qt,on:h,action:p,render:y,collides:D,overlaps:A,clicks:L,keyDown:B,keyPress:N,keyPressRep:Q,keyRelease:Z,charInput:le,mouseDown:Pe,mouseClick:Ie,mouseRelease:ue,mousePos:_,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:q,wait:M,play:F,volume:c.volume,makeRng:Ye,rand:_e,randSeed:dt,vec2:m,rgb:it,rgba:j,quad:ne,choose:ht,chance:mt,lerp:Ae,map:De,wave:at,drawSprite:T,drawText:w,drawRect:s.drawRect,drawRectStroke:s.drawRectStroke,drawLine:s.drawLine,dbg:Kt,objCount:Jt,fps:Zt,stepFrame:We,log:S.info,error:S.error,addLevel:en};if(e.plugins)for(let n of e.plugins){let r=n(Ce);for(let a in r)Ce[a]=r[a]}if(e.global)for(let n in Ce)window[n]=Ce[n];return Ce}});export default yn();
//# sourceMappingURL=kaboom.mjs.map
