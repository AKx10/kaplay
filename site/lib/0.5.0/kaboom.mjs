var at=Object.defineProperty,on=Object.defineProperties;var an=Object.getOwnPropertyDescriptors;var ct=Object.getOwnPropertySymbols;var cn=Object.prototype.hasOwnProperty,un=Object.prototype.propertyIsEnumerable;var ut=(e,t,i)=>t in e?at(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,de=(e,t)=>{for(var i in t||(t={}))cn.call(t,i)&&ut(e,i,t[i]);if(ct)for(var i of ct(t))un.call(t,i)&&ut(e,i,t[i]);return e},ye=(e,t)=>on(e,an(t));var s=(e,t)=>at(e,"name",{value:t,configurable:!0});var ce=(e,t)=>()=>(e&&(t=e(e=0)),t),hn=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);function ht(e){return e*Math.PI/180}function dt(e){return e*180/Math.PI}function ue(e,t,i){return Math.min(Math.max(e,t),i)}function ke(e,t,i){return e+(t-e)*i}function be(e,t,i,o,l){return o+(e-t)/(i-t)*(l-o)}function ft(e,t,i,o,l){return ue(be(e,t,i,o,l),o,l)}function d(...e){if(e.length===0)return d(0,0);if(e.length===1){if(typeof e[0]=="number")return d(e[0],e[0]);if(De(e[0]))return d(e[0].x,e[0].y);if(Array.isArray(e[0])&&e[0].length===2)return d.apply(null,e[0])}return{x:e[0],y:e[1],clone(){return d(this.x,this.y)},add(...t){let i=d(...t);return d(this.x+i.x,this.y+i.y)},sub(...t){let i=d(...t);return d(this.x-i.x,this.y-i.y)},scale(t){return d(this.x*t,this.y*t)},dist(...t){let i=d(...t);return Math.sqrt((this.x-i.x)*(this.x-i.x)+(this.y-i.y)*(this.y-i.y))},len(){return this.dist(d(0,0))},unit(){return this.scale(1/this.len())},normal(){return d(this.y,-this.x)},dot(...t){let i=d(...t);return d(this.x*i.x,this.y*i.y)},angle(...t){let i=d(...t);return Math.atan2(this.y-i.y,this.x-i.x)},lerp(t,i){return d(ke(this.x,t.x,i),ke(this.y,t.y,i))},eq(t){return this.x===t.x&&this.y===t.y},str(){return`(${this.x}, ${this.y})`}}}function lt(e){return d(Math.cos(e),Math.sin(e))}function xe(e,t,i){return{x:e,y:t,z:i,xy(){return d(this.x,this.y)}}}function De(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0}function mt(e){return e!==void 0&&e.x!==void 0&&e.y!==void 0&&e.z!==void 0}function we(e){return e!==void 0&&e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0}function pt(e){if(e!==void 0&&Array.isArray(e.m)&&e.m.length===16)return e}function Pe(...e){if(e.length===0)return Y();if(e.length===1){if(we(e[0]))return Y(e[0]);if(Array.isArray(e[0])&&e[0].length===3)return Pe.apply(null,e[0])}return Y(e[0],e[1],e[2],1)}function Y(...e){var t;if(e.length===0)return Y(1,1,1,1);if(e.length===1){if(we(e[0]))return Y(e[0].r,e[0].g,e[0].b,e[0].a);if(Array.isArray(e[0])&&e[0].length===4)return Y.apply(null,e[0])}return{r:e[0],g:e[1],b:e[2],a:(t=e[3])!=null?t:1,clone(){return Y(this.r,this.g,this.b,this.a)},lighten(i){return Y(this.r+i,this.g+i,this.b+i,this.a)},darken(i){return this.lighten(-i)},invert(){return Y(1-this.r,1-this.g,1-this.b,this.a)},isDark(i=.5){return this.r+this.g+this.b<3*i},isLight(i=.5){return this.r+this.g+this.b>3*i},eq(i){return this.r===i.r&&this.g===i.g&&this.b===i.g&&this.a===i.a}}}function re(e,t,i,o){return{x:e,y:t,w:i,h:o,clone(){return re(this.x,this.y,this.w,this.h)},eq(l){return this.x===l.x&&this.y===l.y&&this.w===l.w&&this.h===l.h}}}function Q(e){return{m:e?[...e]:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],clone(){return Q(this.m)},mult(t){let i=[];for(let o=0;o<4;o++)for(let l=0;l<4;l++)i[o*4+l]=this.m[0*4+l]*t.m[o*4+0]+this.m[1*4+l]*t.m[o*4+1]+this.m[2*4+l]*t.m[o*4+2]+this.m[3*4+l]*t.m[o*4+3];return Q(i)},multVec4(t){return{x:t.x*this.m[0]+t.y*this.m[4]+t.z*this.m[8]+t.w*this.m[12],y:t.x*this.m[1]+t.y*this.m[5]+t.z*this.m[9]+t.w*this.m[13],z:t.x*this.m[2]+t.y*this.m[6]+t.z*this.m[10]+t.w*this.m[14],w:t.x*this.m[3]+t.y*this.m[7]+t.z*this.m[11]+t.w*this.m[15]}},multVec3(t){let i=this.multVec4({x:t.x,y:t.y,z:t.z,w:1});return xe(i.x,i.y,i.z)},multVec2(t){return d(t.x*this.m[0]+t.y*this.m[4]+0*this.m[8]+1*this.m[12],t.x*this.m[1]+t.y*this.m[5]+0*this.m[9]+1*this.m[13])},translate(t){return this.mult(Q([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,0,1]))},scale(t){return this.mult(Q([t.x,0,0,0,0,t.y,0,0,0,0,1,0,0,0,0,1]))},rotateX(t){return this.mult(Q([1,0,0,0,0,Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1]))},rotateY(t){return this.mult(Q([Math.cos(t),0,-Math.sin(t),0,0,1,0,0,Math.sin(t),0,Math.cos(t),0,0,0,0,1]))},rotateZ(t){return this.mult(Q([Math.cos(t),-Math.sin(t),0,0,Math.sin(t),Math.cos(t),0,0,0,0,1,0,0,0,0,1]))},invert(){let t=[],i=this.m[10]*this.m[15]-this.m[14]*this.m[11],o=this.m[9]*this.m[15]-this.m[13]*this.m[11],l=this.m[9]*this.m[14]-this.m[13]*this.m[10],R=this.m[8]*this.m[15]-this.m[12]*this.m[11],C=this.m[8]*this.m[14]-this.m[12]*this.m[10],_=this.m[8]*this.m[13]-this.m[12]*this.m[9],B=this.m[6]*this.m[15]-this.m[14]*this.m[7],k=this.m[5]*this.m[15]-this.m[13]*this.m[7],F=this.m[5]*this.m[14]-this.m[13]*this.m[6],V=this.m[4]*this.m[15]-this.m[12]*this.m[7],A=this.m[4]*this.m[14]-this.m[12]*this.m[6],g=this.m[5]*this.m[15]-this.m[13]*this.m[7],v=this.m[4]*this.m[13]-this.m[12]*this.m[5],N=this.m[6]*this.m[11]-this.m[10]*this.m[7],T=this.m[5]*this.m[11]-this.m[9]*this.m[7],$=this.m[5]*this.m[10]-this.m[9]*this.m[6],y=this.m[4]*this.m[11]-this.m[8]*this.m[7],q=this.m[4]*this.m[10]-this.m[8]*this.m[6],X=this.m[4]*this.m[9]-this.m[8]*this.m[5];t[0]=this.m[5]*i-this.m[6]*o+this.m[7]*l,t[4]=-(this.m[4]*i-this.m[6]*R+this.m[7]*C),t[8]=this.m[4]*o-this.m[5]*R+this.m[7]*_,t[12]=-(this.m[4]*l-this.m[5]*C+this.m[6]*_),t[1]=-(this.m[1]*i-this.m[2]*o+this.m[3]*l),t[5]=this.m[0]*i-this.m[2]*R+this.m[3]*C,t[9]=-(this.m[0]*o-this.m[1]*R+this.m[3]*_),t[13]=this.m[0]*l-this.m[1]*C+this.m[2]*_,t[2]=this.m[1]*B-this.m[2]*k+this.m[3]*F,t[6]=-(this.m[0]*B-this.m[2]*V+this.m[3]*A),t[10]=this.m[0]*g-this.m[1]*V+this.m[3]*v,t[14]=-(this.m[0]*F-this.m[1]*A+this.m[2]*v),t[3]=-(this.m[1]*N-this.m[2]*T+this.m[3]*$),t[7]=this.m[0]*N-this.m[2]*y+this.m[3]*q,t[11]=-(this.m[0]*T-this.m[1]*y+this.m[3]*X),t[15]=this.m[0]*$-this.m[1]*q+this.m[2]*X;let O=this.m[0]*t[0]+this.m[1]*t[4]+this.m[2]*t[8]+this.m[3]*t[12];for(let z=0;z<4;z++)for(let w=0;w<4;w++)t[z*4+w]*=1/O;return Q(t)}}}function yt(e,t,i){return e+(Math.sin(i)+1)/2*(t-e)}function We(e){return{seed:e,gen(t,i){if(De(t)&&De(i))return d(this.gen(t.x,i.x),this.gen(t.y,i.y));if(we(t)&&we(i))return Y(this.gen(t.r,i.r),this.gen(t.g,i.g),this.gen(t.b,i.b),this.gen(t.a,i.a));if(t!==void 0)return i===void 0?this.gen()*t:this.gen()*(i-t)+t;if(t===void 0&&i===void 0)return this.seed=(dn*this.seed+fn)%bt,this.seed/bt;throw new Error("invalid param to rand()")}}}function wt(e){xt.seed=e}function Ie(e,t){return xt.gen(e,t)}function gt(e){return Ie(0,1)<=e}function vt(e){return e[Math.floor(Ie(e.length))]}function Ke(e,t){return e.p2.x>=t.p1.x&&e.p1.x<=t.p2.x&&e.p2.y>=t.p1.y&&e.p1.y<=t.p2.y}function Rt(e,t){return e.p2.x>t.p1.x&&e.p1.x<t.p2.x&&e.p2.y>t.p1.y&&e.p1.y<t.p2.y}function _t(e,t){return t.x>=e.p1.x&&t.x<=e.p2.x&&t.y>=e.p1.y&&t.y<e.p2.y}var dn,fn,bt,xt,me=ce(()=>{s(ht,"deg2rad");s(dt,"rad2deg");s(ue,"clamp");s(ke,"lerp");s(be,"map");s(ft,"mapc");s(d,"vec2");s(lt,"vec2FromAngle");s(xe,"vec3");s(De,"isVec2");s(mt,"isVec3");s(we,"isColor");s(pt,"isMat4");s(Pe,"rgb");s(Y,"rgba");s(re,"quad");s(Q,"mat4");s(yt,"wave");dn=1103515245,fn=12345,bt=2147483648,xt=We(Date.now());s(We,"makeRng");s(wt,"randSeed");s(Ie,"rand");s(gt,"chance");s(vt,"choose");s(Ke,"colRectRect");s(Rt,"overlapRectRect");s(_t,"colRectPt")});function Qe(e,t){let i=typeof e,o=typeof t;if(i!==o)return!1;if(i==="object"&&o==="object"){let l=Object.keys(e),R=Object.keys(t);if(l.length!==R.length)return!1;for(let C of l){let _=e[C],B=t[C];if(!(typeof _=="function"&&typeof B=="function")&&!Qe(_,B))return!1}return!0}return e===t}var Et=ce(()=>{s(Qe,"deepEq")});function Le(e){switch(e){case"topleft":return d(-1,-1);case"top":return d(0,-1);case"topright":return d(1,-1);case"left":return d(-1,0);case"center":return d(0,0);case"right":return d(1,0);case"botleft":return d(-1,1);case"bot":return d(0,1);case"botright":return d(1,1);default:return e}}function At(e,t){let i=(()=>{switch(t.texFilter){case"linear":return e.LINEAR;case"nearest":return e.NEAREST;default:return e.NEAREST}})(),o=(()=>{var L;let f=R(Je,et),b=l(new ImageData(new Uint8ClampedArray([255,255,255,255]),1,1)),x=(L=t.clearColor)!=null?L:Y(0,0,0,1);e.clearColor(x.r,x.g,x.b,x.a),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.depthFunc(e.LEQUAL),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);let P=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,P),e.bufferData(e.ARRAY_BUFFER,Be*4,e.DYNAMIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null);let U=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,U),e.bufferData(e.ELEMENT_ARRAY_BUFFER,Be*2,e.DYNAMIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),{drawCalls:0,lastDrawCalls:0,defProg:f,curProg:f,defTex:b,curTex:b,curUniform:{},vbuf:P,ibuf:U,vqueue:[],iqueue:[],transform:Q(),transformStack:[],clearColor:x}})();function l(f){let b=e.createTexture();return e.bindTexture(e.TEXTURE_2D,b),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,f),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_2D,null),{width:f.width,height:f.height,bind(){e.bindTexture(e.TEXTURE_2D,b)},unbind(){e.bindTexture(e.TEXTURE_2D,null)}}}s(l,"makeTex");function R(f=Je,b=et){let x,P=ln.replace("{{user}}",f!=null?f:Je),U=mn.replace("{{user}}",b!=null?b:et),L=e.createShader(e.VERTEX_SHADER),W=e.createShader(e.FRAGMENT_SHADER);if(e.shaderSource(L,P),e.shaderSource(W,U),e.compileShader(L),e.compileShader(W),x=e.getShaderInfoLog(L))throw new Error(x);if(x=e.getShaderInfoLog(W))throw new Error(x);let E=e.createProgram();if(e.attachShader(E,L),e.attachShader(E,W),e.bindAttribLocation(E,0,"a_pos"),e.bindAttribLocation(E,1,"a_uv"),e.bindAttribLocation(E,2,"a_color"),e.linkProgram(E),x=e.getProgramInfoLog(E))throw new Error(x);return{bind(){e.useProgram(E)},unbind(){e.useProgram(null)},bindAttribs(){e.vertexAttribPointer(0,3,e.FLOAT,!1,Fe*4,0),e.enableVertexAttribArray(0),e.vertexAttribPointer(1,2,e.FLOAT,!1,Fe*4,12),e.enableVertexAttribArray(1),e.vertexAttribPointer(2,4,e.FLOAT,!1,Fe*4,20),e.enableVertexAttribArray(2)},send(D){this.bind();for(let j in D){let I=D[j],K=e.getUniformLocation(E,j);typeof I=="number"?e.uniform1f(K,I):pt(I)?e.uniformMatrix4fv(K,!1,new Float32Array(I.m)):we(I)?e.uniform4f(K,I.r,I.g,I.b,I.a):mt(I)?e.uniform3f(K,I.x,I.y,I.z):De(I)&&e.uniform2f(K,I.x,I.y)}this.unbind()}}}s(R,"makeProgram");function C(f,b,x,P){let U=f.width/b,L=f.height/x,W=1/U,E=1/L,D={},j=P.split("").entries();for(let[I,K]of j)D[K]=d(I%U*W,Math.floor(I/U)*E);return{tex:f,map:D,qw:W,qh:E}}s(C,"makeFont");function _(f,b,x=o.defTex,P=o.defProg,U={}){x=x!=null?x:o.defTex,P=P!=null?P:o.defProg,(x!==o.curTex||P!==o.curProg||!Qe(o.curUniform,U)||o.vqueue.length+f.length*Fe>Be||o.iqueue.length+b.length>Be)&&B(),o.curTex=x,o.curProg=P,o.curUniform=U;let L=b.map(E=>E+o.vqueue.length/Fe),W=f.map(E=>{let D=A(o.transform.multVec2(E.pos.xy()));return[D.x,D.y,E.pos.z,E.uv.x,E.uv.y,E.color.r,E.color.g,E.color.b,E.color.a]}).flat();L.forEach(E=>o.iqueue.push(E)),W.forEach(E=>o.vqueue.push(E))}s(_,"drawRaw");function B(){!o.curTex||!o.curProg||o.vqueue.length===0||o.iqueue.length===0||(o.curProg.send(o.curUniform),e.bindBuffer(e.ARRAY_BUFFER,o.vbuf),e.bufferSubData(e.ARRAY_BUFFER,0,new Float32Array(o.vqueue)),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o.ibuf),e.bufferSubData(e.ELEMENT_ARRAY_BUFFER,0,new Uint16Array(o.iqueue)),o.curProg.bind(),o.curProg.bindAttribs(),o.curTex.bind(),e.drawElements(e.TRIANGLES,o.iqueue.length,e.UNSIGNED_SHORT,0),o.curTex.unbind(),o.curProg.unbind(),e.bindBuffer(e.ARRAY_BUFFER,null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),o.iqueue=[],o.vqueue=[],o.drawCalls++)}s(B,"flush");function k(){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),o.drawCalls=0,o.transformStack=[],o.transform=Q()}s(k,"frameStart");function F(){B(),o.lastDrawCalls=o.drawCalls}s(F,"frameEnd");function V(){return o.lastDrawCalls}s(V,"drawCalls");function A(f){return d(f.x/Me()*2-1,-f.y/ve()*2+1)}s(A,"toNDC");function g(f){o.transform=f.clone()}s(g,"pushMatrix");function v(f){!f||f.x===0&&f.y===0||(o.transform=o.transform.translate(f))}s(v,"pushTranslate");function N(f){!f||f.x===1&&f.y===1||(o.transform=o.transform.scale(f))}s(N,"pushScale");function T(f){!f||(o.transform=o.transform.rotateX(f))}s(T,"pushRotateX");function $(f){!f||(o.transform=o.transform.rotateY(f))}s($,"pushRotateY");function y(f){!f||(o.transform=o.transform.rotateZ(f))}s(y,"pushRotateZ");function q(){o.transformStack.push(o.transform.clone())}s(q,"pushTransform");function X(){o.transformStack.length>0&&(o.transform=o.transformStack.pop())}s(X,"popTransform");function O(f={}){var K,ee;let b=f.width||0,x=f.height||0,P=f.pos||d(0,0),L=Le(f.origin||Ze).dot(d(b,x).scale(-.5)),W=d((K=f.scale)!=null?K:1),E=f.rot||0,D=f.quad||re(0,0,1,1),j=1-((ee=f.z)!=null?ee:0),I=f.color||Y(1,1,1,1);q(),v(P),N(W),y(E),v(L),_([{pos:xe(-b/2,x/2,j),uv:d(D.x,D.y+D.h),color:I},{pos:xe(-b/2,-x/2,j),uv:d(D.x,D.y),color:I},{pos:xe(b/2,-x/2,j),uv:d(D.x+D.w,D.y),color:I},{pos:xe(b/2,x/2,j),uv:d(D.x+D.w,D.y+D.h),color:I}],[0,1,3,1,2,3],f.tex,f.prog,f.uniform),X()}s(O,"drawQuad");function z(f,b={}){var L;let x=(L=b.quad)!=null?L:re(0,0,1,1),P=f.width*x.w,U=f.height*x.h;O(ye(de({},b),{tex:f,quad:x,width:P,height:U}))}s(z,"drawTexture");function w(f,b,x,P={}){O(ye(de({},P),{pos:f,width:b,height:x}))}s(w,"drawRect");function G(f,b,x,P={}){let U=Le(P.origin||Ze).dot(d(b,x)).scale(.5),L=f.add(d(-b/2,-x/2)).sub(U),W=f.add(d(-b/2,x/2)).sub(U),E=f.add(d(b/2,x/2)).sub(U),D=f.add(d(b/2,-x/2)).sub(U);Z(L,W,P),Z(W,E,P),Z(E,D,P),Z(D,L,P)}s(G,"drawRectStroke");function Z(f,b,x={}){let P=x.width||1,U=f.dist(b),L=Math.PI/2-f.angle(b);O(ye(de({},x),{pos:f.add(b).scale(.5),width:P,height:U,rot:L,origin:"center"}))}s(Z,"drawLine");function ne(f,b,x={}){let P=(f+"").split(""),U=b.qw*b.tex.width,L=b.qh*b.tex.height,W=x.size||L,E=d(W/L).dot(d(x.scale||1)),D=E.x*U,j=E.y*L,I=0,K=j,ee=0,pe=[[]];for(let se of P)(se===`
`||(x.width?I+D>x.width:!1))&&(K+=j,I=0,pe.push([])),se!==`
`&&(pe[pe.length-1].push(se),I+=D),ee=Math.max(ee,I);x.width&&(ee=x.width);let Ge=[],qe=d(x.pos),te=Le(x.origin||Ze).scale(.5),he=-te.x*D-(te.x+.5)*(ee-D),Ee=-te.y*j-(te.y+.5)*(K-j);return pe.forEach((se,ze)=>{let Oe=(ee-se.length*D)*(te.x+.5);se.forEach((Ae,je)=>{let Se=b.map[Ae],Xe=je*D,Ve=ze*j;Se&&Ge.push({tex:b.tex,quad:re(Se.x,Se.y,b.qw,b.qh),ch:Ae,pos:d(qe.x+Xe+he+Oe,qe.y+Ve+Ee),color:x.color,origin:x.origin,scale:E,z:x.z})})}),{width:ee,height:K,chars:Ge}}s(ne,"fmtText");function ie(f,b,x={}){J(ne(f,b,x))}s(ie,"drawText");function J(f){for(let b of f.chars)O({tex:b.tex,width:b.tex.width*b.quad.w,height:b.tex.height*b.quad.h,pos:b.pos,scale:b.scale,color:b.color,quad:b.quad,origin:"center",z:b.z})}s(J,"drawFmtText");function Me(){return e.drawingBufferWidth/Re()}s(Me,"width");function ve(){return e.drawingBufferHeight/Re()}s(ve,"height");function Re(){var f;return(f=t.scale)!=null?f:1}s(Re,"scale");function _e(){return o.clearColor.clone()}return s(_e,"clearColor"),{width:Me,height:ve,scale:Re,makeTex:l,makeProgram:R,makeFont:C,drawTexture:z,drawText:ie,drawFmtText:J,drawRect:w,drawRectStroke:G,drawLine:Z,fmtText:ne,frameStart:k,frameEnd:F,pushTransform:q,popTransform:X,pushMatrix:g,drawCalls:V,clearColor:_e}}var Ze,Fe,Be,ln,mn,Je,et,St=ce(()=>{me();Et();Ze="topleft",Fe=9,Be=65536,ln=`
attribute vec3 a_pos;
attribute vec2 a_uv;
attribute vec4 a_color;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

vec4 def_vert() {
	return vec4(a_pos, 1.0);
}

{{user}}

void main() {
	vec4 pos = vert(a_pos, a_uv, a_color);
	v_pos = a_pos;
	v_uv = a_uv;
	v_color = a_color;
	gl_Position = pos;
}
`,mn=`
precision mediump float;

varying vec3 v_pos;
varying vec2 v_uv;
varying vec4 v_color;

uniform sampler2D u_tex;

vec4 def_frag() {
	return v_color * texture2D(u_tex, v_uv);
}

{{user}}

void main() {
	gl_FragColor = frag(v_pos, v_uv, v_color, u_tex);
	if (gl_FragColor.a == 0.0) {
		discard;
	}
}
`,Je=`
vec4 vert(vec3 pos, vec2 uv, vec4 color) {
	return def_vert();
}
`,et=`
vec4 frag(vec3 pos, vec2 uv, vec4 color, sampler2D tex) {
	return def_frag();
}
`;s(Le,"originPt");s(At,"gfxInit")});function Tt(e){return e==="pressed"||e==="rpressed"?"down":e==="released"?"up":e}function Ct(e={}){var O,z;let t={canvas:(O=e.canvas)!=null?O:(()=>{var G;let w=document.createElement("canvas");return((G=e.root)!=null?G:document.body).appendChild(w),w})(),keyStates:{},charInputted:[],mouseState:"up",mousePos:d(0,0),time:0,realTime:0,skipTime:!1,dt:0,scale:(z=e.scale)!=null?z:1,isTouch:!1,loopID:null,stopped:!1},i={ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"," ":"space"},o=["space","left","right","up","down","tab","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11"];e.fullscreen?(t.canvas.width=window.innerWidth,t.canvas.height=window.innerHeight):(t.canvas.width=(e.width||640)*t.scale,t.canvas.height=(e.height||480)*t.scale);let l=["outline: none","cursor: default"];e.crisp&&(l.push("image-rendering: pixelated"),l.push("image-rendering: crisp-edges")),t.canvas.style=l.join(";"),t.canvas.setAttribute("tabindex","0");let R=t.canvas.getContext("webgl",{antialias:!0,depth:!0,stencil:!0,alpha:!0,preserveDrawingBuffer:!0});t.isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,t.canvas.addEventListener("mousemove",w=>{t.mousePos=d(w.offsetX,w.offsetY).scale(1/t.scale)}),t.canvas.addEventListener("mousedown",()=>{t.mouseState="pressed"}),t.canvas.addEventListener("mouseup",()=>{t.mouseState="released"}),t.canvas.addEventListener("touchstart",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale),t.mouseState="pressed"}),t.canvas.addEventListener("touchmove",w=>{let G=w.touches[0];t.mousePos=d(G.clientX,G.clientY).scale(1/t.scale)}),t.canvas.addEventListener("keydown",w=>{let G=i[w.key]||w.key.toLowerCase();o.includes(G)&&w.preventDefault(),G.length===1&&t.charInputted.push(G),G==="space"&&t.charInputted.push(" "),w.repeat?t.keyStates[G]="rpressed":t.keyStates[G]="pressed"}),t.canvas.addEventListener("keyup",w=>{let G=i[w.key]||w.key.toLowerCase();t.keyStates[G]="released"}),t.canvas.focus(),document.addEventListener("visibilitychange",()=>{switch(document.visibilityState){case"visible":t.skipTime=!0;break;case"hidden":break}});function C(){return t.mousePos.clone()}s(C,"mousePos");function _(){return t.mouseState==="pressed"}s(_,"mouseClicked");function B(){return t.mouseState==="pressed"||t.mouseState==="down"}s(B,"mouseDown");function k(){return t.mouseState==="released"}s(k,"mouseReleased");function F(w){return t.keyStates[w]==="pressed"}s(F,"keyPressed");function V(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"}s(V,"keyPressedRep");function A(w){return t.keyStates[w]==="pressed"||t.keyStates[w]==="rpressed"||t.keyStates[w]==="down"}s(A,"keyDown");function g(w){return t.keyStates[w]==="released"}s(g,"keyReleased");function v(){return[...t.charInputted]}s(v,"charInputted");function N(){return t.dt}s(N,"dt");function T(){return t.time}s(T,"time");function $(){return t.canvas.toDataURL()}s($,"screenshot");function y(w){return w&&(t.canvas.style.cursor=w!=null?w:"default"),t.canvas.style.cursor}s(y,"cursor");function q(w){let G=s(Z=>{let ne=Z/1e3,ie=ne-t.realTime;t.realTime=ne,t.skipTime||(t.dt=ie,t.time+=t.dt),t.skipTime=!1,w();for(let J in t.keyStates)t.keyStates[J]=Tt(t.keyStates[J]);t.mouseState=Tt(t.mouseState),t.charInputted=[],t.stopped||(t.loopID=requestAnimationFrame(G))},"frame");t.loopID=requestAnimationFrame(G)}s(q,"run");function X(){cancelAnimationFrame(t.loopID),t.stopped=!0}return s(X,"quit"),{gl:R,mousePos:C,keyDown:A,keyPressed:F,keyPressedRep:V,keyReleased:g,mouseDown:B,mouseClicked:_,mouseReleased:k,charInputted:v,cursor:y,dt:N,time:T,screenshot:$,run:q,quit:X}}var kt=ce(()=>{me();s(Tt,"processBtnState");s(Ct,"appInit")});function It(){let e=(()=>{let l=new(window.AudioContext||window.webkitAudioContext),R=l.createGain(),C=R;return C.connect(l.destination),{ctx:l,gainNode:R,masterNode:C}})();function t(l){return l!==void 0&&(e.gainNode.gain.value=ue(l,Dt,Pt)),e.gainNode.gain.value}s(t,"volume");function i(l,R={loop:!1,volume:1,speed:1,detune:0,seek:0}){var g;let C=!1,_=e.ctx.createBufferSource();_.buffer=l,_.loop=!!R.loop;let B=e.ctx.createGain();_.connect(B),B.connect(e.masterNode);let k=(g=R.seek)!=null?g:0;_.start(0,k);let F=e.ctx.currentTime-k,V=null,A={stop(){this.pause(),F=e.ctx.currentTime},play(v){if(!C)return;let N=_;_=e.ctx.createBufferSource(),_.buffer=N.buffer,_.loop=N.loop,_.playbackRate.value=N.playbackRate.value,_.detune&&(_.detune.value=N.detune.value),_.connect(B);let T=v!=null?v:this.time();_.start(0,T),F=e.ctx.currentTime-T,C=!1,V=null},pause(){_.stop(),C=!0,V=e.ctx.currentTime},paused(){return C},stopped(){return C},speed(v){return v!==void 0&&(_.playbackRate.value=ue(v,pn,yn)),_.playbackRate.value},detune(v){return _.detune?(v!==void 0&&(_.detune.value=ue(v,bn,xn)),_.detune.value):0},volume(v){return v!==void 0&&(B.gain.value=ue(v,Dt,Pt)),B.gain.value},loop(){_.loop=!0},unloop(){_.loop=!1},duration(){return l.duration},time(){return C&&V?V-F:e.ctx.currentTime-F}};return A.speed(R.speed),A.detune(R.detune),A.volume(R.volume),A}s(i,"play");function o(){return e.ctx}return s(o,"ctx"),{ctx:o,volume:t,play:i}}var Dt,Pt,pn,yn,bn,xn,Ft=ce(()=>{me();Dt=0,Pt=3,pn=0,yn=3,bn=-1200,xn=1200;s(It,"audioInit")});var Lt,Mt=ce(()=>{Lt="data:image/png;base64,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"});function Gt(e){let t=new Image;return t.src=e,t.crossOrigin="anonymous",new Promise((i,o)=>{t.onload=()=>{i(t)},t.onerror=()=>{o(`failed to load ${e}`)}})}function qt(e){return e.startsWith("data:")}function Ot(e,t,i={}){let o={lastLoaderID:0,loadRoot:"",loaders:{},sprites:{},sounds:{},fonts:{},shaders:{}};function l(A){var v;let g=o.lastLoaderID;o.loaders[g]=!1,o.lastLoaderID++,A.catch((v=i.errHandler)!=null?v:console.error).finally(()=>{o.loaders[g]=!0})}s(l,"addLoader");function R(){let A=0,g=0;for(let v in o.loaders)A+=1,o.loaders[v]&&(g+=1);return g/A}s(R,"loadProgress");function C(A){return A&&(o.loadRoot=A),o.loadRoot}s(C,"loadRoot");function _(A,g,v,N,T=gn){let $=new Promise((y,q)=>{let X=qt(g)?g:o.loadRoot+g;Gt(X).then(O=>{let z=e.makeFont(e.makeTex(O),v,N,T);o.fonts[A]=z,y(z)}).catch(q)});return l($),$}s(_,"loadFont");function B(A,g,v={sliceX:1,sliceY:1,anims:{}}){function N($,y,q={sliceX:1,sliceY:1,anims:{}}){let X=[],O=e.makeTex(y),z=q.sliceX||1,w=q.sliceY||1,G=1/z,Z=1/w;for(let ie=0;ie<w;ie++)for(let J=0;J<z;J++)X.push(re(J*G,ie*Z,G,Z));let ne={tex:O,frames:X,anims:q.anims||{}};return o.sprites[$]=ne,ne}s(N,"loadRawSprite");let T=new Promise(($,y)=>{if(!g)return y(`expected sprite src for "${A}"`);if(typeof g=="string"){let q=qt(g)?g:o.loadRoot+g;Gt(q).then(X=>{$(N(A,X,v))}).catch(y)}else $(N(A,g,v))});return l(T),T}s(B,"loadSprite");function k(A,g,v,N=!1){function T(y,q,X){let O=e.makeProgram(q,X);return o.shaders[y]=O,O}s(T,"loadRawShader");let $=new Promise((y,q)=>{if(!g&&!v)return q("no shader");function X(O){return O?fetch(o.loadRoot+O).then(z=>{if(z.ok)return z.text();throw new Error(`failed to load ${O}`)}).catch(q):new Promise(z=>z(null))}if(s(X,"resolveUrl"),N)Promise.all([X(g),X(v)]).then(([O,z])=>{y(T(A,O,z))}).catch(q);else try{y(T(A,g,v))}catch(O){q(O)}});return l($),$}s(k,"loadShader");function F(A,g){let v=o.loadRoot+g,N=new Promise((T,$)=>{if(!g)return $(`expected sound src for "${A}"`);typeof g=="string"&&fetch(v).then(y=>{if(y.ok)return y.arrayBuffer();throw new Error(`failed to load ${v}`)}).then(y=>new Promise((q,X)=>{t.ctx().decodeAudioData(y,q,X)})).then(y=>{o.sounds[A]=y,T(y)}).catch($)});return l(N),N}s(F,"loadSound");function V(){return o.fonts[ge]}return s(V,"defFont"),_(ge,Lt,8,8),{loadRoot:C,loadSprite:B,loadSound:F,loadFont:_,loadShader:k,loadProgress:R,addLoader:l,defFont:V,sprites:o.sprites,fonts:o.fonts,sounds:o.sounds,shaders:o.shaders}}var gn,ge,Vt=ce(()=>{me();Mt();gn=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",ge="unscii";s(Gt,"loadImg");s(qt,"isDataUrl");s(Ot,"assetsInit")});function Nt(e,t,i={max:8}){var k;let o=[],l=(k=i.max)!=null?k:8;function R(){o.length>l&&(o=o.slice(0,l));let F=d(0,e.height());o.forEach((V,A)=>{let g=be(A,0,l,1,.2),v=be(A,0,l,.8,.2),N=(()=>{switch(V.type){case"info":return Y(1,1,1,g);case"error":return Y(1,0,.5,g)}})(),T=e.fmtText(V.msg,t.defFont(),{pos:F,origin:"botleft",color:N,z:1,size:vn/e.scale(),width:e.width()});e.drawRect(F,T.width,T.height,{origin:"botleft",color:Y(0,0,0,v),z:1}),e.drawFmtText(T),F.y-=T.height})}s(R,"draw");function C(F){console.error(F),o.unshift({type:"error",msg:F})}s(C,"error");function _(F){o.unshift({type:"info",msg:F})}s(_,"info");function B(){o=[]}return s(B,"clear"),{info:_,error:C,draw:R,clear:B}}var vn,Ut=ce(()=>{me();vn=16;s(Nt,"loggerInit")});function Bt(e){let t={},i=[],o=null;function l(){return o!==null&&o.readyState===1}s(l,"connected");function R(){let k=new WebSocket(e);return new Promise((F,V)=>{k.onopen=()=>{F(k),o=k;for(let A of i)k.send(A)},k.onerror=()=>{V(`failed to connect to ${e}`)},k.onmessage=A=>{let g=JSON.parse(A.data);if(t[g.type])for(let v of t[g.type])v(g.data,g.id)}})}s(R,"connect");function C(k,F){t[k]||(t[k]=[]),t[k].push(F)}s(C,"recv");function _(k,F){let V=JSON.stringify({type:k,data:F});o?o.send(V):i.push(V)}s(_,"send");function B(){o&&o.close()}return s(B,"close"),{connect:R,close:B,connected:l,recv:C,send:_}}var zt=ce(()=>{s(Bt,"netInit")});var Rn=hn(($n,jt)=>{me();St();kt();Ft();Vt();Ut();zt();jt.exports=(e={width:640,height:480,scale:1,fullscreen:!1,debug:!1,crisp:!1,canvas:null,connect:null,logMax:8,root:document.body})=>{var nt;let t=Ct({width:e.width,height:e.height,scale:e.scale,fullscreen:e.fullscreen,crisp:e.crisp,canvas:e.canvas,root:e.root}),i=At(t.gl,{clearColor:Y((nt=e.clearColor)!=null?nt:[0,0,0,1]),scale:e.scale,texFilter:e.texFilter}),o=It(),l=Ot(i,o,{errHandler:r=>{R.error(r)}}),R=Nt(i,l,{max:e.logMax}),C=(()=>e.connect?Bt(e.connect):null)();function _(r,n){if(!C)throw new Error("not connected to any websockets");C.recv(r,(a,c)=>{try{n(a,c)}catch(u){R.error(u)}})}s(_,"recv");function B(r,n){if(!C)throw new Error("not connected to any websockets");C.send(r,n)}s(B,"send");function k(){return t.dt()*H.timeScale}s(k,"dt");function F(r,n={}){let a=l.sounds[r];if(!a)throw new Error(`sound not found: "${r}"`);return o.play(a,n)}s(F,"play");function V(r){let n=y();return Object.keys(n.layers).length===0?n.cam.mpos:n.cam.ignore.includes(r!=null?r:n.defLayer)?t.mousePos():n.cam.mpos}s(V,"mousePos");function A(r,n={}){var u;let a=(()=>typeof r=="string"?l.sprites[r]:r)();if(!a)throw new Error(`sprite not found: "${r}"`);let c=a.frames[(u=n.frame)!=null?u:0];i.drawTexture(a.tex,ye(de({},n),{quad:c}))}s(A,"drawSprite");function g(r,n={}){var u;let a=(u=n.font)!=null?u:ge,c=l.fonts[a];if(!c)throw new Error(`font not found: ${a}`);i.drawText(r,c,n)}s(g,"drawText");let v=980,N="topleft",T={loaded:!1,scenes:{},curScene:null,nextScene:null};function $(r,n){T.scenes[r]={init:n,initialized:!1,events:{add:[],update:[],draw:[],destroy:[],keyDown:[],keyPress:[],keyPressRep:[],keyRelease:[],mouseClick:[],mouseRelease:[],mouseDown:[],charInput:[]},action:[],render:[],objs:new Map,lastID:0,timers:{},lastTimerID:0,cam:{pos:d(i.width()/2,i.height()/2),scale:d(1,1),angle:0,shake:0,ignore:[],mpos:d(0),matrix:Q()},layers:{},defLayer:null,gravity:v,data:{}}}s($,"scene");function y(){return T.scenes[T.curScene]}s(y,"curScene");function q(){return y().data}s(q,"sceneData");function X(){j("`",()=>{H.showLog=!H.showLog,R.info(`show log: ${H.showLog?"on":"off"}`)}),j("f1",()=>{H.inspect=!H.inspect,R.info(`inspect: ${H.inspect?"on":"off"}`)}),j("f2",()=>{H.clearLog()}),j("f8",()=>{H.paused=!H.paused,R.info(`${H.paused?"paused":"unpaused"}`)}),j("f7",()=>{H.timeScale=ue(H.timeScale-.2,0,2),R.info(`time scale: ${H.timeScale.toFixed(1)}`)}),j("f9",()=>{H.timeScale=ue(H.timeScale+.2,0,2),R.info(`time scale: ${H.timeScale.toFixed(1)}`)}),j("f10",()=>{H.stepFrame(),R.info("stepped frame")})}s(X,"regDebugInputs");function O(r,...n){T.nextScene={name:r,args:[...n]}}s(O,"go");function z(r,...n){w(r),T.curScene=r;let a=T.scenes[r];if(!a)throw new Error(`scene not found: '${r}'`);if(!a.initialized){try{a.init(...n)}catch(c){R.error(c.stack)}e.debug&&X(),a.initialized=!0}}s(z,"goSync");function w(r){if(!T.scenes[r])throw new Error(`scene not found: '${r}'`);$(r,T.scenes[r].init)}s(w,"reload");function G(r,n){let a=y();if(!a)return;let c=.5/r.length;r.forEach((u,m)=>{a.layers[u]=.5+c*m}),n&&(a.defLayer=n)}s(G,"layers");function Z(...r){let n=y().cam;return r.length>0&&(n.pos=d(...r)),n.pos.clone()}s(Z,"camPos");function ne(...r){let n=y().cam;return r.length>0&&(n.scale=d(...r)),n.scale.clone()}s(ne,"camScale");function ie(r){let n=y().cam;return r!==void 0&&(n.angle=r),n.angle}s(ie,"camRot");function J(r){let n=y().cam;n.shake=r}s(J,"camShake");function Me(r){let n=y().cam;n.ignore=r}s(Me,"camIgnore");function ve(r){let n={hidden:!1,paused:!1,_tags:[],_sceneID:null,_events:{add:[],update:[],draw:[],destroy:[],inspect:[]},use(c){if(c===void 0)return;let u=typeof c;if(u==="string"){this._tags.push(c);return}if(u!=="object")throw new Error(`invalid comp type: ${u}`);if(Array.isArray(c)){for(let m of c)this.use(m);return}for(let m in c){if(typeof c[m]=="function"){this._events[m]?this._events[m].push(c[m].bind(this)):this[m]=c[m].bind(this);continue}this[m]=c[m]}},exists(){return this._sceneID!==void 0},is(c){if(c==="*")return!0;if(Array.isArray(c)){for(let u of c)if(!this._tags.includes(u))return!1;return!0}return this._tags.includes(c)},on(c,u){this._events[c]||(this._events[c]=[]),this._events[c].push(u)},action(c){this.on("update",c)},trigger(c,...u){if(this._events[c])for(let p of this._events[c])p.call(this,...u);let h=y().events[c];if(h)for(let p of h)this.is(p.tag)&&p.cb(this,...u)},rmTag(c){let u=this._tags.indexOf(c);u>-1&&this._tags.splice(u,1)}};n.use(r);let a=y();a.objs.set(a.lastID,n),n._sceneID=a.lastID,a.lastID++,n.trigger("add");for(let c of a.events.add)n.is(c.tag)&&c.cb(n);return n}s(ve,"add");function Re(r){if(!r.exists())return;let n=y();return n.objs.delete(r._sceneID),n.objs.set(n.lastID,r),r._sceneID=n.lastID,n.lastID++,r}s(Re,"readd");function _e(r,n,a){let c=y();c.events[r]||(c.events[r]=[]),c.events[r].push({tag:n,cb:a})}s(_e,"on");function f(r,n){typeof r=="function"&&n===void 0?y().action.push(r):typeof r=="string"&&_e("update",r,n)}s(f,"action");function b(r,n){typeof r=="function"&&n===void 0?y().render.push(r):typeof r=="string"&&_e("update",r,n)}s(b,"render");function x(r,n,a){f(r,c=>{c._checkCollisions(n,u=>{a(c,u)})})}s(x,"collides");function P(r,n,a){f(r,c=>{c._checkOverlaps(n,u=>{a(c,u)})})}s(P,"overlaps");function U(r,n){f(r,a=>{a.isClicked()&&n(a)})}s(U,"clicks");function L(r,n){return new Promise(a=>{let c=y();c.timers[c.lastTimerID++]={time:r,cb:()=>{n&&n(),a()}}})}s(L,"wait");function W(r,n){let a=!1,c=s(()=>{a||(n(),L(r,c))},"newF");return c(),{stop(){a=!0}}}s(W,"loop");function E(r,n,a){if(Array.isArray(n))for(let c of n)E(r,c,a);else y().events[r].push({key:n,cb:a})}s(E,"pushKeyEvent");function D(r,n){E("keyDown",r,n)}s(D,"keyDown");function j(r,n){E("keyPress",r,n)}s(j,"keyPress");function I(r,n){E("keyPressRep",r,n)}s(I,"keyPressRep");function K(r,n){E("keyRelease",r,n)}s(K,"keyRelease");function ee(r){y().events.charInput.push({cb:r})}s(ee,"charInput");function pe(r){y().events.mouseDown.push({cb:r})}s(pe,"mouseDown");function Ge(r){y().events.mouseClick.push({cb:r})}s(Ge,"mouseClick");function qe(r){y().events.mouseRelease.push({cb:r})}s(qe,"mouseRelease");function te(r){let a=[...y().objs.values()];return r?a.filter(c=>c.is(r)):a}s(te,"get");function he(r,n){typeof r=="function"&&n===void 0?te().forEach(r):typeof r=="string"&&te(r).forEach(n)}s(he,"every");function Ee(r,n){typeof r=="function"&&n===void 0?te().reverse().forEach(r):typeof r=="string"&&te(r).reverse().forEach(n)}s(Ee,"revery");function se(r){if(!r.exists())return;let n=y();!n||(r.trigger("destroy"),n.objs.delete(r._sceneID),delete r._sceneID)}s(se,"destroy");function ze(r){he(r,n=>{se(n)})}s(ze,"destroyAll");function Oe(r){let n=y();return r!==void 0&&(n.gravity=r),n.gravity}s(Oe,"gravity");function Ae(r){let n=y();if(!n)throw new Error(`scene not found: '${T.curScene}'`);let a=r||!H.paused;if(a)for(let h in n.timers){let p=n.timers[h];p.time-=k(),p.time<=0&&(p.cb(),delete n.timers[h])}if(Ee(h=>{!h.paused&&a&&h.trigger("update")}),a)for(let h of n.action)h();let c=d(i.width(),i.height()),u=n.cam,m=lt(Ie(0,Math.PI*2)).scale(u.shake);u.shake=ke(u.shake,0,5*k()),u.matrix=Q().translate(c.scale(.5)).scale(u.scale).rotateZ(u.angle).translate(c.scale(-.5)).translate(u.pos.scale(-1).add(c.scale(.5)).add(m)),u.mpos=u.matrix.invert().multVec2(t.mousePos()),he(h=>{h.hidden||(i.pushTransform(),u.ignore.includes(h.layer)||i.pushMatrix(u.matrix),h.trigger("draw"),i.popTransform())});for(let h of n.render)h()}s(Ae,"gameFrame");function je(){let r=y();for(let n of r.events.charInput)t.charInputted().forEach(n.cb);for(let n of r.events.keyDown)t.keyDown(n.key)&&n.cb();for(let n of r.events.keyPress)t.keyPressed(n.key)&&n.cb();for(let n of r.events.keyPressRep)t.keyPressedRep(n.key)&&n.cb();for(let n of r.events.keyRelease)t.keyReleased(n.key)&&n.cb();for(let n of r.events.mouseDown)t.mouseDown()&&n.cb();for(let n of r.events.mouseClick)t.mouseClicked()&&n.cb();for(let n of r.events.mouseRelease)t.mouseReleased()&&n.cb()}s(je,"handleEvents");function Se(){var p;let r=y(),n=!1,a=i.scale()*((r.cam.scale.x+r.cam.scale.y)/2),c=l.defFont(),u=Y((p=e.inspectColor)!=null?p:[0,1,1,1]),m=d(6,6).scale(1/a),h=12;Ee(S=>{if(!S.area||S.hidden)return;i.pushTransform(),r.cam.ignore.includes(S.layer)||i.pushMatrix(r.cam.matrix);let M=!1;S.isHovered()&&!n&&(M=!0,n=!0);let oe=(M?6:2)/a,ae=S._worldArea(),$e=ae.p2.x-ae.p1.x,He=ae.p2.y-ae.p1.y;if(i.drawRectStroke(ae.p1,$e,He,{width:oe,color:u,z:.9}),M){let st=V(S.layer),Ce=0,Ue=0,rt=[],it=s(fe=>{let le=i.fmtText(fe,c,{size:h/a,pos:st.add(d(m.x,m.y+Ue)),z:1});rt.push(le),Ce=le.width>Ce?le.width:Ce,Ue+=le.height},"addLine");for(let fe of S._tags)it(`"${fe}"`);for(let fe of S._events.inspect){let le=fe();for(let ot in le)it(`${ot}: ${le[ot]}`)}Ce+=m.x*2,Ue+=m.y*2,i.drawRect(st,Ce,Ue,{color:Y(0,0,0,1),z:1});for(let fe of rt)i.drawFmtText(fe)}i.popTransform()})}s(Se,"drawInspect");function Xe(r,...n){t.run(()=>{if(i.frameStart(),T.loaded){try{if(!y())throw new Error(`scene not found: '${T.curScene}'`);je(),Ae(),H.inspect&&Se()}catch(a){R.error(a.stack),t.quit()}H.showLog&&R.draw(),T.nextScene&&(z.apply(null,[T.nextScene.name,...T.nextScene.args]),T.nextScene=null)}else{let a=l.loadProgress();if(a===1)T.loaded=!0,z(r,...n),C&&C.connect().catch(R.error);else{let c=i.width()/2,u=12,m=d(i.width()/2,i.height()/2).sub(d(c/2,u/2)),h=i.clearColor().isDark(.7)?Pe(1,1,1):Pe(0,0,0);i.drawRectStroke(m,c,u,{width:2,color:h}),i.drawRect(m,c*a,u,{color:h})}}i.frameEnd()})}s(Xe,"start");function Ve(...r){return{pos:d(...r),move(...n){let a=d(...n),c=a.x*k(),u=a.y*k();this.pos.x+=c,this.pos.y+=u},inspect(){return{pos:`(${~~this.pos.x}, ${~~this.pos.y})`}}}}s(Ve,"pos");function Xt(...r){return{scale:d(...r),flipX(n){this.scale.x=Math.sign(n)*Math.abs(this.scale.x)},flipY(n){this.scale.y=Math.sign(n)*Math.abs(this.scale.y)}}}s(Xt,"scale");function Yt(r){return{angle:r}}s(Yt,"rotate");function $t(...r){return{color:Y(...r)}}s($t,"color");function Ht(r){return{origin:r}}s(Ht,"origin");function Wt(r){return{layer:r,inspect(){var a;let n=y();return{layer:(a=this.layer)!=null?a:n.defLayer}}}}s(Wt,"layer");function Ye(r,n){var c,u;let a=y();return((c=r.layer)!=null?c:a.defLayer)===((u=n.layer)!=null?u:a.defLayer)}s(Ye,"isSameLayer");function tt(r,n){let a={},c={};return{area:{p1:r,p2:n},areaWidth(){let{p1:u,p2:m}=this._worldArea();return m.x-u.x},areaHeight(){let{p1:u,p2:m}=this._worldArea();return m.y-u.y},isClicked(){return t.mouseClicked()&&this.isHovered()},isHovered(){return this.hasPt(V(this.layer))},isCollided(u){if(!u.area||!Ye(this,u))return!1;let m=this._worldArea(),h=u._worldArea();return Ke(m,h)},isOverlapped(u){if(!u.area||!Ye(this,u))return!1;let m=this._worldArea(),h=u._worldArea();return Rt(m,h)},clicks(u){this.action(()=>{this.isClicked()&&u()})},hovers(u){this.action(()=>{this.isHovered()&&u()})},collides(u,m){this.action(()=>{this._checkCollisions(u,m)})},overlaps(u,m){this.action(()=>{this._checkOverlaps(u,m)})},hasPt(u){let m=this._worldArea();return _t({p1:m.p1,p2:m.p2},u)},resolve(){let u=[];return he(m=>{if(m===this||!m.solid||!m.area||!Ye(this,m))return;let h=this._worldArea(),p=m._worldArea();if(!Ke(h,p))return;let S=h.p2.x-p.p1.x,M=p.p2.x-h.p1.x,oe=h.p2.y-p.p1.y,ae=p.p2.y-h.p1.y,$e=Math.min(S,M,oe,ae),He=(()=>{switch($e){case S:return this.pos.x-=S,"right";case M:return this.pos.x+=M,"left";case oe:return this.pos.y-=oe,"bottom";case ae:return this.pos.y+=ae,"top"}})();u.push({obj:m,side:He})}),u},_checkCollisions(u,m){he(u,h=>{this!==h&&(a[h._sceneID]||this.isCollided(h)&&(m(h),a[h._sceneID]=h))});for(let h in a){let p=a[h];this.isCollided(p)||delete a[h]}},_checkOverlaps(u,m){he(u,h=>{this!==h&&(c[h._sceneID]||this.isOverlapped(h)&&(m(h),c[h._sceneID]=h))});for(let h in c){let p=c[h];this.isOverlapped(p)||delete c[h]}},_worldArea(){let u=this.area,m=this.pos||d(0),h=this.scale||d(1),p=m.add(u.p1.dot(h)),S=m.add(u.p2.dot(h));return{p1:d(Math.min(p.x,S.x),Math.min(p.y,S.y)),p2:d(Math.max(p.x,S.x),Math.max(p.y,S.y))}}}}s(tt,"area");function Ne(r,n,a){let c=d(r,n),u=Le(a||N).dot(c).scale(-.5);return tt(u.sub(c.scale(.5)),u.add(c.scale(.5)))}s(Ne,"getAreaFromSize");function Kt(r,n={}){let a=l.sprites[r];if(!a)throw new Error(`sprite not found: "${r}"`);let c=de({},a.frames[0]);n.quad&&(c.x+=n.quad.x*c.w,c.y+=n.quad.y*c.h,c.w*=n.quad.w,c.h*=n.quad.h);let u=a.tex.width*c.w,m=a.tex.height*c.h,h=null;return{width:u,height:m,animSpeed:n.animSpeed||.1,frame:n.frame||0,quad:n.quad||re(0,0,1,1),add(){!this.area&&!n.noArea&&this.use(Ne(this.width,this.height,this.origin))},draw(){var M;let p=y(),S=a.frames[this.frame];A(a,{pos:this.pos,scale:this.scale,rot:this.angle,color:this.color,frame:this.frame,origin:this.origin,quad:this.quad,prog:l.shaders[this.shader],uniform:this.uniform,z:p.layers[(M=this.layer)!=null?M:p.defLayer]})},update(){if(!h)return;let p=a.anims[h.name];h.timer+=k(),h.timer>=this.animSpeed&&(this.frame++,this.frame>p.to&&(h.loop?this.frame=p.from:(this.frame--,this.stop())),h.timer-=this.animSpeed)},play(p,S=!0){let M=a.anims[p];if(!M)throw new Error(`anim not found: ${p}`);h&&this.stop(),h={name:p,loop:S,timer:0},this.frame=M.from,this.trigger("animPlay",p)},stop(){if(!h)return;let p=h.name;h=null,this.trigger("animEnd",p)},changeSprite(p){if(a=l.sprites[p],!a)throw new Error(`sprite not found: "${p}"`);let S=de({},a.frames[0]);n.quad&&(S.x+=n.quad.x*S.w,S.y+=n.quad.y*S.h,S.w*=n.quad.w,S.h*=n.quad.h),this.width=a.tex.width*S.w,this.height=a.tex.height*S.h,this.area&&!n.noArea&&this.use(Ne(this.width,this.height,this.origin)),h=null,this.frame=0},numFrames(){return a.frames.length},curAnim(){return h==null?void 0:h.name},inspect(){let p={};return h&&(p.curAnim=`"${h.name}"`),p}}}s(Kt,"sprite");function Qt(r,n,a={}){return{text:r,textSize:n,font:a.font,width:0,height:0,add(){var c,u,m,h;if(!this.area&&!a.noArea){let p=y(),S=l.fonts[(c=this.font)!=null?c:ge],M=i.fmtText(this.text+"",S,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:p.layers[(u=this.layer)!=null?u:p.defLayer]});this.width=M.width/(((m=this.scale)==null?void 0:m.x)||1),this.height=M.height/(((h=this.scale)==null?void 0:h.y)||1),this.use(Ne(this.width,this.height,this.origin))}},draw(){var h,p;let c=y(),u=l.fonts[(h=this.font)!=null?h:ge],m=i.fmtText(this.text+"",u,{pos:this.pos,scale:this.scale,rot:this.angle,size:this.textSize,origin:this.origin,color:this.color,width:a.width,z:c.layers[(p=this.layer)!=null?p:c.defLayer]});this.width=m.width,this.height=m.height,i.drawFmtText(m)}}}s(Qt,"text");function Zt(r,n,a={}){return{width:r,height:n,add(){!this.area&&!a.noArea&&this.use(Ne(this.width,this.height,this.origin))},draw(){var u;let c=y();i.drawRect(this.pos,this.width,this.height,{scale:this.scale,rot:this.angle,color:this.color,origin:this.origin,z:c.layers[(u=this.layer)!=null?u:c.defLayer],prog:l.shaders[this.shader],uniform:this.uniform})}}}s(Zt,"rect");function Jt(){return{solid:!0}}s(Jt,"solid");let en=960,tn=480;function nn(r={}){var m,h;let n=0,a=null,c=null,u=(m=r.maxVel)!=null?m:en;return{jumpForce:(h=r.jumpForce)!=null?h:tn,update(){this.move(0,n);let p=this.resolve(),S=!1;if(a&&(!a.exists()||!this.isCollided(a)?(a=null,c=null,S=!0):c&&(this.pos=this.pos.add(a.pos.sub(c)),c=a.pos.clone())),!a){n=Math.min(n+Oe()*k(),u);for(let M of p)M.side==="bottom"&&n>0?(a=M.obj,n=0,c=a.pos.clone(),S||this.trigger("grounded",a)):M.side==="top"&&n<0&&(n=0,this.trigger("headbump",M.obj))}},curPlatform(){return a},grounded(){return a!==null},falling(){return n>0},jump(p){a=null,n=-p||-this.jumpForce}}}s(nn,"body");function sn(r,n={}){let a=l.shaders[r];return{shader:r,uniform:n}}s(sn,"shader");let H={paused:!1,inspect:!1,timeScale:1,showLog:!0,fps(){return 1/t.dt()},objCount(){return y().objs.size},stepFrame(){Ae(!0)},drawCalls:i.drawCalls,clearLog:R.clear,log:R.info,error:R.error};function rn(r,n){let a=[],c=d(n.pos),u=0,m={getPos(...h){let p=d(...h);return d(c.x+p.x*n.width,c.y+p.y*n.height)},spawn(h,p){let S=(()=>{if(Array.isArray(h))return h;if(n[h]){if(typeof n[h]=="function")return n[h]();if(Array.isArray(n[h]))return[...n[h]]}else if(n.any)return n.any(h)})();if(!S)return;S.push(Ve(c.x+p.x*n.width,c.y+p.y*n.height));let M=ve(S);return a.push(M),M.use({gridPos:p.clone(),setGridPos(oe){this.gridPos=oe.clone(),this.pos=d(c.x+this.gridPos.x*n.width,c.y+this.gridPos.y*n.height)},moveLeft(){this.setGridPos(this.gridPos.add(d(-1,0)))},moveRight(){this.setGridPos(this.gridPos.add(d(1,0)))},moveUp(){this.setGridPos(this.gridPos.add(d(0,-1)))},moveDown(){this.setGridPos(this.gridPos.add(d(0,1)))}}),M},width(){return u*n.width},height(){return r.length*n.height},destroy(){for(let h of a)se(h)}};return r.forEach((h,p)=>{let S=h.split("");u=Math.max(S.length,u),S.forEach((M,oe)=>{m.spawn(M,d(oe,p))})}),m}s(rn,"addLevel");let Te={start:Xe,loadRoot:l.loadRoot,loadSprite:l.loadSprite,loadSound:l.loadSound,loadFont:l.loadFont,loadShader:l.loadShader,addLoader:l.addLoader,width:i.width,height:i.height,dt:k,time:t.time,screenshot:t.screenshot,scene:$,go:O,sceneData:q,layers:G,camPos:Z,camScale:ne,camRot:ie,camShake:J,camIgnore:Me,gravity:Oe,add:ve,readd:Re,destroy:se,destroyAll:ze,get:te,every:he,revery:Ee,send:B,recv:_,pos:Ve,scale:Xt,rotate:Yt,color:$t,origin:Ht,layer:Wt,area:tt,sprite:Kt,text:Qt,rect:Zt,solid:Jt,body:nn,shader:sn,on:_e,action:f,render:b,collides:x,overlaps:P,clicks:U,keyDown:D,keyPress:j,keyPressRep:I,keyRelease:K,charInput:ee,mouseDown:pe,mouseClick:Ge,mouseRelease:qe,mousePos:V,cursor:t.cursor,keyIsDown:t.keyDown,keyIsPressed:t.keyPressed,keyIsPressedRep:t.keyPressedRep,keyIsReleased:t.keyReleased,mouseIsDown:t.mouseDown,mouseIsClicked:t.mouseClicked,mouseIsReleased:t.mouseReleased,loop:W,wait:L,play:F,volume:o.volume,makeRng:We,rand:Ie,randSeed:wt,vec2:d,rgb:Pe,rgba:Y,quad:re,choose:vt,chance:gt,lerp:ke,map:be,mapc:ft,wave:yt,deg2rad:ht,rad2deg:dt,drawSprite:A,drawText:g,drawRect:i.drawRect,drawRectStroke:i.drawRectStroke,drawLine:i.drawLine,debug:H,addLevel:rn};if(e.plugins)for(let r of e.plugins){let n=r(Te);for(let a in n)Te[a]=n[a]}if(e.global)for(let r in Te)window[r]=Te[r];return Te}});export default Rn();
//# sourceMappingURL=kaboom.mjs.map
